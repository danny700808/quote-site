<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>活動企劃｜設備選配與即時報價（逐日導引）</title>
  <style>
    :root{
      --bg:#f7fbf9;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e6efe9;
      --brand:#63bfae;
      --brand2:#2f8f7b;
      --blush:#f4b7c4;
      --mintSoft:#eaf7f3;
      --blushSoft:#fff1f4;
      --danger:#e25a6a;
      --shadow:0 10px 28px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .ttl{font-weight:1000;font-size:20px}
    .backBtn{
      border:1px solid var(--line);background:#fff;border-radius:999px;
      padding:10px 14px;font-weight:900;color:#2563eb;cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }

    .steps{display:flex;align-items:center;gap:10px;margin:10px 0 14px}
    .step{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:900}
    .dot{
      width:34px;height:34px;border-radius:999px;display:grid;place-items:center;
      border:2px solid var(--line);background:#fff;color:var(--muted);
    }
    .step.active{color:var(--brand2)}
    .step.active .dot{border-color:var(--brand);color:var(--brand2)}
    .line{flex:1;height:2px;background:var(--line);border-radius:99px}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .cardHd{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 14px;border-bottom:1px solid var(--line)}
    .cardHd .h{font-weight:1000}
    .badge{font-weight:1000;border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;color:var(--muted)}
    .cardBd{padding:14px}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:820px){ .grid2{grid-template-columns:1fr} }

    label{display:block;font-weight:900;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--line);
      background:#fff;font-size:16px;outline:none;
    }
    textarea{min-height:100px;resize:vertical}

    .hint{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.35}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff;color:var(--muted);font-weight:900;font-size:13px}
    .noteBox{
      margin-top:12px;border:1px dashed var(--line);background:var(--mintSoft);
      border-radius:14px;padding:12px;color:var(--muted);font-weight:800;line-height:1.5
    }
    .dangerBox{
      margin-top:12px;border:1px dashed rgba(226,90,106,.4);background:rgba(226,90,106,.08);
      border-radius:14px;padding:12px;color:#a01426;font-weight:900;line-height:1.5
    }

    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap}
    .btn{
      border:none;border-radius:14px;padding:12px 14px;font-weight:1000;cursor:pointer;
      box-shadow:0 10px 24px rgba(0,0,0,.10);
    }
    .btn.primary{background:var(--brand);color:#083b32}
    .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--muted);box-shadow:none}
    .btn.blue{background:#2563eb;color:#fff}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.small{padding:10px 12px;border-radius:12px;box-shadow:none}

    .section{display:none}
    .section.active{display:block}

    /* Step1：橫向「延伸」區（避免直排擠成一團） */
    .extendHd{
      display:flex;align-items:flex-start;gap:12px;
      padding:12px;border-radius:16px;background:var(--blushSoft);
      border:1px solid rgba(244,183,196,.55);
      margin-top:14px
    }
    .extendDot{width:12px;height:12px;border-radius:99px;background:var(--danger);margin-top:6px}
    .extendTxt .t{font-weight:1000;color:#7a1b2d}
    .extendTxt .d{color:var(--muted);font-weight:800;margin-top:4px}

    /* 日卡列表 */
    .dayList{display:grid;gap:12px}
    .dayCard{
      border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden
    }
    .dayTop{display:flex;justify-content:space-between;gap:10px;padding:12px 12px;border-bottom:1px solid var(--line);align-items:center}
    .dayTitle{display:flex;flex-direction:column;gap:4px}
    .dayTitle .big{font-weight:1000;font-size:18px}
    .dayTitle .sub{color:var(--muted);font-weight:900}
    .dayMeta{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .status{
      display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;
      border:1px solid var(--line);font-weight:1000;color:var(--muted);background:#fff
    }
    .status.todo{border-color:rgba(226,90,106,.35);color:#a01426;background:rgba(226,90,106,.06)}
    .dayBody{padding:12px}
    .dayBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .miniHint{color:var(--muted);font-weight:800;font-size:13px;margin-top:8px}

    /* 編輯設備 overlay */
    .mask{position:fixed;inset:0;background:rgba(0,0,0,.40);display:none;align-items:flex-end;justify-content:center;z-index:50}
    .panel{
      width:min(1100px, 100%);max-height:92vh;overflow:auto;background:var(--bg);
      border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -18px 40px rgba(0,0,0,.25)
    }
    .panelHd{position:sticky;top:0;background:rgba(247,251,249,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:12px}
    .panelHdRow{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .panelHd .pTitle{font-weight:1000}
    .panelHd .pSub{color:var(--muted);font-weight:900;font-size:13px;margin-top:4px}
    .panelBody{padding:14px}

    /* 設備選取區（簡化版 UI，但保留你原來的加減/購物車/小計邏輯） */
    .layout{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media (max-width:980px){ .layout{grid-template-columns:1fr} }
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .tab{
      border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;font-weight:1000;color:var(--muted);cursor:pointer
    }
    .tab.active{border-color:rgba(99,191,174,.6);color:var(--brand2);background:rgba(99,191,174,.10)}
    .item{
      display:grid;grid-template-columns:84px 1fr auto;gap:12px;
      border:1px solid var(--line);background:#fff;border-radius:16px;padding:10px;margin-bottom:10px
    }
    .thumb{width:84px;height:64px;object-fit:cover;border-radius:12px;border:1px solid var(--line);background:#f3f4f6}
    .name{font-weight:1000}
    .sub{color:var(--muted);font-weight:900;font-size:13px;margin-top:4px}
    .qty{display:flex;align-items:center;gap:8px}
    .qbtn{
      width:34px;height:34px;border-radius:10px;border:1px solid var(--line);
      background:#fff;font-weight:1000;cursor:pointer
    }
    .qval{width:28px;text-align:center;font-weight:1000}
    .price{font-weight:1000;min-width:88px;text-align:right}
    .cartBox{border:1px solid var(--line);border-radius:16px;background:#fff;overflow:hidden}
    .cartHd{padding:12px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .cartBd{padding:12px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:8px}
    .row .k{color:var(--muted);font-weight:900}
    .row .v{font-weight:1000}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .stickyBottom{
      position:sticky;bottom:0;background:rgba(247,251,249,.92);backdrop-filter:blur(8px);
      border-top:1px solid var(--line);padding:12px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap
    }
    /* ✅ Step3 套裝等級區塊（安全/氣氛/升級） */
#tierSectionRoot{
  margin:12px 0;
  padding:12px;
  border:1px solid var(--line);
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:0 6px 18px rgba(0,0,0,.06);
}
#tierSectionRoot .tierTop{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
#tierSectionRoot .tierTitle{
  font-weight:1000;
  color:var(--text);
}
#tierSectionRoot .tierHint{
  color:var(--muted);
  font-weight:700;
  margin-top:4px;
  font-size:13px;
  line-height:1.4;
}
#tierSectionRoot .tierPillsText{
  font-weight:900;
  color:var(--muted);
  white-space:nowrap;
}
#tierSectionRoot .tierCols{
  display:grid;
  grid-template-columns:1fr;
  gap:12px;
  margin-top:10px;
}
@media(min-width:980px){
  #tierSectionRoot .tierCols{ grid-template-columns:repeat(3,1fr); }
}
#tierSectionRoot .tierCol{
  border:1px dashed var(--line);
  border-radius:14px;
  padding:10px;
  background:#fff;
}
#tierSectionRoot .tierColHead{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  font-weight:1000;
  color:var(--text);
  margin-bottom:8px;
}
#tierSectionRoot .pillMini{
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  color:var(--muted);
  font-size:12px;
  white-space:nowrap;
}
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="ttl">活動企劃｜設備選配與即時報價（逐日導引）</div>
    <button class="backBtn" id="btnBackBasic" type="button">回到基本資料</button>
  </div>

  <!-- 3 Steps（你要求取消 Step2「生成日期圖框」的步驟感） -->
  <div class="steps" aria-label="steps">
    <div class="step" id="s1"><div class="dot">1</div><div>基本資料＋場次規劃</div></div>
    <div class="line"></div>
    <div class="step" id="s2"><div class="dot">2</div><div>選擇日期／進入設備選取</div></div>
    <div class="line"></div>
    <div class="step" id="s3"><div class="dot">3</div><div>輸出報價單</div></div>
  </div>

  <!-- STEP 1 -->
  <section class="section active" id="step1">
    <div class="card">
      <div class="cardHd">
        <div class="h">1）基本資料</div>
        <div class="badge" id="basicBadge">未完成</div>
      </div>
      <div class="cardBd">
        <div class="grid2">
          <div>
            <label>姓名 / 單位</label>
            <input id="fName" placeholder="例：黃明 / XX公司" />
          </div>
          <div>
            <label>行動電話</label>
            <input id="fPhone" placeholder="例：0953xxxxxx" />
          </div>
          <div>
            <label>Email</label>
            <input id="fEmail" placeholder="例：abc@gmail.com" />
          </div>
          <div>
            <label>活動類型</label>
            <select id="fEventType">
              <option value="">請選擇</option>
              <option>展覽開幕 / 展場活動（含舞台時段）</option>
              <option>婚禮 / 喜宴</option>
              <option>校園活動 / 表演</option>
              <option>企業活動 / 發表會</option>
              <option>其他</option>
            </select>
          </div>
          <div>
            <label>室內 / 戶外</label>
            <select id="fIndoor">
              <option value="">請選擇</option>
              <option>室內</option>
              <option>戶外</option>
            </select>
          </div>
          <div>
            <label>預估人數</label>
            <select id="fCrowd">
              <option value="">請選擇</option>
              <option>30 人內</option>
              <option>30～80 人</option>
              <option>80～150 人</option>
              <option>150～300 人</option>
              <option>300 人以上</option>
            </select>
          </div>
        </div>

        <div class="grid2" style="margin-top:8px">
          <div>
            <label>活動地點（縣市）</label>
            <select id="fCity"></select>
          </div>
          <div>
            <label>活動地點（區域）</label>
            <select id="fArea"></select>
          </div>
        </div>

        <div class="grid2" style="margin-top:8px">
          <div>
            <label>詳細地址（路名/號）</label>
            <input id="fAddr" placeholder="例：圓環東路 357 號" />
          </div>
          <div>
            <label>樓層/場地補充（選填）</label>
            <input id="fBldg" placeholder="例：地下室 1F / XX入口" />
          </div>
        </div>

        <label style="margin-top:10px">備註 / 需求</label>
        <textarea id="fNote" placeholder="例：場地有 220V 插座、需含進退場…"></textarea>

        <div class="noteBox">
          ✅ 你填寫的所有資料都會出現在 PDF 報價單裡（含：姓名/電話/Email/日期/時間/地點/備註/每一天的設備明細）。
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="cardHd">
        <div class="h">1）活動日期規劃</div>
        <div class="badge" id="dateBadge">未設定</div>
      </div>
      <div class="cardBd">
        <label>第 1 天（必填）</label>
        <input id="fDateStart" type="date" />

        <!-- 你要求：連續/不連續都要同時可見，不要互相隱藏 -->
        <div class="grid2" style="margin-top:10px">
          <div class="card" style="box-shadow:none">
            <div class="cardBd">
              <label style="margin-top:0">
                <input type="checkbox" id="fIsMultiDay" style="width:18px;height:18px;vertical-align:middle;margin-right:8px" />
                連續多日活動（勾選後可選結束日期）
              </label>
              <div id="multiDayWrap" style="display:none;margin-top:10px">
                <div class="grid2">
                  <div>
                    <label style="margin-top:0">開始</label>
                    <input id="fDateStartMirror" type="date" disabled />
                  </div>
                  <div>
                    <label style="margin-top:0">結束</label>
                    <input id="fDateEnd" type="date" />
                  </div>
                </div>
                <div class="hint">
                  計價：第 2 天加 B×50%；第 3 天起每一天加 B×30%。<br>
                  注意：連續多日模式下，若各天設備不同，系統會提示並改以「每日獨立計價」。
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <div class="cardBd">
              <label style="margin-top:0">
                <input type="checkbox" id="fHasExtraDates" style="width:18px;height:18px;vertical-align:middle;margin-right:8px" />
                新增不連續日期（可加多個；每日重新計算）
              </label>
              <div id="extraDatesWrap" style="display:none;margin-top:10px">
                <div class="grid2" style="grid-template-columns:1fr auto;gap:10px">
                  <input id="extraDateInput" type="date" />
                  <button class="btn ghost small" type="button" id="btnAddExtraDate">加入日期</button>
                </div>
                <div class="hint">加入後會出現在下方「場次規劃」清單；每一天會獨立計價。</div>
                <div id="extraDatesList" style="display:grid;gap:8px;margin-top:10px"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- 你要求：粉紅區不要直排擠在一起 -->
        <div class="extendHd">
          <div class="extendDot"></div>
          <div class="extendTxt">
            <div class="t">（Step1 延伸）逐日時間 / 第二場規劃（完成後進入設備選取）</div>
            <div class="d">先把每一天的「第一場時間」與「是否有第二場 / 第二場時間」規劃好，後面進入每一天的設備選取會更清楚。</div>
          </div>
        </div>

        <div id="dayTimePlan" style="margin-top:12px"></div>

        <div class="actions">
          <button class="btn ghost" type="button" id="btnStep1Preview">更新清單</button>
          <button class="btn primary" type="button" id="btnToStep2">進入設備選取</button>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 2：日期/場次列表 -->
  <section class="section" id="step2">
    <div class="card">
      <div class="cardHd">
        <div class="h">2）日期列表（點「進入設備選取」）</div>
        <div class="badge" id="daysBadge">0 天</div>
      </div>
      <div class="cardBd">
        <div class="noteBox">
          ✅ 卡片會顯示「第一場/第二場」資訊；第一天不會顯示複製按鈕（避免誤導）。<br>
          ✅ 你也可以從任意一天進入編輯，再回到列表快速切換。
        </div>
        <div class="dayList" id="dayCards" style="margin-top:12px"></div>

        <div class="actions">
          <button class="btn ghost" type="button" id="btnBackToStep1">回到基本資料</button>
          <button class="btn blue" type="button" id="btnToStep3">前往輸出報價單</button>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 3：輸出報價單 -->
  <section class="section" id="step3">
    <div class="card">
      <div class="cardHd">
        <div class="h">3）輸出報價單</div>
        <div class="badge" id="totalBadge">NT$0</div>
      </div>
      <div class="cardBd">
        <div id="quotePreview"></div>
        <div class="actions">
          <button class="btn ghost" type="button" id="btnBackToStep2">回到日期列表</button>
          <button class="btn primary" type="button" id="btnSendQuote">送出並產生 PDF（寄到信箱）</button>
        </div>
        <div class="hint">送出後：Apps Script 會生成 PDF 並寄給客人（以及你的備份信箱）。</div>
      </div>
    </div>
  </section>
</div>

<!-- 設備選取 overlay -->
<div class="mask" id="editorMask">
  <div class="panel">
    <div class="panelHd">
      <div class="panelHdRow">
        <div>
          <div class="pTitle" id="editorTitle">設備選取</div>
          <div class="pSub" id="editorSub">—</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn ghost small" type="button" id="btnBackToDayList">回到場次列表</button>
          <button class="btn ghost small" type="button" id="btnCloseEditor">關閉</button>
        </div>
      </div>
    </div>

    <div class="panelBody">
      <!-- 本日資料（可單獨修改） -->
      <div class="card" style="box-shadow:none">
        <div class="cardHd">
          <div class="h">本日資料（此頁可單獨修改）</div>
          <div class="badge" id="dayModePill">—</div>
        </div>
        <div class="cardBd">
          <div class="grid2">
            <div>
              <label>日期（本日）</label>
              <input id="dDate" type="date" disabled />
            </div>
            <div>
              <label>第一場時間</label>
              <div class="grid2" style="grid-template-columns:1fr 1fr;gap:10px">
                <input id="dTime1" disabled />
                <div class="pill" id="dS2Pill">第二場：無</div>
              </div>
            </div>
          </div>

          <div class="grid2" style="margin-top:8px">
            <div>
              <label>（本日）縣市</label>
              <select id="dCity"></select>
            </div>
            <div>
              <label>（本日）區域</label>
              <select id="dArea"></select>
            </div>
          </div>
          <div class="grid2" style="margin-top:8px">
            <div>
              <label>（本日）地址</label>
              <input id="dAddr" />
            </div>
            <div>
              <label>（本日）樓層/補充</label>
              <input id="dBldg" />
            </div>
          </div>
          <div class="hint">你在這裡修改的地址只會影響「本日」頁與 PDF 的「該日頁面」。</div>
        </div>
      </div>

      <!-- 設備選取 -->
      <div class="layout" style="margin-top:12px">
        <div>
          <div class="tabs" id="tabs"></div>
          <div id="items"></div>
        </div>

        <div>
          <div class="cartBox">
            <div class="cartHd">
              <div style="font-weight:1000">本日即時報價</div>
              <div class="pill" id="pickedCount">0 項已選</div>
            </div>
            <div class="cartBd">
              <div class="row"><div class="k">第一場小計（B）</div><div class="v" id="sumB">NT$0</div></div>
              <div class="row" id="rowS2Fee" style="display:none"><div class="k">第二場加價（每場 B×30%）</div><div class="v" id="feeS2">NT$0</div></div>
              <div class="hr"></div>
              <div class="row"><div class="k">本日合計</div><div class="v" id="dayTotal">NT$0</div></div>
              <div class="hint" id="contHint" style="margin-top:10px"></div>
            </div>
          </div>

          <div class="stickyBottom">
            <button class="btn ghost" type="button" id="btnPrevDay">上一天</button>
            <button class="btn ghost" type="button" id="btnNextDay">下一天</button>
            <button class="btn primary" type="button" id="btnDoneDay">完成本日設備</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/** ===== 小工具 ===== */
const $ = (s)=>document.querySelector(s);
const fmt = (n)=>"NT$"+(Number(n||0)).toLocaleString("zh-Hant");
const pad2 = (n)=>String(n).padStart(2,"0");
function deepClone(o){ return JSON.parse(JSON.stringify(o||{})); }

/** ===== 你的 Apps Script Web App URL（請換成你自己的） ===== */
const ORDER_API_URL = "PASTE_YOUR_WEB_APP_URL_HERE";

/** ===== 台灣縣市/區域（fallback，避免你遇到「地址下拉不能選」） ===== */
const CITY_AREAS_TW = {
  "台中市":["中區","東區","南區","西區","北區","北屯區","西屯區","南屯區","豐原區","大里區","太平區","清水區","沙鹿區","大甲區","東勢區","梧棲區","烏日區","神岡區","大肚區","大雅區","后里區","霧峰區","潭子區","龍井區","外埔區","和平區","石岡區","新社區","大安區"],
  "台北市":["中正區","大同區","中山區","松山區","大安區","萬華區","信義區","士林區","北投區","內湖區","南港區","文山區"],
  "新北市":["板橋區","三重區","中和區","永和區","新莊區","新店區","土城區","蘆洲區","樹林區","汐止區","三峽區","淡水區","鶯歌區","五股區","泰山區","林口區","深坑區","石碇區","坪林區","三芝區","石門區","八里區","平溪區","雙溪區","貢寮區","金山區","萬里區","烏來區"],
  "桃園市":["桃園區","中壢區","平鎮區","八德區","楊梅區","蘆竹區","大溪區","龜山區","大園區","觀音區","新屋區","龍潭區","復興區"],
  "台南市":["中西區","東區","南區","北區","安平區","安南區","永康區","歸仁區","仁德區","新化區","新市區","善化區","關廟區","龍崎區","官田區","麻豆區","佳里區","學甲區","西港區","七股區","將軍區","北門區","後壁區","白河區","東山區","六甲區","下營區","柳營區","鹽水區","大內區","山上區","左鎮區","南化區","楠西區","玉井區"],
  "高雄市":["楠梓區","左營區","鼓山區","三民區","新興區","前金區","苓雅區","前鎮區","旗津區","小港區","鳳山區","大寮區","鳥松區","林園區","仁武區","大樹區","岡山區","橋頭區","燕巢區","田寮區","阿蓮區","路竹區","湖內區","茄萣區","永安區","彌陀區","梓官區","旗山區","美濃區","六龜區","甲仙區","杉林區","內門區","茂林區","桃源區","那瑪夏區"],
  "新竹市":["東區","北區","香山區"],
  "新竹縣":["竹北市","竹東鎮","新豐鄉","湖口鄉","新埔鎮","關西鎮","芎林鄉","寶山鄉","北埔鄉","峨眉鄉","橫山鄉","尖石鄉","五峰鄉"],
  "苗栗縣":["苗栗市","頭份市","竹南鎮","後龍鎮","通霄鎮","苑裡鎮","造橋鄉","頭屋鄉","公館鄉","大湖鄉","泰安鄉","銅鑼鄉","三義鄉","西湖鄉","卓蘭鎮","南庄鄉","三灣鄉","獅潭鄉"],
  "彰化縣":["彰化市","員林市","和美鎮","鹿港鎮","溪湖鎮","二林鎮","田中鎮","北斗鎮","花壇鄉","芬園鄉","大村鄉","永靖鄉","埔心鄉","埔鹽鄉","福興鄉","秀水鄉","伸港鄉","線西鄉","和美鎮","田尾鄉","埤頭鄉","溪州鄉","芳苑鄉","大城鄉","竹塘鄉","二水鄉"],
  "南投縣":["南投市","埔里鎮","草屯鎮","竹山鎮","集集鎮","名間鄉","魚池鄉","國姓鄉","水里鄉","信義鄉","仁愛鄉","鹿谷鄉","中寮鄉"],
  "雲林縣":["斗六市","斗南鎮","虎尾鎮","西螺鎮","土庫鎮","北港鎮","古坑鄉","大埤鄉","莿桐鄉","林內鄉","二崙鄉","崙背鄉","麥寮鄉","東勢鄉","褒忠鄉","臺西鄉","元長鄉","四湖鄉","口湖鄉","水林鄉"],
  "嘉義市":["東區","西區"],
  "嘉義縣":["太保市","朴子市","民雄鄉","溪口鄉","新港鄉","大林鎮","水上鄉","中埔鄉","竹崎鄉","梅山鄉","番路鄉","大埔鄉","阿里山鄉","六腳鄉","東石鄉","布袋鎮","義竹鄉","鹿草鄉"],
  "屏東縣":["屏東市","潮州鎮","東港鎮","恆春鎮","內埔鄉","萬丹鄉","長治鄉","麟洛鄉","九如鄉","里港鄉","鹽埔鄉","高樹鄉","萬巒鄉","崁頂鄉","新園鄉","林邊鄉","佳冬鄉","枋寮鄉","枋山鄉","春日鄉","獅子鄉","車城鄉","牡丹鄉","滿州鄉","三地門鄉","霧台鄉","瑪家鄉","泰武鄉","來義鄉"],
  "宜蘭縣":["宜蘭市","羅東鎮","蘇澳鎮","頭城鎮","礁溪鄉","冬山鄉","五結鄉","員山鄉","三星鄉","大同鄉","南澳鄉"],
  "花蓮縣":["花蓮市","鳳林鎮","玉里鎮","新城鄉","吉安鄉","壽豐鄉","光復鄉","豐濱鄉","瑞穗鄉","富里鄉","秀林鄉","萬榮鄉","卓溪鄉"],
  "台東縣":["台東市","成功鎮","關山鎮","卑南鄉","鹿野鄉","池上鄉","東河鄉","長濱鄉","太麻里鄉","大武鄉","綠島鄉","蘭嶼鄉","延平鄉","金峰鄉","達仁鄉","海端鄉"],
  "基隆市":["仁愛區","信義區","中正區","中山區","安樂區","暖暖區","七堵區"],
  "新竹市":["東區","北區","香山區"],
  "金門縣":["金城鎮","金湖鎮","金沙鎮","金寧鄉","烈嶼鄉","烏坵鄉"],
  "連江縣":["南竿鄉","北竿鄉","莒光鄉","東引鄉"],
  "澎湖縣":["馬公市","湖西鄉","白沙鄉","西嶼鄉","望安鄉","七美鄉"]
};

/** ===== 示範設備資料（你可改成讀 Sheet；先確保功能跑得動） ===== */
const CATEGORIES = [
  {id:"audio", name:"音響", items:[
    {id:"spk15", name:"15吋主喇叭", unit:"組", price:4800, img:"https://picsum.photos/seed/spk15/200/150", desc:"示範：15吋主喇叭（含架）"},
    {id:"mon12", name:"12吋監聽喇叭", unit:"顆", price:2000, img:"https://picsum.photos/seed/mon12/200/150", desc:"示範：舞台監聽"},
    {id:"wireless4", name:"無線麥克風（4支）", unit:"組", price:3800, img:"https://picsum.photos/seed/wireless/200/150", desc:"示範：4 支無線麥"},
  ]},
  {id:"light", name:"燈光", items:[
    {id:"par8", name:"染色燈 PAR（8盞）", unit:"組", price:5200, img:"https://picsum.photos/seed/par/200/150", desc:"示範：基礎染色"},
    {id:"move2", name:"移動燈（2盞）", unit:"組", price:6000, img:"https://picsum.photos/seed/move/200/150", desc:"示範：移動燈效果"},
  ]},
  {id:"stage", name:"舞台/其他", items:[
    {id:"curtain", name:"舞台布幕/遮擋（基本）", unit:"組", price:4800, img:"https://picsum.photos/seed/curtain/200/150", desc:"示範：遮擋/背景"},
    {id:"engineer", name:"專業音控人員", unit:"人", price:4500, img:"https://picsum.photos/seed/eng/200/150", desc:"示範：音控人力"},
  ]},
];

function getUnitPrice(item, qty){ return Number(item.price||0); }
function svgThumb(t){ return `data:image/svg+xml;utf8,`+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="240" height="160"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="18" fill="#6b7280">${(t||"IMG").slice(0,10)}</text></svg>`); }

/** ===== state：每一天都有自己的 cart / 本日地址覆寫（符合你想要的「逐日可改」） ===== */
const state = {
  step: 1,
  catId: "audio",
  extraDates: [],
  days: [],
  dayData: {}, // {date:{ session1:{start,end}, session2:{on,start,end}, cart:{}, addr:{city,area,addr,bldg} }}
  currentDate: null,
};

/** ===== Step 切換 ===== */
function setStep(n){
  state.step = n;
  ["#step1","#step2","#step3"].forEach((sel,i)=>{
    const el=$(sel);
    if(el) el.classList.toggle("active", (i+1)===n);
  });
  ["#s1","#s2","#s3"].forEach((sel,i)=>{
    const el=$(sel);
    if(el) el.classList.toggle("active", (i+1)===n);
  });
  if(n===2) renderDayCards();
  if(n===3) renderQuotePreview();
}

/** ===== 日期工具 ===== */
function dateToTS(d){ return new Date(d+"T00:00:00").getTime(); }
function tsToDate(ts){
  const x = new Date(ts);
  return `${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
}
function getContinuousRange(){
  const ds = $("#fDateStart")?.value || "";
  if(!ds) return [];
  const on = !!$("#fIsMultiDay")?.checked;
  if(!on) return [ds];
  const de = $("#fDateEnd")?.value || ds;
  let s = dateToTS(ds), e = dateToTS(de);
  if(isNaN(s)||isNaN(e)) return [ds];
  if(e<s){ const t=s; s=e; e=t; }
  const out=[];
  for(let cur=s; cur<=e; cur+=86400000) out.push(tsToDate(cur));
  return out.length?out:[ds];
}
function getAllDates(){
  const ds = $("#fDateStart")?.value || "";
  if(!ds) return [];
  const set = new Set();
  set.add(ds);
  // 連續範圍（若勾選）
  if($("#fIsMultiDay")?.checked){
    getContinuousRange().forEach(d=>set.add(d));
  }
  // 不連續加的日期
  (state.extraDates||[]).forEach(d=>set.add(d));
  const out = Array.from(set).sort();
  return out;
}

/** ===== 初始化縣市區域（避免你遇到不能選的問題） ===== */
function fillSelect(sel, arr, placeholder){
  if(!sel) return;
  const p = placeholder ? `<option value="">${placeholder}</option>` : "";
  sel.innerHTML = p + arr.map(v=>`<option value="${v}">${v}</option>`).join("");
}
function initCityPair(citySel, areaSel, presetCity="", presetArea=""){
  const cities = Object.keys(CITY_AREAS_TW);
  fillSelect(citySel, cities, "請選擇");
  const setAreas = ()=>{
    const c = citySel.value || presetCity || "";
    const areas = CITY_AREAS_TW[c] || [];
    fillSelect(areaSel, areas, "請選擇");
    if(presetArea && areas.includes(presetArea)) areaSel.value = presetArea;
  };
  citySel.addEventListener("change", setAreas);
  if(presetCity && cities.includes(presetCity)) citySel.value = presetCity;
  setAreas();
}
function initCity(){
  initCityPair($("#fCity"), $("#fArea"), "台中市", "豐原區");
}

/** ===== Step1：不連續日期加入/移除 ===== */
function renderExtraDates(){
  const box = $("#extraDatesList");
  if(!box) return;
  box.innerHTML = (state.extraDates||[]).map(d=>`
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff">
      <div style="font-weight:1000">${d}</div>
      <button class="btn danger small" type="button" data-del="${d}">刪除</button>
    </div>
  `).join("") || `<div class="hint">尚未加入任何不連續日期。</div>`;
  box.querySelectorAll("button[data-del]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const d=b.dataset.del;
      state.extraDates = (state.extraDates||[]).filter(x=>x!==d);
      renderExtraDates();
      renderDayTimePlan();
    });
  });
}

/** ===== Step1：逐日時間/第二場規劃（你圖片那塊） ===== */
function ensureDayData(date){
  state.dayData[date] = state.dayData[date] || {
    session1:{start:"09:00", end:"12:00"},
    session2:{on:false, start:"15:00", end:"19:00"},
    cart:{}, // itemId->qty
    addr:{ city:$("#fCity")?.value||"", area:$("#fArea")?.value||"", addr:$("#fAddr")?.value||"", bldg:$("#fBldg")?.value||"" }
  };
}
function makeTimeSel(id, value, isHour){
  const hours = Array.from({length:24}, (_,i)=>pad2(i));
  const mins = ["00","10","20","30","40","50"];
  const arr = isHour ? hours : mins;
  return `<select id="${id}">${arr.map(v=>`<option value="${v}" ${v===value?"selected":""}>${v}</option>`).join("")}</select>`;
}
function toMin(hh,mm){ return (parseInt(hh,10)||0)*60 + (parseInt(mm,10)||0); }
function fromMin(m){
  m = Math.max(0, Math.min(24*60-10, m));
  const hh = pad2(Math.floor(m/60));
  const mm = pad2(m%60);
  return [hh,mm];
}
function renderDayTimePlan(){
  const box=$("#dayTimePlan");
  if(!box) return;

  // mirror
  $("#fDateStartMirror").value = $("#fDateStart")?.value || "";

  const days = getAllDates();
  state.days = days;
  $("#dateBadge").textContent = days.length ? `${days.length} 天` : "未設定";
  $("#daysBadge").textContent = days.length ? `${days.length} 天` : "0 天";

  if(!days.length){
    box.innerHTML = `<div class="hint">請先選擇第 1 天日期。</div>`;
    return;
  }

  // 建立每一天的資料
  days.forEach(d=>ensureDayData(d));

  box.innerHTML = days.map((d, idx)=>{
    const dd = state.dayData[d];
    const [s1h,s1m]=dd.session1.start.split(":");
    const [e1h,e1m]=dd.session1.end.split(":");
    const [s2h,s2m]=dd.session2.start.split(":");
    const [e2h,e2m]=dd.session2.end.split(":");
    return `
      <div class="dayCard" style="border-style:dashed">
        <div class="dayTop">
          <div class="dayTitle">
            <div class="big">第 ${idx+1} 天（${d}）</div>
            <div class="sub">第一場：${dd.session1.start}～${dd.session1.end}　｜　第二場：${dd.session2.on? "有":"無"}</div>
          </div>
          <span class="pill">${$("#fIsMultiDay")?.checked ? "連續模式" : "不連續模式"}</span>
        </div>
        <div class="dayBody">
          <div class="grid2" style="grid-template-columns:1fr auto 1fr;gap:10px;align-items:center">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              ${makeTimeSel(`d1_${d}_sh`, s1h, true)}
              ${makeTimeSel(`d1_${d}_sm`, s1m, false)}
            </div>
            <div class="pill">～</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              ${makeTimeSel(`d1_${d}_eh`, e1h, true)}
              ${makeTimeSel(`d1_${d}_em`, e1m, false)}
            </div>
          </div>

          <div style="margin-top:10px;border:1px dashed var(--line);border-radius:14px;padding:10px;background:#fff">
            <label style="margin:0 0 6px;display:flex;align-items:center;gap:10px;cursor:pointer">
              <input type="checkbox" id="d2_${d}_on" ${dd.session2.on?"checked":""} style="width:18px;height:18px" />
              此天需要第二場（每一場加價：B×30%）
            </label>

            <div id="d2_${d}_wrap" style="${dd.session2.on?"display:block":"display:none"}">
              <div class="grid2" style="grid-template-columns:1fr auto 1fr;gap:10px;align-items:center">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                  ${makeTimeSel(`d2_${d}_sh`, s2h, true)}
                  ${makeTimeSel(`d2_${d}_sm`, s2m, false)}
                </div>
                <div class="pill">～</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                  ${makeTimeSel(`d2_${d}_eh`, e2h, true)}
                  ${makeTimeSel(`d2_${d}_em`, e2m, false)}
                </div>
              </div>
              <div class="hint">第二場開始不得早於第一場結束（會自動修正）。</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join("");

  // 綁事件：第一場/第二場變更
  days.forEach(d=>{
    const dd = state.dayData[d];

    const sync1 = ()=>{
      const sh=$("#d1_"+d+"_sh").value, sm=$("#d1_"+d+"_sm").value;
      const eh=$("#d1_"+d+"_eh").value, em=$("#d1_"+d+"_em").value;
      dd.session1.start = `${sh}:${sm}`;
      dd.session1.end = `${eh}:${em}`;
      // 若第二場早於第一場結束 → 修正
      if(dd.session2.on){
        let s2 = toMin(...dd.session2.start.split(":"));
        const e1 = toMin(eh, em);
        if(s2 < e1){
          s2 = e1;
          const [hh,mm]=fromMin(s2);
          dd.session2.start = `${hh}:${mm}`;
          const sh2=$("#d2_"+d+"_sh"); const sm2=$("#d2_"+d+"_sm");
          if(sh2) sh2.value=hh;
          if(sm2) sm2.value=mm;
        }
      }
      renderDayTimePlan(); // 讓上方摘要更新
    };

    ["sh","sm","eh","em"].forEach(k=>{
      const el=$("#d1_"+d+"_"+k);
      if(el) el.addEventListener("change", sync1);
    });

    const onEl=$("#d2_"+d+"_on");
    if(onEl){
      onEl.addEventListener("change", ()=>{
        dd.session2.on = !!onEl.checked;
        const w=$("#d2_"+d+"_wrap");
        if(w) w.style.display = dd.session2.on ? "block":"none";
        renderDayTimePlan();
      });
    }

    const sync2 = ()=>{
      if(!dd.session2.on) return;
      let sh=$("#d2_"+d+"_sh").value, sm=$("#d2_"+d+"_sm").value;
      let eh=$("#d2_"+d+"_eh").value, em=$("#d2_"+d+"_em").value;

      const e1 = toMin(...dd.session1.end.split(":"));
      let s2 = toMin(sh,sm);
      let e2 = toMin(eh,em);
      const STEP=10;

      if(s2 < e1){
        s2 = e1;
        [sh,sm]=fromMin(s2);
        $("#d2_"+d+"_sh").value=sh;
        $("#d2_"+d+"_sm").value=sm;
      }
      if(e2 <= s2){
        e2 = s2 + STEP;
        [eh,em]=fromMin(e2);
        $("#d2_"+d+"_eh").value=eh;
        $("#d2_"+d+"_em").value=em;
      }
      dd.session2.start = `${sh}:${sm}`;
      dd.session2.end   = `${eh}:${em}`;
      renderDayTimePlan();
    };

    ["sh","sm","eh","em"].forEach(k=>{
      const el=$("#d2_"+d+"_"+k);
      if(el) el.addEventListener("change", sync2);
    });
  });
}

/** ===== Step2：日期卡片（你要求：第一天不要出現複製按鈕，複製要寫清楚來源日期） ===== */
function cartHasAny(cart){
  if(!cart) return false;
  const keys = Object.keys(cart).filter(k=>Number(cart[k]||0)>0);
  return keys.length>0;
}
function calcBaseSum(cart){
  let sum=0;
  for(const [id,qty] of Object.entries(cart||{})){
    const item = CATEGORIES.flatMap(c=>c.items).find(x=>x.id===id);
    if(!item) continue;
    sum += getUnitPrice(item, qty)*Number(qty||0);
  }
  return sum;
}
function calcDayTotal(date){
  const dd = state.dayData[date];
  const B = calcBaseSum(dd.cart);
  const s2 = dd.session2.on ? Math.round(B*0.30) : 0;
  return {B, s2, dayTotal: B+s2};
}
function sameCart(a,b){
  return JSON.stringify(a||{})===JSON.stringify(b||{});
}
function calcContinuousSurcharge(){
  if(!$("#fIsMultiDay")?.checked) return {ok:false, fee:0, reason:"未勾選連續"};
  const cont = getContinuousRange();
  const N = cont.length;
  if(N<=1) return {ok:true, fee:0, reason:"只有一天"};
  // 連續模式：所有天設備需相同
  const baseDate = cont[0];
  const baseCart = state.dayData[baseDate]?.cart || {};
  for(const d of cont){
    if(!sameCart(state.dayData[d]?.cart||{}, baseCart)){
      return {ok:false, fee:0, reason:"連續模式下設備不同→改用每日獨立計價"};
    }
  }
  const B = calcBaseSum(baseCart);
  let fee=0;
  if(N>=2) fee += Math.round(B*0.50);
  if(N>=3) fee += Math.round(B*0.30) * (N-2);
  return {ok:true, fee, reason:"OK"};
}
function renderDayCards(){
  const box=$("#dayCards");
  const days = state.days || [];
  $("#daysBadge").textContent = days.length ? `${days.length} 天` : "0 天";
  if(!box) return;

  if(!days.length){
    box.innerHTML = `<div class="hint">請先在 Step1 選日期，再按「更新清單」。</div>`;
    return;
  }

  const contInfo = calcContinuousSurcharge();

  box.innerHTML = days.map((d, idx)=>{
    const dd = state.dayData[d];
    const r = calcDayTotal(d);
    const done = cartHasAny(dd.cart);
    const statusClass = done ? "" : "todo";
    const statusText = done ? "已選設備" : "未完成";

    // 複製按鈕規則：Day1 不顯示
    const prevDate = idx>0 ? days[idx-1] : "";
    const day1Date = days[0];

    const canCopyPrev = idx>0 && cartHasAny(state.dayData[prevDate]?.cart);
    const canCopyDay1 = idx>0 && cartHasAny(state.dayData[day1Date]?.cart) && (day1Date!==prevDate);

    return `
      <div class="dayCard">
        <div class="dayTop">
          <div class="dayTitle">
            <div class="big">第 ${idx+1} 天｜第一場（${dd.session1.start}～${dd.session1.end}）</div>
            <div class="sub">日期：${d}　｜　第二場：${dd.session2.on ? (dd.session2.start+"～"+dd.session2.end) : "無"}</div>
          </div>
          <div class="dayMeta">
            <span class="status ${statusClass}">⏳ ${statusText}</span>
            <span class="pill">${fmt(r.dayTotal)}</span>
          </div>
        </div>
        <div class="dayBody">
          ${($("#fIsMultiDay")?.checked ? `<div class="pill">連續模式</div>` : `<div class="pill">不連續模式</div>`)}
          <div class="miniHint">
            第一場小計（B）：${fmt(r.B)}　｜　第二場加價：${fmt(r.s2)}
          </div>

          <div class="dayBtns">
            <button class="btn primary small" type="button" data-act="edit" data-date="${d}">進入設備選取</button>
            ${canCopyPrev ? `<button class="btn ghost small" type="button" data-act="copy" data-from="${prevDate}" data-to="${d}">複製上一天（${prevDate}）設備</button>` : ""}
            ${canCopyDay1 ? `<button class="btn ghost small" type="button" data-act="copy" data-from="${day1Date}" data-to="${d}">複製 ${day1Date} 的設備</button>` : ""}
          </div>

          ${(!contInfo.ok && $("#fIsMultiDay")?.checked) ? `<div class="dangerBox">⚠️ ${contInfo.reason}</div>` : ""}
        </div>
      </div>
    `;
  }).join("");

  box.querySelectorAll("button[data-act]").forEach(b=>{
    const act=b.dataset.act;
    if(act==="edit"){
      b.addEventListener("click", ()=>openDayEditor(b.dataset.date));
    }
    if(act==="copy"){
      b.addEventListener("click", ()=>{
        const from=b.dataset.from, to=b.dataset.to;
        if(!from||!to) return;
        state.dayData[to].cart = deepClone(state.dayData[from].cart || {});
        renderDayCards();
      });
    }
  });
}

/** ===== 設備選取（Day Editor） ===== */
function curDay(){ return state.dayData[state.currentDate]; }
function openDayEditor(date){
  state.currentDate = date;
  ensureDayData(date);

  // 右側本日資料（可單獨改）
  const dd = curDay();
  $("#dDate").value = date;
  $("#dTime1").value = `${dd.session1.start}～${dd.session1.end}`;
  $("#dS2Pill").textContent = dd.session2.on ? `第二場：${dd.session2.start}～${dd.session2.end}` : "第二場：無";
  $("#dayModePill").textContent = $("#fIsMultiDay")?.checked ? "連續模式" : "不連續模式";

  // 本日地址預設用基本資料；若本日有覆寫就用本日
  dd.addr = dd.addr || {city:"",area:"",addr:"",bldg:""};
  dd.addr.city = dd.addr.city || $("#fCity")?.value || "";
  dd.addr.area = dd.addr.area || $("#fArea")?.value || "";
  dd.addr.addr = dd.addr.addr || $("#fAddr")?.value || "";
  dd.addr.bldg = dd.addr.bldg || $("#fBldg")?.value || "";

  // init 本日 city/area（獨立）
  initCityPair($("#dCity"), $("#dArea"), dd.addr.city, dd.addr.area);
  $("#dAddr").value = dd.addr.addr;
  $("#dBldg").value = dd.addr.bldg;

  $("#dCity").addEventListener("change", ()=>{ dd.addr.city=$("#dCity").value; dd.addr.area=$("#dArea").value; });
  $("#dArea").addEventListener("change", ()=>{ dd.addr.area=$("#dArea").value; });
  $("#dAddr").addEventListener("input", ()=>{ dd.addr.addr=$("#dAddr").value; });
  $("#dBldg").addEventListener("input", ()=>{ dd.addr.bldg=$("#dBldg").value; });

  $("#editorTitle").textContent = `設備選取｜第 ${state.days.indexOf(date)+1} 天`;
  $("#editorSub").textContent = `日期：${date}　｜　第一場：${dd.session1.start}～${dd.session1.end}　｜　第二場：${dd.session2.on ? "有":"無"}`;

  $("#editorMask").style.display="flex";
  renderTabs();
  renderItems();
  renderDayCartSummary();
  updatePrevNextButtons();
}
function closeDayEditor(){
  $("#editorMask").style.display="none";
  renderDayCards();
}
function updatePrevNextButtons(){
  const idx = state.days.indexOf(state.currentDate);
  $("#btnPrevDay").disabled = idx<=0;
  $("#btnNextDay").disabled = idx>=state.days.length-1;
}

/** Tabs / Items */
function renderTabs(){
  const el=$("#tabs");
  if(!el) return;
  el.innerHTML = CATEGORIES.map(c=>`<button class="tab ${c.id===state.catId?"active":""}" data-cat="${c.id}">${c.name}</button>`).join("");
  el.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", ()=>{
      state.catId=b.dataset.cat;
      renderTabs(); renderItems();
    });
  });
}
function setQty(itemId, qty){
  const dd = curDay();
  dd.cart = dd.cart || {};
  if(qty<=0) delete dd.cart[itemId];
  else dd.cart[itemId]=qty;
  renderItems();
  renderDayCartSummary();
}
function renderItems(){
  const cat = CATEGORIES.find(c=>c.id===state.catId);
  const el=$("#items");
  if(!el) return;
  const dd = curDay();
  const cart = dd.cart || {};
  el.innerHTML = (cat?.items||[]).map(it=>{
    const qty = Number(cart[it.id]||0);
    const line = getUnitPrice(it, qty)*qty;
    return `
      <div class="item">
        <img class="thumb" src="${it.img}" onerror="this.onerror=null;this.src='${svgThumb(it.name)}'">
        <div>
          <div class="name">${it.name}</div>
          <div class="sub">${fmt(getUnitPrice(it, qty))} / ${it.unit}</div>
          <div class="qty" style="margin-top:10px">
            <button class="qbtn" data-act="dec" data-id="${it.id}">-</button>
            <div class="qval">${qty}</div>
            <button class="qbtn" data-act="inc" data-id="${it.id}">+</button>
          </div>
        </div>
        <div class="price">${fmt(line)}</div>
      </div>
    `;
  }).join("");

  el.querySelectorAll("button[data-act]").forEach(b=>{
    const act=b.dataset.act, id=b.dataset.id;
    if(act==="inc") b.addEventListener("click", ()=>setQty(id,(curDay().cart?.[id]||0)+1));
    if(act==="dec") b.addEventListener("click", ()=>setQty(id,Math.max(0,(curDay().cart?.[id]||0)-1)));
  });

  const picked = Object.keys(curDay().cart||{}).filter(k=>Number(curDay().cart[k]||0)>0).length;
  $("#pickedCount").textContent = `${picked} 項已選`;
}

/** 小計區：第一場小計(B) + 第二場加價 */
function renderDayCartSummary(){
  const dd = curDay();
  const B = calcBaseSum(dd.cart);
  const s2 = dd.session2.on ? Math.round(B*0.30) : 0;
  $("#sumB").textContent = fmt(B);
  $("#feeS2").textContent = fmt(s2);
  $("#dayTotal").textContent = fmt(B+s2);
  $("#rowS2Fee").style.display = dd.session2.on ? "flex" : "none";

  // 連續模式提示（若設備不一致）
  const contInfo = calcContinuousSurcharge();
  const hint=$("#contHint");
  if($("#fIsMultiDay")?.checked){
    hint.textContent = contInfo.ok
      ? "連續模式：若各天設備相同，跨天加價會在「輸出報價單」統一計算。"
      : "⚠️ 連續模式下設備不同：將改以每日獨立計價（不計跨天加價）。";
    hint.style.color = contInfo.ok ? "var(--muted)" : "#a01426";
    hint.style.fontWeight = contInfo.ok ? "800" : "1000";
  }else{
    hint.textContent = "不連續模式：每一天獨立計價。";
    hint.style.color="var(--muted)";
    hint.style.fontWeight="800";
  }
}

/** ===== Step3：輸出預覽（第一頁總覽 + 每日明細交給 PDF） ===== */
function calcAllTotals(){
  const days = state.days || [];
  let sumDays=0;
  const dayRows = days.map((d, idx)=>{
    const r = calcDayTotal(d);
    sumDays += r.dayTotal;
    return {idx:idx+1, date:d, ...r};
  });
  const cont = calcContinuousSurcharge();
  const contFee = cont.ok ? cont.fee : 0;
  const total = sumDays + contFee;
  return {dayRows, sumDays, contFee, total, contOk:cont.ok, contReason:cont.reason};
}
function renderQuotePreview(){
  const box=$("#quotePreview");
  if(!box) return;

  const {dayRows,sumDays,contFee,total,contOk,contReason} = calcAllTotals();
  $("#totalBadge").textContent = fmt(total);

  if(!dayRows.length){
    box.innerHTML = `<div class="hint">尚未建立日期清單。</div>`;
    return;
  }

  const contLine = ($("#fIsMultiDay")?.checked)
    ? (contOk ? `<div class="row"><div class="k">跨天加價（第2天：B×50%；第3天起：每一天 B×30%）</div><div class="v">${fmt(contFee)}</div></div>`
              : `<div class="dangerBox">⚠️ ${contReason}</div>`)
    : "";

  box.innerHTML = `
    <div class="noteBox">
      PDF 第 1 頁：會列出「每一天小計＋跨天加價＋總價」。<br>
      後續頁：每一天各自一頁（含：本日資料＋設備明細）。
    </div>

    <div class="card" style="box-shadow:none;margin-top:12px">
      <div class="cardHd"><div class="h">總覽（預覽）</div><div class="badge">${dayRows.length} 天</div></div>
      <div class="cardBd">
        ${dayRows.map(r=>`
          <div class="row">
            <div class="k">第${r.idx}天｜${r.date}（第一場B：${fmt(r.B)} / 第二場：${fmt(r.s2)}）</div>
            <div class="v">${fmt(r.dayTotal)}</div>
          </div>
        `).join("")}
        <div class="hr"></div>
        <div class="row"><div class="k">每日小計合計</div><div class="v">${fmt(sumDays)}</div></div>
        ${contLine}
        <div class="hr"></div>
        <div class="row"><div class="k" style="font-weight:1000">總價</div><div class="v" style="font-size:18px">${fmt(total)}</div></div>
      </div>
    </div>
  `;
}

/** ===== 送出到 Apps Script（含每一天資料/每一天設備） ===== */
function buildPayload(){
  const form = {
    name: $("#fName")?.value?.trim() || "",
    phone: $("#fPhone")?.value?.trim() || "",
    email: $("#fEmail")?.value?.trim() || "",
    city: $("#fCity")?.value || "",
    area: $("#fArea")?.value || "",
    addr: $("#fAddr")?.value?.trim() || "",
    bldg: $("#fBldg")?.value?.trim() || "",
    eventType: $("#fEventType")?.value || "",
    crowd: $("#fCrowd")?.value || "",
    indoor: $("#fIndoor")?.value || "",
    note: $("#fNote")?.value?.trim() || "",
    isMultiDay: $("#fIsMultiDay")?.checked ? "是" : "否",
    hasExtraDates: $("#fHasExtraDates")?.checked ? "是" : "否",
    dateStart: $("#fDateStart")?.value || "",
    dateEnd: ($("#fIsMultiDay")?.checked ? ($("#fDateEnd")?.value || $("#fDateStart")?.value || "") : ($("#fDateStart")?.value || "")),
    extraDates: deepClone(state.extraDates||[])
  };

  const {dayRows,sumDays,contFee,total,contOk,contReason} = calcAllTotals();

  const days = (state.days||[]).map((d, idx)=>{
    const dd = state.dayData[d];
    const r = calcDayTotal(d);
    // 將 cart 轉為 items 明細
    const items = [];
    for(const [id,qty] of Object.entries(dd.cart||{})){
      const it = CATEGORIES.flatMap(c=>c.items).find(x=>x.id===id);
      if(!it) continue;
      const up = getUnitPrice(it, qty);
      items.push({
        id, name: it.name, unit: it.unit, price: up, qty: Number(qty||0),
        lineTotal: up*Number(qty||0),
        categoryName: (CATEGORIES.find(c=>c.items.some(x=>x.id===id))?.name)||""
      });
    }
    return {
      dayIndex: idx+1,
      date: d,
      session1: deepClone(dd.session1),
      session2: deepClone(dd.session2),
      addr: deepClone(dd.addr||{}),
      subtotalB: r.B,
      session2Fee: r.s2,
      dayTotal: r.dayTotal,
      items
    };
  });

  return {
    action:"submitQuote",
    form,
    pricing: {
      mode: $("#fIsMultiDay")?.checked ? "連續" : "不連續",
      continuousOk: contOk,
      continuousReason: contReason || "",
      continuousFee: contOk ? contFee : 0
    },
    summary:{
      sumDays, contFee: contOk ? contFee : 0, total
    },
    days
  };
}
function submitQuoteToAppsScript(){
  if(!ORDER_API_URL || ORDER_API_URL.includes("PASTE_YOUR_WEB_APP_URL")){
    alert("請先在 index.html 把 ORDER_API_URL 換成你的 Apps Script Web App URL。");
    return;
  }
  const payload = buildPayload();
  try{
    const ok = navigator.sendBeacon(ORDER_API_URL, JSON.stringify(payload));
    if(ok){
      alert("已送出！系統會產生 PDF 報價單並寄到信箱。");
      return;
    }
  }catch(e){}
  // fallback
  fetch(ORDER_API_URL, {method:"POST", body:JSON.stringify(payload)})
    .then(r=>r.text())
    .then(()=>alert("已送出！系統會產生 PDF 報價單並寄到信箱。"))
    .catch(err=>alert("送出失敗："+(err?.message||err)));
}

/** ===== 綁定 ===== */
(function init(){
  // Step 按鈕
  $("#btnBackBasic").addEventListener("click", ()=>setStep(1));
  $("#btnBackToStep1").addEventListener("click", ()=>setStep(1));
  $("#btnBackToStep2").addEventListener("click", ()=>setStep(2));
  $("#btnToStep2").addEventListener("click", ()=>{
    renderDayTimePlan();
    setStep(2);
  });
  $("#btnToStep3").addEventListener("click", ()=>{ renderQuotePreview(); setStep(3); });
  $("#btnSendQuote").addEventListener("click", submitQuoteToAppsScript);

  // 連續/不連續 checkbox
  $("#fIsMultiDay").addEventListener("change", ()=>{
    $("#multiDayWrap").style.display = $("#fIsMultiDay").checked ? "block":"none";
    // 預設結束日 = 開始日
    const ds = $("#fDateStart").value || "";
    if(ds && !$("#fDateEnd").value) $("#fDateEnd").value = ds;
    renderDayTimePlan();
  });
  $("#fHasExtraDates").addEventListener("change", ()=>{
    $("#extraDatesWrap").style.display = $("#fHasExtraDates").checked ? "block":"none";
    renderExtraDates();
    renderDayTimePlan();
  });

  // 日期變更
  $("#fDateStart").addEventListener("change", ()=>{
    $("#fDateStartMirror").value = $("#fDateStart").value || "";
    const ds = $("#fDateStart").value || "";
    if(ds && $("#fIsMultiDay").checked && !$("#fDateEnd").value) $("#fDateEnd").value = ds;
    renderDayTimePlan();
  });
  $("#fDateEnd")?.addEventListener("change", renderDayTimePlan);

  // 不連續日期加入
  $("#btnAddExtraDate").addEventListener("click", ()=>{
    const d = $("#extraDateInput").value || "";
    if(!d) return;
    const ds = $("#fDateStart").value || "";
    if(d===ds){ alert("此日期已包含在第 1 天。"); return; }
    if(!(state.extraDates||[]).includes(d)) state.extraDates.push(d);
    state.extraDates.sort();
    $("#extraDateInput").value = "";
    renderExtraDates();
    renderDayTimePlan();
  });

  // Step1 更新清單
  $("#btnStep1Preview").addEventListener("click", ()=>{
    renderDayTimePlan();
    alert("已更新日期/場次清單。");
  });

  // editor
  $("#btnCloseEditor").addEventListener("click", closeDayEditor);
  $("#btnBackToDayList").addEventListener("click", closeDayEditor);
  $("#editorMask").addEventListener("click", (e)=>{ if(e.target===$("#editorMask")) closeDayEditor(); });

  $("#btnDoneDay").addEventListener("click", ()=>{
    closeDayEditor();
  });
  $("#btnPrevDay").addEventListener("click", ()=>{
    const idx = state.days.indexOf(state.currentDate);
    if(idx>0) openDayEditor(state.days[idx-1]);
  });
  $("#btnNextDay").addEventListener("click", ()=>{
    const idx = state.days.indexOf(state.currentDate);
    if(idx<state.days.length-1) openDayEditor(state.days[idx+1]);
  });

  // init city
  initCity();

  // 初始 UI
  $("#multiDayWrap").style.display = $("#fIsMultiDay").checked ? "block":"none";
  $("#extraDatesWrap").style.display = $("#fHasExtraDates").checked ? "block":"none";
  renderExtraDates();
  renderDayTimePlan();
})();
  /* ✅ Step3：自動把「安全/氣氛/升級」等級卡片補回到逐日選設備畫面
   - 不改你原本邏輯
   - 不需要改 Step3 HTML 模板
   - 看到 Step3 的 #tabs + #items + #cart 時，自動插入到 tabs 上方
*/
(function(){
  function ensureEl(id, tag){
    let el = document.getElementById(id);
    if(!el){
      el = document.createElement(tag || "div");
      el.id = id;
    }
    return el;
  }

  function buildRoot(){
    let root = document.getElementById("tierSectionRoot");
    if(!root){
      root = document.createElement("section");
      root.id = "tierSectionRoot";
      root.innerHTML = `
        <div class="tierTop">
          <div>
            <div class="tierTitle">套裝等級（可選）</div>
            <div class="tierHint">
              可先選「安全 / 氣氛 / 升級」其中一種等級加入本日報價；也可不選，直接往下加設備。
            </div>
          </div>
          <div class="tierPillsText" data-slot="tierPills"></div>
        </div>

        <div class="tierCols">
          <div class="tierCol">
            <div class="tierColHead"><span>safety｜安全等級</span><span class="pillMini" data-slot="pillSafety">未選</span></div>
            <div data-slot="levelsSafety"></div>
          </div>
          <div class="tierCol">
            <div class="tierColHead"><span>ambience｜氣氛等級</span><span class="pillMini" data-slot="pillAmbience">未選</span></div>
            <div data-slot="levelsAmbience"></div>
          </div>
          <div class="tierCol">
            <div class="tierColHead"><span>upgrade｜升級等級</span><span class="pillMini" data-slot="pillUpgrade">未選</span></div>
            <div data-slot="levelsUpgrade"></div>
          </div>
        </div>
      `;
    }

    // slots
    const slotPills = root.querySelector('[data-slot="tierPills"]');
    const slotPS = root.querySelector('[data-slot="pillSafety"]');
    const slotPA = root.querySelector('[data-slot="pillAmbience"]');
    const slotPU = root.querySelector('[data-slot="pillUpgrade"]');

    const slotLS = root.querySelector('[data-slot="levelsSafety"]');
    const slotLA = root.querySelector('[data-slot="levelsAmbience"]');
    const slotLU = root.querySelector('[data-slot="levelsUpgrade"]');

    // 如果你原本頁面已經有這些元素，這段會「搬移」到 Step3；避免產生重複 id
    const tierPills = ensureEl("tierPills", "div");
    const pillSafety = ensureEl("pillSafety", "span");
    const pillAmbience = ensureEl("pillAmbience", "span");
    const pillUpgrade = ensureEl("pillUpgrade", "span");

    const levelsSafety = ensureEl("levelsSafety", "div");
    const levelsAmbience = ensureEl("levelsAmbience", "div");
    const levelsUpgrade = ensureEl("levelsUpgrade", "div");

    // 清空 slot 再塞（避免重複）
    slotPills.innerHTML = "";
    slotPS.innerHTML = "";
    slotPA.innerHTML = "";
    slotPU.innerHTML = "";
    slotLS.innerHTML = "";
    slotLA.innerHTML = "";
    slotLU.innerHTML = "";

    slotPills.appendChild(tierPills);
    slotPS.appendChild(pillSafety);
    slotPA.appendChild(pillAmbience);
    slotPU.appendChild(pillUpgrade);

    slotLS.appendChild(levelsSafety);
    slotLA.appendChild(levelsAmbience);
    slotLU.appendChild(levelsUpgrade);

    return root;
  }

  function mountIntoStep3(){
    // Step3（逐日選設備）通常同時存在這三個區塊
    const tabs = document.getElementById("tabs");
    const items = document.getElementById("items");
    const cart  = document.getElementById("cart");
    if(!tabs || !items || !cart) return;

    const host = tabs.parentElement;
    if(!host) return;

    const root = buildRoot();

    // 插到 tabs 上方
    if(!host.contains(root)){
      host.insertBefore(root, tabs);
    }

    // 重新渲染等級 UI（使用你原本已存在的函式）
    try{ if(typeof renderTierPills === "function") renderTierPills(); }catch(e){}
    try{ if(typeof renderTierButtons === "function") renderTierButtons(); }catch(e){}
  }

  // 立刻跑一次 + 監看 DOM（打開 Step3 / 切換日期時都會觸發）
  mountIntoStep3();
  const obs = new MutationObserver(()=>mountIntoStep3());
  obs.observe(document.body, { childList:true, subtree:true });
})();
</script>
</body>
</html>
