<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>活動企劃｜設備選配與即時報價（場次導引）</title>

<style>
:root{
  --bg:#f7fbf9; --card:#fff; --text:#1f2937; --muted:#6b7280; --line:#e6efe9;
  --brand:#63bfae; --brand2:#2f8f7b; --danger:#e25a6a; --shadow:0 10px 28px rgba(0,0,0,.08);
  --radius:16px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
.wrap{max-width:1100px;margin:0 auto;padding:18px}
header{position:sticky;top:0;z-index:20;background:rgba(247,251,249,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
.head{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center;padding:14px 18px}
.title{grid-column:2;display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center}
.title h1{margin:0;font-size:18px}
.actions{grid-column:3;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

.btn{border:1px solid var(--line);background:var(--card);padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px}
.btn.primary{background:var(--brand);border-color:transparent;color:#fff}
.btn.primary:hover{background:var(--brand2)}
.btn.danger{background:var(--danger);border-color:transparent;color:#fff}
.btn.ghost{background:transparent}
.btn.warn{background:#facc15;border-color:#f59e0b;color:#111827;font-weight:900;}
.btn.warn:hover{filter:brightness(.97)}

.grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:14px;align-items:start}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
.card .hd h2{margin:0;font-size:16px}
.pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff;white-space:nowrap}
.note{color:var(--muted);font-size:12px;line-height:1.55}
.hint{font-size:12px;color:var(--muted);line-height:1.55}
.hint b{color:var(--text)}

.form{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{display:flex;flex-direction:column;gap:6px}
.field label{font-size:12px;color:var(--muted);font-weight:900}
.field input,.field select,.field textarea{border:1px solid var(--line);border-radius:12px;padding:11px 12px;background:#fff;outline:none;font-size:14px}
.field textarea{min-height:84px;resize:vertical}
.span2{grid-column:1/-1}

.timeRow{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
.timeRow .sep{color:var(--muted);font-weight:900;text-align:center}

.stepsWrap{width:100%;margin-top:4px}
.steps{display:flex;justify-content:space-between;position:relative;padding:0;margin:0}
.steps::before{content:"";position:absolute;top:15px;left:10%;right:10%;height:2px;background:var(--line);z-index:0}
.stepBox{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:6px;flex:1}
.stepNum{width:32px;height:32px;background:var(--card);border:2px solid var(--line);color:var(--muted);font-weight:900;border-radius:999px;display:grid;place-items:center;box-shadow:0 2px 6px rgba(0,0,0,.06)}
.stepText{font-size:13px;font-weight:900;color:var(--muted);text-align:center;line-height:1.25}
.stepBox.active .stepNum{border-color:var(--brand);color:var(--brand2)}
.stepBox.active .stepText{color:var(--text)}
.stepBox.done .stepNum{border-color:var(--brand2);background:rgba(99,191,174,.12);color:var(--brand2)}
.stepBox.done .stepText{color:var(--text)}

.view{display:none}
.view.show{display:block}

/* Step1：日期區塊（連續/不連續同時顯示） */
.block{padding:14px;display:grid;gap:12px}
.box{border:1px dashed var(--line);border-radius:14px;background:#fbfdfc;padding:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
.row > *{flex:1;min-width:220px}
.smallCap{font-size:11px;color:var(--muted);font-weight:900;margin-bottom:6px}

/* Step1：場次規劃列表（每個日期顯示第1場＋第二場開關） */
.planList{display:grid;gap:12px}
.planCard{border:1px solid var(--line);border-radius:14px;background:#fff;padding:12px;display:grid;gap:10px}
.planTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
.planTitle{font-weight:1000}
.tag{font-size:12px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;color:var(--muted);font-weight:900}
.planTimes{display:grid;gap:8px}
.s2Box{border:1px dashed var(--line);border-radius:12px;background:#fbfdfc;padding:10px;display:grid;gap:8px}
.switchRow{display:flex;gap:10px;align-items:center;font-weight:1000;color:var(--muted)}
.switchRow input{width:18px;height:18px}

/* Step2（設備頁）：分類/商品 */
.tabs{padding:12px 14px 14px;display:flex;gap:10px;flex-wrap:wrap;border-top:1px solid var(--line)}
.tab{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000;font-size:14px}
.tab.active{background:rgba(30,142,111,.12);border-color:rgba(30,142,111,.35);color:var(--brand2)}

.items{padding:14px;display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
.item{border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;grid-template-columns:74px 1fr auto;gap:12px;align-items:center}
.thumb{width:74px;height:74px;border-radius:14px;object-fit:cover;border:1px solid var(--line);background:#f3f4f6}
.meta{min-width:0}
.meta .name{font-weight:1000}
.meta .sub{color:var(--muted);font-size:12px;margin-top:2px}
.meta .row2{margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.price{font-weight:1000;text-align:right}
.qty{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 8px;background:#fff}
.qbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000}
.qval{min-width:44px;text-align:center;font-weight:1000}
.linkbtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:1000;font-size:12px}

/* 三模組 */
.tierWrap{padding:14px;display:grid;gap:12px}
.tierGrid{display:grid;grid-template-columns:1fr;gap:12px}
.tierCard{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
.tierHead{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
.tierHead b{font-size:14px}
.tierBody{padding:12px;display:grid;gap:10px}
.levelRow{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px}
.levelBtn{padding:12px;border-radius:14px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000;text-align:left;display:flex;flex-direction:column;gap:10px}
.levelTopRow{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.levelName{font-size:13px;line-height:1.25;word-break:break-word}
.levelPrice{font-size:12px;font-weight:1000;white-space:nowrap}
.levelActions{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap}
.miniBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:7px 10px;cursor:pointer;font-weight:1000;font-size:12px}
.miniBtn.primaryMini{background:var(--brand);border-color:transparent;color:#fff}
.levelMedia{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#f3f4f6}
.levelMedia img{width:100%;height:120px;object-fit:cover;display:block}

/* 場次頁：本場資料可收合 */
.fold{border-top:1px solid var(--line)}
.foldBtn{width:100%;text-align:left;border:none;background:#fff;padding:12px 14px;font-weight:1000;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.foldBody{display:none}
.fold.open .foldBody{display:block}

/* 場次頁：本場即時報價 + 底部操作列 */
.summary{padding:14px;display:grid;gap:12px}
.totals{border:1px dashed var(--line);border-radius:14px;padding:12px;display:grid;gap:8px;background:linear-gradient(180deg, rgba(30,142,111,.06), transparent)}
.trow{display:flex;justify-content:space-between;align-items:center;gap:10px}
.cart{display:grid;gap:12px}
.group{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
.group .gh{padding:10px 12px;background:#fafafa;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;font-weight:1000}
.group .gb{padding:12px;display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
.citem{position:relative;border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;display:block;padding-right:52px}
.citem img{display:none!important}
.cmeta .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.cmeta .nm{font-weight:1000;line-height:1.2}
.cline{margin-top:6px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.xbtn{position:absolute;top:50%;transform:translateY(-50%);right:10px;width:36px;height:36px;border-radius:12px;border:1px solid rgba(226,74,74,.35);background:rgba(226,74,74,.10);color:var(--danger);font-weight:1000;cursor:pointer}

.stickyBar{
  position:sticky; bottom:0; z-index:15;
  background:rgba(247,251,249,.96); backdrop-filter:saturate(180%) blur(10px);
  border-top:1px solid var(--line);
  padding:10px 12px;
  display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center;
}
.stickyLeft{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.stickyRight{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

/* Modal */
.modalMask{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
.modal{width:min(560px,100%);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 18px 48px rgba(0,0,0,.22);overflow:hidden}
.modal .mh{padding:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;border-bottom:1px solid var(--line)}
.modal .mb{padding:14px 14px 20px;}
.modal .mb p{margin:0;color:#374151;line-height:1.65}
.photoGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.photoBox{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;background:#fff}
.photoBox img{width:100%;height:140px;object-fit:cover;display:block}
.photoCap{padding:8px 10px;font-size:12px;color:#6b7280}
.packList{margin:8px 0 0;padding-left:18px;line-height:1.65}
.packList li{margin:4px 0}
.modalDesc{margin-top:8px;color:var(--muted);line-height:1.7}

/* Print */
#printRoot{display:none}
body.printing #printRoot{display:block}
@media print{
  body.printing *{visibility:hidden !important}
  body.printing #printRoot, body.printing #printRoot *{visibility:visible !important}
  body.printing #printRoot{position:absolute; inset:0; padding:16mm 12mm; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif; color:#111827;}
  .printHdr{margin-bottom:10mm}
  .printBrand{font-size:18px;font-weight:900;margin:0}
  .printTitle{font-size:15px;font-weight:800;margin:6px 0 0 0}
  .printMeta{font-size:11px;color:#6b7280;margin-top:6px}
  .printH3{font-size:13px;font-weight:900;margin:10mm 0 4mm 0}
  .printTbl{width:100%;border-collapse:collapse;font-size:11px}
  .printTbl th,.printTbl td{border:1px solid #e5e7eb;padding:6px 7px;vertical-align:top}
  .printTbl th{background:#f9fafb;text-align:left}
  .right{text-align:right}
  .muted{color:#6b7280}
  .totalsBox{margin-top:8mm;display:flex;justify-content:flex-end}
  .totalsPrint{min-width:260px;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px}
  .trowPrint{display:flex;justify-content:space-between;gap:12px;margin:6px 0}
  .trowPrint.total{border-top:1px solid #e5e7eb;padding-top:8px;margin-top:8px;font-size:12px;font-weight:900}
  .pageBreak{break-after:page}
  @page{size:auto;margin:10mm}
}

/* Mobile */
@media (max-width:920px){
  .levelRow{grid-template-columns:repeat(2, 1fr)}
}
@media (max-width:620px){
  .wrap{padding:8px}
  .form{grid-template-columns:1fr}
  .field input,.field select,.field textarea{font-size:16px;padding:10px 12px}
  .items{grid-template-columns:repeat(2,1fr);gap:6px;padding:10px}
  .item{display:flex;flex-direction:column;align-items:stretch}
  .thumb{width:100%;height:90px;border-radius:10px}
  .price{text-align:left;border-top:1px dashed var(--line);padding-top:6px}
  .steps::before{top:13px;left:8%;right:8%}
  .stepNum{width:28px;height:28px;font-size:12px;border-width:1.5px}
  .stepText{font-size:11px}
  .stickyBar{gap:8px}
}
</style>
</head>

<body>
<header>
  <div class="head">
    <div class="title">
      <h1>活動企劃｜設備選配與即時報價（場次導引）</h1>
      <div class="stepsWrap">
        <div class="steps" id="stepsBar">
          <div class="stepBox" data-step="1">
            <div class="stepNum">1</div>
            <div class="stepText">基本資料<br>＋場次規劃</div>
          </div>
          <div class="stepBox" data-step="2">
            <div class="stepNum">2</div>
            <div class="stepText">選設備<br>（可複製）</div>
          </div>
          <div class="stepBox" data-step="3">
            <div class="stepNum">3</div>
            <div class="stepText">輸出報價單<br>（PDF）</div>
          </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn" id="btnBackBasicTop">回到基本資料</button>
      <button class="btn warn" id="btnPrintTop" style="display:none">列印 PDF</button>
    </div>
  </div>
</header>

<div class="wrap">
  <noscript>
    <div style="margin:12px 0;padding:12px;border:1px solid #f59e0b;background:#fffbeb;border-radius:12px;font-weight:900;color:#92400e">
      ⚠️ 你的瀏覽器目前停用了 JavaScript，本頁無法運作。請改用可執行 JS 的瀏覽器。
    </div>
  </noscript>

  <div class="grid">

    <!-- ================= VIEW 1：基本資料＋場次規劃 ================= -->
    <section class="card view show" id="viewBasic">
      <div class="hd">
        <h2>1) 基本資料</h2>
        <span class="pill" id="basicStatus">尚未建立</span>
      </div>

      <div class="form" id="basicForm">
        <div class="field">
          <label>姓名 / 單位</label>
          <input id="fName" placeholder="例：柚子樂器 / 王小明">
        </div>
        <div class="field">
          <label>行動電話</label>
          <input id="fPhone" type="tel" inputmode="tel" placeholder="例：09xx-xxx-xxx">
        </div>
        <div class="field">
          <label>Email</label>
          <input id="fEmail" type="email" placeholder="例：you@example.com">
        </div>

        <div class="field span2">
          <label>活動地點（縣市/區）</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <select id="fCity"></select>
            <select id="fArea"></select>
          </div>
        </div>

        <div class="field span2">
          <label>詳細地址（路名/號）</label>
          <input id="fAddr" placeholder="例：中山路 100 號">
        </div>

        <div class="field span2">
          <label>大樓/棟別/樓層/入口（讓地址更清楚）</label>
          <input id="fBldg" placeholder="例：XX大樓 A棟 3F（從側門進）">
        </div>

        <div class="field">
          <label>活動類型</label>
          <select id="fEventType">
            <option value="">請選擇活動類型</option>
            <option>開幕典禮／剪綵儀式</option>
            <option>記者會／產品發表會</option>
            <option>品牌活動／快閃活動（商場/戶外）</option>
            <option>展覽開幕／展場活動（含舞台時段）</option>
            <option>校慶活動（運動會/園遊會/舞台）</option>
            <option>畢業典禮</option>
            <option>成果發表會（學校/才藝/社團）</option>
            <option>社團成發／迎新送舊晚會</option>
            <option>演講／講座／論壇</option>
            <option>研討會／學術會議（含分場）</option>
            <option>公司內訓／教育訓練／大會</option>
            <option>尾牙／春酒</option>
            <option>公司家庭日／園遊會</option>
            <option>餐會／晚宴（含抽獎、致詞、表演）</option>
            <option>商務交流會／同業公會活動</option>
            <option>演唱會／Live Band 表演</option>
            <option>DJ 派對／電音活動</option>
            <option>舞蹈表演／舞蹈比賽</option>
            <option>戲劇／舞台劇／音樂劇</option>
            <option>親子活動／兒童舞台秀</option>
            <option>慶生會／派對（含包場）</option>
            <option>婚禮（證婚/宴客/After party）</option>
            <option>告別式／追思會（殯儀館/會館/戶外追思）</option>
            <option>宗教活動（廟會/法會/禮拜/慶典）</option>
            <option>社區活動／里民大會／宣導活動（戶外廣播）</option>
          </select>
        </div>

        <div class="field">
          <label>預估人數</label>
          <select id="fCrowd">
            <option value="">請選擇</option>
            <option value="100">100人以內</option>
            <option value="400">100到400人</option>
            <option value="1000">400至1000人</option>
            <option value="2000">1000人至2000人</option>
            <option value="9999">2000人至以上</option>
          </select>
        </div>

        <div class="field">
          <label>室內 / 戶外</label>
          <select id="fIndoor">
            <option value="">請選擇</option>
            <option>室內</option>
            <option>戶外</option>
            <option>半戶外</option>
          </select>
        </div>

        <div class="field span2">
          <label>備註 / 需求</label>
          <textarea id="fNote" placeholder="例：室內婚禮120人，需四支無線麥，場地有220V插座，需含進退場..."></textarea>
        </div>
      </div>

      <div class="hd">
        <h2>日期/場次規劃（先規劃每一天第1場＋可選第2場）</h2>
        <span class="pill">完成後直接進入「選設備」</span>
      </div>

      <div class="block">
        <!-- 連續多日：永遠顯示 -->
        <div class="box">
          <div class="planTop">
            <div class="planTitle">連續多日（可選結束日）</div>
            <span class="tag">第2天 B×50%｜第3天起 B×30%</span>
          </div>

          <div class="row">
            <div>
              <div class="smallCap">開始日期（第1天）</div>
              <input id="cStart" type="date">
            </div>
            <div>
              <div class="smallCap">結束日期（選填）</div>
              <input id="cEnd" type="date">
            </div>
          </div>

          <div class="hint">
            注意：連續多日模式要套用加價規則，原則上各天設備需一致；若設備不同，系統會視為「每日獨立計價」。
          </div>
        </div>

        <!-- 不連續日期：永遠顯示 -->
        <div class="box">
          <div class="planTop">
            <div class="planTitle">新增不連續日期（可加多天；每日重新計算）</div>
            <span class="tag">每一天重新計價</span>
          </div>

          <div class="row">
            <div>
              <div class="smallCap">新增日期</div>
              <input id="ncAdd" type="date">
            </div>
            <div style="flex:0 0 auto;min-width:auto">
              <button class="btn" id="btnNcAdd" type="button">＋加入</button>
            </div>
          </div>

          <div class="note">已加入的不連續日期：</div>
          <div id="ncList" style="display:grid;gap:8px"></div>
        </div>

        <!-- 手機好讀：橫向分行提示（你說的紅字擠一團問題） -->
        <div class="box" style="background:#fff">
          <div class="planTop">
            <div class="planTitle">場次規劃提示</div>
            <span class="tag">先規劃時間，再選設備</span>
          </div>
          <div class="note" style="display:grid;gap:6px">
            <div>• 先把每一天「第1場時間」規劃好。</div>
            <div>• 若同一天需要第2場，勾選後再設定第2場時間（每一場加價：B×30%）。</div>
            <div>• 完成規劃後，按下「開始選設備」，系統會直接帶你進入第1場設備選取。</div>
          </div>
        </div>

        <div class="box">
          <div class="planTop">
            <div class="planTitle">逐日時間/第二場規劃</div>
            <span class="tag">每一天先規劃場次</span>
          </div>
          <div id="planner" class="planList"></div>

          <div style="display:flex;justify-content:flex-end;gap:10px;flex-wrap:wrap">
            <button class="btn primary" id="btnStartEquip" type="button">開始選設備</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ================= VIEW 2：選設備（場次） ================= -->
    <section class="card view" id="viewEquip">
      <div class="hd">
        <h2 id="equipTitle">2) 設備選取</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn" id="btnJump">快速跳轉</button>
          <button class="btn" id="btnGoQuote">輸出報價單</button>
        </div>
      </div>

      <!-- 本場資料可收合（你說的：不要佔主線、但要能改） -->
      <div class="fold" id="foldForm">
        <button class="foldBtn" type="button" id="btnFold">
          <span>編輯本場資料（選填）</span>
          <span class="pill" id="foldHint">可展開修改</span>
        </button>
        <div class="foldBody">
          <div class="form" id="sForm">
            <div class="field">
              <label>場次</label>
              <input id="sLabel" disabled>
            </div>
            <div class="field">
              <label>日期</label>
              <input id="sDate" type="date" disabled>
            </div>

            <div class="field">
              <label>姓名 / 單位</label>
              <input id="sName">
            </div>
            <div class="field">
              <label>行動電話</label>
              <input id="sPhone" type="tel" inputmode="tel">
            </div>
            <div class="field">
              <label>Email</label>
              <input id="sEmail" type="email">
            </div>

            <div class="field span2">
              <label>活動地點（縣市/區）</label>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <select id="sCity"></select>
                <select id="sArea"></select>
              </div>
            </div>

            <div class="field span2">
              <label>詳細地址（路名/號）</label>
              <input id="sAddr">
            </div>

            <div class="field span2">
              <label>大樓/棟別/樓層/入口</label>
              <input id="sBldg">
            </div>

            <div class="field">
              <label>活動類型</label>
              <select id="sEventType"></select>
            </div>

            <div class="field">
              <label>預估人數</label>
              <select id="sCrowd"></select>
            </div>

            <div class="field">
              <label>室內 / 戶外</label>
              <select id="sIndoor"></select>
            </div>

            <div class="field span2">
              <label>備註 / 需求（本場）</label>
              <textarea id="sNote" placeholder="本場特別需求（若每場不同可填）"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- 複製（依你規則：第一場不顯示） -->
      <div class="block" id="copyBar" style="padding:14px;display:none">
        <div class="box" style="background:#fff">
          <div class="planTop">
            <div class="planTitle">快速複製設備</div>
            <span class="tag" id="copyHint">來源會顯示日期/場次</span>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" id="btnCopyPrev" type="button">複製上一場設備</button>
            <button class="btn" id="btnCopyPick" type="button">選擇要複製的場次</button>
          </div>
        </div>
      </div>

      <!-- 三模組 -->
      <div class="hd">
        <h2>燈光音響三模組（安全 / 氣氛 / 升級）</h2>
        <span class="pill" id="tierPills">安全—｜氣氛—｜升級—</span>
      </div>

      <div class="tierWrap">
        <div class="tierGrid">
          <div class="tierCard">
            <div class="tierHead">
              <b>安全等級 <span style="font-size:12px;color:var(--muted);font-weight:normal;">（不包含燈光）</span></b>
              <span class="pill" id="pillSafety">未選</span>
            </div>
            <div class="tierBody">
              <div class="levelRow" id="levelsSafety"></div>
              <div class="hint">建議：一般活動多數選 <b>第3級</b>；戶外建議至少 <b>第3級</b>。</div>
            </div>
          </div>

          <div class="tierCard">
            <div class="tierHead">
              <b>氣氛等級 <span style="font-size:12px;color:var(--muted);font-weight:normal;">（含燈光+簡易特效）</span></b>
              <span class="pill" id="pillAmbience">未選</span>
            </div>
            <div class="tierBody">
              <div class="levelRow" id="levelsAmbience"></div>
              <div class="hint">想要「看起來不寒酸」：至少選到 <b>第2級</b>；有表演感：選到 <b>第4級</b>。</div>
            </div>
          </div>

          <div class="tierCard">
            <div class="tierHead">
              <b>升級等級 <span style="font-size:12px;color:var(--muted);font-weight:normal;">（含進階燈光+高級特效）</span></b>
              <span class="pill" id="pillUpgrade">未選</span>
            </div>
            <div class="tierBody">
              <div class="levelRow" id="levelsUpgrade"></div>
              <div class="hint">升級是高滿意度來源：先看內容與價格再選等級，之後再微調。</div>
            </div>
          </div>
        </div>

        <div class="hint">
          提示：如果是「連續多日」要套用 Day2/Day3+ 加價，原則上各天設備要一致；你可以用複製快速讓設備一致。
        </div>
      </div>

      <div class="hd">
        <h2>設備/服務分類（自由加減）</h2>
        <span class="pill" id="catName">—</span>
      </div>

      <div class="tabs" id="tabs"></div>
      <div class="items" id="items"></div>

      <div class="hd">
        <h2>本場即時報價</h2>
        <span class="pill" id="sessionTotalPill">NT$0</span>
      </div>

      <div class="summary">
        <div class="totals">
          <div class="trow"><span class="note">本場設備小計（B）</span><b id="sessionSubtotal">NT$0</b></div>
          <div class="trow" id="sessionS2Row" style="display:none"><span class="note">第二場加價（B×30%）</span><b id="sessionS2Fee">NT$0</b></div>
          <div class="trow"><span class="note">本場合計</span><b id="sessionTotal">NT$0</b></div>
        </div>
        <div class="cart" id="cart"></div>
      </div>

      <!-- 底部操作列（你要求：不用滑回上面） -->
      <div class="stickyBar">
        <div class="stickyLeft">
          <span class="pill" id="stickyNow">—</span>
        </div>
        <div class="stickyRight">
          <button class="btn" id="btnBackBasic">回到基本資料</button>
          <button class="btn primary" id="btnDoneThis">完成本場</button>
          <button class="btn primary" id="btnNextSession">前往下一場</button>
        </div>
      </div>
    </section>

    <!-- ================= VIEW 3：輸出報價單（PDF） ================= -->
    <section class="card view" id="viewQuote">
      <div class="hd">
        <h2>3) 輸出報價單（PDF）</h2>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn warn" id="btnPrint">列印成 PDF</button>
          <button class="btn primary" id="btnSend">送出報價單</button>
        </div>
      </div>

      <div class="block">
        <div class="note" id="quoteNote"></div>
        <div class="box" style="background:#fff">
          <div class="planTop">
            <div class="planTitle">總覽（每一場小計 + 總價）</div>
            <span class="tag" id="grandTotalPill">NT$0</span>
          </div>
          <div id="quoteTable"></div>
        </div>

        <div class="note">
          PDF 規則：第 1 頁會顯示「每一場的小計＋總價」，後面每一頁會顯示「該場完整明細（含客人資料）」。
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn" id="btnBackEquip">回到選設備</button>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- Modal -->
<div class="modalMask" id="modalMask">
  <div class="modal">
    <div class="mh">
      <b id="mTitle">詳情</b>
      <button class="btn danger" id="mClose" style="padding:8px 10px">關閉</button>
    </div>
    <div class="mb"><p id="mBody">—</p></div>
  </div>
</div>

<div class="modalMask" id="jumpMask">
  <div class="modal">
    <div class="mh">
      <b>快速跳轉（選擇要編輯的場次）</b>
      <button class="btn danger" id="jumpClose" style="padding:8px 10px">關閉</button>
    </div>
    <div class="mb">
      <div id="jumpList" style="display:grid;gap:10px"></div>
    </div>
  </div>
</div>

<div class="modalMask" id="pickCopyMask">
  <div class="modal">
    <div class="mh">
      <b>選擇要複製的場次</b>
      <button class="btn danger" id="pickCopyClose" style="padding:8px 10px">關閉</button>
    </div>
    <div class="mb">
      <div id="pickCopyList" style="display:grid;gap:10px"></div>
    </div>
  </div>
</div>

<div id="printRoot"></div>

<script>
/* =========================
   場次導引版
   - Step1：基本資料 +（連續區 + 不連續區 同時顯示）+ 規劃每一天第1場/第2場時間
   - Step2：直接選設備（以場次為主）
   - Step3：輸出 PDF（第1頁總覽 + 後面每頁每場明細）
   ========================= */

const BRAND_NAME = "柚子樂器";
const PRINT_TITLE = "活動企劃｜設備與器材報價單（場次版）";

// 你原本的 Apps Script URL（先沿用；後面我會說 GAS 要不要改）
const ORDER_API_URL = "https://script.google.com/macros/s/AKfycbxrphr7gIrOVrrhp1lplR7IYrZdc_8E8cajBEitSoUiujGRE7v8FDy0BYL8VLHaexvq/exec";

const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
const escapeHtml = (v)=>String(v??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
const fmt = (n)=>"NT$"+Number(n||0).toLocaleString("zh-Hant-TW");
function pad2(n){ return String(n).padStart(2,"0"); }
function deepClone(obj){ return JSON.parse(JSON.stringify(obj||{})); }

function setStep(n){
  $$("#stepsBar .stepBox").forEach(b=>{
    const s = Number(b.dataset.step||0);
    b.classList.toggle("active", s===n);
    b.classList.toggle("done", s<n);
  });
  $("#btnPrintTop").style.display = (n>=3) ? "" : "none";
}
function showView(id){
  $$(".view").forEach(v=>v.classList.remove("show"));
  const el=$("#"+id); if(el) el.classList.add("show");
}
function normalizeDateStr(d){ return d ? String(d).slice(0,10) : ""; }
function compareDate(a,b){ return (a||"").localeCompare(b||""); }
function toMin(hh,mm){ return (parseInt(hh,10)||0)*60 + (parseInt(mm,10)||0); }
function fromMin(m){
  m = Math.max(0, Math.min(24*60-10, m));
  return [pad2(Math.floor(m/60)), pad2(m%60)];
}

/* SVG thumb (保留你原本) */
function svgThumb(label){
  const safe = (label||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200">
 <defs>
   <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
     <stop offset="0" stop-color="#e8f5f0"/>
     <stop offset="1" stop-color="#f6f7fb"/>
   </linearGradient>
 </defs>
 <rect width="200" height="200" rx="22" fill="url(#g)"/>
 <circle cx="160" cy="40" r="26" fill="#1e8e6f" opacity="0.18"/>
 <circle cx="40" cy="160" r="36" fill="#156e56" opacity="0.12"/>
 <text x="18" y="102" font-size="16" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial" fill="#156e56" font-weight="700">${safe}</text>
</svg>`;
  return "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(svg);
}

/* =========================
   state（以「場次 session」為核心）
   sessions: [{ id, date, slot(1/2), label, timeStart, timeEnd, form, tiers, cart, itemOpts, catId, done }]
   ========================= */
const state = {
  step: 1,
  globalForm: {},
  // 日期來源：
  cont: { start:"", end:"" }, // 連續
  nonDates: [],               // 不連續日期
  // 日期→規劃（第1場/第2場）/* =========================
   Part2：資料區
   ========================= */

const TW = {
  "台北市":["中正區","大同區","中山區","松山區","大安區","萬華區","信義區","士林區","北投區","內湖區","南港區","文山區"],
  "新北市":["板橋區","新莊區","中和區","永和區","三重區","土城區","新店區","汐止區","淡水區","林口區"],
  "桃園市":["桃園區","中壢區","平鎮區","八德區","龜山區","蘆竹區"],
  "台中市":["西屯區","北屯區","南屯區","中區","東區","西區","南區","北區","豐原區"],
  "台南市":["中西區","東區","南區","北區","永康區","安平區"],
  "高雄市":["三民區","左營區","鼓山區","苓雅區","前鎮區","鳳山區"]
};

const CATEGORIES = [
{ id:"stage", name:"舞台結構與桁架系統", items:[
{ id:"stage-deck", name:"舞台板（2x1m）", unit:"片", price:1200,
priceTiers:[{min:1,price:1200},{min:20,price:1100},{min:50,price:1000}],
options:{
carpet:{label:"是否要鋪地毯", values:["請選擇","要","不要"], omitValues:["不要"]},
carpet_color:{label:"地毯顏色", values:["請選擇","黑","灰","紅","藍","綠","米白"], when:{opt:"carpet", is:"要"}},
color:{label:"舞台板顏色", values:["請選擇","黑","灰","紅","藍"]},
height:{label:"舞台高度", values:["請選擇","20cm","40cm","60cm","80cm","100cm"]}
},
img:svgThumb("舞台板"),
desc:"舞台板（2x1m）。可依尺寸、階梯、圍裙等調整。\n\n數量優惠（可修改）：1–19片 1200/片；20–49片 1100/片；50片以上 1000/片。\n可選細項：顏色/高度（會在右側報價單顯示）。"
},
{ id:"stage-step", name:"舞台階梯（含扶手）", unit:"座", price:900, img:svgThumb("階梯"), desc:"舞台上下台階梯，適合典禮/表演。" },
{ id:"stage-truss", name:"TRUSS 桁架（3m）", unit:"支", price:1800, img:svgThumb("TRUSS"), desc:"基本桁架結構，用於燈具/背板/布幕。" },
{ id:"stage-backdrop", name:"主視覺背板（基本）", unit:"組", price:6500, img:svgThumb("背板"), desc:"基本背板（含架設）。主視覺輸出另計或可包套。" },
{ id:"stage-drape", name:"舞台布幕/遮擋（基本）", unit:"組", price:4800, img:svgThumb("布幕"), desc:"舞台側布/後布/遮擋，提升整體質感。" },
]},
{ id:"light", name:"燈光與氣氛效果", items:[
{ id:"light-par", name:"LED PAR（染色燈）", unit:"盞", price:900, img:svgThumb("染色燈"), desc:"典禮/氛圍底色必備。可搭配燈控/場景變換。" },
{ id:"light-moving", name:"Moving Head（光束燈）", unit:"盞", price:2500, img:svgThumb("光束燈"), desc:"動態光束效果，適合表演/高潮段落。" },
{ id:"light-follow", name:"追光燈（含操作）", unit:"組", price:6000, img:svgThumb("追光"), desc:"追光燈含操作人員，適合走位/得獎/表演主角。" },
{ id:"light-console", name:"燈控台（基本）", unit:"套", price:3500, img:svgThumb("燈控"), desc:"燈光場景切換/節奏控制。演出感提升。" },
{ id:"fx-haze", name:"薄霧機（Hazer）", unit:"台", price:2200, img:svgThumb("薄霧"), desc:"讓光束更立體。小心場地方規定/消防。" },
]},
{ id:"audio", name:"音響與舞台收音", items:[
{ id:"audio-main", name:"主喇叭（全頻）", unit:"組", price:6000, img:svgThumb("主喇叭"), desc:"主擴聲系統（示意）。可依品牌/功率/場域調整。" },
{ id:"audio-sub", name:"低音喇叭（Sub）", unit:"顆", price:4500, img:svgThumb("Sub"), desc:"增加低頻能量，適合戶外/音樂活動。" },
{ id:"audio-mixer", name:"混音器（基本）", unit:"台", price:3000, img:svgThumb("混音"), desc:"基本混音控制。多路數需求可升級。" },
{ id:"audio-wireless2", name:"無線麥克風（2支組）", unit:"組", price:2200, img:svgThumb("無線麥"), desc:"常見典禮/講座用。可加到 4/6/8 支。" },
{ id:"audio-monitor", name:"舞台監聽喇叭", unit:"顆", price:1800, img:svgThumb("監聽"), desc:"給主持/表演者聽到自己的聲音。" },
{ id:"audio-di", name:"DI Box（主動式）", unit:"顆", price:400, img:svgThumb("DI"), desc:"鍵盤/木吉他/電貝斯等訊號轉換。" },
{ id:"audio-drumkit", name:"鼓組收音套裝（基本）", unit:"組", price:6500, img:svgThumb("鼓組"), desc:"適合 Live Band / 表演。細項可拆分。" },
]},
{ id:"video", name:"影像、投影與直播導播", items:[
{ id:"video-projector", name:"投影機（基本）", unit:"台", price:6500, img:svgThumb("投影"), desc:"會議/典禮簡報。亮度/鏡頭依場地調整。" },
{ id:"video-screen", name:"投影布幕（120吋）", unit:"面", price:1800, img:svgThumb("布幕"), desc:"投影布幕（示意）。也可用電動布幕。" },
{ id:"video-tv", name:"電視（75吋）", unit:"台", price:4800, img:svgThumb("75吋TV"), desc:"展場/小型場地更方便。" },
{ id:"video-camera", name:"活動攝影機（基本）", unit:"台", price:5000, img:svgThumb("攝影"), desc:"活動錄影/直播機位（示意）。" },
{ id:"video-switcher", name:"直播導播/切換台（基本）", unit:"套", price:9000, img:svgThumb("導播"), desc:"多機位切換/字幕/畫面輸出（示意）。" },
]},
{ id:"site", name:"帳篷桌子椅子", items:[
{ id:"site-tent", name:"快帳（3x3m）", unit:"頂", price:1800, img:svgThumb("快帳"), desc:"戶外遮陽遮雨。可加配重/側布。" },
{ id:"site-chair", name:"折疊椅", unit:"張", price:30, img:svgThumb("椅子"), desc:"觀眾座位（示意）。" },
{ id:"site-table", name:"折疊桌", unit:"張", price:150, img:svgThumb("桌子"), desc:"報到/設備區用。" },
{ id:"site-queue", name:"紅龍/排隊動線（2m）", unit:"支", price:120, img:svgThumb("紅龍"), desc:"控場動線、入口區排隊。" },
{ id:"site-cableramp", name:"護線板（1m）", unit:"條", price:120, img:svgThumb("護線"), desc:"走線安全必備，避免絆倒。" },
]},
{ id:"power", name:"電力、控場人員與安全營運", items:[
{ id:"power-gen", name:"發電機（基本）", unit:"台", price:12000, img:svgThumb("發電"), desc:"戶外/電力不足時必備。功率可升級。" },
{ id:"power-dist", name:"配電箱/延長線組（基本）", unit:"套", price:1800, img:svgThumb("配電"), desc:"含基本配電、延長線、整理。" },
{ id:"staff-audio", name:"音控工程師（含彩排）", unit:"人/場", price:6500, img:svgThumb("音控"), desc:"含設定、彩排、全程控場（示意）。" },
{ id:"staff-light", name:"燈控工程師（含彩排）", unit:"人/場", price:6500, img:svgThumb("燈控"), desc:"燈光場景、節奏控制（示意）。" },
{ id:"staff-stage", name:"舞台監督/控場（舞監）", unit:"人/場", price:7000, img:svgThumb("舞監"), desc:"流程控場、演出串接、後台協調（示意）。" },
{ id:"staff-host", name:"主持人（基本）", unit:"人/場", price:9000, img:svgThumb("主持"), desc:"主持/串場/互動（示意）。" },
]}
];

const LEVELS = {
  safety: ["① 基礎穩定","② 標準配置","③ 活動專業","④ 演出進階","⑤ 旗艦舞台","⑥ 全盛典藏"],
  ambience:["① 純淨燈色","② 典禮質感","③ 氛圍層次","④ 視覺焦點","⑤ 沉浸舞台","⑥ 全感體驗"],
  upgrade:["① 亮點入門","② 氣氛效果","③ 儀式震撼","④ 演出支援","⑤ 全方位","⑥ 尊榮規格"]
};

const LEVEL_PRICES = {
  safety:  [ 10000, 15000, 20000, 25000, 35000, 50000 ],
  ambience:[ 20000, 25000, 35000, 45000, 60000, 80000 ],
  upgrade: [ 30000, 40000, 50000, 80000, 100000, 150000 ],
};

const PACKS_SAFETY = {
1: [{id:"audio-main",qty:1},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:1}],
2: [{id:"audio-main",qty:1},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:2},{id:"audio-monitor",qty:1},{id:"power-dist",qty:1}],
3: [{id:"audio-main",qty:2},{id:"audio-sub",qty:1},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:2},{id:"audio-monitor",qty:2},{id:"power-dist",qty:1},{id:"staff-audio",qty:1}],
4: [{id:"audio-main",qty:2},{id:"audio-sub",qty:2},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:3},{id:"audio-monitor",qty:3},{id:"power-dist",qty:1},{id:"staff-audio",qty:1}],
5: [{id:"audio-main",qty:3},{id:"audio-sub",qty:3},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:4},{id:"audio-monitor",qty:4},{id:"power-gen",qty:1},{id:"power-dist",qty:2},{id:"staff-audio",qty:1}],
6: [{id:"audio-main",qty:4},{id:"audio-sub",qty:4},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:5},{id:"audio-monitor",qty:5},{id:"power-gen",qty:1},{id:"power-dist",qty:3},{id:"staff-audio",qty:1}],
};
const PACKS_AMBIENCE = {
1: [{id:"light-par",qty:4}],
2: [{id:"stage-backdrop",qty:1},{id:"light-par",qty:6},{id:"light-console",qty:1}],
3: [{id:"stage-deck",qty:4},{id:"stage-backdrop",qty:1},{id:"light-par",qty:8},{id:"light-console",qty:1},{id:"staff-light",qty:1}],
4: [{id:"stage-deck",qty:6},{id:"stage-truss",qty:2},{id:"stage-backdrop",qty:1},{id:"light-par",qty:10},{id:"light-moving",qty:4},{id:"light-console",qty:1},{id:"fx-haze",qty:1},{id:"staff-light",qty:1}],
5: [{id:"stage-deck",qty:8},{id:"stage-truss",qty:4},{id:"stage-drape",qty:1},{id:"stage-backdrop",qty:1},{id:"light-par",qty:12},{id:"light-moving",qty:6},{id:"light-console",qty:1},{id:"fx-haze",qty:1},{id:"staff-light",qty:1}],
6: [{id:"stage-deck",qty:10},{id:"stage-truss",qty:6},{id:"stage-drape",qty:1},{id:"stage-backdrop",qty:1},{id:"light-par",qty:16},{id:"light-moving",qty:8},{id:"light-console",qty:1},{id:"fx-haze",qty:2},{id:"staff-light",qty:1}],
};
const PACKS_UPGRADE = {
1: [{id:"light-follow",qty:1}],
2: [{id:"fx-haze",qty:1}],
3: [{id:"video-projector",qty:1},{id:"video-screen",qty:1}],
4: [{id:"audio-drumkit",qty:1},{id:"audio-di",qty:4},{id:"audio-monitor",qty:2}],
5: [{id:"staff-host",qty:1},{id:"staff-stage",qty:1},{id:"staff-audio",qty:1}],
6: [{id:"staff-host",qty:1},{id:"staff-stage",qty:1},{id:"staff-audio",qty:1},{id:"staff-light",qty:1}],
};

const TIER_PHOTOS = {
  safety: Array.from({length:6},(_,i)=>[
    `https://picsum.photos/seed/safety-${i+1}-a/800/600`,
    `https://picsum.photos/seed/safety-${i+1}-b/800/600`
  ]),
  ambience: Array.from({length:6},(_,i)=>[
    `https://picsum.photos/seed/ambience-${i+1}-a/800/600`,
    `https://picsum.photos/seed/ambience-${i+1}-b/800/600`
  ]),
  upgrade: Array.from({length:6},(_,i)=>[
    `https://picsum.photos/seed/upgrade-${i+1}-a/800/600`,
    `https://picsum.photos/seed/upgrade-${i+1}-b/800/600`
  ])
};
  /* =========================
   Part3：核心邏輯
   ========================= */

function fillCityArea(citySel, areaSel, cityVal, areaVal){
  if(!citySel || !areaSel) return;
  citySel.innerHTML = Object.keys(TW).map(c=>`<option value="${c}">${c}</option>`).join("");
  function fillArea(){
    areaSel.innerHTML = (TW[citySel.value]||[]).map(a=>`<option value="${a}">${a}</option>`).join("");
  }
  citySel.addEventListener("change", ()=>fillArea());
  fillArea();
  if(cityVal && Object.keys(TW).includes(cityVal)){ citySel.value = cityVal; fillArea(); }
  if(areaVal && (TW[citySel.value]||[]).includes(areaVal)) areaSel.value = areaVal;
}

function getGlobalForm(){
  return {
    name: $("#fName")?.value?.trim()||"",
    phone: $("#fPhone")?.value?.trim()||"",
    email: $("#fEmail")?.value?.trim()||"",
    city: $("#fCity")?.value||"",
    area: $("#fArea")?.value||"",
    addr: $("#fAddr")?.value?.trim()||"",
    bldg: $("#fBldg")?.value?.trim()||"",
    eventType: $("#fEventType")?.value||"",
    crowd: $("#fCrowd")?.value||"",
    indoor: $("#fIndoor")?.value||"",
    note: $("#fNote")?.value?.trim()||"",
  };
}

function applyGlobalToSessionForm(sess){
  sess.form = deepClone(state.globalForm||{});
  sess.form.sessionNote = ""; // 本場備註（選填）
}

function ensurePlan(date){
  state.plan[date] = state.plan[date] || {
    s1:{start:"09:00", end:"12:00"},
    s2:{on:false, start:"18:00", end:"21:00"}
  };
  return state.plan[date];
}

function buildContinuousDates(){
  const s = normalizeDateStr($("#cStart").value||"");
  const e = normalizeDateStr($("#cEnd").value||"");
  if(!s) return [];
  if(!e || e===s) return [s];
  const S = new Date(s+"T00:00:00");
  const E = new Date(e+"T00:00:00");
  const start = new Date(Math.min(S.getTime(), E.getTime()));
  const end = new Date(Math.max(S.getTime(), E.getTime()));
  const out=[];
  let cur = new Date(start.getFullYear(), start.getMonth(), start.getDate());
  const end2= new Date(end.getFullYear(), end.getMonth(), end.getDate());
  while(cur.getTime()<=end2.getTime()){
    out.push(`${cur.getFullYear()}-${pad2(cur.getMonth()+1)}-${pad2(cur.getDate())}`);
    cur.setDate(cur.getDate()+1);
  }
  return out;
}

function getAllDatesMerged(){
  // 連續日期 + 不連續日期（可混用）
  const cont = buildContinuousDates();
  const non = (state.nonDates||[]).map(normalizeDateStr).filter(Boolean);
  const set = new Set([...(cont||[]), ...(non||[])].filter(Boolean));
  return Array.from(set).sort(compareDate);
}

function hmSelectHTML(name, value, isMin){
  const hours = Array.from({length:24}, (_,i)=>pad2(i));
  const mins  = ["00","10","20","30","40","50"];
  const arr = isMin ? mins : hours;
  return `<select data-hm="${name}">
    ${arr.map(v=>`<option value="${v}" ${v===value?"selected":""}>${v}</option>`).join("")}
  </select>`;
}

function fixS2NotOverlap(card, plan){
  const get = (n)=>card.querySelector(`select[data-hm="${n}"]`)?.value || "";
  const fEnd = toMin(get("eH"), get("eM"));
  const STEP=10;

  let s2Start = toMin(get("s2H"), get("s2M"));
  let s2End   = toMin(get("e2H"), get("e2M"));

  if(s2Start < fEnd){
    s2Start = fEnd;
    const [hh,mm]=fromMin(s2Start);
    card.querySelector(`select[data-hm="s2H"]`).value = hh;
    card.querySelector(`select[data-hm="s2M"]`).value = mm;
  }
  if(s2End <= s2Start){
    s2End = s2Start + STEP;
    const [hh,mm]=fromMin(s2End);
    card.querySelector(`select[data-hm="e2H"]`).value = hh;
    card.querySelector(`select[data-hm="e2M"]`).value = mm;
  }

  plan.s1.start = `${get("sH")}:${get("sM")}`;
  plan.s1.end   = `${get("eH")}:${get("eM")}`;
  plan.s2.start = `${get("s2H")}:${get("s2M")}`;
  plan.s2.end   = `${get("e2H")}:${get("e2M")}`;
}

function renderNcList(){
  const box = $("#ncList");
  const list = (state.nonDates||[]).map(normalizeDateStr).filter(Boolean).sort(compareDate);
  state.nonDates = list;

  if(!list.length){
    box.innerHTML = `<div class="note">目前沒有加入不連續日期。</div>`;
    return;
  }
  box.innerHTML = list.map(d=>`
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;border:1px solid var(--line);border-radius:12px;background:#fff;padding:10px 12px">
      <b>${d}</b>
      <button class="btn danger" type="button" data-del="${d}" style="padding:8px 10px">刪除</button>
    </div>
  `).join("");
  box.querySelectorAll("button[data-del]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const d=b.dataset.del;
      state.nonDates = (state.nonDates||[]).filter(x=>x!==d);
      renderNcList();
      renderPlanner();
    });
  });
}

function renderPlanner(){
  const box = $("#planner");
  const dates = getAllDatesMerged();
  if(!dates.length){
    box.innerHTML = `<div class="note">請先至少選一個日期：連續開始日期或加入不連續日期。</div>`;
    return;
  }

  box.innerHTML = dates.map((d, idx)=>{
    const plan = ensurePlan(d);
    const [sH,sM]=(plan.s1.start||"09:00").split(":");
    const [eH,eM]=(plan.s1.end||"12:00").split(":");
    const [s2H,s2M]=(plan.s2.start||"18:00").split(":");
    const [e2H,e2M]=(plan.s2.end||"21:00").split(":");
    return `
      <div class="planCard" data-date="${d}">
        <div class="planTop">
          <div class="planTitle">日期：${d}</div>
          <span class="tag">本日可規劃第1場＋第2場</span>
        </div>

        <div class="planTimes">
          <div class="note"><b>第1場（必填）</b></div>
          <div class="timeRow">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              ${hmSelectHTML("sH", sH||"09", false)}
              ${hmSelectHTML("sM", sM||"00", true)}
            </div>
            <div class="sep">～</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              ${hmSelectHTML("eH", eH||"12", false)}
              ${hmSelectHTML("eM", eM||"00", true)}
            </div>
          </div>

          <div class="s2Box">
            <div class="switchRow">
              <input type="checkbox" data-s2="1" ${plan.s2.on?"checked":""}>
              <span>此日需要第2場（每一場加價：<b>B×30%</b>）</span>
            </div>

            <div class="s2Times" style="${plan.s2.on?"":"display:none"}">
              <div class="note"><b>第2場（選填）</b></div>
              <div class="timeRow">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                  ${hmSelectHTML("s2H", s2H||"18", false)}
                  ${hmSelectHTML("s2M", s2M||"00", true)}
                </div>
                <div class="sep">～</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                  ${hmSelectHTML("e2H", e2H||"21", false)}
                  ${hmSelectHTML("e2M", e2M||"00", true)}
                </div>
              </div>
              <div class="hint">第2場開始不得早於第1場結束（會自動修正）。</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join("");

  box.querySelectorAll(".planCard").forEach(card=>{
    const d = card.dataset.date;
    const plan = ensurePlan(d);

    // 第1場時間變更
    card.querySelectorAll('select[data-hm="sH"],select[data-hm="sM"],select[data-hm="eH"],select[data-hm="eM"]').forEach(sel=>{
      sel.addEventListener("change", ()=>{
        plan.s1.start = `${card.querySelector('select[data-hm="sH"]').value}:${card.querySelector('select[data-hm="sM"]').value}`;
        plan.s1.end   = `${card.querySelector('select[data-hm="eH"]').value}:${card.querySelector('select[data-hm="eM"]').value}`;
        if(plan.s2.on) fixS2NotOverlap(card, plan);
      });
    });

    // 第2場開關
    const cb = card.querySelector('input[type="checkbox"][data-s2="1"]');
    cb.addEventListener("change", ()=>{
      plan.s2.on = !!cb.checked;
      card.querySelector(".s2Times").style.display = cb.checked ? "" : "none";
      if(cb.checked) fixS2NotOverlap(card, plan);
    });

    // 第2場時間變更
    card.querySelectorAll('select[data-hm="s2H"],select[data-hm="s2M"],select[data-hm="e2H"],select[data-hm="e2M"]').forEach(sel=>{
      sel.addEventListener("change", ()=>fixS2NotOverlap(card, plan));
    });
  });
}

/* ===== sessions 生成（取消 Step2：直接進選設備） ===== */
function makeSessionId(date, slot){ return `${date}#${slot}`; }
function sessionLabel(date, slot){
  return slot===1 ? `第1場（${date}）` : `第2場（${date}）`;
}

function buildSessionsFromPlanner(){
  const dates = getAllDatesMerged();
  if(!dates.length){
    alert("請先至少選一個日期。");
    return false;
  }

  state.globalForm = getGlobalForm();
  state.sessions = [];

  for(const d of dates){
    const p = ensurePlan(d);
    // 第1場永遠有
    const s1 = {
      id: makeSessionId(d,1),
      date: d,
      slot: 1,
      label: sessionLabel(d,1),
      timeStart: p.s1.start,
      timeEnd: p.s1.end,
      form: {},
      tiers: {safety:0, ambience:0, upgrade:0},
      cart: {packs:{}, items:{}},
      itemOpts: {},
      catId: CATEGORIES?.[0]?.id || "stage",
      done: false,
      isSecondSession: false
    };
    applyGlobalToSessionForm(s1);
    state.sessions.push(s1);

    // 第2場：如果勾選就加入（第二場也是一個「場次」）
    if(p.s2.on){
      const s2 = {
        id: makeSessionId(d,2),
        date: d,
        slot: 2,
        label: sessionLabel(d,2),
        timeStart: p.s2.start,
        timeEnd: p.s2.end,
        form: {},
        tiers: {safety:0, ambience:0, upgrade:0},
        cart: {packs:{}, items:{}},
        itemOpts: {},
        catId: CATEGORIES?.[0]?.id || "stage",
        done: false,
        isSecondSession: true
      };
      applyGlobalToSessionForm(s2);
      state.sessions.push(s2);
    }
  }

  // 排序：按 date，再 slot
  state.sessions.sort((a,b)=>{
    const c = compareDate(a.date,b.date);
    if(c!==0) return c;
    return Number(a.slot||0)-Number(b.slot||0);
  });

  state.curIdx = 0;
  return true;
}

/* ===== options（每場各自） ===== */
function findItem(itemId){
  for(const c of CATEGORIES){
    const it=(c.items||[]).find(x=>x.id===itemId);
    if(it) return {cat:c,item:it};
  }
  return null;
}
function getUnitPrice(item, qty){
  const q = Math.max(1, Number(qty||1));
  const tiers = item?.priceTiers;
  if(Array.isArray(tiers) && tiers.length){
    let price = Number(item.price||0);
    for(const t of tiers){
      const min=Number(t.min||1), p=Number(t.price||0);
      if(q>=min) price=p;
    }
    return price;
  }
  return Number(item?.price||0);
}
function formatTiers(item){
  const tiers=item?.priceTiers;
  if(!Array.isArray(tiers)||!tiers.length) return "";
  const sorted=[...tiers].sort((a,b)=>Number(a.min||1)-Number(b.min||1));
  const parts=[];
  for(let i=0;i<sorted.length;i++){
    const cur=sorted[i], next=sorted[i+1];
    const min=Number(cur.min||1);
    const max=next ? (Number(next.min||1)-1) : null;
    if(max && max>=min) parts.push(`${min}–${max}${item.unit} ${fmt(cur.price)} / ${item.unit}`);
    else parts.push(`${min}${item.unit}以上 ${fmt(cur.price)} / ${item.unit}`);
  }
  return parts.join("；");
}
function getLineSubtotal(item, qty){ return getUnitPrice(item, qty) * Number(qty||0); }
function getItemSubPriceText(item, qty){
  const hasTiers = Array.isArray(item?.priceTiers) && item.priceTiers.length;
  if(!hasTiers) return `${fmt(item.price)} / ${item.unit}`;
  const q=Number(qty||0);
  if(q>0){
    const up=getUnitPrice(item,q);
    const base=Number(item.price||0);
    const tag = up<base ? "（優惠）" : "";
    return `${fmt(up)}${tag} / ${item.unit} <span class="note">｜${formatTiers(item)}</span>`;
  }
  return `${fmt(item.price)} 起 / ${item.unit} <span class="note">｜${formatTiers(item)}</span>`;
}

function getItemOpts(sess, itemId){ return (sess.itemOpts && sess.itemOpts[itemId]) ? sess.itemOpts[itemId] : {}; }
function isOptVisible(def, opts){
  const w=def?.when;
  if(w && w.opt) return String(opts?.[w.opt] ?? "") === String(w.is ?? "");
  return true;
}
function normalizeOptValue(def, value){
  const v = (value==null) ? "" : String(value);
  if(v==="請選擇") return "";
  return v;
}
function cleanupHiddenOpts(sess, itemId){
  const f=findItem(itemId); if(!f) return;
  const item=f.item;
  if(!item?.options) return;
  const opts=getItemOpts(sess,itemId) || {};
  let changed=false;
  for(const [k,def] of Object.entries(item.options)){
    if(opts[k]==null) continue;
    if(!isOptVisible(def, opts)){ delete opts[k]; changed=true; }
  }
  if(changed){
    sess.itemOpts[itemId]=opts;
    if(Object.keys(opts).length===0) delete sess.itemOpts[itemId];
  }
}
function setItemOpt(sess, itemId, key, value){
  const f=findItem(itemId);
  const def=f?.item?.options?.[key];
  const v=normalizeOptValue(def, value);
  sess.itemOpts = sess.itemOpts || {};
  if(!sess.itemOpts[itemId]) sess.itemOpts[itemId]={};
  if(v===""){
    delete sess.itemOpts[itemId][key];
    if(Object.keys(sess.itemOpts[itemId]).length===0) delete sess.itemOpts[itemId];
  }else{
    sess.itemOpts[itemId][key]=v;
  }
  cleanupHiddenOpts(sess, itemId);
}
function formatOptText(sess, itemId){
  const f=findItem(itemId); if(!f) return "";
  const item=f.item;
  const opts=getItemOpts(sess,itemId) || {};
  if(!item?.options) return "";
  const parts=[];
  for(const [k,def] of Object.entries(item.options)){
    if(!isOptVisible(def, opts)) continue;
    const v=opts[k];
    if(v==null || v==="") continue;
    if(def?.omitValues && def.omitValues.includes(String(v))) continue;
    parts.push(`${def.label||k}：${v}`);
  }
  return parts.length ? `（${parts.join("，")}）` : "";
}
function buildOptionsHTML(sess, item){
  if(!item?.options) return "";
  const optsState=getItemOpts(sess,item.id) || {};
  const rows = Object.entries(item.options).map(([k,def])=>{
    if(!isOptVisible(def, optsState)) return "";
    const values=Array.isArray(def.values)?def.values:[];
    const curRaw = (optsState[k]!=null)?String(optsState[k]):"";
    const cur = normalizeOptValue(def, curRaw);
    const optionsHTML = values.map(v=>{
      const vv=String(v);
      const valueAttr=(vv==="請選擇")?"":vv;
      const selected=(valueAttr===cur) || (cur==="" && valueAttr==="");
      return `<option value="${escapeHtml(valueAttr)}" ${selected?"selected":""}>${escapeHtml(vv)}</option>`;
    }).join("");
    return `
      <div class="optrow">
        <div class="optlabel">${escapeHtml(def.label||k)}</div>
        <select class="optselect" data-act="opt" data-id="${item.id}" data-opt="${k}">
          ${optionsHTML}
        </select>
      </div>
    `;
  }).join("");
  return rows.trim() ? `<div class="optbox">${rows}</div>` : "";
}

/* ===== Modal / 詳情 ===== */
function openModal(title, htmlBody){
  $("#mTitle").textContent=title||"詳情";
  $("#mBody").innerHTML=htmlBody||"—";
  $("#modalMask").style.display="flex";
}
function closeModal(){ $("#modalMask").style.display="none"; }
$("#mClose").addEventListener("click", closeModal);
$("#modalMask").addEventListener("click", (e)=>{ if(e.target===$("#modalMask")) closeModal(); });

function buildPhotoHTML(urls){
  const a = (urls&&urls[0])?urls[0]:"https://picsum.photos/seed/event-fallback/800/600";
  const b = (urls&&urls[1])?urls[1]:"https://picsum.photos/seed/stage-fallback/800/600";
  return `
    <div class="photoGrid">
      <div class="photoBox"><img src="${a}" alt="示意照片1" loading="lazy"><div class="photoCap">示意照片 1</div></div>
      <div class="photoBox"><img src="${b}" alt="示意照片2" loading="lazy"><div class="photoCap">示意照片 2</div></div>
    </div>
  `;
}
function getItemPhotos(catId, itemId){
  const seedBase=`${catId||"cat"}-${itemId||"item"}`;
  return [`https://picsum.photos/seed/${seedBase}-a/800/600`,`https://picsum.photos/seed/${seedBase}-b/800/600`];
}
function openItemDetail(itemId){
  const f=findItem(itemId); if(!f) return;
  const photos=getItemPhotos(f.cat.id, f.item.id);
  const desc=((f.item.desc||"—")+"").replace(/\n/g,"<br>");
  openModal(`商品詳情｜${f.item.name}`, `${buildPhotoHTML(photos)}<div class="modalDesc">${desc}</div>`);
}
function openTierDetail(tierKey, level){
  const tierLabel=({safety:"安全",ambience:"氣氛",upgrade:"升級"}[tierKey])||"套裝";
  const levelName = LEVELS[tierKey]?.[level-1] || `第${level}級`;
  const price = LEVEL_PRICES[tierKey]?.[level-1];
  const packs = tierKey==="safety"?PACKS_SAFETY:(tierKey==="ambience"?PACKS_AMBIENCE:PACKS_UPGRADE);
  const list = packs[level] || [];
  const photos = TIER_PHOTOS[tierKey]?.[level-1];

  const itemsHTML=list.map(p=>{
    const f=findItem(p.id);
    const nm=f?f.item.name:p.id;
    const unit=f?f.item.unit:"";
    return `<li><b>${escapeHtml(nm)}</b> × ${p.qty}${unit?` ${escapeHtml(unit)}`:""}</li>`;
  }).join("");

  openModal(`套裝詳情｜${tierLabel} ${levelName}`, `
    ${buildPhotoHTML(photos)}
    <div class="note" style="margin-top:10px">
      參考價：<b>${price?fmt(price):"—"}</b>
    </div>
    <ul class="packList">${itemsHTML||"<li>—</li>"}</ul>
  `);
}

/* ===== 選設備頁 rendering ===== */
function cur(){ return state.sessions[state.curIdx]; }
function showCopyBar(){
  // 第一場不顯示複製（你指定）
  $("#copyBar").style.display = (state.curIdx<=0) ? "none" : "";
}

function renderSessionHeader(){
  const s=cur();
  const title = `2) 設備選取｜${s.slot===1?"第1場":"第2場"}（${s.date} ${s.timeStart}～${s.timeEnd}）`;
  $("#equipTitle").textContent = title;
  $("#stickyNow").textContent = `${s.slot===1?"第1場":"第2場"}｜${s.date} ${s.timeStart}～${s.timeEnd}`;
  $("#btnNextSession").textContent = (state.curIdx < state.sessions.length-1) ? "前往下一場" : "前往輸出報價單";
}

function fillSessionFormOptions(){
  $("#sEventType").innerHTML = $("#fEventType").innerHTML;
  $("#sCrowd").innerHTML = $("#fCrowd").innerHTML;
  $("#sIndoor").innerHTML = $("#fIndoor").innerHTML;
}

function renderSessionForm(){
  const s=cur();
  $("#sLabel").value = s.slot===1 ? "第1場" : "第2場";
  $("#sDate").value = s.date;

  $("#sName").value = s.form?.name || "";
  $("#sPhone").value= s.form?.phone || "";
  $("#sEmail").value= s.form?.email || "";
  $("#sAddr").value = s.form?.addr || "";
  $("#sBldg").value = s.form?.bldg || "";
  $("#sEventType").value = s.form?.eventType || "";
  $("#sCrowd").value = s.form?.crowd || "";
  $("#sIndoor").value = s.form?.indoor || "";
  $("#sNote").value = s.form?.sessionNote || "";

  fillCityArea($("#sCity"), $("#sArea"), s.form?.city || "", s.form?.area || "");
}

function bindSessionForm(){
  const map = {
    sName:"name", sPhone:"phone", sEmail:"email", sAddr:"addr", sBldg:"bldg",
    sEventType:"eventType", sCrowd:"crowd", sIndoor:"indoor", sNote:"sessionNote",
    sCity:"city", sArea:"area"
  };
  Object.keys(map).forEach(id=>{
    const el=$("#"+id);
    el.addEventListener("input", ()=>{
      const s=cur();
      s.form = s.form || {};
      s.form[map[id]] = (id==="sEventType"||id==="sCrowd"||id==="sIndoor"||id==="sCity"||id==="sArea") ? el.value : el.value;
    });
    el.addEventListener("change", ()=>{
      const s=cur();
      s.form = s.form || {};
      s.form[map[id]] = el.value;
    });
  });
}

function renderTierPills(sess){
  const s = sess.tiers?.safety ? `安全第${sess.tiers.safety}級` : "安全—";
  const a = sess.tiers?.ambience ? `氣氛第${sess.tiers.ambience}級` : "氣氛—";
  const u = sess.tiers?.upgrade ? `升級第${sess.tiers.upgrade}級` : "升級—";
  $("#tierPills").textContent = `${s}｜${a}｜${u}`;
  $("#pillSafety").textContent = sess.tiers?.safety ? `第${sess.tiers.safety}級` : "未選";
  $("#pillAmbience").textContent = sess.tiers?.ambience ? `第${sess.tiers.ambience}級` : "未選";
  $("#pillUpgrade").textContent = sess.tiers?.upgrade ? `第${sess.tiers.upgrade}級` : "未選";
}

function applyPackLevel(sess, tierKey, level){
  const packs = tierKey==="safety"?PACKS_SAFETY:(tierKey==="ambience"?PACKS_AMBIENCE:PACKS_UPGRADE);
  const list = packs[level] || [];
  if(!list.length){ alert("此等級尚未設定套裝內容。"); return; }
  sess.tiers[tierKey] = level;
  const label = tierKey==="safety"?"安全等級":(tierKey==="ambience"?"氣氛等級":"升級等級");
  const name = LEVELS[tierKey]?.[level-1] || `第${level}級`;
  const price = LEVEL_PRICES[tierKey]?.[level-1] || 0;
  sess.cart.packs[tierKey] = {tierKey,label,level,name,price,items:list};
  renderAllEquip();
}
function removePack(sess, tierKey){
  delete sess.cart.packs[tierKey];
  sess.tiers[tierKey]=0;
  renderAllEquip();
}

function renderTierButtons(sess){
  const mk = (tierKey, containerSel)=>{
    const el=$(containerSel);
    el.innerHTML = LEVELS[tierKey].map((name, idx)=>{
      const n=idx+1;
      const price = LEVEL_PRICES[tierKey]?.[idx];
      return `
        <div class="levelBtn" data-tier="${tierKey}" data-level="${n}">
          <div>
            <div class="levelTopRow">
              <span class="levelName">${escapeHtml(name)}</span>
              <span class="levelPrice">${price?fmt(price):"—"}</span>
            </div>
            <div class="levelActions">
              <button type="button" class="miniBtn primaryMini" data-act="apply" data-tier="${tierKey}" data-level="${n}">加入報價</button>
              <button type="button" class="miniBtn" data-act="detail" data-tier="${tierKey}" data-level="${n}">詳情</button>
            </div>
          </div>
          <div class="levelMedia">
            <img src="${(TIER_PHOTOS[tierKey]?.[idx]?.[0]) || 'https://picsum.photos/seed/stage-fallback/800/600'}" alt="示意照片" loading="lazy">
          </div>
        </div>
      `;
    }).join("");

    el.querySelectorAll(".miniBtn").forEach(b=>{
      b.addEventListener("click", (e)=>{
        e.stopPropagation();
        const tier=b.dataset.tier;
        const level=Number(b.dataset.level||0);
        const act=b.dataset.act||"";
        if(act==="apply") return applyPackLevel(sess, tier, level);
        openTierDetail(tier, level);
      });
    });
  };
  mk("safety","#levelsSafety");
  mk("ambience","#levelsAmbience");
  mk("upgrade","#levelsUpgrade");
}

function renderTabs(sess){
  const el=$("#tabs");
  el.innerHTML = CATEGORIES.map(c=>`<button class="tab ${c.id===sess.catId?"active":""}" data-cat="${c.id}">${escapeHtml(c.name)}</button>`).join("");
  el.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", ()=>{
      sess.catId=b.dataset.cat;
      renderItems(sess);
    });
  });
}

function renderItems(sess){
  const cat=CATEGORIES.find(c=>c.id===sess.catId);
  $("#catName").textContent=cat?.name||"—";
  const el=$("#items");
  el.innerHTML=(cat?.items||[]).map(it=>{
    const qty = Number(sess.cart.items[it.id]||0);
    return `
      <div class="item">
        <img class="thumb" src="${getItemPhotos(sess.catId,it.id)[0]}" alt="${escapeHtml(it.name)}" loading="lazy"
          onerror="this.onerror=null;this.src='${svgThumb(it.name)}';">
        <div class="meta">
          <div class="name">${escapeHtml(it.name)}</div>
          <div class="sub">${getItemSubPriceText(it, qty)}</div>
          <div class="row2">
            <div class="qty">
              <button class="qbtn" data-act="dec" data-id="${it.id}">-</button>
              <div class="qval">${qty}</div>
              <button class="qbtn" data-act="inc" data-id="${it.id}">+</button>
            </div>
            <button class="linkbtn" data-act="detail" data-id="${it.id}">詳情</button>
          </div>
          ${qty>0 ? buildOptionsHTML(sess, it) : ""}
        </div>
        <div class="price">${fmt(getLineSubtotal(it, qty))}</div>
      </div>
    `;
  }).join("");

  el.querySelectorAll("button").forEach(b=>{
    const act=b.dataset.act, id=b.dataset.id;
    if(!act||!id) return;
    if(act==="inc"){ b.addEventListener("click", ()=>{ sess.cart.items[id]=(sess.cart.items[id]||0)+1; renderAllEquip(); }); }
    if(act==="dec"){ b.addEventListener("click", ()=>{ sess.cart.items[id]=Math.max(0,(sess.cart.items[id]||0)-1); if(sess.cart.items[id]===0) delete sess.cart.items[id]; renderAllEquip(); }); }
    if(act==="detail"){ b.addEventListener("click", ()=>openItemDetail(id)); }
  });

  el.querySelectorAll('select[data-act="opt"]').forEach(s=>{
    s.addEventListener("change", ()=>{
      const id=s.dataset.id, key=s.dataset.opt;
      setItemOpt(sess, id, key, s.value);
      renderAllEquip();
    });
  });
}

function groupCart(sess){
  const groups=new Map();
  for(const [id,qty] of Object.entries(sess.cart.items||{})){
    const f=findItem(id); if(!f) continue;
    const key=f.cat.name;
    if(!groups.has(key)) groups.set(key,[]);
    groups.get(key).push({item:f.item,qty:Number(qty||0)});
  }
  return groups;
}

function renderCart(sess){
  const el=$("#cart");
  const parts=[];
  // packs
  const order=[["safety","安全等級"],["ambience","氣氛等級"],["upgrade","升級等級"]];
  for(const [k,title] of order){
    const p=sess.cart.packs[k];
    if(!p) continue;
    parts.push(`
      <div class="group">
        <div class="gh"><span>${title}（套裝）</span><span class="note">1 項</span></div>
        <div class="gb">
          <div class="citem">
            <img alt="">
            <div class="cmeta">
              <div class="top">
                <div class="nm">${escapeHtml(p.name||"")}</div>
                <div style="font-weight:1000">${fmt(p.price||0)}</div>
              </div>
              <div class="cline">
                <div class="note">套裝</div>
                <button class="xbtn" data-act="delpack" data-tier="${k}">✕</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `);
  }
  // items
  const groups=groupCart(sess);
  for(const [gname, rows] of groups.entries()){
    parts.push(`
      <div class="group">
        <div class="gh"><span>${escapeHtml(gname)}</span><span class="note">${rows.length} 項</span></div>
        <div class="gb">
          ${rows.map(({item,qty})=>{
            const up=getUnitPrice(item,qty);
            const line=up*qty;
            const optText=formatOptText(sess,item.id);
            return `
              <div class="citem">
                <img alt="">
                <div class="cmeta">
                  <div class="top">
                    <div class="nm">${escapeHtml(item.name)}${escapeHtml(optText)}</div>
                    <div style="font-weight:1000">${fmt(line)}</div>
                  </div>
                  <div class="cline">
                    <div class="qty">
                      <button class="qbtn" data-act="dec" data-id="${item.id}">-</button>
                      <div class="qval">${qty}</div>
                      <button class="qbtn" data-act="inc" data-id="${item.id}">+</button>
                    </div>
                    <button class="xbtn" data-act="del" data-id="${item.id}">✕</button>
                  </div>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      </div>
    `);
  }

  el.innerHTML = parts.join("") || `<div class="note">尚未選擇任何設備。</div>`;

  el.querySelectorAll("button").forEach(b=>{
    const act=b.dataset.act, id=b.dataset.id;
    if(act==="inc"){ b.addEventListener("click", ()=>{ sess.cart.items[id]=(sess.cart.items[id]||0)+1; renderAllEquip(); }); }
    if(act==="dec"){ b.addEventListener("click", ()=>{ sess.cart.items[id]=Math.max(0,(sess.cart.items[id]||0)-1); if(sess.cart.items[id]===0) delete sess.cart.items[id]; renderAllEquip(); }); }
    if(act==="del"){ b.addEventListener("click", ()=>{ delete sess.cart.items[id]; renderAllEquip(); }); }
    if(act==="delpack"){ b.addEventListener("click", ()=>removePack(sess, b.dataset.tier)); }
  });
}

function calcSessionB(sess){
  let sum=0;
  for(const p of Object.values(sess.cart.packs||{})){
    if(p) sum += Number(p.price||0);
  }
  for(const [id,qty] of Object.entries(sess.cart.items||{})){
    const f=findItem(id); if(!f) continue;
    sum += getUnitPrice(f.item,qty) * Number(qty||0);
  }
  return sum;
}

function calcSessionTotal(sess){
  const B = calcSessionB(sess);
  // 這裡的「第二場加價」只有在「同一天第二場」才需要，但我們把第2場當成獨立場次，
  // 所以這裡不再額外加價（避免重複）。你之前的規則是「第二場加價 B×30%」，
  // 在本版本中：第二場本身就是一個場次，所以它的設備就是它的 B，不再另外加。
  // 若你仍要第二場＝「在第1場基礎上加價」，我可以下一步再把第二場計價改回加價模式。
  return {B, total:B};
}

/* ===== 連續多日加價（只針對「日期連續」且「每一天第1場設備一致」） ===== */
function signatureForSess(sess){
  const packs = sess.cart.packs||{};
  const packSig = {safety:packs.safety?.level||0, ambience:packs.ambience?.level||0, upgrade:packs.upgrade?.level||0};
  const items = sess.cart.items||{};
  const itemsSig = Object.keys(items).sort().map(id=>[id, Number(items[id]||0)]);
  const opts = sess.itemOpts||{};
  const optsSig = Object.keys(opts).sort().map(id=>{
    const o=opts[id]||{};
    const kk=Object.keys(o).sort().map(k=>[k,String(o[k])]);
    return [id,kk];
  });
  return JSON.stringify({packSig,itemsSig,optsSig});
}

function calcGrand(){
  // 規則（照你之前）：連續多日第2天 +50%，第3天起每一天 +30%
  // 但你的「連續」是以「同一套設備」為前提。
  // 在場次版中，我們只拿「每一天第1場」來做連續判斷（比較符合你的概念）。
  const allSessions = state.sessions||[];
  const s1List = allSessions.filter(s=>s.slot===1).sort((a,b)=>compareDate(a.date,b.date));

  // 基礎：每場都是自己的小計
  const perSession = allSessions.map(s=>{
    const r=calcSessionTotal(s);
    return {id:s.id, label:s.label, date:s.date, slot:s.slot, B:r.B, total:r.total};
  });

  // 判斷連續（僅針對連續日期範圍內的第1場）
  const contDates = buildContinuousDates();
  const contSet = new Set(contDates);
  const contS1 = s1List.filter(s=>contSet.has(s.date));

  let continuousEligible=false;
  if(contS1.length>=2){
    const sig0 = signatureForSess(contS1[0]);
    continuousEligible = contS1.every(x=>signatureForSess(x)===sig0);
  }

  let surcharge = 0;
  if(continuousEligible){
    const B = calcSessionB(contS1[0]); // 基準B（第1天第1場）
    if(contS1.length>=2) surcharge += Math.round(B*0.50);
    if(contS1.length>=3) surcharge += Math.round(B*0.30) * (contS1.length-2);
  }

  const baseTotal = perSession.reduce((a,x)=>a+Number(x.total||0),0);
  const grandTotal = baseTotal + surcharge;

  return { perSession, baseTotal, surcharge, grandTotal, continuousEligible, contS1Count: contS1.length };
}

function renderTotals(){
  const sess=cur();
  const r=calcSessionTotal(sess);
  $("#sessionSubtotal").textContent = fmt(r.B);
  $("#sessionS2Row").style.display = "none";
  $("#sessionS2Fee").textContent = fmt(0);
  $("#sessionTotal").textContent = fmt(r.total);
  $("#sessionTotalPill").textContent = fmt(r.total);
}

/* ===== 全部渲染 ===== */
function renderAllEquip(){
  const sess=cur();
  renderSessionHeader();
  showCopyBar();

  renderTierPills(sess);
  renderTierButtons(sess);
  renderTabs(sess);
  renderItems(sess);
  renderCart(sess);
  renderTotals();
  renderJumpList();
}

function openSession(idx){
  state.curIdx = Math.max(0, Math.min((state.sessions.length-1), idx));
  setStep(2);
  showView("viewEquip");
  fillSessionFormOptions();
  renderSessionForm();
  renderAllEquip();
}

/* ===== 複製規則（第一場不出現複製） ===== */
function copyEquip(fromIdx, toIdx){
  const from = state.sessions[fromIdx];
  const to   = state.sessions[toIdx];
  if(!from || !to) return;
  to.tiers = deepClone(from.tiers||{safety:0,ambience:0,upgrade:0});
  to.cart  = deepClone(from.cart||{packs:{},items:{}});
  to.itemOpts = deepClone(from.itemOpts||{});
  to.catId = from.catId || to.catId;
}

function renderPickCopyList(){
  const box=$("#pickCopyList");
  const toIdx=state.curIdx;
  box.innerHTML = state.sessions.map((s, i)=>{
    const disabled = (i===toIdx) ? "disabled" : "";
    return `
      <button class="btn" type="button" data-i="${i}" ${disabled}>
        複製 ${escapeHtml(s.label)}｜${s.timeStart}～${s.timeEnd}
      </button>
    `;
  }).join("");
  box.querySelectorAll("button[data-i]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const i=Number(b.dataset.i||0);
      copyEquip(i, toIdx);
      $("#pickCopyMask").style.display="none";
      renderAllEquip();
    });
  });
}

/* ===== 快速跳轉 ===== */
function renderJumpList(){
  const box=$("#jumpList");
  box.innerHTML = state.sessions.map((s,i)=>{
    const st = s.done ? "✓ 已完成" : "⏳ 未完成";
    return `
      <button class="btn" type="button" data-j="${i}">
        ${escapeHtml(s.label)}｜${s.timeStart}～${s.timeEnd}｜${st}
      </button>
    `;
  }).join("");
  box.querySelectorAll("button[data-j]").forEach(b=>{
    b.addEventListener("click", ()=>{
      $("#jumpMask").style.display="none";
      openSession(Number(b.dataset.j||0));
    });
  });
}

/* ===== Quote（Step3） ===== */
function renderQuote(){
  const g = state.globalForm||{};
  const all = calcGrand();

  const warn = [];
  if(buildContinuousDates().length>=2 && !all.continuousEligible){
    warn.push("⚠️ 你設定了連續多日，但連續範圍內的「第1場設備」不一致，因此不套用 Day2/Day3+ 加價（改為每日獨立計價）。");
  }
  $("#quoteNote").innerHTML = `
    <div class="note" style="display:grid;gap:6px">
      <div>聯絡人：<b>${escapeHtml(g.name||"")}</b>｜電話：<b>${escapeHtml(g.phone||"")}</b>｜Email：<b>${escapeHtml(g.email||"")}</b></div>
      <div>地點：${escapeHtml(g.city||"")} ${escapeHtml(g.area||"")} ${escapeHtml(g.addr||"")} ${escapeHtml(g.bldg||"")}</div>
      ${warn.length?`<div class="note" style="color:#92400e;font-weight:900">${warn.join("<br>")}</div>`:""}
    </div>
  `;

  const rows = all.perSession.map((x,idx)=>`
    <div style="display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid var(--line)">
      <div>
        <b>${escapeHtml(x.label)}</b>
        <div class="note">${escapeHtml(x.date)}｜${x.slot===1?"第1場":"第2場"}</div>
      </div>
      <div style="font-weight:1000">${fmt(x.total)}</div>
    </div>
  `).join("");

  const surchargeRow = all.surcharge>0 ? `
    <div style="display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid var(--line)">
      <div><b>連續多日加價</b><div class="note">第2天 B×50%｜第3天起 B×30%</div></div>
      <div style="font-weight:1000">${fmt(all.surcharge)}</div>
    </div>
  ` : "";

  $("#quoteTable").innerHTML = `
    <div>${rows}</div>
    ${surchargeRow}
    <div style="display:flex;justify-content:space-between;gap:10px;padding:12px 0">
      <div><b>總計</b></div>
      <div style="font-weight:1000">${fmt(all.grandTotal)}</div>
    </div>
  `;
  $("#grandTotalPill").textContent = fmt(all.grandTotal);
}

/* ===== Print：第1頁總覽 + 每場一頁明細（含資料） ===== */
function buildItemsForPrint(sess){
  const items=[];
  for(const p of Object.values(sess.cart.packs||{})){
    if(!p) continue;
    items.push({category:"套裝", name:`套裝｜${p.label||""}｜${p.name||""}`, unit:"套", price:Number(p.price||0), qty:1, total:Number(p.price||0), options:{}});
  }
  for(const [id,qty] of Object.entries(sess.cart.items||{})){
    const f=findItem(id); if(!f) continue;
    const up=getUnitPrice(f.item,qty);
    items.push({category:f.cat.name, name:f.item.name, unit:f.item.unit, price:Number(up||0), qty:Number(qty||0), total:Number(up||0)*Number(qty||0), options:sess.itemOpts?.[id]||{}});
  }
  return items;
}
function formatOptionsInline(opts){
  if(!opts) return "";
  const ks=Object.keys(opts);
  if(!ks.length) return "";
  return ks.map(k=>`${k}=${opts[k]}`).join("；");
}

function buildPrint(){
  const root=$("#printRoot");
  const g=state.globalForm||{};
  const all=calcGrand();
  const now=new Date();
  const ts=`${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())} ${pad2(now.getHours())}:${pad2(now.getMinutes())}`;

  // 第1頁：總覽
  const sumRows = all.perSession.map((x,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${escapeHtml(x.label)}</td>
      <td>${escapeHtml(x.date)}</td>
      <td class="right">${fmt(x.total)}</td>
    </tr>
  `).join("");

  const sumPage = `
    <div class="printHdr">
      <p class="printBrand">${escapeHtml(BRAND_NAME)}</p>
      <p class="printTitle">${escapeHtml(PRINT_TITLE)}</p>
      <div class="printMeta">產生時間：${escapeHtml(ts)}</div>
      <div class="printMeta">姓名/單位：${escapeHtml(g.name||"")}｜電話：${escapeHtml(g.phone||"")}｜Email：${escapeHtml(g.email||"")}</div>
      <div class="printMeta">地點：${escapeHtml(g.city||"")} ${escapeHtml(g.area||"")} ${escapeHtml(g.addr||"")} ${escapeHtml(g.bldg||"")}</div>
      <div class="printMeta">活動：${escapeHtml(g.eventType||"")}｜人數：${escapeHtml(g.crowd||"")}｜室內外：${escapeHtml(g.indoor||"")}</div>
      ${g.note?`<div class="printMeta">備註：${escapeHtml(g.note)}</div>`:""}
    </div>

    <div class="printH3">總覽（每一場小計）</div>
    <table class="printTbl">
      <thead><tr><th style="width:40px">#</th><th>場次</th><th style="width:90px">日期</th><th class="right" style="width:90px">金額</th></tr></thead>
      <tbody>${sumRows || `<tr><td colspan="4">—</td></tr>`}</tbody>
    </table>

    <div class="totalsBox">
      <div class="totalsPrint">
        <div class="trowPrint"><span class="muted">小計</span><b>${fmt(all.baseTotal)}</b></div>
        ${all.surcharge>0?`<div class="trowPrint"><span class="muted">連續多日加價</span><b>${fmt(all.surcharge)}</b></div>`:""}
        <div class="trowPrint total"><span>總計</span><b>${fmt(all.grandTotal)}</b></div>
      </div>
    </div>

    <div class="pageBreak"></div>
  `;

  // 後續每頁：每場明細（包含該場資料）
  const detailPages = state.sessions.map((s, idx)=>{
    const items=buildItemsForPrint(s);
    const rows = items.map(it=>`
      <tr>
        <td>${escapeHtml(it.category||"")}</td>
        <td>${escapeHtml(it.name||"")}</td>
        <td>${escapeHtml(it.unit||"")}</td>
        <td class="right">${fmt(it.price||0)}</td>
        <td class="right">${it.qty||0}</td>
        <td class="right">${fmt(it.total||0)}</td>
        <td>${escapeHtml(formatOptionsInline(it.options))}</td>
      </tr>
    `).join("");

    const f=s.form||{};
    const money = calcSessionTotal(s).total;

    return `
      <div class="printHdr">
        <p class="printBrand">${escapeHtml(BRAND_NAME)}</p>
        <p class="printTitle">${escapeHtml(s.label)}｜${escapeHtml(s.timeStart)}～${escapeHtml(s.timeEnd)}</p>

        <div class="printMeta">姓名/單位：${escapeHtml(f.name||"")}｜電話：${escapeHtml(f.phone||"")}｜Email：${escapeHtml(f.email||"")}</div>
        <div class="printMeta">地點：${escapeHtml(f.city||"")} ${escapeHtml(f.area||"")} ${escapeHtml(f.addr||"")} ${escapeHtml(f.bldg||"")}</div>
        <div class="printMeta">活動：${escapeHtml(f.eventType||"")}｜人數：${escapeHtml(f.crowd||"")}｜室內外：${escapeHtml(f.indoor||"")}</div>
        ${f.sessionNote?`<div class="printMeta">本場備註：${escapeHtml(f.sessionNote)}</div>`:""}
      </div>

      <div class="printH3">設備明細</div>
      <table class="printTbl">
        <thead>
          <tr>
            <th style="width:90px">分類</th>
            <th>品項</th>
            <th style="width:40px">單位</th>
            <th class="right" style="width:90px">單價</th>
            <th class="right" style="width:50px">數量</th>
            <th class="right" style="width:90px">小計</th>
            <th>選項</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="7">—</td></tr>`}</tbody>
      </table>

      <div class="totalsBox">
        <div class="totalsPrint">
          <div class="trowPrint total"><span>本場合計</span><b>${fmt(money)}</b></div>
        </div>
      </div>

      ${idx===state.sessions.length-1 ? `` : `<div class="pageBreak"></div>`}
    `;
  }).join("");

  root.innerHTML = sumPage + detailPages;
}

function printPDF(){
  buildPrint();
  document.body.classList.add("printing");
  window.print();
  setTimeout(()=>document.body.classList.remove("printing"), 600);
}

/* ===== 送出（payload 包含所有場次 + 每場資料 + PDF可重建內容） ===== */
function buildPayload(){
  const all=calcGrand();
  const sessionsPayload = state.sessions.map((s,idx)=>{
    const items=buildItemsForPrint(s);
    return {
      index: idx+1,
      id: s.id,
      date: s.date,
      slot: s.slot,
      label: s.label,
      timeStart: s.timeStart,
      timeEnd: s.timeEnd,
      form: s.form||{},
      tiers: s.tiers||{},
      items,
      subtotal: calcSessionB(s),
      total: calcSessionTotal(s).total
    };
  });

  return {
    action: "submitQuote_v2",
    globalForm: state.globalForm||{},
    continuous: { start: normalizeDateStr($("#cStart").value||""), end: normalizeDateStr($("#cEnd").value||"") },
    nonDates: state.nonDates||[],
    sessions: sessionsPayload,
    summary: {
      baseTotal: Number(all.baseTotal||0),
      surcharge: Number(all.surcharge||0),
      grandTotal: Number(all.grandTotal||0),
      continuousEligible: !!all.continuousEligible
    }
  };
}

function submitQuote(){
  try{
    const payload = buildPayload();
    const ok = navigator.sendBeacon(ORDER_API_URL, JSON.stringify(payload));
    if(ok) alert("已送出！系統會產生 PDF 報價單並寄給您，請至信箱查收。");
    else alert("送出失敗（瀏覽器未送出）。請重新整理後再試一次。");
  }catch(e){
    console.error(e);
    alert("送出失敗：" + (e?.message||e));
  }
}

/* ===== Fold ===== */
$("#btnFold").addEventListener("click", ()=>{
  $("#foldForm").classList.toggle("open");
});

/* ===== Jump modal ===== */
$("#btnJump").addEventListener("click", ()=>{ $("#jumpMask").style.display="flex"; renderJumpList(); });
$("#jumpClose").addEventListener("click", ()=>{ $("#jumpMask").style.display="none"; });
$("#jumpMask").addEventListener("click", (e)=>{ if(e.target===$("#jumpMask")) $("#jumpMask").style.display="none"; });

/* ===== pick copy modal ===== */
$("#btnCopyPick").addEventListener("click", ()=>{ $("#pickCopyMask").style.display="flex"; renderPickCopyList(); });
$("#pickCopyClose").addEventListener("click", ()=>{ $("#pickCopyMask").style.display="none"; });
$("#pickCopyMask").addEventListener("click", (e)=>{ if(e.target===$("#pickCopyMask")) $("#pickCopyMask").style.display="none"; });

/* ===== Buttons ===== */
$("#btnBackBasicTop").addEventListener("click", ()=>{ setStep(1); showView("viewBasic"); });
$("#btnBackBasic").addEventListener("click", ()=>{ setStep(1); showView("viewBasic"); });

$("#btnStartEquip").addEventListener("click", ()=>{
  state.globalForm = getGlobalForm();
  const ok = buildSessionsFromPlanner();
  if(!ok) return;
  $("#basicStatus").textContent = "已建立";
  openSession(0);
});

$("#btnCopyPrev").addEventListener("click", ()=>{
  if(state.curIdx<=0) return;
  copyEquip(state.curIdx-1, state.curIdx);
  renderAllEquip();
});

$("#btnDoneThis").addEventListener("click", ()=>{
  const s=cur();
  s.done = true;
  // 完成本場後：若還有下一場直接跳下一場；不然跳到輸出
  if(state.curIdx < state.sessions.length-1){
    openSession(state.curIdx+1);
  }else{
    setStep(3); showView("viewQuote"); renderQuote();
  }
});

$("#btnNextSession").addEventListener("click", ()=>{
  if(state.curIdx < state.sessions.length-1){
    openSession(state.curIdx+1);
  }else{
    setStep(3); showView("viewQuote"); renderQuote();
  }
});

$("#btnGoQuote").addEventListener("click", ()=>{ setStep(3); showView("viewQuote"); renderQuote(); });
$("#btnBackEquip").addEventListener("click", ()=>{ openSession(state.curIdx); });

$("#btnPrint").addEventListener("click", printPDF);
$("#btnPrintTop").addEventListener("click", printPDF);
$("#btnSend").addEventListener("click", submitQuote);

/* ===== Step1：不連續日期加入 ===== */
$("#btnNcAdd").addEventListener("click", ()=>{
  const d=normalizeDateStr($("#ncAdd").value||"");
  if(!d){ alert("請先選擇要加入的不連續日期。"); return; }
  state.nonDates = state.nonDates || [];
  if(!state.nonDates.includes(d)) state.nonDates.push(d);
  $("#ncAdd").value="";
  renderNcList();
  renderPlanner();
});

/* ===== 日期變更時更新 planner ===== */
$("#cStart").addEventListener("change", ()=>{ renderPlanner(); });
$("#cEnd").addEventListener("change", ()=>{ renderPlanner(); });

/* ===== init ===== */
(function init(){
  // Step1 城市連動
  fillCityArea($("#fCity"), $("#fArea"), "台中市", "豐原區");

  // Step2 場次資料選單 options 同步（從 Step1 複製）
  fillCityArea($("#sCity"), $("#sArea"), "台中市", "豐原區");
  fillSessionFormOptions();
  bindSessionForm();

  // 初始顯示
  setStep(1);
  showView("viewBasic");
  renderNcList();
  renderPlanner();
})();
</script>
</body>
</html>
  plan: {}, // { "YYYY-MM-DD": { s1:{start,end}, s2:{on,start,end} } }
  sessions: [],
  curIdx: 0
};

/* ========= Part2 會貼資料：TW / CATEGORIES / LEVELS / PACKS... ========= */
  
