<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>活動企劃｜設備選配與即時報價</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --brand:#1e8e6f; --brand2:#156e56; --danger:#e24a4a; --warn:#f59e0b;
      --radius:14px; --shadow:0 10px 28px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.6}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .card h2{font-size:14px;margin:0 0 10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 680px){ .row{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:#374151;margin:0 0 6px}
    input,select,textarea{
      width:100%;padding:10px 10px;border:1px solid var(--line);border-radius:12px;
      font-size:14px;background:#fff;outline:none
    }
    textarea{min-height:92px;resize:vertical}
    .hint{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.5}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chk{display:flex;align-items:center;gap:8px;font-size:13px;color:#111}
    .chk input{width:auto}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer;
      background:var(--brand);color:#fff
    }
    button.secondary{background:#111827}
    button.ghost{background:#fff;color:#111827;border:1px solid var(--line)}
    button.danger{background:var(--danger)}
    button.warn{background:var(--warn);color:#111827}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #f0f2f5;padding:8px;font-size:13px;vertical-align:top}
    .table th{background:#f9fafb;text-align:left;font-size:12px;color:#374151}
    .right{text-align:right}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#f3f4f6;color:#374151;font-size:12px}
    .totals{margin-top:10px;border-top:1px solid var(--line);padding-top:10px}
    .trow{display:flex;justify-content:space-between;gap:12px;padding:4px 0;font-size:13px}
    .trow strong{font-size:16px}
    .ok{color:var(--brand2);font-weight:700}
    .err{color:var(--danger);font-weight:700}
    .small{font-size:12px;color:var(--muted);line-height:1.6}
    .hr{height:1px;background:var(--line);margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>活動企劃｜設備選配與即時報價</h1>
        <div class="sub">送出後會由 Apps Script 自動產生 PDF 報價單並寄信（以實際雙方溝通確認為準）。</div>
      </div>
      <div class="pill">v3（基本資料必完整）</div>
    </header>

    <div class="grid">
      <!-- 左：基本資料 + 明細 -->
      <div class="card">
        <h2>1) 基本資料（有填就一定顯示在 PDF）</h2>

        <div id="basicForm">
          <div class="row">
            <div>
              <label>姓名 / 單位</label>
              <input name="name" data-label="姓名/單位" placeholder="例：王小明 / 柚子樂器" />
            </div>
            <div>
              <label>行動電話</label>
              <input name="phone" data-label="行動電話" placeholder="例：0912-345-678" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Email</label>
              <input name="email" data-label="Email" placeholder="例：abc@gmail.com" />
            </div>
            <div>
              <label>活動類型</label>
              <select name="eventType" data-label="活動類型">
                <option value="">請選擇活動類型</option>
                <option>開幕典禮／剪綵儀式</option>
                <option>記者會／產品發表會</option>
                <option>品牌活動／快閃活動（商場/戶外）</option>
                <option>展覽開幕／展場活動（含舞台時段）</option>
                <option>校慶活動（運動會/園遊會/舞台）</option>
                <option>畢業典禮</option>
                <option>成果發表會（學校/才藝/社團）</option>
                <option>社團成發／迎新送舊晚會</option>
                <option>演講／講座／論壇</option>
                <option>研討會／學術會議（含分場）</option>
                <option>公司內訓／教育訓練／大會</option>
                <option>尾牙／春酒</option>
                <option>公司家庭日／園遊會</option>
                <option>餐會／晚宴（含抽獎、致詞、表演）</option>
                <option>商務交流會／同業公會活動</option>
                <option>演唱會／Live Band 表演</option>
                <option>DJ 派對／電音活動</option>
                <option>舞蹈表演／舞蹈比賽</option>
                <option>戲劇／舞台劇／音樂劇</option>
                <option>親子活動／兒童舞台秀</option>
                <option>慶生會／派對（含包場）</option>
                <option>婚禮（證婚/宴客/After party）</option>
                <option>告別式／追思會（殯儀館/會館/戶外追思）</option>
                <option>宗教活動（廟會/法會/禮拜/慶典）</option>
                <option>社區活動／里民大會／宣導活動（戶外廣播）</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>預估人數</label>
              <select name="crowd" data-label="預估人數">
                <option value="">請選擇</option>
                <option>100人以內</option>
                <option>100到400人</option>
                <option>400至1000人</option>
                <option>1000人至2000人</option>
                <option>2000人以上</option>
              </select>
            </div>
            <div>
              <label>室內 / 戶外</label>
              <select name="indoor" data-label="室內/戶外">
                <option value="">請選擇</option>
                <option>室內</option>
                <option>戶外</option>
                <option>半戶外</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>活動地點（縣市/區）</label>
              <input name="cityArea" data-label="活動地點（縣市/區）" placeholder="例：台中市 豐原區" />
            </div>
            <div>
              <label>詳細地址（路名/號）</label>
              <input name="address" data-label="詳細地址（路名/號）" placeholder="例：圓環東路347號" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>大樓/棟別/樓層/入口（讓地址更清楚）</label>
              <input name="building" data-label="大樓/棟別/樓層/入口" placeholder="例：4樓 / 入口在側門" />
            </div>
            <div>
              <label>地點補充（選填：校園/樓層/場地名稱等）</label>
              <input name="placeNote" data-label="地點補充" placeholder="例：活動中心2樓禮堂 / 操場舞台區" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>活動日期（開始 ～ 結束）</label>
              <div class="inline">
                <input name="dateStart" data-label="活動日期（開始）" type="date" />
                <span class="small">～</span>
                <input name="dateEnd" data-label="活動日期（結束）" type="date" />
              </div>
            </div>
            <div>
              <label>活動時間（只提供 00/10/20/30/40/50 分）</label>
              <div class="inline">
                <input name="timeStart" data-label="活動時間（開始）" type="time" step="600" />
                <span class="small">～</span>
                <input name="timeEnd" data-label="活動時間（結束）" type="time" step="600" />
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <h2 style="margin:0 0 10px">同日第二場（選填）</h2>

          <div class="inline" style="margin-bottom:8px">
            <label class="chk">
              <input type="checkbox" name="hasSession2" data-label="同一天有第二場" />
              同一天有第二場（勾選後可設定第二場時間）
            </label>
          </div>

          <div class="row">
            <div>
              <label>第二場時間</label>
              <div class="inline">
                <input name="session2Start" data-label="第二場時間（開始）" type="time" step="600" />
                <span class="small">～</span>
                <input name="session2End" data-label="第二場時間（結束）" type="time" step="600" />
              </div>
              <div class="hint">提示：第二場只算同一天內的加價，不影響跨天判定。</div>
            </div>
            <div>
              <label>（跨天時）第2天起的第二場日別</label>
              <input name="session2Day" data-label="第二場日別（跨天）" placeholder="例：2（代表第2天）" inputmode="numeric" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div style="grid-column:1 / -1">
              <label>備註 / 需求</label>
              <textarea name="note" data-label="備註/需求" placeholder="例：需要主持麥2支、學校指定走線、舞台尺寸、供電位置等"></textarea>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <h2>2) 報價明細（你可手動新增品項）</h2>
        <div class="row">
          <div>
            <label>分類</label>
            <input id="inCat" placeholder="例：音響 / 燈光 / 舞台 / 方案" />
          </div>
          <div>
            <label>品項</label>
            <input id="inName" placeholder="例：12吋主喇叭 / 無線麥克風 / 方案A" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>數量</label>
            <input id="inQty" type="number" min="1" step="1" value="1" />
          </div>
          <div>
            <label>單價（NT$）</label>
            <input id="inPrice" type="number" min="0" step="1" value="0" />
          </div>
        </div>
        <div class="btns" style="margin-top:10px">
          <button class="ghost" id="btnAdd">加入明細</button>
          <button class="danger" id="btnClear">清空明細</button>
        </div>

        <table class="table" style="margin-top:10px">
          <thead>
            <tr>
              <th style="width:16%">分類</th>
              <th>品項</th>
              <th class="right" style="width:10%">數量</th>
              <th class="right" style="width:14%">單價</th>
              <th class="right" style="width:16%">小計</th>
              <th style="width:70px"></th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>

        <div class="hr"></div>

        <h2>3) 加價規則（可調整）</h2>
        <div class="row">
          <div>
            <label>跨天加價比例（%）</label>
            <input id="dayRate" type="number" min="0" step="1" value="0" />
            <div class="hint">例：填 20 代表「小計 × 20% × 跨天天數」。不加價就填 0。</div>
          </div>
          <div>
            <label>同日第二場加價比例（%）</label>
            <input id="s2Rate" type="number" min="0" step="1" value="30" />
            <div class="hint">預設 30%。若你想固定不加價就填 0。</div>
          </div>
        </div>

      </div>

      <!-- 右：即時報價 + 送出 -->
      <div class="card">
        <h2>4) 即時報價</h2>

        <div class="totals">
          <div class="trow"><span>目前合計</span><span id="subtotal" class="mono">NT$0</span></div>
          <div class="trow" id="dayFeeRow" style="display:none"><span>跨天加價</span><span id="dayFee" class="mono">NT$0</span></div>
          <div class="trow" id="s2FeeRow" style="display:none"><span>同日第二場加價</span><span id="s2Fee" class="mono">NT$0</span></div>
          <div class="trow"><strong>總計</strong><strong id="total" class="mono">NT$0</strong></div>
          <div class="small" id="calcHint"></div>
        </div>

        <div class="btns" style="margin-top:12px">
          <button id="btnSubmit">送出報價單（寄出 PDF）</button>
        </div>

        <div class="hr"></div>
        <div class="small">
          <div><b>送出狀態：</b><span id="status" class="mono">—</span></div>
          <div class="hint">若收不到信，請先確認 Apps Script 已重新部署 Web App，且已授權 MailApp。</div>
        </div>
      </div>
    </div>
  </div>

<script>
/** ✅ 改成你的 Apps Script Web App /exec */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxrphr7gIrOVrrhp1lplR7IYrZdc_8E8cajBEitSoUiujGRE7v8FDy0BYL8VLHaexvq/exec";

const items = [];

const $ = (sel)=>document.querySelector(sel);

function fmt(n){ return "NT$" + (Number(n||0)).toLocaleString(); }

function dayDiffInclusive(dateStart, dateEnd){
  if(!dateStart || !dateEnd) return 0;
  const a = new Date(dateStart);
  const b = new Date(dateEnd);
  if(isNaN(a.getTime()) || isNaN(b.getTime())) return 0;
  const ms = b.getTime() - a.getTime();
  const days = Math.floor(ms / 86400000);
  // 若同一天 -> 0 跨天；若兩天以上 -> days（例：20->21 是 1）
  return Math.max(0, days);
}

function collectForm(containerSel){
  const box = document.querySelector(containerSel);
  const form = {};
  const labels = {};
  if(!box) return {form, labels};

  box.querySelectorAll("input[name], select[name], textarea[name]").forEach(el=>{
    const key = el.name;
    const label = el.dataset.label || key;
    let val = "";

    if(el.type === "checkbox"){
      val = el.checked ? "是" : "";
    }else if(el.type === "radio"){
      if(!el.checked) return;
      val = (el.value ?? "").toString().trim();
    }else{
      val = (el.value ?? "").toString().trim();
    }

    if(val !== ""){
      form[key] = val;
      labels[key] = label;
    }
  });

  return {form, labels};
}

function renderItems(){
  const tb = $("#itemsBody");
  tb.innerHTML = "";
  items.forEach((it, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${it.categoryName || ""}</td>
      <td>${it.name || ""}</td>
      <td class="right">${it.qty || 0}</td>
      <td class="right">${fmt(it.price||0)}</td>
      <td class="right">${fmt(it.lineTotal||0)}</td>
      <td class="right"><button class="ghost" data-del="${idx}">刪除</button></td>
    `;
    tb.appendChild(tr);
  });

  tb.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i = Number(btn.dataset.del);
      items.splice(i, 1);
      recalc();
      renderItems();
    });
  });
}

function recalc(){
  const subtotal = items.reduce((a,it)=>a+Number(it.lineTotal||0), 0);

  const {form} = collectForm("#basicForm");

  const dayRatePct = Number($("#dayRate").value || 0);
  const s2RatePct = Number($("#s2Rate").value || 0);

  const extraDays = dayDiffInclusive(form.dateStart, form.dateEnd);
  const dayFee = extraDays > 0 && dayRatePct > 0 ? Math.round(subtotal * (dayRatePct/100) * extraDays) : 0;

  const hasS2 = form.hasSession2 === "是";
  const s2Fee = hasS2 && s2RatePct > 0 ? Math.round(subtotal * (s2RatePct/100)) : 0;

  const total = subtotal + dayFee + s2Fee;

  $("#subtotal").textContent = fmt(subtotal);
  $("#total").textContent = fmt(total);

  $("#dayFeeRow").style.display = dayFee > 0 ? "" : "none";
  $("#s2FeeRow").style.display = s2Fee > 0 ? "" : "none";
  $("#dayFee").textContent = fmt(dayFee);
  $("#s2Fee").textContent = fmt(s2Fee);

  const hints = [];
  if(dayFee > 0){
    hints.push(`跨天：小計 × ${dayRatePct}% × ${extraDays}天`);
  }
  if(s2Fee > 0){
    hints.push(`第二場：小計 × ${s2RatePct}%`);
  }
  $("#calcHint").textContent = hints.join("／");

  return {subtotal, dayFee, s2Fee, total, extraDays, dayRatePct, s2RatePct};
}

$("#btnAdd").addEventListener("click", (e)=>{
  e.preventDefault();
  const categoryName = ($("#inCat").value || "").trim();
  const name = ($("#inName").value || "").trim();
  const qty = Math.max(1, Number($("#inQty").value || 1));
  const price = Math.max(0, Number($("#inPrice").value || 0));
  if(!name){
    alert("請先填「品項」");
    return;
  }
  const lineTotal = Math.round(qty * price);
  items.push({categoryName, name, qty, price, lineTotal});
  $("#inName").value = "";
  $("#inPrice").value = 0;
  $("#inQty").value = 1;
  recalc();
  renderItems();
});

$("#btnClear").addEventListener("click", (e)=>{
  e.preventDefault();
  if(!confirm("確定清空所有明細？")) return;
  items.length = 0;
  renderItems();
  recalc();
});

["#dayRate","#s2Rate"].forEach(sel=>{
  $(sel).addEventListener("input", ()=>recalc());
});
document.querySelectorAll("#basicForm input, #basicForm select, #basicForm textarea").forEach(el=>{
  el.addEventListener("input", ()=>recalc());
  el.addEventListener("change", ()=>recalc());
});

$("#btnSubmit").addEventListener("click", async ()=>{
  const {form, labels} = collectForm("#basicForm");
  if(!form.name && !form.phone && !form.email){
    alert("至少填「姓名/電話/Email」其中一項，方便聯絡");
    return;
  }
  if(items.length === 0){
    if(!confirm("目前明細為 0 項，仍要送出嗎？")) return;
  }

  const calc = recalc();

  const payload = {
    action: "submitQuote",
    ownerEmail: "", // 你若想前端指定店家收信，也可填在這；不填就用 Sheet 系統設定
    form,
    formLabels: labels,
    items: items,
    summary: {
      subtotal: calc.subtotal,
      dayFee: calc.dayFee,
      session2Fee: calc.s2Fee,
      total: calc.total,
      dayFeeRate: calc.dayRatePct,     // %（PDF 會顯示）
      dayCount: calc.extraDays,        // 跨天天數（PDF 會顯示）
      session2Rate: calc.s2RatePct     // %（PDF 會顯示）
    }
  };

  $("#status").textContent = "sending...";
  try{
    const res = await fetch(WEBAPP_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    if(json.ok){
      $("#status").innerHTML = `<span class="ok">OK</span> orderId=${json.orderId} mailed=${JSON.stringify(json.mailed)}`;
      alert("已送出！請至信箱查看 PDF（也可看 MailLog）。");
    }else{
      $("#status").innerHTML = `<span class="err">ERROR</span> ${json.error || "unknown"}`;
      alert("送出失敗：" + (json.error || "unknown"));
    }
  }catch(err){
    $("#status").innerHTML = `<span class="err">ERROR</span> ${String(err)}`;
    alert("送出失敗：" + String(err));
  }
});

renderItems();
recalc();
</script>
</body>
</html>
