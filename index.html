<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>活動企劃｜設備選配與即時報價</title>
  <style>
    /* 保留原有的 CSS 樣式 */
    #btnMail{display:none !important;}
    :root{
      --bg:#f7fbf9; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --line:#e6efe9;
      --brand:#63bfae; --brand2:#2f8f7b; --blush:#f4b7c4; --mintSoft:#eaf7f3;
      --blushSoft:#fff1f4; --danger:#e25a6a; --shadow:0 10px 28px rgba(0,0,0,.08); --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:10;background:rgba(247,251,249,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .head{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center;padding:14px 18px}
    .title{grid-column:2;display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center}
    .title h1{margin:0;font-size:18px}
    .steps{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap}
    .stepBox{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--mintSoft);border:1px solid var(--line);border-radius:999px;box-shadow:0 10px 26px rgba(0,0,0,.06);white-space:nowrap}
    .stepNum{width:34px;height:34px;border-radius:999px;display:grid;place-items:center;background:rgba(99,191,174,.18);color:var(--brand2);font-weight:900}
    .stepText{font-size:14px;font-weight:750}
    .btn{border:1px solid var(--line);background:var(--card);padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px}
    .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
    .btn.warn{background:#facc15;border-color:#f59e0b;color:#111827}
    .btn.danger{background:var(--danger);border-color:transparent;color:#fff}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:14px;align-items:start}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .hd{padding:14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .form{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted);font-weight:900}
    .field input,.field select,.field textarea{border:1px solid var(--line);border-radius:12px;padding:11px 12px;font-size:14px}
    .span2{grid-column:1/-1}
    .timeRow{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
    .dateRow{display:grid;grid-template-columns:1fr auto 1fr;gap:10px}
    .tabs{padding:14px;display:flex;gap:10px;flex-wrap:wrap;border-top:1px solid var(--line)}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000}
    .tab.active{background:rgba(30,142,111,.12);border-color:rgba(30,142,111,.35);color:var(--brand2)}
    .items{padding:14px;display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;grid-template-columns:74px 1fr auto;gap:12px;align-items:center}
    .thumb{width:74px;height:74px;border-radius:14px;object-fit:cover;background:#f3f4f6}
    .summary{padding:14px;display:grid;gap:12px}
    .totals{border:1px dashed var(--line);border-radius:14px;padding:12px;background:linear-gradient(180deg, rgba(30,142,111,.06), transparent)}
    .trow{display:flex;justify-content:space-between;padding:4px 0}
    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(560px,100%);background:#fff;border-radius:18px;overflow:hidden}
    .modal .mh{padding:14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between}
    .modal .mb{padding:14px}
    @media (max-width:700px){ .items, .form{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <div class="head">
    <div class="title">
      <h1>活動企劃｜設備選配與即時報價</h1>
      <div class="steps">
        <div class="stepBox"><span class="stepNum">1</span><span class="stepText">填寫資料</span></div>
        <div class="stepBox"><span class="stepNum">2</span><span class="stepText">選配器材</span></div>
        <div class="stepBox"><span class="stepNum">3</span><span class="stepText">即時報價</span></div>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card">
      <div class="hd"><h2>1) 基本資料</h2></div>
      <div class="form">
        <div class="field"><label>姓名 / 單位</label><input id="fName" placeholder="例：柚子樂器 / 王小明"></div>
        <div class="field"><label>行動電話</label><input id="fPhone" type="tel" placeholder="例：09xx-xxx-xxx"></div>
        <div class="field"><label>Email</label><input id="fEmail" type="email" placeholder="例：you@example.com"></div>
        <div class="field span2"><label>活動地點</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <select id="fCity"></select><select id="fArea"></select>
          </div>
        </div>
        <div class="field span2"><label>詳細地址</label><input id="fAddr" placeholder="路名/號"></div>
        <div class="field span2"><label>樓層/大樓/入口</label><input id="fBldg" placeholder="例：A棟 3F"></div>
        <div class="field">
          <label>活動類型</label>
          <select id="fEventType">
            <option value="">請選擇</option><option>開幕典禮</option><option>記者會</option><option>品牌活動</option><option>尾牙/春酒</option><option>婚禮</option><option>校慶活動</option>
          </select>
        </div>
        <div class="field">
          <label>預估人數</label>
          <select id="fCrowd">
            <option value="">請選擇</option><option>100人以內</option><option>100-400人</option><option>400-1000人</option>
          </select>
        </div>
        <div class="field"><label>室內 / 戶外</label><select id="fIndoor"><option value="">請選擇</option><option>室內</option><option>戶外</option></select></div>
        <div class="field span2">
          <label>活動日期</label>
          <div class="dateRow">
            <input id="fDateStart" type="date"> <span>～</span> <input id="fDateEnd" type="date">
          </div>
        </div>
        <div class="field span2">
          <label>活動時間</label>
          <div class="timeRow">
            <select id="tStartH"></select>:<select id="tStartM"></select> <span>～</span> <select id="tEndH"></select>:<select id="tEndM"></select>
          </div>
          <input id="fTimeStart" type="hidden"><input id="fTimeEnd" type="hidden">
        </div>
        <div class="field span2">
          <label style="display:flex;align-items:center;gap:10px">
            <input type="checkbox" id="fHasSession2" style="width:18px;height:18px"> 同日第二場（加價 30%）
          </label>
          <div id="session2Wrap" style="display:none;margin-top:10px;padding:12px;border:1px solid var(--line);border-radius:12px">
            <div style="font-weight:900;margin-bottom:8px">第二場時間</div>
            <div class="timeRow">
              <select id="t2StartH"></select>:<select id="t2StartM"></select> <span>～</span> <select id="t2EndH"></select>:<select id="t2EndM"></select>
            </div>
            <input id="fTime2Start" type="hidden"><input id="fTime2End" type="hidden">
            <div id="session2Days" style="margin-top:10px;display:grid;gap:8px"></div>
          </div>
        </div>
        <div class="field span2"><label>備註需求</label><textarea id="fNote" style="min-height:80px"></textarea></div>
      </div>
      
      <div class="hd" style="border-top:1px solid var(--line)"><h2>2) 器材選配</h2></div>
      <div class="tabs" id="tabs"></div>
      <div class="items" id="items"></div>
    </section>

    <aside class="card">
      <div class="hd"><h2>3) 即時報價</h2> <button class="btn warn" id="btnPrint">列印 PDF</button></div>
      <div class="summary">
        <div class="totals">
          <div class="trow"><span>設備小計</span><b id="grandTotal">NT$0</b></div>
          <div class="trow" id="daySurchargeRow" style="display:none"><span>跨天加價</span><b id="daySurcharge">NT$0</b></div>
          <div class="trow" id="session2SurchargeRow" style="display:none"><span>第二場加價</span><b id="session2Surcharge">NT$0</b></div>
          <div class="trow" style="font-size:18px;color:var(--brand2);margin-top:8px;border-top:1px solid var(--line);padding-top:8px">
            <span>總計金額</span><b id="finalTotal">NT$0</b>
          </div>
        </div>
        <div id="cart"></div>
        <button class="btn primary" id="btnSendQuote" style="width:100%;padding:14px;font-size:16px">送出正式報價單</button>
      </div>
    </aside>
  </div>
</div>

<div class="modalMask" id="modalMask">
  <div class="modal">
    <div class="mh"><b id="mTitle">詳情</b><button onclick="document.getElementById('modalMask').style.display='none'">✕</button></div>
    <div class="mb" id="mBody"></div>
  </div>
</div>

<script>
  // 基礎設定
  const BRAND_NAME = "柚子樂器";
  const CATEGORIES = [
    { id:"audio", name:"音響系統", items:[
      { id:"spk-1", name:"主喇叭組", unit:"組", price:6000, img:"https://picsum.photos/seed/audio1/200", desc:"適用小型活動" },
      { id:"mic-1", name:"無線麥克風", unit:"支", price:1000, img:"https://picsum.photos/seed/audio2/200", desc:"高音質手持麥" }
    ]},
    { id:"light", name:"燈光系統", items:[
      { id:"par-1", name:"LED 染色燈", unit:"盞", price:800, img:"https://picsum.photos/seed/light1/200", desc:"氣氛營造" }
    ]}
  ];

  const state = { catId: CATEGORIES[0].id, cart: {}, cat: CATEGORIES };
  const $ = (id) => document.getElementById(id);

  function init() {
    initPickers();
    renderTabs();
    renderItems();
    initListeners();
  }

  function initPickers() {
    const hours = Array.from({length:24},(_,i)=>String(i).padStart(2,'0'));
    const mins = ["00","10","20","30","40","50"];
    const fill = (id, arr) => $(id).innerHTML = arr.map(v=>`<option value="${v}">${v}</option>`).join("");
    ["tStartH","tEndH","t2StartH","t2EndH"].forEach(id=>fill(id, hours));
    ["tStartM","tEndM","t2StartM","t2EndM"].forEach(id=>fill(id, mins));
    
    const city = $("fCity");
    city.innerHTML = '<option value="台中市">台中市</option>';
    $("fArea").innerHTML = '<option value="豐原區">豐原區</option><option value="西屯區">西屯區</option>';
  }

  function renderTabs() {
    $("tabs").innerHTML = CATEGORIES.map(c=>`<button class="tab ${c.id===state.catId?'active':''}" onclick="state.catId='${c.id}';renderAll()">${c.name}</button>`).join("");
  }

  function renderItems() {
    const items = CATEGORIES.find(c=>c.id===state.catId).items;
    $("items").innerHTML = items.map(it=>`
      <div class="item">
        <img src="${it.img}" class="thumb">
        <div><b>${it.name}</b><br><small>NT$${it.price}/${it.unit}</small></div>
        <div style="display:flex;gap:5px">
          <button class="btn" onclick="updateQty('${it.id}',-1)">-</button>
          <span style="min-width:20px;text-align:center">${state.cart[it.id]||0}</span>
          <button class="btn" onclick="updateQty('${it.id}',1)">+</button>
        </div>
      </div>
    `).join("");
  }

  function updateQty(id, delta) {
    state.cart[id] = Math.max(0, (state.cart[id]||0) + delta);
    if(state.cart[id]===0) delete state.cart[id];
    renderAll();
  }

  function renderAll() {
    renderTabs();
    renderItems();
    renderCart();
  }

  function renderCart() {
    let sum = 0;
    let html = "";
    for(const id in state.cart) {
      const it = CATEGORIES.flatMap(c=>c.items).find(i=>i.id===id);
      const sub = it.price * state.cart[id];
      sum += sub;
      html += `<div class="trow"><span>${it.name} x ${state.cart[id]}</span><b>NT$${sub}</b></div>`;
    }
    $("cart").innerHTML = html;
    $("grandTotal").textContent = "NT$" + sum;
    
    const hasS2 = $("fHasSession2").checked;
    const s2Fee = hasS2 ? Math.round(sum * 0.3) : 0;
    $("session2SurchargeRow").style.display = hasS2 ? "flex" : "none";
    $("session2Surcharge").textContent = "NT$" + s2Fee;
    
    $("finalTotal").textContent = "NT$" + (sum + s2Fee);
  }

  function initListeners() {
    $("fHasSession2").onchange = (e) => {
      $("session2Wrap").style.display = e.target.checked ? "block" : "none";
      renderCart();
    };
    $("btnSendQuote").onclick = submitQuoteToAppsScript;
    $("fDateStart").onchange = $("fDateEnd").onchange = renderS2Days;
  }

  function renderS2Days() {
    const ds = $("fDateStart").value;
    const de = $("fDateEnd").value;
    if(!ds || !de || ds===de) { $("session2Days").innerHTML=""; return; }
    const days = Math.floor((new Date(de)-new Date(ds))/(24*60*60*1000));
    let h = "";
    for(let i=1; i<=days; i++) {
      h += `<label><input type="checkbox" data-s2day="1"> 第${i+1}天有第二場</label>`;
    }
    $("session2Days").innerHTML = h;
  }

  async function submitQuoteToAppsScript() {
    const s2Days = Array.from(document.querySelectorAll('input[data-s2day="1"]:checked'))
                        .map(cb => cb.parentNode.textContent.trim()).join(", ");

    const payload = {
      action: "submitQuote",
      form: {
        name: $("fName").value,
        phone: $("fPhone").value,
        email: $("fEmail").value,
        eventType: $("fEventType").value,
        crowd: $("fCrowd").value,
        indoor: $("fIndoor").value,
        dateStart: $("fDateStart").value,
        dateEnd: $("fDateEnd").value,
        timeStart: $("tStartH").value + ":" + $("tStartM").value,
        timeEnd: $("tEndH").value + ":" + $("tEndM").value,
        cityArea: $("fCity").value + $("fArea").value,
        address: $("fAddr").value,
        building: $("fBldg").value,
        note: $("fNote").value,
        hasSession2: $("fHasSession2").checked ? "是" : "否",
        session2Start: $("fHasSession2").checked ? ($("t2StartH").value + ":" + $("t2StartM").value) : "",
        session2End: $("fHasSession2").checked ? ($("t2EndH").value + ":" + $("t2EndM").value) : "",
        session2Day: $("fHasSession2").checked ? s2Days : ""
      },
      items: Object.entries(state.cart).map(([id,qty])=>{
        const it = CATEGORIES.flatMap(c=>c.items).find(i=>i.id===id);
        const cat = CATEGORIES.find(c=>c.items.some(i=>i.id===id));
        return { categoryName: cat.name, name: it.name, qty, unit: it.unit, price: it.price, lineTotal: it.price*qty };
      }),
      summary: {
        subtotal: parseInt($("grandTotal").textContent.replace("NT$","")),
        session2Fee: parseInt($("session2Surcharge").textContent.replace("NT$","")),
        total: parseInt($("finalTotal").textContent.replace("NT$",""))
      }
    };

    const API_URL = "你的_GOOGLE_APPS_SCRIPT_部署網址"; // <--- 請在此處貼上你的網址
    if(API_URL.includes("你的")) return alert("請先填寫 GAS 部署網址");

    try {
      const res = await fetch(API_URL, { method:"POST", body: JSON.stringify(payload) });
      alert("報價單已成功送出！請查收 Email。");
    } catch(e) {
      alert("已送出請求（由於跨網域限制，請查看信箱確認是否收到）。");
    }
  }

  window.onload = init;
</script>
</body>
</html>
