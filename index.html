<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>活動企劃｜燈光音響配置區｜設備選配與即時報價</title>

  <style>
    #btnMail{display:none !important;}
    :root{
      --bg:#f7fbf9;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e6efe9;
      --brand:#63bfae;
      --brand2:#2f8f7b;
      --blush:#f4b7c4;
      --mintSoft:#eaf7f3;
      --blushSoft:#fff1f4;
      --danger:#e25a6a;
      --shadow:0 10px 28px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:10;background:rgba(247,251,249,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .head{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center;padding:14px 18px}
    .title{grid-column:2;display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center}
    .title h1{margin:0;font-size:18px}

    /* 四步驟導覽 */
    .stepsWrap { width: 100%; margin-top: 4px; }
    .steps { display: flex; justify-content: space-between; position: relative; padding: 0; margin: 0; }
    .steps::before { content: ""; position: absolute; top: 15px; left: 10%; right: 10%; height: 2px; background: var(--line); z-index: 0; }
    .stepBox { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; }
    .stepNum { width: 32px; height: 32px; background: var(--card); border: 2px solid var(--brand); color: var(--brand2); font-weight: 900; border-radius: 999px; display: grid; place-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    .stepText { font-size: 13px; font-weight: 800; color: var(--text); text-align: center; line-height: 1.25; }

    .btn{border:1px solid var(--line);background:var(--card);padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px}
    .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
    .btn.danger{background:var(--danger);border-color:transparent;color:#fff}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:14px;align-items:start}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;}
    .card .hd h2{margin:0;font-size:16px}

    .stepHd{position:relative;border-bottom:1px solid var(--line)}
    .step1{background:linear-gradient(90deg, color-mix(in srgb, var(--brand) 18%, #fff), #fff)}
    .step2{background:linear-gradient(90deg, color-mix(in srgb, var(--blush) 18%, #fff), #fff)}
    .step3{background:linear-gradient(90deg, #eff6ff, #fff)}
    .step4{background:linear-gradient(90deg, #fffbeb, #fff)}

    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff;white-space:nowrap}

    .form{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px;min-width:0}
    .field label{font-size:12px;color:var(--muted);font-weight:900}
    .field input,.field select,.field textarea{border:1px solid var(--line);border-radius:12px;padding:11px 12px;background:#fff;outline:none;font-size:14px;min-width:0;max-width:100%}
    .field textarea{min-height:84px;resize:vertical}
    .span2{grid-column:1/-1}

    /* ✅ 日期：固定把「～」放在中間欄，不要壓到輸入框 */
    .dateRow{
      display:grid;
      grid-template-columns:minmax(0,1fr) 28px minmax(0,1fr);
      gap:10px;
      align-items:end;
      min-width:0;
    }
    .dateRow .sep{
      width:28px;
      justify-self:center;
      text-align:center;
      color:var(--muted);
      font-weight:900;
      transform: translateY(-14px);
      pointer-events:none;
      user-select:none;
    }
    .dateCol{display:grid;gap:6px;min-width:0}
    .dateCap{font-size:11px;color:var(--muted);font-weight:900}
    .dateRow input{width:100%;min-width:0}

    .timeRow{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
    .timeRow .sep{color:var(--muted);font-weight:900;text-align:center}
    .timeInputGroup{display:grid;grid-template-columns:1fr 1fr;gap:6px}

    .tabs{padding:12px 14px 14px;display:flex;gap:10px;flex-wrap:wrap;border-top:1px solid var(--line)}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000;font-size:14px}
    .tab.active{background:rgba(30,142,111,.12);border-color:rgba(30,142,111,.35);color:var(--brand2)}

    .items{padding:14px;display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;grid-template-columns:74px 1fr auto;gap:12px;align-items:center;min-width:0}
    .thumb{width:74px;height:74px;border-radius:14px;object-fit:cover;border:1px solid var(--line);background:#f3f4f6}
    .meta{min-width:0}
    .meta .name{font-weight:1000}
    .meta .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .meta .row2{margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .linkbtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:1000;font-size:12px}
    .price{font-weight:1000;text-align:right}

    .qty{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 8px;background:#fff}
    .qbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000}
    .qval{min-width:44px;text-align:center;font-weight:1000}

    .summary{padding:14px;display:grid;gap:12px}
    .totals{border:1px dashed var(--line);border-radius:14px;padding:12px;display:grid;gap:8px;background:linear-gradient(180deg, rgba(30,142,111,.06), transparent)}
    .trow{display:flex;justify-content:space-between;align-items:center;gap:10px}

    .cart{display:grid;gap:12px}
    .citem{position:relative;border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;display:block; padding-right:52px;}
    .xbtn{position:absolute; top:50%; transform:translateY(-50%); right:10px; width:36px;height:36px;border-radius:12px;border:1px solid rgba(226,74,74,.35);background:rgba(226,74,74,.10);color:var(--danger);font-weight:1000;cursor:pointer}

    .tierWrap{padding:14px;display:grid;gap:12px}
    .tierGrid{display:grid;grid-template-columns:1fr;gap:12px}
    .tierCard{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .tierHead{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .levelRow{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;padding:12px;min-width:0}
    .levelBtn{border:1px solid var(--line);border-radius:14px;padding:8px;cursor:pointer;background:#fff;display:flex;flex-direction:column;gap:8px;min-width:0}
    .levelTopRow{display:flex;justify-content:space-between;gap:8px;align-items:flex-start;min-width:0}
    .levelName{font-size:13px;font-weight:900;min-width:0}
    .levelPrice{font-size:12px;font-weight:1000;white-space:nowrap}
    .levelMedia img{width:100%;height:120px;object-fit:cover;display:block;border-radius:8px}
    .levelActions{display:flex;gap:8px;flex-wrap:wrap}
    .miniBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:7px 10px;cursor:pointer;font-weight:1000;font-size:12px}
    .primaryMini{background:var(--brand);border-color:transparent;color:#fff}
    .miniBtn:active{transform:translateY(1px)}

    .sendBar{display:flex;justify-content:flex-end}
    .btn.send{background:#0ea5e9;border-color:#0284c7;color:#fff;font-weight:900}
    .btn.send:hover{filter:brightness(.97)}

    /* Modal */
    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
    .modal{width:min(560px,100%);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 18px 48px rgba(0,0,0,.22);overflow:hidden}
    .modal .mh{padding:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;border-bottom:1px solid var(--line)}
    .modal .mb{padding:14px 14px 20px;}
    .modal .mb p{margin:0;color:#374151;line-height:1.65;white-space:pre-line}

    @media (max-width: 620px) {
      .form { grid-template-columns: 1fr !important; }
      .field input, .field select, .field textarea { font-size: 16px !important; }
      .timeRow { gap: 4px; }
      .timeInputGroup { gap: 4px; }
      .timeInputGroup select { padding: 8px 4px !important; font-size: 13px !important; }

      /* ✅ 手機日期：固定中間欄寬，避免「～」跑進去輸入框 */
      .dateRow{grid-template-columns:minmax(0,1fr) 22px minmax(0,1fr); gap:6px}
      .dateRow .sep{width:22px; transform:translateY(-10px)}

      /* ✅ 手機：等級標題不要被價格擠到斷字（把價格放下一行） */
      .levelTopRow{flex-direction:column;align-items:flex-start;gap:2px}
      .levelName{line-height:1.2}

      .levelRow { grid-template-columns: repeat(2, 1fr); gap: 6px; }
      .levelMedia img { height: 75px; }
      .items { grid-template-columns: repeat(2, 1fr); gap: 6px; }
      .item { display: flex; flex-direction: column; align-items: stretch; padding: 8px; }
      .thumb { width: 100%; height: 90px; }
      .sendBar{justify-content:stretch}
      .btn.send{width:100%}
      .miniBtn{width:100%} /* 兩顆按鈕在手機改成滿版疊放，避免擠壓 */
    }
  </style>
</head>

<body>
<header>
  <div class="head">
    <div class="title">
      <h1>活動企劃｜設備選配與即時報價</h1>
      <div class="stepsWrap">
        <div class="steps">
          <div class="stepBox"><span class="stepNum">1</span><span class="stepText">填寫基本資料</span></div>
          <div class="stepBox"><span class="stepNum">2</span><span class="stepText">選取燈光音響配置</span></div>
          <div class="stepBox"><span class="stepNum">3</span><span class="stepText">選取設備服務加購</span></div>
          <div class="stepBox"><span class="stepNum">4</span><span class="stepText">送出報價單</span></div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card">
      <div class="hd stepHd step1">
        <h2>1) 基本資料</h2>
        <span class="pill" id="pickedCount">0 項已選</span>
      </div>

      <div class="form">
        <div class="field"><label>姓名 / 單位</label><input id="fName" placeholder="例：柚子樂器 / 王小明"></div>
        <div class="field"><label>行動電話</label><input id="fPhone" type="tel" placeholder="09xx-xxx-xxx"></div>
        <div class="field"><label>Email</label><input id="fEmail" type="email" placeholder="you@example.com"></div>
        <div class="field span2"><label>詳細地址</label><input id="fAddr" placeholder="例：中山路 100 號"></div>

        <div class="field span2">
          <label>活動日期（開始 ～ 結束）</label>
          <div class="dateRow">
            <div class="dateCol">
              <div class="dateCap">開始</div>
              <input id="fDateStart" type="date">
            </div>
            <div class="sep">～</div>
            <div class="dateCol">
              <div class="dateCap">結束</div>
              <input id="fDateEnd" type="date">
            </div>
          </div>
        </div>

        <div class="field span2">
          <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted);cursor:pointer;">
            <input type="checkbox" id="fHasExtraDate" style="width:18px;height:18px">
            新增不連續的活動日期 (依原價計算)
          </label>
          <div id="extraDateWrap" style="display:none; margin-top:8px; padding:10px; border:1px dashed var(--line); border-radius:12px; background:#fbfdfc;">
            <div class="dateRow">
              <div class="dateCol">
                <div class="dateCap">額外開始</div>
                <input id="fExtraDateStart" type="date">
              </div>
              <div class="sep">～</div>
              <div class="dateCol">
                <div class="dateCap">額外結束</div>
                <input id="fExtraDateEnd" type="date">
              </div>
            </div>
          </div>
        </div>

        <div class="field span2">
          <label>活動時間</label>
          <div class="timeRow">
            <div class="timeInputGroup">
              <select id="tStartH"></select>
              <select id="tStartM"></select>
            </div>
            <div class="sep">～</div>
            <div class="timeInputGroup">
              <select id="tEndH"></select>
              <select id="tEndM"></select>
            </div>
          </div>
          <input id="fTimeStart" type="hidden">
          <input id="fTimeEnd" type="hidden">
        </div>

        <div class="field span2">
          <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted);cursor:pointer;">
            <input type="checkbox" id="fHasSession2" style="width:18px;height:18px">
            同一天有第二場同性質活動（勾選後可設定第二場時間；第二場加價：原始總價 x 30%）
          </label>

          <div id="session2Wrap" style="display:none; margin-top:8px; padding:10px; border:1px dashed var(--line); border-radius:12px; background:#fbfdfc;">
            <div style="font-weight:1000; margin-bottom:8px; color:var(--text);">第二場時間</div>
            <div class="timeRow">
              <div class="timeInputGroup">
                <select id="t2StartH"></select>
                <select id="t2StartM"></select>
              </div>
              <div class="sep">～</div>
              <div class="timeInputGroup">
                <select id="t2EndH"></select>
                <select id="t2EndM"></select>
              </div>
            </div>
            <input id="fTime2Start" type="hidden">
            <input id="fTime2End" type="hidden">
          </div>
        </div>

        <div class="field span2"><label>備註需求</label><textarea id="fNote"></textarea></div>
      </div>

      <div class="hd stepHd step2" style="border-top:1px solid var(--line);border-bottom:none">
        <h2>2) 燈光音響配置區</h2>
      </div>

      <div class="tierWrap">
        <div class="tierGrid">
          <div class="tierCard">
            <div class="tierHead"><b>安全等級</b></div>
            <div id="levelsSafety" class="levelRow"></div>
          </div>
          <div class="tierCard">
            <div class="tierHead"><b>氣氛等級</b></div>
            <div id="levelsAmbience" class="levelRow"></div>
          </div>
          <div class="tierCard">
            <div class="tierHead"><b>升級等級</b></div>
            <div id="levelsUpgrade" class="levelRow"></div>
          </div>
        </div>
      </div>

      <div class="hd stepHd step3" style="border-top:1px solid var(--line);border-bottom:none">
        <h2>3) 設備/服務分類（自由加減）</h2>
        <span class="pill" id="catName">—</span>
      </div>
      <div class="tabs" id="tabs"></div>
      <div class="items" id="items"></div>
    </section>

    <aside class="card" id="quoteCard">
      <div class="hd stepHd step4"><h2>4) 即時報價</h2></div>
      <div class="summary">
        <div class="totals">
          <div class="trow"><span>總計</span><b id="finalTotal">NT$0</b></div>
        </div>
        <div class="cart" id="cart"></div>
        <div class="sendBar"><button class="btn send" id="btnSendQuote" type="button">送出報價單</button></div>
      </div>
    </aside>
  </div>
</div>

<div class="modalMask" id="modalMask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="mh"><b id="mTitle">詳情</b><button class="xbtn" id="mClose" type="button">✕</button></div>
    <div class="mb"><p id="mBody">—</p></div>
  </div>
</div>

<script>
  /* -----------------------------------------------------------
     你的資料（保持原樣）
     ----------------------------------------------------------- */
  const CATEGORIES = [
    { id:"stage", name:"舞台結構與桁架系統", items:[
      { id:"stage-deck", name:"舞台板（2x1m）", unit:"片", price:1200, img:svgThumb("舞台板"), desc:"標準舞台板。數量優惠：1-19片 1200；20-49片 1100；50片以上 1000。" },
      { id:"stage-backdrop", name:"主視覺背板", unit:"組", price:6500, img:svgThumb("背板"), desc:"基本背板輸出與架設。" },
      { id:"stage-truss", name:"TRUSS 桁架", unit:"支", price:1800, img:svgThumb("TRUSS"), desc:"燈光/布幕架設用。" }
    ]},
    { id:"audio", name:"音響與舞台收音", items:[
      { id:"audio-main", name:"主喇叭組", unit:"組", price:6000, img:svgThumb("主喇叭"), desc:"適合 100-400 人場地。" },
      { id:"audio-wireless2", name:"無線麥克風(2支組)", unit:"組", price:2200, img:svgThumb("無線麥"), desc:"專業等級無線收音。" },
      { id:"staff-audio", name:"音控工程師", unit:"人/場", price:6500, img:svgThumb("音控"), desc:"全程現場控場。" }
    ]},
    { id:"light", name:"燈光與氣氛效果", items:[
      { id:"light-par", name:"LED 染色燈", unit:"盞", price:900, img:svgThumb("染色燈"), desc:"氛圍營造染色。" },
      { id:"light-moving", name:"光束燈", unit:"盞", price:2500, img:svgThumb("光束燈"), desc:"動態舞台燈光效果。" }
    ]},
    { id:"video", name:"影像與投影系統", items:[
      { id:"video-projector", name:"投影機(基本)", unit:"台", price:6500, img:svgThumb("投影"), desc:"會議簡報必備。" }
    ]},
    { id:"site", name:"帳篷桌椅器材", items:[
      { id:"site-tent", name:"快帳(3x3m)", unit:"頂", price:1800, img:svgThumb("快帳"), desc:"戶外遮陽必備。" }
    ]},
    { id:"power", name:"電力營運與安全", items:[
      { id:"power-dist", name:"配電箱組", unit:"套", price:1800, img:svgThumb("配電"), desc:"基本電力分配。" }
    ]}
  ];

  const LEVELS = {
    safety: ["① 基礎穩定","② 標準配置","③ 活動專業","④ 演出進階","⑤ 旗艦舞台","⑥ 全盛典藏"],
    ambience:["① 純淨燈色","② 典禮質感","③ 氛圍層次","④ 視覺焦點","⑤ 沉浸舞台","⑥ 全感體驗"],
    upgrade:["① 亮點入門","② 氣氛效果","③ 儀式震撼","④ 演出支援","⑤ 全方位","⑥ 尊榮規格"]
  };

  const LEVEL_PRICES = {
    safety: [10000, 15000, 20000, 25000, 35000, 50000],
    ambience:[20000, 25000, 35000, 45000, 60000, 80000],
    upgrade: [30000, 40000, 50000, 80000, 100000, 150000]
  };

  function svgThumb(label){ return `https://picsum.photos/seed/${encodeURIComponent(label)}/200`; }
  const state = { catId: "audio", cart: { packs: {} }, tiers: { safety: 0, ambience: 0, upgrade: 0 } };
  const $ = (s)=>document.querySelector(s);
  const fmt = (n)=>"NT$"+Number(n||0).toLocaleString();

  /* -----------------------------------------------------------
     ✅ Modal：恢復「詳情」功能
     ----------------------------------------------------------- */
  function openModal(title, bodyText){
    const mask = $("#modalMask");
    const t = $("#mTitle");
    const b = $("#mBody");
    if(t) t.textContent = title || "詳情";
    if(b) b.textContent = bodyText || "—";
    if(mask){
      mask.style.display = "flex";
      mask.setAttribute("aria-hidden","false");
    }
  }
  function closeModal(){
    const mask = $("#modalMask");
    if(mask){
      mask.style.display = "none";
      mask.setAttribute("aria-hidden","true");
    }
  }

  (function(){
    const mask = $("#modalMask");
    const btn = $("#mClose");
    btn?.addEventListener("click", closeModal);
    mask?.addEventListener("click", (e)=>{ if(e.target===mask) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });
  })();

  function findItemById(itemId){
    for(const c of CATEGORIES){
      const it = c.items.find(x=>x.id===itemId);
      if(it) return {cat:c, item:it};
    }
    return null;
  }

  function openItemDetail(itemId){
    const f = findItemById(itemId);
    if(!f) return;
    const it = f.item;
    const title = `詳情｜${it.name}`;
    const body = `分類：${f.cat.name}\n單價：${fmt(it.price)} / ${it.unit}\n\n${it.desc || "—"}`;
    openModal(title, body);
  }

  function openTierDetail(tierKey, level){
    const name = LEVELS[tierKey]?.[level-1] || `第${level}級`;
    const price = LEVEL_PRICES[tierKey]?.[level-1] || 0;
    const label = ({safety:"安全等級", ambience:"氣氛等級", upgrade:"升級等級"}[tierKey]) || "等級";
    openModal(`詳情｜${label}｜${name}`, `參考價：${fmt(price)}\n\n（此處可放你之後要寫的「包含內容」說明。）`);
  }

  function setHiddenTime(hId, mId, outId){
    const h = document.getElementById(hId)?.value ?? "00";
    const m = document.getElementById(mId)?.value ?? "00";
    const out = document.getElementById(outId);
    if(out) out.value = `${h}:${m}`;
  }

  function initTimePickers(){
    const hours = Array.from({length:24}, (_,i)=>String(i).padStart(2,"0"));
    const mins = ["00","10","20","30","40","50"];
    const fill = (id, arr)=> {
      const el = document.getElementById(id);
      if(el) el.innerHTML = arr.map(v=>`<option value="${v}">${v}</option>`).join("");
    };

    fill("tStartH", hours); fill("tStartM", mins);
    fill("tEndH", hours); fill("tEndM", mins);
    fill("t2StartH", hours); fill("t2StartM", mins);
    fill("t2EndH", hours); fill("t2EndM", mins);

    const safeSet = (id,val)=>{ const el=document.getElementById(id); if(el) el.value=val; }
    safeSet("tStartH","09"); safeSet("tStartM","00");
    safeSet("tEndH","12"); safeSet("tEndM","00");
    safeSet("t2StartH","14"); safeSet("t2StartM","00");
    safeSet("t2EndH","17"); safeSet("t2EndM","00");

    const bind = (hId,mId,outId)=>{
      const h=document.getElementById(hId), m=document.getElementById(mId);
      const fn=()=>setHiddenTime(hId,mId,outId);
      h?.addEventListener("change", fn);
      m?.addEventListener("change", fn);
      fn();
    };
    bind("tStartH","tStartM","fTimeStart");
    bind("tEndH","tEndM","fTimeEnd");
    bind("t2StartH","t2StartM","fTime2Start");
    bind("t2EndH","t2EndM","fTime2End");
  }

  function renderTierButtons(){
    const mk = (tierKey, containerSel) => {
      const el = $(containerSel);
      el.innerHTML = LEVELS[tierKey].map((name, idx)=>{
        const n = idx+1;
        const active = state.tiers[tierKey] === n ? "active" : "";
        return `
          <div class="levelBtn ${active}" role="button" tabindex="0" onclick="selectTier('${tierKey}', ${n})">
            <div class="levelTopRow">
              <span class="levelName">${name}</span>
              <span class="levelPrice">${fmt(LEVEL_PRICES[tierKey][idx])}</span>
            </div>
            <div class="levelMedia"><img src="https://picsum.photos/seed/${tierKey}${n}/200/120" alt=""></div>
            <div class="levelActions">
              <button class="miniBtn primaryMini" type="button" onclick="event.stopPropagation(); selectTier('${tierKey}', ${n});">加入報價</button>
              <button class="miniBtn" type="button" onclick="event.stopPropagation(); openTierDetail('${tierKey}', ${n});">詳情</button>
            </div>
          </div>`;
      }).join("");
    };
    mk("safety","#levelsSafety"); mk("ambience","#levelsAmbience"); mk("upgrade","#levelsUpgrade");
  }

  window.selectTier = (key, n) => {
    state.tiers[key] = n;
    state.cart.packs[key] = { name: LEVELS[key][n-1], price: LEVEL_PRICES[key][n-1] };
    renderAll();
  };

  window.openTierDetail = openTierDetail;

  function renderItems(){
    const cat = CATEGORIES.find(c=>c.id===state.catId) || CATEGORIES[0];
    $("#catName").textContent = cat.name;
    $("#items").innerHTML = cat.items.map(it=>{
      const q = state.cart[it.id] || 0;
      return `
        <div class="item">
          <img class="thumb" src="${it.img}" alt="">
          <div class="meta">
            <div class="name">${it.name}</div>
            <div class="sub">${fmt(it.price)} / ${it.unit}</div>
            <div class="row2">
              <div class="qty">
                <button class="qbtn" type="button" onclick="updateQty('${it.id}',-1)">-</button>
                <div class="qval">${q}</div>
                <button class="qbtn" type="button" onclick="updateQty('${it.id}',1)">+</button>
              </div>
              <button class="linkbtn" type="button" onclick="openItemDetail('${it.id}')">詳情</button>
            </div>
          </div>
          <div class="price">${fmt(it.price * q)}</div>
        </div>`;
    }).join("");
  }

  window.openItemDetail = openItemDetail;

  window.updateQty = (id, delta) => {
    state.cart[id] = Math.max(0, (state.cart[id]||0) + delta);
    if(state.cart[id]===0) delete state.cart[id];
    renderAll();
  };

  function renderCart(){
    let sum = 0;
    const items = [];

    Object.entries(state.cart.packs).forEach(([k, p]) => {
      sum += p.price;
      items.push(`<div class="citem"><div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start"><div style="font-weight:1000">${p.name}</div><div style="font-weight:1000">${fmt(p.price)}</div></div><button class="xbtn" type="button" onclick="deletePack('${k}')">✕</button></div>`);
    });

    CATEGORIES.forEach(c => c.items.forEach(it => {
      const q = state.cart[it.id];
      if(q > 0) {
        sum += it.price * q;
        items.push(`<div class="citem"><div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start"><div style="font-weight:1000">${it.name} x ${q}</div><div style="font-weight:1000">${fmt(it.price*q)}</div></div><button class="xbtn" type="button" onclick="updateQty('${it.id}',-${q})">✕</button></div>`);
      }
    }));

    $("#cart").innerHTML = items.join("");
    $("#finalTotal").textContent = fmt(sum);

    const itemCount = Object.keys(state.cart).filter(k => k !== "packs").length;
    const packCount = Object.keys(state.cart.packs || {}).length;
    $("#pickedCount").textContent = (itemCount + packCount) + " 項已選";
  }

  window.deletePack = (key) => { delete state.cart.packs[key]; state.tiers[key]=0; renderAll(); };

  function renderTabs(){
    $("#tabs").innerHTML = CATEGORIES.map(c => `<button type="button" class="tab ${c.id===state.catId?'active':''}" onclick="state.catId='${c.id}';renderAll()">${c.name}</button>`).join("");
  }

  function renderAll(){ renderTierButtons(); renderTabs(); renderItems(); renderCart(); }

  function bindToggles(){
    const ex = document.getElementById("fHasExtraDate");
    const exWrap = document.getElementById("extraDateWrap");
    const s2 = document.getElementById("fHasSession2");
    const s2Wrap = document.getElementById("session2Wrap");

    const apply = ()=>{
      if(exWrap) exWrap.style.display = ex?.checked ? "block" : "none";
      if(s2Wrap) s2Wrap.style.display = s2?.checked ? "block" : "none";
    };
    ex?.addEventListener("change", apply);
    s2?.addEventListener("change", apply);
    apply();
  }


  /* -----------------------------------------------------------
     ✅ 送出報價單（Apps Script / Google Sheet Web App）
     - 你只要把 ORDER_API_URL 換成你自己的 Web App /exec 連結
     ----------------------------------------------------------- */
  const ORDER_API_URL = ""; // 例如：https://script.google.com/macros/s/XXXX/exec

  
  function buildQuotePayload(){
    const form = {
      name: ($("#fName")?.value || "").trim(),
      phone: ($("#fPhone")?.value || "").trim(),
      email: ($("#fEmail")?.value || "").trim(),
      addr: ($("#fAddr")?.value || "").trim(),
      dateStart: ($("#fDateStart")?.value || "").trim(),
      dateEnd: ($("#fDateEnd")?.value || "").trim(),
      timeStart: ($("#fTimeStart")?.value || "").trim(),
      timeEnd: ($("#fTimeEnd")?.value || "").trim(),
      hasExtraDate: $("#fHasExtraDate")?.checked ? "是" : "否",
      extraDate1: ($("#fExtraDate1")?.value || "").trim(),
      extraDate2: ($("#fExtraDate2")?.value || "").trim(),
      hasSession2: $("#fHasSession2")?.checked ? "是" : "否",
      session2Start: ($("#fSession2Start")?.value || "").trim(),
      session2End: ($("#fSession2End")?.value || "").trim(),
      note: ($("#fNote")?.value || "").trim()
      // 其餘欄位（city/area/bldg/eventType...）若你之後要加，後端模板已支援空值
    };

    // 等級
    const levels = {
      safety: state.tiers.safety,
      ambience: state.tiers.ambience,
      upgrade: state.tiers.upgrade
    };

    // 明細 items：後端 PDFTemplate 期待 categoryName / lineTotal 等欄位
    const items = [];

    // 1) 等級包（當作 qty=1 的品項）
    if(state.cart?.packs){
      for(const [k, p] of Object.entries(state.cart.packs)){
        if(!p) continue;
        items.push({
          categoryName: "燈光音響配置",
          id: `pack-${k}`,
          name: String(p.name || ""),
          qty: 1,
          unit: "組",
          price: Number(p.price || 0),
          lineTotal: Number(p.price || 0)
        });
      }
    }

    // 2) 分類商品
    for(const c of CATEGORIES){
      for(const it of c.items){
        const q = Number(state.cart[it.id] || 0);
        if(q>0){
          const price = Number(it.price || 0);
          items.push({
            categoryName: c.name,
            id: it.id,
            name: it.name,
            qty: q,
            unit: it.unit,
            price,
            lineTotal: price * q
          });
        }
      }
    }

    const subtotal = items.reduce((s, it)=> s + Number(it.lineTotal || 0), 0);

    // 目前依你前端功能：第二場加價 = 原始總價 x 30%
    const session2Fee = (form.hasSession2 === "是") ? Math.round(subtotal * 0.30) : 0;

    // 跨天 / 不連續日期加價：你前端目前沒有完整計價規則，這裡先保留欄位（預設 0）
    const dayFee = 0;

    const total = subtotal + dayFee + session2Fee;

    return {
      action: "submitQuote",
      form,
      levels,
      items,
      summary: { subtotal, dayFee, session2Fee, total }
    };
  }


  function submitQuote(){
    if(!ORDER_API_URL){
      alert("尚未設定 ORDER_API_URL（Apps Script Web App 連結）。\n請把程式碼裡的 ORDER_API_URL 貼上你的 /exec 連結後再試。");
      return;
    }
    const payload = buildQuotePayload();

    // 基本檢查（可依你需求調整）
    if(!payload.form.name){
      alert("請先填寫：姓名 / 單位");
      return;
    }
    if(!payload.form.email){
      alert("請先填寫：Email（用來寄出報價單）");
      return;
    }

    try{
      const ok = navigator.sendBeacon(ORDER_API_URL, JSON.stringify(payload));
      if(ok){
        alert("已送出！系統將依 Apps Script 設定寄出報價單，請至信箱查收。");
      }else{
        // 備援：fetch
        fetch(ORDER_API_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        }).then(r=>r.text()).then(()=>{
          alert("已送出！系統將依 Apps Script 設定寄出報價單，請至信箱查收。");
        }).catch(err=>{
          alert("送出失敗：" + (err?.message || err));
        });
      }
    }catch(e){
      alert("送出失敗：" + (e?.message || e));
    }
  }

  (function bindSubmitBtn(){
    const btn = document.getElementById("btnSendQuote");
    if(btn){
      btn.addEventListener("click", submitQuote);
    }
  })();

  window.onload = () => { initTimePickers(); bindToggles(); renderAll(); };
</script>
</body>
</html>
