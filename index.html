<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>活動企劃｜設備選配與即時報價系統</title>
  <style>
    /* 核心佈局與主題顏色 */
    #btnMail{display:none !important;}
    :root{
      --bg:#f7fbf9;         /* 淡薄荷白 */
      --card:#ffffff;       /* 卡片白 */
      --text:#1f2937;       /* 深灰字 */
      --muted:#6b7280;      /* 次要字 */
      --line:#e6efe9;       /* 薄荷邊線 */
      --brand:#63bfae;      /* 主綠（粉嫩薄荷） */
      --brand2:#2f8f7b;      /* 深綠 */
      --blush:#f4b7c4;      /* 粉嫩點綴 */
      --danger:#e25a6a;     /* 警示紅 */
      --shadow:0 10px 28px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:10;background:rgba(247,251,249,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .head{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr auto 1fr;padding:14px 18px;align-items:center}
    .title{grid-column:2;text-align:center}
    .title h1{margin:0;font-size:18px}
    
    /* 步驟導覽 */
    .steps{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;margin-top:8px}
    .stepBox{display:flex;align-items:center;gap:8px;padding:8px 16px;background:#fff;border:1px solid var(--line);border-radius:999px;font-size:13px;font-weight:700}
    .stepNum{width:24px;height:24px;border-radius:999px;background:var(--brand);color:#fff;display:grid;place-items:center;font-size:11px}
    
    /* 卡片與格線 */
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:14px;align-items:start}
    @media (min-width:920px){ .grid{grid-template-columns:1fr 380px;} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .hd{padding:14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .hd h2{margin:0;font-size:16px;display:flex;align-items:center;gap:8px}
    .step1{background:linear-gradient(90deg, #eaf7f3, #fff)}

    /* 表單樣式 */
    .form{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted);font-weight:900}
    .field input,.field select,.field textarea{border:1px solid var(--line);border-radius:12px;padding:11px 12px;font-size:14px;outline:none}
    .span2{grid-column:1/-1}
    .dateRow, .timeRow{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}

    /* 按鈕與其餘組件 */
    .btn{border:1px solid var(--line);background:#fff;padding:10px 16px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px;transition:0.2s}
    .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
    .btn.primary:hover{background:var(--brand2)}
    .btn.send{background:#0ea5e9;color:#fff;width:100%;margin-top:10px;font-size:15px}
    
    /* 報價清單樣式 */
    .items{padding:14px;display:grid;gap:12px}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;grid-template-columns:60px 1fr auto;gap:12px;align-items:center}
    .thumb{width:60px;height:60px;border-radius:10px;object-fit:cover;background:#f3f4f6}
    .price{font-weight:1000;color:var(--brand2)}
    .summary{padding:14px;background:#fbfdfc}
    .totals{border:1px dashed var(--line);padding:12px;border-radius:12px;margin-bottom:12px}
    .trow{display:flex;justify-content:space-between;margin:4px 0}
    .grand{font-size:18px;font-weight:900;color:var(--danger);border-top:1px solid var(--line);padding-top:8px;margin-top:8px}

    /* 隱藏原生捲軸與其餘細節優化 */
    textarea{min-height:80px;resize:none}
  </style>
</head>
<body>

<header>
  <div class="head">
    <div class="title">
      <h1>柚子樂器｜活動設備報價系統</h1>
      <div class="steps">
        <div class="stepBox"><span class="stepNum">1</span>基本資料</div>
        <div class="stepBox"><span class="stepNum">2</span>配置選取</div>
        <div class="stepBox"><span class="stepNum">3</span>即時報價</div>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <main>
      <section class="card">
        <div class="hd step1"><h2>1) 填寫基本資料</h2></div>
        <div class="form">
          <div class="field"><label>姓名 / 單位</label><input id="fName" placeholder="例如：柚子樂器"></div>
          <div class="field"><label>行動電話</label><input id="fPhone" type="tel" placeholder="09xx-xxx-xxx"></div>
          <div class="field span2"><label>Email (必填，系統將自動寄送 PDF)</label><input id="fEmail" type="email" placeholder="you@example.com"></div>
          
          <div class="field span2">
            <label>活動日期</label>
            <div class="dateRow">
              <input id="fDateStart" type="date">
              <span>～</span>
              <input id="fDateEnd" type="date">
            </div>
          </div>

          <div class="field span2">
            <label>活動地點</label>
            <div class="timeRow" style="grid-template-columns:1fr 1fr 1fr; gap:8px">
              <input id="fCity" placeholder="縣市">
              <input id="fArea" placeholder="區域">
              <input id="fAddr" placeholder="詳細地址">
            </div>
            <input id="fBldg" placeholder="大樓 / 樓層 / 入口備註" style="margin-top:8px">
          </div>

          <div class="field"><label>活動類型</label><input id="fEventType" placeholder="例如：婚禮、成發"></div>
          <div class="field"><label>預估人數</label><input id="fCrowd" placeholder="例如：100人"></div>
          <div class="field span2"><label>需求備註</label><textarea id="fNote" placeholder="如有特殊用電需求或進場限制請註明"></textarea></div>
        </div>
      </section>

      <section class="card" style="margin-top:16px">
        <div class="hd"><h2>2) 設備選取</h2></div>
        <div class="items" id="itemList">
          </div>
      </section>
    </main>

    <aside>
      <div class="card" style="position:sticky; top:80px">
        <div class="hd"><h2>即時報價摘要</h2></div>
        <div class="summary">
          <div id="cartItems" style="font-size:13px; margin-bottom:12px; color:var(--muted)">尚未選取任何設備</div>
          <div class="totals">
            <div class="trow"><span>設備小計</span><span id="subtotal">NT$0</span></div>
            <div class="trow grand"><span>總計金額</span><span id="totalPrice">NT$0</span></div>
          </div>
          <button class="btn primary send" id="btnSendQuote" onclick="submitQuoteToAppsScript()">確認並送出報價單</button>
          <p style="font-size:11px; color:var(--muted); text-align:center; margin-top:10px">
            點擊送出後，系統將產出正式 PDF 報價單
          </p>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
  // 資料設定區
  const PRODUCTS = [
    { id: "audio_1", name: "標準音響套裝", price: 8000, unit: "套", img: "https://via.placeholder.com/60" },
    { id: "light_1", name: "舞台染色燈", price: 800, unit: "盞", img: "https://via.placeholder.com/60" },
    { id: "stage_1", name: "結構 Truss (3米)", price: 1500, unit: "支", img: "https://via.placeholder.com/60" }
  ];

  let cart = {};

  // 初始化產品清單
  function init() {
    const list = document.getElementById("itemList");
    list.innerHTML = PRODUCTS.map(p => `
      <div class="item">
        <img src="${p.img}" class="thumb">
        <div>
          <div style="font-weight:800">${p.name}</div>
          <div style="font-size:12px; color:var(--muted)">NT$${p.price.toLocaleString()} / ${p.unit}</div>
        </div>
        <input type="number" min="0" value="0" style="width:50px" onchange="updateCart('${p.id}', this.value)">
      </div>
    `).join("");
  }

  function updateCart(id, qty) {
    if (qty > 0) cart[id] = parseInt(qty);
    else delete cart[id];
    renderSummary();
  }

  function renderSummary() {
    let subtotal = 0;
    let html = "";
    for (let id in cart) {
      const p = PRODUCTS.find(x => x.id === id);
      const line = p.price * cart[id];
      subtotal += line;
      html += `<div>${p.name} x ${cart[id]}</div>`;
    }
    document.getElementById("cartItems").innerHTML = html || "尚未選取任何設備";
    document.getElementById("subtotal").textContent = `NT$${subtotal.toLocaleString()}`;
    document.getElementById("totalPrice").textContent = `NT$${subtotal.toLocaleString()}`;
  }

  // 核心修正：完整打包所有欄位送往 GAS
  async function submitQuoteToAppsScript() {
    const btn = document.getElementById("btnSendQuote");
    const email = document.getElementById("fEmail").value;
    
    if (!email) return alert("請輸入電子郵件以接收報價單！");
    
    btn.disabled = true;
    btn.textContent = "處理中...";

    // 打包所有前端看到的欄位
    const payload = {
      action: "submitQuote",
      form: {
        name: document.getElementById("fName").value,
        phone: document.getElementById("fPhone").value,
        email: email,
        dateStart: document.getElementById("fDateStart").value,
        dateEnd: document.getElementById("fDateEnd").value,
        city: document.getElementById("fCity").value,
        area: document.getElementById("fArea").value,
        addr: document.getElementById("fAddr").value,
        bldg: document.getElementById("fBldg").value,
        eventType: document.getElementById("fEventType").value,
        crowd: document.getElementById("fCrowd").value,
        note: document.getElementById("fNote").value
      },
      items: Object.keys(cart).map(id => {
        const p = PRODUCTS.find(x => x.id === id);
        return { name: p.name, qty: cart[id], price: p.price, unit: p.unit, lineTotal: p.price * cart[id] };
      }),
      summary: { total: document.getElementById("totalPrice").textContent.replace("NT$","").replace(",","") }
    };

    try {
      // 請將此處替換為您的 Google Apps Script 部署網址
      const GAS_URL = "https://script.google.com/macros/s/AKfycbxrphr7gIrOVrrhp1lplR7IYrZdc_8E8cajBEitSoUiujGRE7v8FDy0BYL8VLHaexvq/exec";
      
      await fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(payload)
      });
      
      alert("報價單已排程送出！請於 1-3 分鐘後查看您的信箱。");
    } catch (e) {
      alert("連線失敗，請檢查網路或 API 網址！");
    } finally {
      btn.disabled = false;
      btn.textContent = "確認並送出報價單";
    }
  }

  init();
</script>
</body>
</html>
