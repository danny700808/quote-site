<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>活動企劃｜燈光音響配置區｜設備選配與即時報價</title>

  <style>
    #btnMail{display:none !important;}
    :root{
      --bg:#f7fbf9;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e6efe9;
      --brand:#63bfae;
      --brand2:#2f8f7b;
      --blush:#f4b7c4;
      --mintSoft:#eaf7f3;
      --blushSoft:#fff1f4;
      --danger:#e25a6a;
      --shadow:0 10px 28px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:10;background:rgba(247,251,249,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .head{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center;padding:14px 18px}
    .title{grid-column:2;display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center}
    .title h1{margin:0;font-size:18px}

    /* 四步驟導覽 */
    .stepsWrap { width: 100%; margin-top: 4px; }
    .steps { display: flex; justify-content: space-between; position: relative; padding: 0; margin: 0; }
    .steps::before { content: ""; position: absolute; top: 15px; left: 10%; right: 10%; height: 2px; background: var(--line); z-index: 0; }
    .stepBox { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; }
    .stepNum { width: 32px; height: 32px; background: var(--card); border: 2px solid var(--brand); color: var(--brand2); font-weight: 900; border-radius: 999px; display: grid; place-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    .stepText { font-size: 13px; font-weight: 800; color: var(--text); text-align: center; line-height: 1.25; }

    .btn{border:1px solid var(--line);background:var(--card);padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px}
    .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
    .btn.danger{background:var(--danger);border-color:transparent;color:#fff}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:14px;align-items:start}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;}
    .card .hd h2{margin:0;font-size:16px}

    .stepHd{position:relative;border-bottom:1px solid var(--line)}
    .step1{background:linear-gradient(90deg, color-mix(in srgb, var(--brand) 18%, #fff), #fff)}
    .step2{background:linear-gradient(90deg, color-mix(in srgb, var(--blush) 18%, #fff), #fff)}
    .step3{background:linear-gradient(90deg, #eff6ff, #fff)}
    .step4{background:linear-gradient(90deg, #fffbeb, #fff)}

    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff;white-space:nowrap}

    .form{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px;min-width:0}
    .field label{font-size:12px;color:var(--muted);font-weight:900}
    .field input,.field select,.field textarea{border:1px solid var(--line);border-radius:12px;padding:11px 12px;background:#fff;outline:none;font-size:14px;min-width:0;max-width:100%}
    .field textarea{min-height:84px;resize:vertical}
    .span2{grid-column:1/-1}

    .mutedNote{font-size:12px;color:var(--muted);line-height:1.35}
    .detailsBox{border:1px solid var(--line);border-radius:14px;background:#fff;overflow:hidden}
    .detailsBox > summary{cursor:pointer;list-style:none;padding:12px 12px;font-weight:1000;color:var(--text);display:flex;align-items:center;justify-content:space-between}
    .detailsBox > summary::-webkit-details-marker{display:none}
    .detailsBody{padding:12px;border-top:1px solid var(--line);display:flex;flex-direction:column;gap:10px}
    .dayList{display:flex;flex-direction:column;gap:10px}
    .dayRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:color-mix(in srgb, var(--mintSoft) 55%, #fff)}
    .dayRow .dleft{display:flex;flex-direction:column;gap:4px;min-width:0}
    .dayRow .dtitle{font-weight:1000}
    .dayRow .dsub{font-size:12px;color:var(--muted)}
    .dayRow label{display:flex;align-items:center;gap:8px;font-weight:900;color:var(--muted);white-space:nowrap}
    .dateSummary{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px dashed var(--line);background:color-mix(in srgb, var(--blushSoft) 55%, #fff);font-weight:1000}

    /* ✅ 日期：固定把「～」放在中間欄，不要壓到輸入框 */
    .dateRow{
      display:grid;
      grid-template-columns:minmax(0,1fr) 28px minmax(0,1fr);
      gap:10px;
      align-items:end;
      min-width:0;
    }
    .dateRow .sep{
      width:28px;
      justify-self:center;
      text-align:center;
      color:var(--muted);
      font-weight:900;
      transform: translateY(-14px);
      pointer-events:none;
      user-select:none;
    }
    .dateCol{display:grid;gap:6px;min-width:0}
    .dateCap{font-size:11px;color:var(--muted);font-weight:900}
    .dateRow input{width:100%;min-width:0}

    .timeRow{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
    .timeRow .sep{color:var(--muted);font-weight:900;text-align:center}
    .timeInputGroup{display:grid;grid-template-columns:1fr 1fr;gap:6px}

    .tabs{padding:12px 14px 14px;display:flex;gap:10px;flex-wrap:wrap;border-top:1px solid var(--line)}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000;font-size:14px}
    .tab.active{background:rgba(30,142,111,.12);border-color:rgba(30,142,111,.35);color:var(--brand2)}

    .items{padding:14px;display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;grid-template-columns:74px 1fr auto;gap:12px;align-items:center;min-width:0}
    .thumb{width:74px;height:74px;border-radius:14px;object-fit:cover;border:1px solid var(--line);background:#f3f4f6}
    .meta{min-width:0}
    .meta .name{font-weight:1000}
    .meta .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .meta .row2{margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .linkbtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:1000;font-size:12px}
    .price{font-weight:1000;text-align:right}

    .qty{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 8px;background:#fff}
    .qbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000}
    .qval{min-width:44px;text-align:center;font-weight:1000}

    .summary{padding:14px;display:grid;gap:12px}
    .totals{border:1px dashed var(--line);border-radius:14px;padding:12px;display:grid;gap:8px;background:linear-gradient(180deg, rgba(30,142,111,.06), transparent)}
    .trow{display:flex;justify-content:space-between;align-items:center;gap:10px}

    .cart{display:grid;gap:12px}
    .citem{position:relative;border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;display:block; padding-right:52px;}
    .xbtn{position:absolute; top:50%; transform:translateY(-50%); right:10px; width:36px;height:36px;border-radius:12px;border:1px solid rgba(226,74,74,.35);background:rgba(226,74,74,.10);color:var(--danger);font-weight:1000;cursor:pointer}

    .tierWrap{padding:14px;display:grid;gap:12px}
    .tierGrid{display:grid;grid-template-columns:1fr;gap:12px}
    .tierCard{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .tierHead{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .levelRow{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;padding:12px;min-width:0}
    .levelBtn{border:1px solid var(--line);border-radius:14px;padding:8px;cursor:pointer;background:#fff;display:flex;flex-direction:column;gap:8px;min-width:0}
    .levelTopRow{display:flex;justify-content:space-between;gap:8px;align-items:flex-start;min-width:0}
    .levelName{font-size:13px;font-weight:900;min-width:0}
    .levelPrice{font-size:12px;font-weight:1000;white-space:nowrap}
    .levelMedia img{width:100%;height:120px;object-fit:cover;display:block;border-radius:8px}

    .levelTopRow{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .levelTopRow .lvlName{flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .levelTopRow .lvlPrice{flex-shrink:0;white-space:nowrap}
    .miniBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:1000;font-size:13px}
    .miniBtn.ghost{background:rgba(99,191,174,.10);border-color:rgba(47,143,123,.25);color:var(--brand2)}

    .levelActions{display:flex;gap:8px;flex-wrap:wrap}
    .miniBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:7px 10px;cursor:pointer;font-weight:1000;font-size:12px}
    .primaryMini{background:var(--brand);border-color:transparent;color:#fff}
    .miniBtn:active{transform:translateY(1px)}

    .sendBar{display:flex;justify-content:flex-end}
    .btn.send{background:#0ea5e9;border-color:#0284c7;color:#fff;font-weight:900}
    .btn.send:hover{filter:brightness(.97)}

    /* Modal */
    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
    .modal{width:min(560px,100%);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 18px 48px rgba(0,0,0,.22);overflow:hidden}
    .modal .mh{padding:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;border-bottom:1px solid var(--line)}
    .modal .mb{padding:14px 14px 20px;}
    .modal .mb p{margin:0;color:#374151;line-height:1.65;white-space:pre-line}

    @media (max-width: 620px) {
      .form { grid-template-columns: 1fr !important; }
      .field input, .field select, .field textarea { font-size: 16px !important; }
      .timeRow { gap: 4px; }
      .timeInputGroup { gap: 4px; }
      .timeInputGroup select { padding: 8px 4px !important; font-size: 13px !important; }

      /* ✅ 手機日期：固定中間欄寬，避免「～」跑進去輸入框 */
      .dateRow{grid-template-columns:minmax(0,1fr) 22px minmax(0,1fr); gap:6px}
      .dateRow .sep{width:22px; transform:translateY(-10px)}

      /* ✅ 手機：等級標題不要被價格擠到斷字（把價格放下一行） */
      .levelTopRow{flex-direction:column;align-items:flex-start;gap:2px}
      .levelName{line-height:1.2}

      .levelRow { grid-template-columns: repeat(2, 1fr); gap: 6px; }
      .levelMedia img { height: 75px; }
      .items { grid-template-columns: repeat(2, 1fr); gap: 6px; }
      .item { display: flex; flex-direction: column; align-items: stretch; padding: 8px; }
      .thumb { width: 100%; height: 90px; }
      .sendBar{justify-content:stretch}
      .btn.send{width:100%}
      .miniBtn{width:100%} /* 兩顆按鈕在手機改成滿版疊放，避免擠壓 */
    }
  
    /* ✅ 加價規則提示（短版＋可展開） */
    .form > .feeHint{grid-column:1/-1}
    .feeHint{
      margin-top:10px;
      border:1px dashed var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:linear-gradient(180deg, rgba(99,191,174,.10), transparent);
      font-size:12px;
      line-height:1.55;
    }
    .feeHint b{font-weight:1000}
    .feeHint .muted{color:var(--muted);font-weight:900}
    .feeDetails{margin-top:6px}
    .feeDetails summary{
      cursor:pointer;
      font-weight:1000;
      color:var(--brand2);
      list-style:none;
      outline:none;
    }
    .feeDetails summary::-webkit-details-marker{display:none}
    .feeDetails summary:before{content:"＋ ";font-weight:1000}
    details[open].feeDetails summary:before{content:"－ "}
    .feeDetails ul{margin:8px 0 0 18px;padding:0;color:var(--muted)}
    .feeDetails li{margin:4px 0}

    /* ✅ 等級卡片：避免手機上文字尷尬斷行 + 顯示「詳情」 */
    .levelTopRow{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .levelName{font-size:13px;font-weight:1000;line-height:1.2}
    .levelPrice{font-size:12px;font-weight:1000;white-space:nowrap}
    .levelActions{display:flex;gap:8px;margin-top:8px}
    .levelActions .miniBtn{flex:1}

    /* ✅ 品項卡：讓「詳情」在手機也明顯可點 */
    .row2{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}
    .linkbtn{white-space:nowrap}

    @media (max-width: 620px) {
      .levelTopRow{display:block}
      .levelPrice{display:block;text-align:right;margin-top:4px}
      .levelActions{display:grid;grid-template-columns:1fr 1fr;gap:6px}
      .levelActions .miniBtn{padding:10px 8px;font-size:13px}
      .row2{gap:8px}
    }

</style>
</head>

<body>
<header>
  <div class="head">
    <div class="title">
      <h1>活動企劃｜設備選配與即時報價</h1>
      <div class="stepsWrap">
        <div class="steps">
          <div class="stepBox"><span class="stepNum">1</span><span class="stepText">填寫基本資料</span></div>
          <div class="stepBox"><span class="stepNum">2</span><span class="stepText">選取燈光音響配置</span></div>
          <div class="stepBox"><span class="stepNum">3</span><span class="stepText">選取設備服務加購</span></div>
          <div class="stepBox"><span class="stepNum">4</span><span class="stepText">送出報價單</span></div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card">
      <div class="hd stepHd step1">
        <h2>1) 基本資料</h2>
        <span class="pill" id="pickedCount">0 項已選</span>
      </div>

      
      <div class="form">
        <div class="field"><label>姓名 / 單位</label><input id="fName" placeholder="例：柚子樂器 / 王小明"></div>
        <div class="field"><label>行動電話</label><input id="fPhone" type="tel" placeholder="09xx-xxx-xxx"></div>

        <div class="field"><label>Email</label><input id="fEmail" type="email" placeholder="example@gmail.com"></div>
        <div class="field"><label>活動類型</label><select id="fEventType"></select></div>

        <div class="field"><label>預估人數</label><select id="fCrowd"></select></div>
        <div class="field"><label>室內 / 戶外</label>
          <select id="fIndoor">
            <option value="">未填</option>
            <option value="室內">室內</option>
            <option value="戶外">戶外</option>
            <option value="半室內">半室內</option>
          </select>
        </div>

        <div class="field"><label>縣市（選填）</label><select id="fCity"><option value="">請選擇縣市</option></select></div>
        <div class="field"><label>區域（選填）</label><select id="fArea" disabled><option value="">請先選縣市</option></select></div>

        <div class="field span2"><label>詳細地址</label><input id="fAddr" placeholder="例：中山路 100 號"></div>
        <div class="field span2"><label>樓層 / 場地補充（選填）</label><input id="fBldg" placeholder="例：4樓 / 禮堂 / 操場"></div>

        <div class="field span2">
          <label>活動日期</label>
          <div class="dateRow" style="grid-template-columns:1fr auto 1fr;">
            <input id="fDateStart" type="date">
            <div id="dateSep" class="sep" style="display:none">～</div>
            <input id="fDateEnd" type="date" style="display:none">
          </div>
          <label style="margin-top:8px;display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted);cursor:pointer;">
            <input type="checkbox" id="fHasExtraDate" style="width:18px;height:18px">
            活動不只一天（連續多日；第2天 50%、第3天起每天 30%）
          </label>

          <div id="multiDayWrap" style="display:none;margin-top:10px;">
            <details class="detailsBox" id="dailyDetails">
              <summary>每日場次設定（選填）</summary>
              <div class="detailsBody">
                <div class="mutedNote">預設每天 1 場；勾選該天第二場則加收：原始總價 × 30%。</div>
                <div id="dailySecondSessionList" class="dayList"></div>
              </div>
            </details>
          </div>

          <div id="dateSummary" class="dateSummary">—</div>

        </div>

        <div class="field span2">
          <label>活動時間</label>
          <div class="timeRow">
            <div class="timeInputGroup">
              <select id="tStartH"></select>
              <select id="tStartM"></select>
            </div>
            <div class="sep">～</div>
            <div class="timeInputGroup">
              <select id="tEndH"></select>
              <select id="tEndM"></select>
            </div>
          </div>
          <input id="fTimeStart" type="hidden">
          <input id="fTimeEnd" type="hidden">
        </div>

        <div class="field span2" id="singleDaySession2Wrap">
          <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted);cursor:pointer;">
            <input type="checkbox" id="fHasSession2" style="width:18px;height:18px">
            同一天有第二場同性質活動（第二場加價：原始總價 × 30%）
          </label>
        </div>


        <div class="field span2" id="session2TimeWrap" style="display:none">
          <label>第二場時間（選填）</label>
          <div class="timeRow">
            <div class="timeInputGroup">
              <select id="t2StartH"></select>
              <select id="t2StartM"></select>
            </div>
            <div class="sep">～</div>
            <div class="timeInputGroup">
              <select id="t2EndH"></select>
              <select id="t2EndM"></select>
            </div>
          </div>
          <input id="fTime2Start" type="hidden">
          <input id="fTime2End" type="hidden">
          <div class="mutedNote">若你勾選多日的「每日第二場」，此時間會套用在有第二場的日期。</div>
        </div>


        <div class="field span2"><label>備註需求</label><textarea id="fNote"></textarea></div>
      </div>


      <div class="hd stepHd step2" style="border-top:1px solid var(--line);border-bottom:none">
        <h2>2) 燈光音響配置區</h2>
      </div>

      <div class="tierWrap">
        <div class="tierGrid">
          <div class="tierCard">
            <div class="tierHead"><b>安全等級</b></div>
            <div id="levelsSafety" class="levelRow"></div>
          </div>
          <div class="tierCard">
            <div class="tierHead"><b>氣氛等級</b></div>
            <div id="levelsAmbience" class="levelRow"></div>
          </div>
          <div class="tierCard">
            <div class="tierHead"><b>升級等級</b></div>
            <div id="levelsUpgrade" class="levelRow"></div>
          </div>
        </div>
      </div>

      <div class="hd stepHd step3" style="border-top:1px solid var(--line);border-bottom:none">
        <h2>3) 設備/服務分類（自由加減）</h2>
        <span class="pill" id="catName">—</span>
      </div>
      <div class="tabs" id="tabs"></div>
      <div class="items" id="items"></div>
    </section>

    <aside class="card" id="quoteCard">
      <div class="hd stepHd step4"><h2>4) 即時報價</h2></div>
      <div class="summary">
        <div class="totals">
          <div class="trow"><span>設備小計</span><b id="subTotal">NT$0</b></div>
          <div class="trow"><span>日期加價</span><b id="dayFee">NT$0</b></div>
          <div class="trow"><span>第二場加價</span><b id="session2Fee">NT$0</b></div>
          <div class="trow" style="border-top:1px dashed var(--line);padding-top:10px;margin-top:6px;"><span>總計</span><b id="finalTotal">NT$0</b></div>
        </div>
        <div class="cart" id="cart"></div>
        <div class="sendBar"><button class="btn send" id="btnSendQuote" type="button">送出報價單</button></div>
      </div>
    </aside>
  </div>
</div>

<div class="modalMask" id="modalMask" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="mh"><b id="mTitle">詳情</b><button class="xbtn" id="mClose" type="button">✕</button></div>
    <div class="mb"><p id="mBody">—</p></div>
  </div>
</div>

<script>
  /* -----------------------------------------------------------
     你的資料（保持原樣）
     ----------------------------------------------------------- */
  const CATEGORIES = [
    { id:"stage", name:"舞台結構與桁架系統", items:[
      { id:"stage-deck", name:"舞台板（2x1m）", unit:"片", price:1200, img:svgThumb("舞台板"), desc:"標準舞台板。數量優惠：1-19片 1200；20-49片 1100；50片以上 1000。" },
      { id:"stage-backdrop", name:"主視覺背板", unit:"組", price:6500, img:svgThumb("背板"), desc:"基本背板輸出與架設。" },
      { id:"stage-truss", name:"TRUSS 桁架", unit:"支", price:1800, img:svgThumb("TRUSS"), desc:"燈光/布幕架設用。" }
    ]},
    { id:"audio", name:"音響與舞台收音", items:[
      { id:"audio-main", name:"主喇叭組", unit:"組", price:6000, img:svgThumb("主喇叭"), desc:"適合 100-400 人場地。" },
      { id:"audio-wireless2", name:"無線麥克風(2支組)", unit:"組", price:2200, img:svgThumb("無線麥"), desc:"專業等級無線收音。" },
      { id:"staff-audio", name:"音控工程師", unit:"人/場", price:6500, img:svgThumb("音控"), desc:"全程現場控場。" }
    ]},
    { id:"light", name:"燈光與氣氛效果", items:[
      { id:"light-par", name:"LED 染色燈", unit:"盞", price:900, img:svgThumb("染色燈"), desc:"氛圍營造染色。" },
      { id:"light-moving", name:"光束燈", unit:"盞", price:2500, img:svgThumb("光束燈"), desc:"動態舞台燈光效果。" }
    ]},
    { id:"video", name:"影像與投影系統", items:[
      { id:"video-projector", name:"投影機(基本)", unit:"台", price:6500, img:svgThumb("投影"), desc:"會議簡報必備。" }
    ]},
    { id:"site", name:"帳篷桌椅器材", items:[
      { id:"site-tent", name:"快帳(3x3m)", unit:"頂", price:1800, img:svgThumb("快帳"), desc:"戶外遮陽必備。" }
    ]},
    { id:"power", name:"電力營運與安全", items:[
      { id:"power-dist", name:"配電箱組", unit:"套", price:1800, img:svgThumb("配電"), desc:"基本電力分配。" }
    ]}
  ];

  const LEVELS = {
    safety: ["① 基礎穩定","② 標準配置","③ 活動專業","④ 演出進階","⑤ 旗艦舞台","⑥ 全盛典藏"],
    ambience:["① 純淨燈色","② 典禮質感","③ 氛圍層次","④ 視覺焦點","⑤ 沉浸舞台","⑥ 全感體驗"],
    upgrade:["① 亮點入門","② 氣氛效果","③ 儀式震撼","④ 演出支援","⑤ 全方位","⑥ 尊榮規格"]
  };

  const LEVEL_DETAILS = {
  "safety": [
    "基本舞台與器材安全配置，適合小型活動。",
    "標準安全配置，含必要固定與防護。",
    "專業活動安全配置，適合一般商演。",
    "進階安全配置，含更多備援與控管。",
    "旗艦級安全配置，適合大型舞台。",
    "全盛典藏規格，最高等級備援與控場。"
  ],
  "ambience": [
    "簡潔燈色，明亮乾淨。",
    "典禮質感燈色與氛圍。",
    "層次氛圍，增加視覺變化。",
    "舞台焦點與視覺主題。",
    "沉浸式視覺，適合演出。",
    "全感體驗，氛圍拉滿。"
  ],
  "upgrade": [
    "入門亮點與基本效果。",
    "增加氣氛效果與小型特效。",
    "儀式感震撼效果更完整。",
    "支援演出需求與舞台效果。",
    "全方位升級，涵蓋多面向。",
    "尊榮規格，最高等級呈現。"
  ]
};
  const LEVEL_PRICES = {
    safety: [10000, 15000, 20000, 25000, 35000, 50000],
    ambience:[20000, 25000, 35000, 45000, 60000, 80000],
    upgrade: [30000, 40000, 50000, 80000, 100000, 150000]
  };

  function svgThumb(label){ return `https://picsum.photos/seed/${encodeURIComponent(label)}/200`; }
  const state = { catId: "audio", cart: { packs: {} }, tiers: { safety: 0, ambience: 0, upgrade: 0 } };
  const $ = (s)=>document.querySelector(s);
  const fmt = (n)=>"NT$"+Number(n||0).toLocaleString();

  function initBasicSelects(){
    const eventTypes = ["開幕典禮","成果發表","畢業典禮","校慶活動","社團成發","尾牙春酒","婚禮宴會","喪禮追思","市集活動","演唱會/表演"];
    const crowds = ["未填","100人以下","100-400人","500人","1000人","3000人"];
    const et = document.getElementById("fEventType");
    if(et){
      et.innerHTML = `<option value="">請選擇</option>` + eventTypes.map(v=>`<option value="${v}">${v}</option>`).join("");
    }
    const cr = document.getElementById("fCrowd");
    if(cr){
      cr.innerHTML = crowds.map(v=>`<option value="${v==='未填'?'':v}">${v}</option>`).join("");
    }
  }

  function bindToggles(){
    const cbMulti = document.getElementById("fHasExtraDate"); // 連續多日
    const sep = document.getElementById("dateSep");
    const end = document.getElementById("fDateEnd");
    const multiWrap = document.getElementById("multiDayWrap");
    const dayList = document.getElementById("dailySecondSessionList");
    const summaryEl = document.getElementById("dateSummary");

    const singleS2Wrap = document.getElementById("singleDaySession2Wrap");
    const singleS2 = document.getElementById("fHasSession2");
    const s2TimeWrap = document.getElementById("session2TimeWrap");

    const isoToDate = (iso)=>{
      if(!iso) return null;
      const [y,m,d] = iso.split("-").map(n=>Number(n));
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d);
    };
    const dateToISO = (dt)=>{
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const d = String(dt.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    };
    const enumerateDateISOs = (startIso, endIso, maxDays=60)=>{
      const s = isoToDate(startIso);
      const e = isoToDate(endIso);
      if(!s || !e) return [];
      if(e < s) return [];
      const out = [];
      const cur = new Date(s.getTime());
      let guard = 0;
      while(cur <= e && guard < maxDays){
        out.push(dateToISO(cur));
        cur.setDate(cur.getDate()+1);
        guard++;
      }
      return out;
    };

    const getSelectedSecondDates = ()=>{
      return Array.from(document.querySelectorAll('#dailySecondSessionList input[type="checkbox"][data-date]'))
        .filter(cb=>cb.checked)
        .map(cb=>cb.dataset.date);
    };

    const renderDayList = ()=>{
      if(!dayList) return;

      const isMulti = !!cbMulti?.checked;
      if(!isMulti){
        dayList.innerHTML = "";
        return;
      }

      const start = document.getElementById("fDateStart")?.value || "";
      const endVal = document.getElementById("fDateEnd")?.value || "";
      if(!start || !endVal){
        dayList.innerHTML = `<div class="mutedNote">請先選擇開始與結束日期，才會產生每日場次設定。</div>`;
        return;
      }

      const keep = new Set(getSelectedSecondDates());
      const dates = enumerateDateISOs(start, endVal, 60);

      if(dates.length === 0){
        dayList.innerHTML = `<div class="mutedNote">結束日期不可早於開始日期。</div>`;
        return;
      }
      if(dates.length >= 60){
        dayList.innerHTML = `<div class="mutedNote">日期天數過多（已限制最多 60 天）。若超過需求，請改用「備註需求」說明。</div>`;
        return;
      }

      // 若剛從「單日第二場」切換到多日，把 Day1 的第二場同步過來
      if(singleS2?.checked && dates[0] && !keep.has(dates[0])){
        keep.add(dates[0]);
      }

      dayList.innerHTML = dates.map((iso, idx)=>{
        const dayNo = idx + 1;
        const tag = (dayNo===1) ? "Day1（原價）" : (dayNo===2 ? "Day2（+50%）" : `Day${dayNo}（+30%）`);
        const checked = keep.has(iso) ? "checked" : "";
        return `
          <div class="dayRow">
            <div class="dleft">
              <div class="dtitle">${iso}</div>
              <div class="dsub">${tag}；若勾第二場：+30%</div>
            </div>
            <label><input type="checkbox" data-date="${iso}" ${checked} style="width:18px;height:18px">第二場</label>
          </div>
        `;
      }).join("");

      Array.from(dayList.querySelectorAll('input[type="checkbox"][data-date]')).forEach(cb=>{
        cb.addEventListener("change", updateAll);
      });
    };

    const getPricingInfo = ()=>{
      const start = document.getElementById("fDateStart")?.value || "";
      const isMulti = !!cbMulti?.checked;
      const endIso = (isMulti ? (document.getElementById("fDateEnd")?.value || "") : "");

      let dayCount = 1;
      if(isMulti && start && endIso){
        const dates = enumerateDateISOs(start, endIso, 60);
        dayCount = dates.length || 1;
      }

      const extraDaysMultiplier = (dayCount>=2) ? (0.5 + Math.max(0, dayCount-2)*0.3) : 0;

      let session2Dates = [];
      if(isMulti && dayCount>=2){
        session2Dates = getSelectedSecondDates();
      }else{
        const on = !!singleS2?.checked;
        session2Dates = (on && start) ? [start] : [];
      }

      const session2Count = session2Dates.length;
      const session2Multiplier = session2Count * 0.3;
      const multiplier = 1 + extraDaysMultiplier + session2Multiplier;

      const parts = [];
      parts.push("Day1：1場（100%）");
      if(dayCount>=2) parts.push("Day2：1場（+50%）");
      if(dayCount>=3) parts.push(`Day3起：${dayCount-2}天 ×（+30%）`);
      if(session2Count>0) parts.push(`第二場：${session2Count}場 ×（+30%）`);
      return { start, end: endIso, isMulti, dayCount, session2Count, session2Dates, extraDaysMultiplier, session2Multiplier, multiplier, breakdownText: parts.join("；") };
    };

    // 供 renderCart / buildQuotePayload 使用
    window.__getDatePricingInfo = getPricingInfo;

    const updateSummary = ()=>{
      if(!summaryEl) return;
      const info = getPricingInfo();
      summaryEl.textContent = `共 ${info.dayCount} 天、第二場 ${info.session2Count} 場｜日期倍率：${info.multiplier.toFixed(2)} 倍`;
    };

    const updateSession2TimeVisibility = ()=>{
      if(!s2TimeWrap) return;
      const info = getPricingInfo();
      s2TimeWrap.style.display = (info.session2Count > 0) ? "block" : "none";
    };

    const updateCart = ()=>{
      if(typeof renderCart === "function") renderCart();
    };

    function updateAll(){
      updateSummary();
      updateSession2TimeVisibility();
      updateCart();
    }

    const apply = ()=>{
      const isMulti = !!cbMulti?.checked;

      if(sep) sep.style.display = isMulti ? "block" : "none";
      if(end) end.style.display = isMulti ? "block" : "none";
      if(multiWrap) multiWrap.style.display = isMulti ? "block" : "none";
      if(singleS2Wrap) singleS2Wrap.style.display = isMulti ? "none" : "block";

      if(!isMulti){
        // 從多日回到單日：把 Day1 第二場同步回單日 checkbox
        const selected = getSelectedSecondDates();
        const start = document.getElementById("fDateStart")?.value || "";
        if(singleS2) singleS2.checked = (start && selected.includes(start));
        if(end) end.value = "";
        if(dayList) dayList.innerHTML = "";
      }else{
        // 多日模式：單日 checkbox 不再使用
        if(singleS2) singleS2.checked = false;
      }

      const s = document.getElementById("fDateStart")?.value || "";
      if(end && s) end.min = s;

      renderDayList();
      updateAll();
    };

    cbMulti?.addEventListener("change", apply);
    document.getElementById("fDateStart")?.addEventListener("change", ()=>{
      const s = document.getElementById("fDateStart")?.value || "";
      if(end && s) end.min = s;
      if(cbMulti?.checked) renderDayList();
      updateAll();
    });
    end?.addEventListener("change", ()=>{
      if(cbMulti?.checked) renderDayList();
      updateAll();
    });
    singleS2?.addEventListener("change", updateAll);

    apply();
  }
const TW_CITY_AREAS = {
  "臺北市": [
    "中正區",
    "大同區",
    "中山區",
    "松山區",
    "大安區",
    "萬華區",
    "信義區",
    "士林區",
    "北投區",
    "內湖區",
    "南港區",
    "文山區"
  ],
  "新北市": [
    "板橋區",
    "三重區",
    "中和區",
    "永和區",
    "新莊區",
    "新店區",
    "樹林區",
    "鶯歌區",
    "三峽區",
    "淡水區",
    "汐止區",
    "瑞芳區",
    "土城區",
    "蘆洲區",
    "五股區",
    "泰山區",
    "林口區",
    "深坑區",
    "石碇區",
    "坪林區",
    "三芝區",
    "石門區",
    "八里區",
    "平溪區",
    "雙溪區",
    "貢寮區",
    "金山區",
    "萬里區",
    "烏來區"
  ],
  "桃園市": [
    "桃園區",
    "中壢區",
    "平鎮區",
    "八德區",
    "楊梅區",
    "蘆竹區",
    "大溪區",
    "龍潭區",
    "龜山區",
    "大園區",
    "觀音區",
    "新屋區",
    "復興區"
  ],
  "臺中市": [
    "中區",
    "東區",
    "南區",
    "西區",
    "北區",
    "北屯區",
    "西屯區",
    "南屯區",
    "太平區",
    "大里區",
    "霧峰區",
    "烏日區",
    "豐原區",
    "后里區",
    "石岡區",
    "東勢區",
    "和平區",
    "新社區",
    "潭子區",
    "大雅區",
    "神岡區",
    "大肚區",
    "沙鹿區",
    "龍井區",
    "梧棲區",
    "清水區",
    "大甲區",
    "外埔區",
    "大安區"
  ],
  "臺南市": [
    "中西區",
    "東區",
    "南區",
    "北區",
    "安平區",
    "安南區",
    "永康區",
    "歸仁區",
    "新化區",
    "左鎮區",
    "玉井區",
    "楠西區",
    "南化區",
    "仁德區",
    "關廟區",
    "龍崎區",
    "官田區",
    "麻豆區",
    "佳里區",
    "西港區",
    "七股區",
    "將軍區",
    "學甲區",
    "北門區",
    "新營區",
    "後壁區",
    "白河區",
    "東山區",
    "六甲區",
    "下營區",
    "柳營區",
    "鹽水區",
    "善化區",
    "大內區",
    "山上區",
    "新市區",
    "安定區"
  ],
  "高雄市": [
    "新興區",
    "前金區",
    "苓雅區",
    "鹽埕區",
    "鼓山區",
    "旗津區",
    "前鎮區",
    "三民區",
    "楠梓區",
    "小港區",
    "左營區",
    "仁武區",
    "大社區",
    "東沙群島",
    "南沙群島",
    "岡山區",
    "路竹區",
    "阿蓮區",
    "田寮區",
    "燕巢區",
    "橋頭區",
    "梓官區",
    "彌陀區",
    "永安區",
    "湖內區",
    "鳳山區",
    "大寮區",
    "林園區",
    "鳥松區",
    "大樹區",
    "旗山區",
    "美濃區",
    "六龜區",
    "內門區",
    "杉林區",
    "甲仙區",
    "桃源區",
    "那瑪夏區",
    "茂林區"
  ],
  "基隆市": [
    "仁愛區",
    "信義區",
    "中正區",
    "中山區",
    "安樂區",
    "暖暖區",
    "七堵區"
  ],
  "新竹市": [
    "東區",
    "北區",
    "香山區"
  ],
  "新竹縣": [
    "竹北市",
    "竹東鎮",
    "新埔鎮",
    "關西鎮",
    "湖口鄉",
    "新豐鄉",
    "芎林鄉",
    "橫山鄉",
    "北埔鄉",
    "寶山鄉",
    "峨眉鄉",
    "尖石鄉",
    "五峰鄉"
  ],
  "苗栗縣": [
    "苗栗市",
    "苑裡鎮",
    "通霄鎮",
    "竹南鎮",
    "頭份市",
    "後龍鎮",
    "卓蘭鎮",
    "大湖鄉",
    "公館鄉",
    "銅鑼鄉",
    "南庄鄉",
    "頭屋鄉",
    "三義鄉",
    "西湖鄉",
    "造橋鄉",
    "三灣鄉",
    "獅潭鄉",
    "泰安鄉"
  ],
  "彰化縣": [
    "彰化市",
    "鹿港鎮",
    "和美鎮",
    "線西鄉",
    "伸港鄉",
    "福興鄉",
    "秀水鄉",
    "花壇鄉",
    "芬園鄉",
    "員林市",
    "溪湖鎮",
    "田中鎮",
    "大村鄉",
    "埔鹽鄉",
    "埔心鄉",
    "永靖鄉",
    "社頭鄉",
    "二水鄉",
    "北斗鎮",
    "二林鎮",
    "田尾鄉",
    "埤頭鄉",
    "芳苑鄉",
    "大城鄉",
    "竹塘鄉",
    "溪州鄉"
  ],
  "南投縣": [
    "南投市",
    "埔里鎮",
    "草屯鎮",
    "竹山鎮",
    "集集鎮",
    "名間鄉",
    "鹿谷鄉",
    "中寮鄉",
    "魚池鄉",
    "國姓鄉",
    "水里鄉",
    "信義鄉",
    "仁愛鄉"
  ],
  "雲林縣": [
    "斗六市",
    "斗南鎮",
    "虎尾鎮",
    "西螺鎮",
    "土庫鎮",
    "北港鎮",
    "古坑鄉",
    "大埤鄉",
    "莿桐鄉",
    "林內鄉",
    "二崙鄉",
    "崙背鄉",
    "麥寮鄉",
    "東勢鄉",
    "褒忠鄉",
    "臺西鄉",
    "元長鄉",
    "四湖鄉",
    "口湖鄉",
    "水林鄉"
  ],
  "嘉義市": [
    "東區",
    "西區"
  ],
  "嘉義縣": [
    "太保市",
    "朴子市",
    "布袋鎮",
    "大林鎮",
    "民雄鄉",
    "溪口鄉",
    "新港鄉",
    "六腳鄉",
    "東石鄉",
    "義竹鄉",
    "鹿草鄉",
    "水上鄉",
    "中埔鄉",
    "竹崎鄉",
    "梅山鄉",
    "番路鄉",
    "大埔鄉",
    "阿里山鄉"
  ],
  "屏東縣": [
    "屏東市",
    "潮州鎮",
    "東港鎮",
    "恆春鎮",
    "萬丹鄉",
    "長治鄉",
    "麟洛鄉",
    "九如鄉",
    "里港鄉",
    "鹽埔鄉",
    "高樹鄉",
    "萬巒鄉",
    "內埔鄉",
    "竹田鄉",
    "新埤鄉",
    "枋寮鄉",
    "新園鄉",
    "崁頂鄉",
    "林邊鄉",
    "南州鄉",
    "佳冬鄉",
    "琉球鄉",
    "車城鄉",
    "滿州鄉",
    "枋山鄉",
    "三地門鄉",
    "霧臺鄉",
    "瑪家鄉",
    "泰武鄉",
    "來義鄉",
    "春日鄉",
    "獅子鄉",
    "牡丹鄉"
  ],
  "宜蘭縣": [
    "宜蘭市",
    "羅東鎮",
    "蘇澳鎮",
    "頭城鎮",
    "礁溪鄉",
    "壯圍鄉",
    "員山鄉",
    "冬山鄉",
    "五結鄉",
    "三星鄉",
    "大同鄉",
    "南澳鄉"
  ],
  "花蓮縣": [
    "花蓮市",
    "鳳林鎮",
    "玉里鎮",
    "新城鄉",
    "吉安鄉",
    "壽豐鄉",
    "光復鄉",
    "豐濱鄉",
    "瑞穗鄉",
    "富里鄉",
    "秀林鄉",
    "萬榮鄉",
    "卓溪鄉"
  ],
  "臺東縣": [
    "臺東市",
    "成功鎮",
    "關山鎮",
    "卑南鄉",
    "鹿野鄉",
    "池上鄉",
    "東河鄉",
    "長濱鄉",
    "太麻里鄉",
    "大武鄉",
    "綠島鄉",
    "海端鄉",
    "延平鄉",
    "金峰鄉",
    "達仁鄉",
    "蘭嶼鄉"
  ],
  "澎湖縣": [
    "馬公市",
    "湖西鄉",
    "白沙鄉",
    "西嶼鄉",
    "望安鄉",
    "七美鄉"
  ],
  "金門縣": [
    "金城鎮",
    "金湖鎮",
    "金沙鎮",
    "金寧鄉",
    "烈嶼鄉",
    "烏坵鄉"
  ],
  "連江縣": [
    "南竿鄉",
    "北竿鄉",
    "莒光鄉",
    "東引鄉"
  ]
};

  function initCityAreaPickers(){
    const cityEl = document.getElementById("fCity");
    const areaEl = document.getElementById("fArea");
    if(!cityEl || !areaEl) return;

    const cities = Object.keys(TW_CITY_AREAS);
    cityEl.innerHTML = ['<option value="">請選擇縣市</option>']
      .concat(cities.map(c=>`<option value="${c}">${c}</option>`)).join("");

    function fillAreas(city){
      const areas = (city && TW_CITY_AREAS[city]) ? TW_CITY_AREAS[city] : [];
      areaEl.disabled = !city;
      areaEl.innerHTML = city
        ? ['<option value="">請選擇區域</option>'].concat(areas.map(a=>`<option value="${a}">${a}</option>`)).join("")
        : '<option value="">請先選縣市</option>';
    }

    cityEl.addEventListener("change", ()=> fillAreas(cityEl.value));

    // 若使用者重新整理，保留先前值（若瀏覽器有記住）
    setTimeout(()=>{
      const c = cityEl.value;
      fillAreas(c);
      if(areaEl.value && c && TW_CITY_AREAS[c] && !TW_CITY_AREAS[c].includes(areaEl.value)){
        areaEl.value = "";
      }
    }, 0);
  }

  /* -----------------------------------------------------------
     ✅ Modal：恢復「詳情」功能
     ----------------------------------------------------------- */
  function openModal(title, bodyText){
    const mask = $("#modalMask");
    const t = $("#mTitle");
    const b = $("#mBody");
    if(t) t.textContent = title || "詳情";
    if(b) b.textContent = bodyText || "—";
    if(mask){
      mask.style.display = "flex";
      mask.setAttribute("aria-hidden","false");
    }
  }
  function closeModal(){
    const mask = $("#modalMask");
    if(mask){
      mask.style.display = "none";
      mask.setAttribute("aria-hidden","true");
    }
  }

  (function(){
    const mask = $("#modalMask");
    const btn = $("#mClose");
    btn?.addEventListener("click", closeModal);
    mask?.addEventListener("click", (e)=>{ if(e.target===mask) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });
  })();

  function findItemById(itemId){
    for(const c of CATEGORIES){
      const it = c.items.find(x=>x.id===itemId);
      if(it) return {cat:c, item:it};
    }
    return null;
  }

  function openItemDetail(itemId){
    const f = findItemById(itemId);
    if(!f) return;
    const it = f.item;
    const title = `詳情｜${it.name}`;
    const body = `分類：${f.cat.name}\n單價：${fmt(it.price)} / ${it.unit}\n\n${it.desc || "—"}`;
    openModal(title, body);
  }

  function openTierDetail(tierKey, level){
    const name = LEVELS[tierKey]?.[level-1] || `第${level}級`;
    const price = LEVEL_PRICES[tierKey]?.[level-1] || 0;
    const label = ({safety:"安全等級", ambience:"氣氛等級", upgrade:"升級等級"}[tierKey]) || "等級";
    openModal(`詳情｜${label}｜${name}`, `參考價：${fmt(price)}\n\n（此處可放你之後要寫的「包含內容」說明。）`);
  }

  function setHiddenTime(hId, mId, outId){
    const h = document.getElementById(hId)?.value ?? "00";
    const m = document.getElementById(mId)?.value ?? "00";
    const out = document.getElementById(outId);
    if(out) out.value = `${h}:${m}`;
  }

  function initTimePickers(){
    const hours = Array.from({length:24}, (_,i)=>String(i).padStart(2,"0"));
    const mins = ["00","10","20","30","40","50"];
    const fill = (id, arr)=> {
      const el = document.getElementById(id);
      if(el) el.innerHTML = arr.map(v=>`<option value="${v}">${v}</option>`).join("");
    };

    fill("tStartH", hours); fill("tStartM", mins);
    fill("tEndH", hours); fill("tEndM", mins);
    fill("t2StartH", hours); fill("t2StartM", mins);
    fill("t2EndH", hours); fill("t2EndM", mins);

    const safeSet = (id,val)=>{ const el=document.getElementById(id); if(el) el.value=val; }
    safeSet("tStartH","09"); safeSet("tStartM","00");
    safeSet("tEndH","12"); safeSet("tEndM","00");
    safeSet("t2StartH","14"); safeSet("t2StartM","00");
    safeSet("t2EndH","17"); safeSet("t2EndM","00");

    const bind = (hId,mId,outId)=>{
      const h=document.getElementById(hId), m=document.getElementById(mId);
      const fn=()=>setHiddenTime(hId,mId,outId);
      h?.addEventListener("change", fn);
      m?.addEventListener("change", fn);
      fn();
    };
    bind("tStartH","tStartM","fTimeStart");
    bind("tEndH","tEndM","fTimeEnd");
    bind("t2StartH","t2StartM","fTime2Start");
    bind("t2EndH","t2EndM","fTime2End");
  }

  
  function renderTierButtons(){
    const mk = (tierKey, containerSel) => {
      const el = $(containerSel);
      el.innerHTML = LEVELS[tierKey].map((name, idx)=>{
        const n = idx+1;
        const active = state.tiers[tierKey] === n ? "active" : "";
        return `
          <div class="levelBtn ${active}">
            <div class="levelTopRow" style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
              <span style="font-size:13px;font-weight:1000;line-height:1.2">${name}</span>
              <span style="font-size:12px;font-weight:1000;white-space:nowrap">${fmt(LEVEL_PRICES[tierKey][idx])}</span>
            </div>
            <div class="levelMedia"><img src="https://picsum.photos/seed/${tierKey}${n}/200/120" alt=""></div>
            <div style="display:grid;gap:8px">
              <button type="button" class="miniBtn primaryMini" style="width:100%" onclick="selectTier('${tierKey}', ${n});event.stopPropagation();">加入報價</button>
              <button type="button" class="miniBtn" style="width:100%" onclick="showTierDetail('${tierKey}', ${n});event.stopPropagation();">詳情</button>
            </div>
          </div>`;
      }).join("");
    };
    mk("safety","#levelsSafety");
    mk("ambience","#levelsAmbience");
    mk("upgrade","#levelsUpgrade");
  }


  window.selectTier = (key, n) => {
    state.tiers[key] = n;
    state.cart.packs[key] = { name: LEVELS[key][n-1], price: LEVEL_PRICES[key][n-1] };
    renderAll();
  };

  window.openTierDetail = openTierDetail;

  
  function findItemById(id){
    for(const c of CATEGORIES){
      const it = (c.items||[]).find(x=>x.id===id);
      if(it) return {cat:c, item:it};
    }
    return null;
  }

  window.showItemDetail = (id) => {
    const hit = findItemById(id);
    if(!hit) return;
    const it = hit.item;
    openModal(it.name, it.desc || "—");
  };

  window.showTierDetail = (tierKey, n) => {
    const name = LEVELS[tierKey][n-1];
    const price = LEVEL_PRICES[tierKey][n-1];
    const lines = [
      `等級：${name}`,
      `價格：${fmt(price)}`,
      "",
      "（此區可放該等級包含內容的說明；若您之後要接 Google Sheet 的「等級包含內容」，我可以再幫您串。）"
    ].join("\n");
    openModal("等級詳情", lines);
  };

  function renderItems(){
    const cat = CATEGORIES.find(c=>c.id===state.catId) || CATEGORIES[0];
    $("#catName").textContent = cat.name;
    $("#items").innerHTML = cat.items.map(it=>{
      const q = state.cart[it.id] || 0;
      return `
        <div class="item">
          <img class="thumb" src="${it.img}" alt="">
          <div class="meta">
            <div class="name">${it.name}</div>
            <div class="sub">${fmt(it.price)} / ${it.unit}</div>
            <div style="display:flex;align-items:center;gap:10px;margin-top:6px;flex-wrap:wrap">
              <div class="qty">
                <button class="qbtn" onclick="updateQty('${it.id}',-1)">-</button>
                <div class="qval">${q}</div>
                <button class="qbtn" onclick="updateQty('${it.id}',1)">+</button>
              </div>
              <button class="btn" style="padding:8px 10px;border-radius:12px" onclick="showItemDetail('${it.id}')">詳情</button>
            </div>
          </div>
          <div class="price">${fmt(it.price * q)}</div>
        </div>`;
    }).join("");
  }


  window.updateQty = (id, delta) => {
    state.cart[id] = Math.max(0, (state.cart[id]||0) + delta);
    if(state.cart[id]===0) delete state.cart[id];
    renderAll();
  };

  function renderCart(){
    let sum = 0;
    const items = [];

    Object.entries(state.cart.packs).forEach(([k, p]) => {
      sum += p.price;
      items.push(`<div class="citem"><div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start"><div style="font-weight:1000">${p.name}</div><div style="font-weight:1000">${fmt(p.price)}</div></div><button class="xbtn" type="button" onclick="deletePack('${k}')">✕</button></div>`);
    });

    CATEGORIES.forEach(c => c.items.forEach(it => {
      const q = state.cart[it.id];
      if(q > 0) {
        sum += it.price * q;
        items.push(`<div class="citem"><div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start"><div style="font-weight:1000">${it.name} x ${q}</div><div style="font-weight:1000">${fmt(it.price*q)}</div></div><button class="xbtn" type="button" onclick="updateQty('${it.id}',-${q})">✕</button></div>`);
      }
    }));

    $("#cart").innerHTML = items.join("");
    const fees = (typeof window.__getDatePricingInfo === "function") ? window.__getDatePricingInfo() : {extraDaysMultiplier:0, session2Multiplier:0};
    const dayFee = Math.round(sum * (fees.extraDaysMultiplier || 0));
    const session2Fee = Math.round(sum * (fees.session2Multiplier || 0));
    const total = sum + dayFee + session2Fee;
    if($("#subTotal")) $("#subTotal").textContent = fmt(sum);
    if($("#dayFee")) $("#dayFee").textContent = fmt(dayFee);
    if($("#session2Fee")) $("#session2Fee").textContent = fmt(session2Fee);
    $("#finalTotal").textContent = fmt(total);

    const itemCount = Object.keys(state.cart).filter(k => k !== "packs").length;
    const packCount = Object.keys(state.cart.packs || {}).length;
    $("#pickedCount").textContent = (itemCount + packCount) + " 項已選";
  }

  window.deletePack = (key) => { delete state.cart.packs[key]; state.tiers[key]=0; renderAll(); };

  function renderTabs(){
    $("#tabs").innerHTML = CATEGORIES.map(c => `<button type="button" class="tab ${c.id===state.catId?'active':''}" onclick="state.catId='${c.id}';renderAll()">${c.name}</button>`).join("");
  }

  function renderAll(){ renderTierButtons(); renderTabs(); renderItems(); renderCart(); }


  /* -----------------------------------------------------------
     ✅ 送出報價單（Apps Script / Google Sheet Web App）
     - 你只要把 ORDER_API_URL 換成你自己的 Web App /exec 連結
     ----------------------------------------------------------- */
  const ORDER_API_URL = ""; // 例如：https://script.google.com/macros/s/XXXX/exec

  
  function buildQuotePayload(){
    const form = {
      name: ($("#fName")?.value || "").trim(),
      phone: ($("#fPhone")?.value || "").trim(),
      email: ($("#fEmail")?.value || "").trim(),
      addr: ($("#fAddr")?.value || "").trim(),
      dateStart: ($("#fDateStart")?.value || "").trim(),
      dateEnd: ($("#fDateEnd")?.value || "").trim(),
      timeStart: ($("#fTimeStart")?.value || "").trim(),
      timeEnd: ($("#fTimeEnd")?.value || "").trim(),
      time2Start: ($("#fTime2Start")?.value || "").trim(),
      time2End: ($("#fTime2End")?.value || "").trim(),
      hasExtraDate: $("#fHasExtraDate")?.checked ? "是" : "否", // 是=連續多日模式
      hasSession2: $("#fHasSession2")?.checked ? "是" : "否", // 單日模式用；多日改由每日設定
      ,dateMode: $("#fHasExtraDate")?.checked ? "連續多日" : "單日"
      ,dayCount: (typeof window.__getDatePricingInfo==="function" ? window.__getDatePricingInfo().dayCount : 1)
      ,session2Count: (typeof window.__getDatePricingInfo==="function" ? window.__getDatePricingInfo().session2Count : ( $("#fHasSession2")?.checked ? 1 : 0))
      ,session2Dates: (typeof window.__getDatePricingInfo==="function" ? (window.__getDatePricingInfo().session2Dates||[]).join(", ") : "")
      ,dateMultiplier: (typeof window.__getDatePricingInfo==="function" ? window.__getDatePricingInfo().multiplier.toFixed(2) : "1.00")
      ,dateBreakdown: (typeof window.__getDatePricingInfo==="function" ? window.__getDatePricingInfo().breakdownText : ""),
      note: ($("#fNote")?.value || "").trim(),
      // 以下為選填（後端 PDFTemplate 已支援）
      eventType: ($("#fEventType")?.value || "").trim(),
      crowd: ($("#fCrowd")?.value || "").trim(),
      indoor: ($("#fIndoor")?.value || "").trim(),
      city: ($("#fCity")?.value || "").trim(),
      area: ($("#fArea")?.value || "").trim(),
      bldg: ($("#fBldg")?.value || "").trim()
      // 其餘欄位（若沒填會是空字串）
    };

    // 等級
    const levels = {
      safety: state.tiers.safety,
      ambience: state.tiers.ambience,
      upgrade: state.tiers.upgrade
    };

    // 明細 items：後端 PDFTemplate 期待 categoryName / lineTotal 等欄位
    const items = [];

    // 1) 等級包（當作 qty=1 的品項）
    if(state.cart?.packs){
      for(const [k, p] of Object.entries(state.cart.packs)){
        if(!p) continue;
        items.push({
          categoryName: "燈光音響配置",
          id: `pack-${k}`,
          name: String(p.name || ""),
          qty: 1,
          unit: "組",
          price: Number(p.price || 0),
          lineTotal: Number(p.price || 0)
        });
      }
    }

    // 2) 分類商品
    for(const c of CATEGORIES){
      for(const it of c.items){
        const q = Number(state.cart[it.id] || 0);
        if(q>0){
          const price = Number(it.price || 0);
          items.push({
            categoryName: c.name,
            id: it.id,
            name: it.name,
            qty: q,
            unit: it.unit,
            price,
            lineTotal: price * q
          });
        }
      }
    }

    const subtotal = items.reduce((s, it)=> s + Number(it.lineTotal || 0), 0);

    // 日期/場次加價（依你的規則）
    const info = (typeof window.__getDatePricingInfo === "function") ? window.__getDatePricingInfo() : {extraDaysMultiplier:0, session2Multiplier:0};
    const session2Fee = Math.round(subtotal * (info.session2Multiplier || 0));
    const dayFee = Math.round(subtotal * (info.extraDaysMultiplier || 0));

    const total = subtotal + dayFee + session2Fee;

    return {
      action: "submitQuote",
      form,
      levels,
      items,
      summary: { subtotal, dayFee, session2Fee, total }
    };
  }


  function submitQuote(){
    if(!ORDER_API_URL){
      alert("尚未設定 ORDER_API_URL（Apps Script Web App 連結）。\n請把程式碼裡的 ORDER_API_URL 貼上你的 /exec 連結後再試。");
      return;
    }
    const payload = buildQuotePayload();

    // 基本檢查（可依你需求調整）
    if(!payload.form.name){
      alert("請先填寫：姓名 / 單位");
      return;
    }
    if(!payload.form.email){
      alert("請先填寫：Email（用來寄出報價單）");
      return;
    }

    try{
      const ok = navigator.sendBeacon(ORDER_API_URL, JSON.stringify(payload));
      if(ok){
        alert("已送出！系統將依 Apps Script 設定寄出報價單，請至信箱查收。");
      }else{
        // 備援：fetch
        fetch(ORDER_API_URL, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        }).then(r=>r.text()).then(()=>{
          alert("已送出！系統將依 Apps Script 設定寄出報價單，請至信箱查收。");
        }).catch(err=>{
          alert("送出失敗：" + (err?.message || err));
        });
      }
    }catch(e){
      alert("送出失敗：" + (e?.message || e));
    }
  }

  (function bindSubmitBtn(){
    const btn = document.getElementById("btnSendQuote");
    if(btn){
      btn.addEventListener("click", submitQuote);
    }
  })();

  window.addEventListener('load', ()=>{ initBasicSelects(); initTimePickers(); initCityAreaPickers(); bindToggles(); renderAll(); });
</script>
</body>
</html>
