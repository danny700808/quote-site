<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>活動企劃｜設備選配與即時報價（方案二：不連續多日×分日購物車）</title>

  <style>
    :root{
      --bg:#f7fbf9;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e6efe9;
      --brand:#63bfae;
      --brand2:#2f8f7b;
      --danger:#e25a6a;
      --shadow:0 10px 28px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans TC',sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:10;background:rgba(247,251,249,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .head{max-width:1100px;margin:0 auto;padding:14px 18px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .title{display:flex;flex-direction:column;gap:4px}
    .title h1{margin:0;font-size:18px}
    .title small{color:var(--muted)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--brand2);color:white}
    .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
    .btn.danger{background:var(--danger);color:white}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .grid{display:grid;gap:14px}
    .grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    .secTitle{display:flex;align-items:center;gap:10px;margin:0 0 8px}
    .badge{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:999px;background:rgba(99,191,174,.18);color:var(--brand2);font-weight:900}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}

    .form{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .field{display:grid;gap:6px}
    .field.span2{grid-column:1 / -1}
    label{font-weight:900;color:var(--muted)}
    input,select,textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:90px;resize:vertical}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);border-radius:999px;
      padding:6px 10px;background:#fff;font-weight:900;color:var(--text)
    }
    .pill input{width:18px;height:18px}

    .modeBox{display:grid;gap:10px}
    .hint{font-size:13px;color:var(--muted);line-height:1.6}
    .miniHint{font-size:12px;color:var(--muted);line-height:1.6}

    .daysWrap{display:grid;gap:12px}
    .dayCard{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      display:grid;gap:10px;
    }
    .dayTop{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .dayLeft{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tag{font-weight:900;color:var(--brand2)}
    .smallBtn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;font-weight:900;cursor:pointer}
    .smallBtn.active{border-color:var(--brand2);box-shadow:0 0 0 2px rgba(47,143,123,.15)}
    .smallBtn.danger{border-color:rgba(226,90,106,.3);color:var(--danger)}
    .timeRow{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
    .sep{color:var(--muted);font-weight:900;text-align:center}
    .subBox{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#fbfffd}

    /* 設備清單 */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 10px}
    .tab{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;font-weight:900;cursor:pointer}
    .tab.active{border-color:var(--brand2);box-shadow:0 0 0 2px rgba(47,143,123,.14)}
    .items{display:grid;gap:10px}
    .item{
      border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;
      display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;
    }
    .item .name{font-weight:900}
    .item .sub{color:var(--muted);font-size:13px}
    .qty{display:flex;gap:8px;align-items:center}
    .qbtn{width:36px;height:36px;border-radius:12px;border:1px solid var(--line);background:#fff;font-weight:900;cursor:pointer}
    .qval{min-width:28px;text-align:center;font-weight:900}
    .price{font-weight:1000}

    /* 右欄摘要 */
    .stickyRight{position:sticky;top:86px;display:grid;gap:12px}
    .sumRow{display:flex;justify-content:space-between;gap:12px;padding:6px 0}
    .total{font-size:18px;font-weight:1000;border-top:2px solid var(--text);padding-top:10px;margin-top:8px;color:var(--danger)}
    .ok{color:var(--brand2);font-weight:900}

    @media (max-width: 920px){
      .grid2{grid-template-columns:1fr}
      header{position:static}
      .stickyRight{position:static}
    }
    @media (max-width: 620px){
      .form{grid-template-columns:1fr}
      .timeRow{grid-template-columns:1fr;gap:8px}
      .sep{display:none}
    }
  </style>
</head>

<body>
<header>
  <div class="head">
    <div class="title">
      <h1>活動企劃｜設備選配與即時報價</h1>
      <small>方案二：不連續多日 × 分日購物車（每一天可設定不同設備與時間）</small>
    </div>
    <div class="actions">
      <button class="btn ghost" id="btnReset">清空</button>
      <button class="btn primary" id="btnSubmit">送出報價單</button>
    </div>
  </div>
</header>

<div class="wrap grid">

  <!-- 1) 基本資料 -->
  <div class="card">
    <div class="secTitle"><span class="badge">1</span><b>基本資料</b></div>
    <div class="form">
      <div class="field">
        <label>姓名 / 單位</label>
        <input id="fName" placeholder="例：黃先生 / XX公司">
      </div>
      <div class="field">
        <label>行動電話</label>
        <input id="fPhone" placeholder="例：09xx-xxx-xxx">
      </div>
      <div class="field">
        <label>Email（有填才寄客人）</label>
        <input id="fEmail" placeholder="例：test@gmail.com">
      </div>
      <div class="field">
        <label>活動類型</label>
        <input id="fEventType" placeholder="例：演唱會 / Live Band / 婚禮">
      </div>

      <div class="field">
        <label>預估人數</label>
        <input id="fCrowd" placeholder="例：100">
      </div>
      <div class="field">
        <label>室內 / 戶外</label>
        <select id="fIndoor">
          <option value="">請選擇</option>
          <option value="室內">室內</option>
          <option value="戶外">戶外</option>
        </select>
      </div>

      <div class="field">
        <label>縣市</label>
        <input id="fCity" placeholder="例：台中市">
      </div>
      <div class="field">
        <label>區域</label>
        <input id="fArea" placeholder="例：豐原區">
      </div>
      <div class="field span2">
        <label>詳細地址（含樓層 / 場地補充）</label>
        <input id="fAddr" placeholder="例：圓環東路347號4樓（從側門進）">
      </div>

      <div class="field span2">
        <label>備註 / 需求</label>
        <textarea id="fNote" placeholder="例：室內120人、需要220V插座、需要走道退場..."></textarea>
      </div>
    </div>
  </div>

  <!-- 2) 活動日期與分日設定 -->
  <div class="card">
    <div class="secTitle"><span class="badge">2</span><b>活動日期與分日設定</b></div>

    <div class="modeBox">
      <div class="row">
        <span class="pill"><input type="radio" name="dateMode" value="single" checked> 單日</span>
        <span class="pill"><input type="radio" name="dateMode" value="range"> 連續多日（起迄）</span>
        <span class="pill"><input type="radio" name="dateMode" value="multi"> 不連續多日（可選多天、分日設備）</span>
      </div>

      <div class="hint">
        規則：<b>不連續日（斷開）＝回到原價重新計算</b>；若其中某一段是連續的，仍照連續規則：第2天加價 <b>50%</b>，第3天起每一天加價 <b>30%</b>。
        第二場加價固定為每一天 <b>+30%</b>，且第二場時間不可與第一場重疊。
      </div>

      <!-- 單日 -->
      <div id="modeSingle" class="subBox">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div style="flex:1;min-width:240px">
            <label style="display:block;margin-bottom:6px">日期</label>
            <input id="singleDate" type="date">
          </div>
          <div style="flex:2;min-width:260px">
            <label style="display:block;margin-bottom:6px">第一場時間（00/10/20/30/40/50 分）</label>
            <div class="timeRow">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <select id="singleStartH"></select>
                <select id="singleStartM"></select>
              </div>
              <div class="sep">～</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <select id="singleEndH"></select>
                <select id="singleEndM"></select>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted)">
            <input type="checkbox" id="singleHas2" style="width:18px;height:18px">
            同日第二場（+30%）
          </label>

          <div id="single2Wrap" style="display:none;margin-top:10px" class="subBox">
            <div class="timeRow">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <select id="single2StartH"></select>
                <select id="single2StartM"></select>
              </div>
              <div class="sep">～</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <select id="single2EndH"></select>
                <select id="single2EndM"></select>
              </div>
            </div>
            <div class="miniHint">第二場開始必須在第一場結束之後；若選到重疊，系統會自動修正。</div>
          </div>
        </div>
      </div>

      <!-- 連續多日 -->
      <div id="modeRange" class="subBox" style="display:none">
        <div class="row" style="align-items:flex-end;gap:12px">
          <div style="flex:1;min-width:240px">
            <label style="display:block;margin-bottom:6px">開始日期</label>
            <input id="rangeStart" type="date">
          </div>
          <div style="flex:1;min-width:240px">
            <label style="display:block;margin-bottom:6px">結束日期</label>
            <input id="rangeEnd" type="date">
          </div>
        </div>

        <div style="margin-top:12px">
          <label style="display:block;margin-bottom:6px">第一場時間（所有日期共用）</label>
          <div class="timeRow">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <select id="rangeStartH"></select>
              <select id="rangeStartM"></select>
            </div>
            <div class="sep">～</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <select id="rangeEndH"></select>
              <select id="rangeEndM"></select>
            </div>
          </div>
        </div>

        <div class="hint" style="margin-top:8px">提示：第2天加價 <b>50%</b>；第3天起每一天加價 <b>30%</b>。</div>

        <div style="margin-top:10px">
          <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted)">
            <input type="checkbox" id="rangeHas2" style="width:18px;height:18px">
            每一天可勾選第二場（+30%）
          </label>
          <div id="rangeDaysWrap" style="display:none;margin-top:10px" class="daysWrap"></div>
        </div>
      </div>

      <!-- 不連續多日（方案二：分日設備） -->
      <div id="modeMulti" class="subBox" style="display:none">
        <div class="row" style="justify-content:space-between">
          <div class="hint">新增多個日期，每一天可設定不同的第一場/第二場時間，並切換到該日選設備（分日購物車）。</div>
          <button class="smallBtn" id="btnAddDay">＋ 新增日期</button>
        </div>
        <div id="multiDaysWrap" class="daysWrap"></div>
      </div>
    </div>
  </div>

  <!-- 3) 設備選配（分日） + 右側摘要 -->
  <div class="grid2">
    <div class="card">
      <div class="secTitle"><span class="badge">3</span><b>設備選配（依日期切換）</b></div>
      <div class="hint" style="margin-bottom:10px">
        你目前正在設定的日期：<b id="activeDateLabel">（尚未選擇日期）</b>。
        只有在「不連續多日」模式下才會有分日購物車；單日/連續多日會以同一份設備為主。
      </div>

      <div id="dateSwitcher" class="row" style="margin-bottom:10px"></div>

      <div class="hr"></div>

      <div class="tabs" id="tabs"></div>
      <div class="items" id="items"></div>
    </div>

    <div class="stickyRight">
      <div class="card">
        <div class="secTitle"><span class="badge">4</span><b>報價摘要</b></div>
        <div class="hint">系統會依「日期是否連續」分段計算跨天加價；斷開日回原價重新算。</div>

        <div class="hr"></div>

        <div id="sumBreakdown"></div>

        <div class="sumRow total">
          <span>總計</span>
          <span id="sumTotal">NT$0</span>
        </div>

        <div class="hint" style="margin-top:10px">
          送出後：會寄 Email（如有填客人信箱），並產出 PDF 報價單。
        </div>
      </div>

      <div class="card">
        <div class="secTitle"><span class="badge">i</span><b>除錯狀態</b></div>
        <div class="hint">這區只給你看目前資料結構（確認分日購物車是否正確）。</div>
        <pre id="debug" style="white-space:pre-wrap;font-size:12px;line-height:1.5;background:#fbfffd;border:1px dashed var(--line);border-radius:12px;padding:10px;margin:0"></pre>
      </div>
    </div>
  </div>

</div>

<script>
/** 你要改這裡：貼上你的 Apps Script Web App URL */
const APPS_SCRIPT_ENDPOINT = ""; // 例：https://script.google.com/macros/s/xxxx/exec

/** 時區/日期工具 */
const pad2 = (n)=>String(n).padStart(2,"0");
const toYMD = (d)=>{
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
};
const addDays = (ymd, n)=>{
  const [y,m,da]=ymd.split("-").map(x=>parseInt(x,10));
  const dt = new Date(y, m-1, da);
  dt.setDate(dt.getDate()+n);
  return toYMD(dt);
};
const diffDays = (a,b)=>{
  // b-a in days
  const [ay,am,ad]=a.split("-").map(Number);
  const [by,bm,bd]=b.split("-").map(Number);
  const ta = new Date(ay,am-1,ad).getTime();
  const tb = new Date(by,bm-1,bd).getTime();
  return Math.round((tb-ta)/86400000);
};

const $ = (sel)=>document.querySelector(sel);

/** 你的設備資料：如果你有 Apps Script 讀表單/設備，可改成 fetch 後覆蓋 */
let CATEGORIES = [
  { id:"pkg", name:"套裝", items:[
    { id:"p1", name:"套裝｜安全等級① 基礎舞台", price:35000 },
    { id:"p2", name:"套裝｜氣氛等級⑥ 全感體驗", price:80000 },
  ]},
  { id:"audio", name:"音響", items:[
    { id:"a1", name:"混音器（基本）", price:3000 },
    { id:"a2", name:"無線麥克風（1支）", price:1200 },
    { id:"a3", name:"監聽喇叭", price:2200 },
  ]},
  { id:"light", name:"燈光", items:[
    { id:"l1", name:"Moving Head（光束燈）", price:2500 },
    { id:"l2", name:"燈控工程師（含彩排）", price:6500 },
  ]},
  { id:"staff", name:"人員", items:[
    { id:"s1", name:"音控工程師（含彩排）", price:6500 },
  ]},
];

/** State */
const state = {
  mode: "single", // single | range | multi
  activeDate: "",
  // 單日/連續模式用同一份 cart
  cart: {},
  // 不連續分日購物車：date -> {itemId:qty}
  cartByDate: {},
  // 每天的場次資料（multi 模式）
  dayMeta: {
    // "YYYY-MM-DD": { time1:{start:"09:00",end:"12:00"}, has2:true/false, time2:{start:"18:00",end:"21:00"} }
  },
  // range 模式：每天是否有第二場（每一天可勾）
  range2: {
    // "YYYY-MM-DD": { on:true/false, start:"18:00", end:"21:00" }
  },
  catId: "pkg",
};

/** Time select utils */
const MINUTES = ["00","10","20","30","40","50"];
function fillTimeSelect(selectEl, type){
  const hours = Array.from({length:24}, (_,i)=>pad2(i));
  const arr = (type==="H") ? hours : MINUTES;
  selectEl.innerHTML = arr.map(v=>`<option value="${v}">${v}</option>`).join("");
}
function getHM(hSel, mSel){
  return `${hSel.value}:${mSel.value}`;
}
function setHM(hSel, mSel, hm){
  const [h,m]=String(hm||"").split(":");
  if(h) hSel.value = pad2(parseInt(h,10));
  if(m) mSel.value = pad2(parseInt(m,10));
}
function toMin(hm){
  const [h,m]=hm.split(":").map(Number);
  return (h*60+m);
}
function fromMin(min){
  min = Math.max(0, Math.min(24*60-10, min));
  const h = pad2(Math.floor(min/60));
  const m = pad2(min%60);
  // 強制到 10 分鐘刻度
  const m10 = pad2(Math.round(parseInt(m,10)/10)*10 % 60);
  return `${h}:${m10}`;
}
function enforceNoOverlap(time1End, time2Start, time2End){
  const step=10;
  let s2s = toMin(time2Start);
  let s2e = toMin(time2End);
  const t1e = toMin(time1End);

  if(s2s < t1e) s2s = t1e;
  if(s2e <= s2s) s2e = s2s + step;

  return { start: fromMin(s2s), end: fromMin(s2e) };
}

/** Load optional data (if you want) */
async function tryLoadFromAppsScript(){
  if(!APPS_SCRIPT_ENDPOINT) return;
  try{
    const res = await fetch(APPS_SCRIPT_ENDPOINT, { method:"GET" });
    const json = await res.json();
    // 你如果 Apps Script 有提供設備大分類/商品/價格，可在這裡轉成 CATEGORIES
    // 目前先不強制，避免你既有表結構不同導致壞掉。
    console.log("AppsScript loaded", json?.ok);
  }catch(e){
    console.warn("AppsScript load failed", e);
  }
}

/** UI init */
function initTimeControls(){
  // single
  ["singleStartH","singleEndH","single2StartH","single2EndH","rangeStartH","rangeEndH"].forEach(id=>fillTimeSelect($("#"+id),"H"));
  ["singleStartM","singleEndM","single2StartM","single2EndM","rangeStartM","rangeEndM"].forEach(id=>fillTimeSelect($("#"+id),"M"));
  // defaults
  setHM($("#singleStartH"),$("#singleStartM"),"09:00");
  setHM($("#singleEndH"),$("#singleEndM"),"12:00");
  setHM($("#single2StartH"),$("#single2StartM"),"18:00");
  setHM($("#single2EndH"),$("#single2EndM"),"21:00");

  setHM($("#rangeStartH"),$("#rangeStartM"),"09:00");
  setHM($("#rangeEndH"),$("#rangeEndM"),"12:00");
}
function wireModeSwitch(){
  document.querySelectorAll('input[name="dateMode"]').forEach(r=>{
    r.addEventListener("change", ()=>{
      state.mode = r.value;
      renderModePanels();
      renderDateSwitcher();
      renderAll();
    });
  });
}
function renderModePanels(){
  $("#modeSingle").style.display = (state.mode==="single") ? "block" : "none";
  $("#modeRange").style.display  = (state.mode==="range") ? "block" : "none";
  $("#modeMulti").style.display  = (state.mode==="multi") ? "block" : "none";
}

/** Helper: get current selected dates list */
function getSelectedDates(){
  if(state.mode==="single"){
    const d = $("#singleDate").value || "";
    return d ? [d] : [];
  }
  if(state.mode==="range"){
    const a = $("#rangeStart").value || "";
    const b = $("#rangeEnd").value || a;
    if(!a) return [];
    const start = a, end = b || a;
    // normalize
    const min = diffDays(start,end) >= 0 ? start : end;
    const max = diffDays(start,end) >= 0 ? end : start;
    const out=[];
    let cur=min;
    while(diffDays(cur,max) >= 0){
      out.push(cur);
      if(cur===max) break;
      cur = addDays(cur,1);
    }
    return out;
  }
  // multi
  const keys = Object.keys(state.dayMeta||{});
  return keys.sort();
}

/** Render range mode day list for session2 */
function renderRangeDays(){
  const wrap = $("#rangeDaysWrap");
  wrap.innerHTML = "";
  const has2 = $("#rangeHas2").checked;
  wrap.style.display = has2 ? "grid" : "none";
  if(!has2) return;
  const days = getSelectedDates();
  if(!days.length){
    wrap.innerHTML = `<div class="hint">請先選擇開始/結束日期。</div>`;
    return;
  }
  const defaultStart="18:00", defaultEnd="21:00";
  const rows = days.map(d=>{
    state.range2[d] = state.range2[d] || { on:false, start:defaultStart, end:defaultEnd };
    const cur = state.range2[d];
    const chk = cur.on ? "checked" : "";
    const [sh,sm]=cur.start.split(":");
    const [eh,em]=cur.end.split(":");
    return `
      <div class="dayCard" data-r2="${d}">
        <div class="dayTop">
          <div class="dayLeft">
            <b class="tag">${d}</b>
            <span class="pill" style="border-style:dashed;">第二場 +30%</span>
          </div>
          <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted);cursor:pointer;">
            <input type="checkbox" data-r2chk="1" data-date="${d}" style="width:18px;height:18px" ${chk}>
            啟用第二場
          </label>
        </div>

        <div class="subBox" data-r2time="${d}" style="${cur.on?"display:block":"display:none"}">
          <div class="timeRow">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <select data-r2sel="H" id="r2_${d}_sh"></select>
              <select data-r2sel="M" id="r2_${d}_sm"></select>
            </div>
            <div class="sep">～</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <select data-r2sel="H" id="r2_${d}_eh"></select>
              <select data-r2sel="M" id="r2_${d}_em"></select>
            </div>
          </div>
          <div class="miniHint">會自動避免與第一場重疊。</div>
        </div>
      </div>
    `;
  }).join("");
  wrap.innerHTML = rows;

  // fill selects
  wrap.querySelectorAll('select[data-r2sel="H"]').forEach(sel=>fillTimeSelect(sel,"H"));
  wrap.querySelectorAll('select[data-r2sel="M"]').forEach(sel=>fillTimeSelect(sel,"M"));

  // set values
  days.forEach(d=>{
    const cur=state.range2[d];
    const [sh,sm]=cur.start.split(":");
    const [eh,em]=cur.end.split(":");
    $(`#r2_${d}_sh`).value = sh;
    $(`#r2_${d}_sm`).value = sm;
    $(`#r2_${d}_eh`).value = eh;
    $(`#r2_${d}_em`).value = em;
  });

  // bind checkbox
  wrap.querySelectorAll('input[data-r2chk="1"]').forEach(cb=>{
    cb.addEventListener("change", ()=>{
      const d = cb.dataset.date;
      state.range2[d].on = !!cb.checked;
      const box = wrap.querySelector(`[data-r2time="${d}"]`);
      if(box) box.style.display = cb.checked ? "block" : "none";
      if(cb.checked){
        // enforce overlap against first scene end
        const t1End = getHM($("#rangeEndH"),$("#rangeEndM"));
        const fixed = enforceNoOverlap(t1End, state.range2[d].start, state.range2[d].end);
        state.range2[d].start = fixed.start; state.range2[d].end = fixed.end;
        const [sh,sm]=fixed.start.split(":");
        const [eh,em]=fixed.end.split(":");
        $(`#r2_${d}_sh`).value=sh; $(`#r2_${d}_sm`).value=sm;
        $(`#r2_${d}_eh`).value=eh; $(`#r2_${d}_em`).value=em;
      }
      renderAll();
    });
  });

  // bind selects
  wrap.querySelectorAll('select[id^="r2_"]').forEach(sel=>{
    sel.addEventListener("change", ()=>{
      const id = sel.id; // r2_YYYY-MM-DD_sh etc
      const d = id.split("_")[1];
      const sh=$(`#r2_${d}_sh`).value, sm=$(`#r2_${d}_sm`).value;
      const eh=$(`#r2_${d}_eh`).value, em=$(`#r2_${d}_em`).value;
      state.range2[d].start = `${sh}:${sm}`;
      state.range2[d].end   = `${eh}:${em}`;

      // enforce overlap
      const t1End = getHM($("#rangeEndH"),$("#rangeEndM"));
      const fixed = enforceNoOverlap(t1End, state.range2[d].start, state.range2[d].end);
      state.range2[d].start = fixed.start; state.range2[d].end = fixed.end;
      const [fsh,fsm]=fixed.start.split(":");
      const [feh,fem]=fixed.end.split(":");
      $(`#r2_${d}_sh`).value=fsh; $(`#r2_${d}_sm`).value=fsm;
      $(`#r2_${d}_eh`).value=feh; $(`#r2_${d}_em`).value=fem;

      renderAll();
    });
  });
}

/** Multi mode: add/remove days and day cards */
function addMultiDay(dateStr){
  const d = dateStr || toYMD(new Date());
  if(!state.dayMeta[d]){
    state.dayMeta[d] = {
      time1:{ start:"09:00", end:"12:00" },
      has2:false,
      time2:{ start:"18:00", end:"21:00" }
    };
    state.cartByDate[d] = state.cartByDate[d] || {};
  }
  if(!state.activeDate) state.activeDate = d;
  renderMultiDays();
  renderDateSwitcher();
  renderAll();
}
function removeMultiDay(d){
  delete state.dayMeta[d];
  delete state.cartByDate[d];
  if(state.activeDate===d){
    const days=getSelectedDates();
    state.activeDate = days[0] || "";
  }
  renderMultiDays();
  renderDateSwitcher();
  renderAll();
}
function renderMultiDays(){
  const wrap = $("#multiDaysWrap");
  if(state.mode!=="multi"){ wrap.innerHTML=""; return; }
  const days = getSelectedDates();
  if(!days.length){
    wrap.innerHTML = `<div class="hint">請先新增日期。</div>`;
    return;
  }

  wrap.innerHTML = days.map(d=>{
    const meta = state.dayMeta[d];
    const active = (state.activeDate===d) ? "active" : "";
    return `
      <div class="dayCard" data-day="${d}">
        <div class="dayTop">
          <div class="dayLeft">
            <button class="smallBtn ${active}" data-act="setActive" data-date="${d}">設定此日：<b class="tag">${d}</b></button>
            <span class="pill" style="border-style:dashed;">分日設備</span>
          </div>
          <button class="smallBtn danger" data-act="removeDay" data-date="${d}">移除</button>
        </div>

        <div class="subBox">
          <div style="font-weight:900;margin-bottom:6px">第一場時間</div>
          <div class="timeRow">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <select data-dsel="H" id="m_${d}_t1sh"></select>
              <select data-dsel="M" id="m_${d}_t1sm"></select>
            </div>
            <div class="sep">～</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <select data-dsel="H" id="m_${d}_t1eh"></select>
              <select data-dsel="M" id="m_${d}_t1em"></select>
            </div>
          </div>
        </div>

        <div>
          <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted);cursor:pointer;">
            <input type="checkbox" data-has2="1" data-date="${d}" style="width:18px;height:18px" ${meta.has2?"checked":""}>
            該日有第二場（+30%）
          </label>

          <div class="subBox" data-2wrap="${d}" style="${meta.has2?"display:block":"display:none"};margin-top:8px">
            <div style="font-weight:900;margin-bottom:6px">第二場時間（不得與第一場重疊）</div>
            <div class="timeRow">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <select data-dsel="H" id="m_${d}_t2sh"></select>
                <select data-dsel="M" id="m_${d}_t2sm"></select>
              </div>
              <div class="sep">～</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <select data-dsel="H" id="m_${d}_t2eh"></select>
                <select data-dsel="M" id="m_${d}_t2em"></select>
              </div>
            </div>
            <div class="miniHint">若選到重疊，系統會自動修正成合法時間。</div>
          </div>
        </div>
      </div>
    `;
  }).join("");

  // fill selects
  wrap.querySelectorAll('select[data-dsel="H"]').forEach(sel=>fillTimeSelect(sel,"H"));
  wrap.querySelectorAll('select[data-dsel="M"]').forEach(sel=>fillTimeSelect(sel,"M"));

  // set values
  days.forEach(d=>{
    const meta=state.dayMeta[d];
    const [a,b]=meta.time1.start.split(":");
    const [c,d2]=meta.time1.end.split(":");
    $(`#m_${d}_t1sh`).value=a; $(`#m_${d}_t1sm`).value=b;
    $(`#m_${d}_t1eh`).value=c; $(`#m_${d}_t1em`).value=d2;
    const [e,f]=meta.time2.start.split(":");
    const [g,h]=meta.time2.end.split(":");
    $(`#m_${d}_t2sh`).value=e; $(`#m_${d}_t2sm`).value=f;
    $(`#m_${d}_t2eh`).value=g; $(`#m_${d}_t2em`).value=h;
  });

  // bind actions
  wrap.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const act=btn.dataset.act;
      const d=btn.dataset.date;
      if(act==="removeDay") removeMultiDay(d);
      if(act==="setActive"){ state.activeDate=d; renderDateSwitcher(); renderAll(); renderMultiDays(); }
    });
  });

  // bind has2
  wrap.querySelectorAll('input[data-has2="1"]').forEach(cb=>{
    cb.addEventListener("change", ()=>{
      const d=cb.dataset.date;
      state.dayMeta[d].has2 = !!cb.checked;
      const box = wrap.querySelector(`[data-2wrap="${d}"]`);
      if(box) box.style.display = cb.checked ? "block" : "none";

      if(cb.checked){
        const t1End = state.dayMeta[d].time1.end;
        const fixed = enforceNoOverlap(t1End, state.dayMeta[d].time2.start, state.dayMeta[d].time2.end);
        state.dayMeta[d].time2 = fixed;
        const [sh,sm]=fixed.start.split(":");
        const [eh,em]=fixed.end.split(":");
        $(`#m_${d}_t2sh`).value=sh; $(`#m_${d}_t2sm`).value=sm;
        $(`#m_${d}_t2eh`).value=eh; $(`#m_${d}_t2em`).value=em;
      }
      renderAll();
    });
  });

  // bind time selects
  wrap.querySelectorAll('select[id^="m_"]').forEach(sel=>{
    sel.addEventListener("change", ()=>{
      const parts = sel.id.split("_");
      const d = parts[1];
      // t1
      const t1 = {
        start: `${$(`#m_${d}_t1sh`).value}:${$(`#m_${d}_t1sm`).value}`,
        end:   `${$(`#m_${d}_t1eh`).value}:${$(`#m_${d}_t1em`).value}`,
      };
      state.dayMeta[d].time1 = t1;

      // enforce second scene if exists
      if(state.dayMeta[d].has2){
        const t2 = {
          start: `${$(`#m_${d}_t2sh`).value}:${$(`#m_${d}_t2sm`).value}`,
          end:   `${$(`#m_${d}_t2eh`).value}:${$(`#m_${d}_t2em`).value}`,
        };
        const fixed = enforceNoOverlap(t1.end, t2.start, t2.end);
        state.dayMeta[d].time2 = fixed;
        const [sh,sm]=fixed.start.split(":");
        const [eh,em]=fixed.end.split(":");
        $(`#m_${d}_t2sh`).value=sh; $(`#m_${d}_t2sm`).value=sm;
        $(`#m_${d}_t2eh`).value=eh; $(`#m_${d}_t2em`).value=em;
      }

      renderAll();
    });
  });
}

/** Date switcher in equipment section */
function renderDateSwitcher(){
  const sw = $("#dateSwitcher");
  const days = getSelectedDates();
  if(state.mode==="multi"){
    sw.innerHTML = days.map(d=>{
      const cls = (state.activeDate===d) ? "smallBtn active" : "smallBtn";
      return `<button class="${cls}" data-sw="${d}">${d}</button>`;
    }).join("");
    sw.querySelectorAll("button[data-sw]").forEach(b=>{
      b.addEventListener("click", ()=>{
        state.activeDate = b.dataset.sw;
        renderDateSwitcher();
        renderAll();
        renderMultiDays();
      });
    });
    $("#activeDateLabel").textContent = state.activeDate || "（尚未選擇日期）";
    if(!state.activeDate && days.length){
      state.activeDate = days[0];
      $("#activeDateLabel").textContent = state.activeDate;
    }
  }else{
    sw.innerHTML = `<span class="muted">（此模式使用同一份設備，不分日期）</span>`;
    $("#activeDateLabel").textContent = days[0] || "（尚未選擇日期）";
    state.activeDate = ""; // not used
  }
}

/** Equipment helpers */
function findItem(itemId){
  for(const c of CATEGORIES){
    const it = c.items.find(x=>x.id===itemId);
    if(it) return {cat:c,item:it};
  }
  return null;
}
function getCartObjForActive(){
  if(state.mode==="multi"){
    const d = state.activeDate;
    if(!d) return null;
    state.cartByDate[d] = state.cartByDate[d] || {};
    return state.cartByDate[d];
  }
  return state.cart;
}
function setQty(itemId, qty){
  const cartObj = getCartObjForActive();
  if(!cartObj) return;
  if(qty<=0) delete cartObj[itemId];
  else cartObj[itemId]=qty;
  renderAll();
}
function fmt(n){ return "NT$" + Math.round(n||0).toLocaleString(); }
function lineSubtotal(item, qty){ return (item.price||0) * (qty||0); }
function cartSubtotal(cartObj){
  let sum=0;
  for(const [id,qty] of Object.entries(cartObj||{})){
    const hit=findItem(id);
    if(hit) sum += lineSubtotal(hit.item, qty);
  }
  return sum;
}
function buildFlatItemsForDay(date, cartObj){
  const arr=[];
  for(const [id,qty] of Object.entries(cartObj||{})){
    const hit=findItem(id);
    if(!hit) continue;
    const it=hit.item;
    arr.push({
      date,
      categoryName: hit.cat.name,
      name: it.name,
      qty,
      price: it.price,
      lineTotal: it.price*qty
    });
  }
  return arr;
}
function renderTabs(){
  const el=$("#tabs");
  el.innerHTML = CATEGORIES.map(c=>`<button class="tab ${c.id===state.catId?"active":""}" data-cat="${c.id}">${c.name}</button>`).join("");
  el.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", ()=>{
      state.catId=b.dataset.cat;
      renderItems();
    });
  });
}
function renderItems(){
  const cat = CATEGORIES.find(c=>c.id===state.catId);
  const el=$("#items");
  const cartObj = getCartObjForActive() || {};
  el.innerHTML = (cat?.items||[]).map(it=>{
    const qty = cartObj[it.id] || 0;
    return `
      <div class="item">
        <div>
          <div class="name">${it.name}</div>
          <div class="sub">單價：${fmt(it.price)}</div>
        </div>
        <div style="display:flex;gap:14px;align-items:center;justify-content:flex-end">
          <div class="qty">
            <button class="qbtn" data-act="dec" data-id="${it.id}">-</button>
            <div class="qval">${qty}</div>
            <button class="qbtn" data-act="inc" data-id="${it.id}">+</button>
          </div>
          <div class="price">${fmt(it.price*qty)}</div>
        </div>
      </div>
    `;
  }).join("");

  el.querySelectorAll("button[data-act]").forEach(b=>{
    const act=b.dataset.act, id=b.dataset.id;
    if(act==="inc") b.addEventListener("click", ()=>setQty(id,(getCartObjForActive()?.[id]||0)+1));
    if(act==="dec") b.addEventListener("click", ()=>setQty(id,Math.max(0,(getCartObjForActive()?.[id]||0)-1)));
  });
}
  <script>
/** Pricing: continuous segments (2nd day +50%, 3rd+ +30%), session2 +30% each day */
function calcAll(){
  const days = getSelectedDates();
  const breakdown = [];

  if(!days.length){
    return { total:0, breakdown, flatItems:[], metaDays:[] };
  }

  // For each day, determine which cart applies
  const dayEntries = days.map(d=>{
    let cartObj = {};
    if(state.mode==="multi"){
      cartObj = state.cartByDate[d] || {};
    }else{
      cartObj = state.cart || {};
    }
    const base = cartSubtotal(cartObj);
    const items = buildFlatItemsForDay(d, cartObj);
    return { date:d, cartObj, base, items };
  });

  // Segment index based on consecutive dates
  // segmentDayIndex: 1,2,3... resets when diff != 1
  let segIndex=1;
  dayEntries.forEach((x, i)=>{
    if(i===0) segIndex=1;
    else{
      const prev = dayEntries[i-1].date;
      segIndex = (diffDays(prev, x.date)===1) ? (segIndex+1) : 1;
    }
    x.segDayIndex = segIndex;
  });

  // Determine time meta and session2 per day
  const metaDays = dayEntries.map(x=>{
    if(state.mode==="single"){
      const time1 = { start:getHM($("#singleStartH"),$("#singleStartM")), end:getHM($("#singleEndH"),$("#singleEndM")) };
      const has2 = $("#singleHas2").checked;
      const t2raw = { start:getHM($("#single2StartH"),$("#single2StartM")), end:getHM($("#single2EndH"),$("#single2EndM")) };
      const t2 = has2 ? enforceNoOverlap(time1.end, t2raw.start, t2raw.end) : {start:"",end:""};
      return { date:x.date, time1, has2, time2:t2 };
    }
    if(state.mode==="range"){
      const time1 = { start:getHM($("#rangeStartH"),$("#rangeStartM")), end:getHM($("#rangeEndH"),$("#rangeEndM")) };
      const has2 = $("#rangeHas2").checked && !!state.range2[x.date]?.on;
      const t2raw = state.range2[x.date] ? { start:state.range2[x.date].start, end:state.range2[x.date].end } : { start:"18:00", end:"21:00" };
      const t2 = has2 ? enforceNoOverlap(time1.end, t2raw.start, t2raw.end) : {start:"",end:""};
      return { date:x.date, time1, has2, time2:t2 };
    }
    // multi
    const meta = state.dayMeta[x.date] || { time1:{start:"09:00",end:"12:00"}, has2:false, time2:{start:"18:00",end:"21:00"} };
    const time1 = meta.time1;
    const has2 = !!meta.has2;
    const time2 = has2 ? enforceNoOverlap(time1.end, meta.time2.start, meta.time2.end) : {start:"",end:""};
    return { date:x.date, time1, has2, time2 };
  });

  // compute fees per day
  let total = 0;
  const flatItems = [];
  dayEntries.forEach((x, idx)=>{
    flatItems.push(...x.items);

    const dayBase = x.base;
    // day surcharge by seg index (2nd day 50%, 3rd+ 30%)
    let dayFee = 0;
    if(x.segDayIndex===2) dayFee = dayBase * 0.5;
    else if(x.segDayIndex>=3) dayFee = dayBase * 0.3;

    // session2 fee
    const m = metaDays[idx];
    const s2Fee = m.has2 ? (dayBase * 0.3) : 0;

    const dayTotal = dayBase + dayFee + s2Fee;
    total += dayTotal;

    breakdown.push({
      date:x.date,
      segDayIndex:x.segDayIndex,
      base:dayBase,
      dayFee,
      has2:m.has2,
      s2Fee,
      dayTotal,
      time1:m.time1,
      time2:m.time2
    });
  });

  return { total, breakdown, flatItems, metaDays };
}

function renderSummary(){
  const { total, breakdown } = calcAll();
  $("#sumTotal").textContent = fmt(total);

  if(!breakdown.length){
    $("#sumBreakdown").innerHTML = `<div class="hint">請先選日期並選設備。</div>`;
    return;
  }

  $("#sumBreakdown").innerHTML = breakdown.map(b=>{
    const segText = (b.segDayIndex===1) ? "第1天（原價）" : (b.segDayIndex===2 ? "第2天（+50%）" : `第${b.segDayIndex}天（+30%）`);
    return `
      <div style="border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px;background:#fff">
        <div class="row" style="justify-content:space-between">
          <div><b class="tag">${b.date}</b> <span class="muted">｜${segText}</span></div>
          <div class="ok">${fmt(b.dayTotal)}</div>
        </div>
        <div class="sumRow"><span>設備小計</span><span>${fmt(b.base)}</span></div>
        <div class="sumRow"><span>跨天加價</span><span>${fmt(b.dayFee)}</span></div>
        <div class="sumRow"><span>第二場加價</span><span>${fmt(b.s2Fee)}</span></div>

        <div class="hr"></div>
        <div class="miniHint">
          第一場：${b.time1.start}～${b.time1.end}
          ${b.has2 ? `｜第二場：${b.time2.start}～${b.time2.end}` : "｜第二場：無"}
        </div>
      </div>
    `;
  }).join("");
}

function renderDebug(){
  const payload = buildPayload(false);
  $("#debug").textContent = JSON.stringify({
    mode: state.mode,
    activeDate: state.activeDate,
    days: getSelectedDates(),
    cart: state.cart,
    cartByDate: state.cartByDate,
    dayMeta: state.dayMeta,
    range2: state.range2,
    submitPreview: payload
  }, null, 2);
}

function renderAll(){
  renderTabs();
  renderItems();
  renderSummary();
  renderDebug();
}

/** build payload compatible with your Apps Script doPost */
function buildPayload(includeItemsFlatten=true){
  const { total, breakdown, flatItems } = calcAll();
  const mode = state.mode;
  const days = breakdown.map(b=>({
    date: b.date,
    time1Start: b.time1.start,
    time1End: b.time1.end,
    hasSession2: b.has2 ? "是" : "否",
    session2Start: b.has2 ? b.time2.start : "",
    session2End: b.has2 ? b.time2.end : "",
    segDayIndex: b.segDayIndex,
    dayBase: b.base,
    dayFee: b.dayFee,
    session2Fee: b.s2Fee,
    dayTotal: b.dayTotal,
    cart: (mode==="multi") ? (state.cartByDate[b.date]||{}) : (state.cart||{})
  }));

  // form (keep your old keys as much as possible)
  const selectedDates = getSelectedDates();
  const dateStart = selectedDates[0] || "";
  const dateEnd = selectedDates[selectedDates.length-1] || dateStart;

  const f = {
    name: $("#fName").value || "",
    phone: $("#fPhone").value || "",
    email: $("#fEmail").value || "",
    eventType: $("#fEventType").value || "",
    crowd: $("#fCrowd").value || "",
    indoor: $("#fIndoor").value || "",
    city: $("#fCity").value || "",
    area: $("#fArea").value || "",
    addr: $("#fAddr").value || "",
    note: $("#fNote").value || "",
    dateStart,
    dateEnd,
    timeStart: days[0]?.time1Start || "",
    timeEnd: days[0]?.time1End || "",
    // 這兩個是兼容舊版「第一天第二場」
    hasSession2: days[0]?.hasSession2 || "否",
    session2Start: days[0]?.session2Start || "",
    session2End: days[0]?.session2End || "",
    // 新增：完整分日資料，給 PDFTemplate 用
    scheduleMode: mode,
    scheduleJson: JSON.stringify(days),
  };

  // summary
  const summary = {
    subtotal: breakdown.reduce((a,b)=>a+(b.base||0),0),
    dayFee: breakdown.reduce((a,b)=>a+(b.dayFee||0),0),
    session2Fee: breakdown.reduce((a,b)=>a+(b.s2Fee||0),0),
    total
  };

  // items
  const items = includeItemsFlatten ? flatItems : [];
  // IMPORTANT: 讓 PDF 可以分日，你可以在 PDFTemplate 依 item.date 分組顯示
  // 同時 f.scheduleJson 也能列出每天時間/加價

  return {
    action: "submitQuote",
    ownerEmail: "", // 你若要前端指定店家信箱可填，否則 Apps Script 會用系統設定
    form: f,
    items,
    summary
  };
}

/** Submit */
async function submitQuote(){
  if(!APPS_SCRIPT_ENDPOINT){
    alert("請先在程式最上方設定 APPS_SCRIPT_ENDPOINT（你的 Apps Script Web App URL）");
    return;
  }
  const payload = buildPayload(true);

  // basic validation
  const days = getSelectedDates();
  if(!days.length){
    alert("請先選擇活動日期。");
    return;
  }
  // multi mode needs at least one active day
  if(state.mode==="multi" && !state.activeDate){
    state.activeDate = days[0];
  }

  try{
    const res = await fetch(APPS_SCRIPT_ENDPOINT, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    if(json?.ok){
      alert(`已送出報價單！單號：${json.orderId}\n客人寄送：${json.mailed?.customer?"成功":"未寄"}\n店家寄送：${json.mailed?.owner?"成功":"未寄"}`);
    }else{
      alert("送出失敗：" + (json?.error || "未知錯誤"));
    }
  }catch(e){
    alert("送出失敗：" + String(e));
  }
}

/** Events */
function wireSingleMode(){
  $("#singleHas2").addEventListener("change", ()=>{
    $("#single2Wrap").style.display = $("#singleHas2").checked ? "block" : "none";
    // enforce overlap right away
    if($("#singleHas2").checked){
      const t1End = getHM($("#singleEndH"),$("#singleEndM"));
      const t2 = { start:getHM($("#single2StartH"),$("#single2StartM")), end:getHM($("#single2EndH"),$("#single2EndM")) };
      const fixed = enforceNoOverlap(t1End, t2.start, t2.end);
      setHM($("#single2StartH"),$("#single2StartM"),fixed.start);
      setHM($("#single2EndH"),$("#single2EndM"),fixed.end);
    }
    renderAll();
  });

  // any time change -> enforce overlap
  ["singleStartH","singleStartM","singleEndH","singleEndM","single2StartH","single2StartM","single2EndH","single2EndM","singleDate"].forEach(id=>{
    $("#"+id).addEventListener("change", ()=>{
      if($("#singleHas2").checked){
        const t1End = getHM($("#singleEndH"),$("#singleEndM"));
        const t2 = { start:getHM($("#single2StartH"),$("#single2StartM")), end:getHM($("#single2EndH"),$("#single2EndM")) };
        const fixed = enforceNoOverlap(t1End, t2.start, t2.end);
        setHM($("#single2StartH"),$("#single2StartM"),fixed.start);
        setHM($("#single2EndH"),$("#single2EndM"),fixed.end);
      }
      renderAll();
    });
  });
}

function wireRangeMode(){
  $("#rangeHas2").addEventListener("change", ()=>{
    renderRangeDays();
    renderAll();
  });
  ["rangeStart","rangeEnd","rangeStartH","rangeStartM","rangeEndH","rangeEndM"].forEach(id=>{
    $("#"+id).addEventListener("change", ()=>{
      renderRangeDays();
      renderDateSwitcher();
      renderAll();
    });
  });
}

function wireMultiMode(){
  $("#btnAddDay").addEventListener("click", ()=>{
    // default add: today or last day + 1
    const days = getSelectedDates();
    const next = days.length ? addDays(days[days.length-1], 1) : toYMD(new Date());
    addMultiDay(next);
  });
}

function wireReset(){
  $("#btnReset").addEventListener("click", ()=>{
    if(!confirm("確定要清空全部資料？")) return;
    // reset
    state.mode="single";
    document.querySelector('input[name="dateMode"][value="single"]').checked=true;
    state.activeDate="";
    state.cart={};
    state.cartByDate={};
    state.dayMeta={};
    state.range2={};
    state.catId="pkg";

    // clear form
    ["fName","fPhone","fEmail","fEventType","fCrowd","fCity","fArea","fAddr","fNote"].forEach(id=>$("#"+id).value="");
    $("#fIndoor").value="";
    $("#singleDate").value="";
    $("#rangeStart").value="";
    $("#rangeEnd").value="";
    $("#singleHas2").checked=false;
    $("#single2Wrap").style.display="none";
    $("#rangeHas2").checked=false;
    $("#rangeDaysWrap").style.display="none";

    renderModePanels();
    renderRangeDays();
    renderMultiDays();
    renderDateSwitcher();
    renderAll();
  });
}

function wireSubmit(){
  $("#btnSubmit").addEventListener("click", submitQuote);
}

/** Initialize */
(async function main(){
  initTimeControls();
  wireModeSwitch();
  wireSingleMode();
  wireRangeMode();
  wireMultiMode();
  wireReset();
  wireSubmit();

  // default date = today
  $("#singleDate").value = toYMD(new Date());

  // when mode changes, extra renders
  $("#rangeStart").addEventListener("change", ()=>renderRangeDays());
  $("#rangeEnd").addEventListener("change", ()=>renderRangeDays());

  await tryLoadFromAppsScript();

  renderModePanels();
  renderRangeDays();
  renderMultiDays();
  renderDateSwitcher();
  renderAll();
})();
</script>

</body>
</html>
