<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>活動企劃｜設備選配與即時報價</title>
<style>
:root{
  --bg:#f6f7fb; --card:#fff; --text:#1a1f2b; --muted:#6b7280; --line:#e5e7eb;
  --brand:#1e8e6f; --brand2:#156e56; --danger:#e24a4a;
  --shadow:0 10px 28px rgba(0,0,0,.08); --radius:16px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
.wrap{max-width:1150px;margin:0 auto;padding:18px}
header{background:linear-gradient(135deg,#ffffff, #f3fbf8);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px 18px 14px;margin-bottom:14px}
h1{margin:0 0 6px;font-size:22px}
.sub{color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns: 1.55fr .85fr;gap:14px;align-items:start}
@media (max-width: 980px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.card-h{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:end;flex-wrap:wrap}
.card-h h2{margin:0;font-size:16px}
.tools{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
select,input{border:1px solid var(--line);border-radius:12px;padding:9px 10px;font-size:14px;background:#fff;outline:none}
select:focus,input:focus{border-color:#bfe7dc;box-shadow:0 0 0 4px rgba(30,142,111,.12)}
.small{font-size:12px;color:var(--muted)}

.items{padding:14px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media (max-width: 600px){.items{grid-template-columns:1fr}}

.it{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff;display:flex;flex-direction:column;min-height:220px}
.thumb{height:120px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-weight:700}
.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.itb{padding:10px 10px 12px;display:flex;flex-direction:column;gap:6px;flex:1}
.name{font-weight:800}
.meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px}
.price{margin-left:auto;font-weight:800;color:var(--brand2)}
.actions{margin-top:auto;display:flex;gap:8px;align-items:center;justify-content:space-between}
.qty{display:flex;gap:8px;align-items:center}
.qbtn{width:34px;height:34px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer}
.qnum{min-width:22px;text-align:center;font-weight:800}
.btn{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.primary:hover{background:var(--brand2)}
.btn.ghost{background:#fff;border:1px solid var(--line)}
.btn.danger{background:var(--danger);color:#fff}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#ecfeff;color:#0f766e;font-size:12px;font-weight:700}

.side{position:sticky;top:14px}
@media (max-width: 980px){.side{position:static}}
.side .body{padding:14px}
.quote-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.qrow{border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center}
.qname{font-weight:800}
.qsub{color:var(--muted);font-size:12px}
.qright{margin-left:auto;text-align:right}
.total{margin-top:12px;padding-top:12px;border-top:1px dashed var(--line);display:flex;align-items:flex-end}
.total .t{font-size:12px;color:var(--muted)}
.total .v{margin-left:auto;font-size:22px;font-weight:900}
.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:999px;font-size:13px;opacity:0;pointer-events:none;transition:.25s}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}

dialog{border:0;border-radius:16px;max-width:720px;width:calc(100% - 26px);box-shadow:0 20px 60px rgba(0,0,0,.25)}
dialog::backdrop{background:rgba(0,0,0,.35)}
.modal-h{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
.modal-h b{font-size:16px}
.modal-b{padding:14px 16px}
.modal-f{padding:14px 16px;border-top:1px solid var(--line);display:flex;gap:10px;justify-content:flex-end}
.ul{margin:8px 0 0;padding-left:18px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>活動企劃｜設備選配與即時報價</h1>
    <div class="sub">資料來源：Google Sheet（你改 Sheet，網頁會跟著更新）。</div>
  </header>

  <div class="grid">
    <main class="card">
      <div class="card-h">
        <h2>2) 燈光音響配置區（方案）</h2>
        <span class="small">點「詳情」看方案內容，點「加入」加入報價單。</span>
      </div>
      <div id="packages" class="items"></div>

      <div class="card-h" style="border-top:1px solid var(--line);">
        <h2>3) 設備 / 服務分類（自由加減）</h2>
        <div class="tools">
          <select id="catSel"><option value="">全部分類</option></select>
          <input id="q" placeholder="搜尋：麥克風、喇叭、PAR..." />
          <select id="sortSel">
            <option value="sortAsc">排序：sort（小→大）</option>
            <option value="priceAsc">價格：低→高</option>
            <option value="priceDesc">價格：高→低</option>
          </select>
          <span class="small">小提醒：items 表裡 img 欄位請放「可公開的圖片網址」。</span>
        </div>
      </div>
      <div id="items" class="items"></div>
      <div id="loadErr" class="small" style="padding:0 14px 14px;color:#b91c1c;display:none"></div>
    </main>

    <aside class="card side">
      <div class="card-h">
        <h2>即時報價單</h2>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button class="btn ghost" id="btnReload">重新載入</button>
          <button class="btn danger" id="btnClear">清空報價</button>
        </div>
      </div>
      <div class="body">
        <div class="small">加入品項後會出現在這裡</div>
        <div id="quote" class="quote-list"></div>

        <div class="total">
          <div class="t">預估總金額<br><span class="small">※ 這是「設備選配」估算，運費/人力/場勘可再加項目。</span></div>
          <div class="v" id="total">NT$ 0</div>
        </div>
      </div>
    </aside>
  </div>
</div>

<div class="toast" id="toast">已加入</div>

<dialog id="dlg">
  <div class="modal-h">
    <b id="dlgTitle">詳情</b>
    <span class="badge" id="dlgBadge" style="display:none"></span>
    <div style="margin-left:auto"></div>
    <button class="btn ghost" id="dlgClose">關閉</button>
  </div>
  <div class="modal-b" id="dlgBody"></div>
  <div class="modal-f">
    <button class="btn primary" id="dlgAdd">加入報價</button>
  </div>
</dialog>

<script>
/** ✅ 你的 Google Sheet CSV 連結（你已經做成功的） **/
const CATEGORIES_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSQagyOTerM4A-yQzU_rZ_jEEHnHv7ilzAeu9XpbaeqVOz3Ur-sINk07I_JYJrW_YKvRDJMi51xPJS-/pub?gid=0&single=true&output=csv";
const ITEMS_CSV      = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSQagyOTerM4A-yQzU_rZ_jEEHnHv7ilzAeu9XpbaeqVOz3Ur-sINk07I_JYJrW_YKvRDJMi51xPJS-/pub?gid=253807614&single=true&output=csv";
const PACKAGES_CSV   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSQagyOTerM4A-yQzU_rZ_jEEHnHv7ilzAeu9XpbaeqVOz3Ur-sINk07I_JYJrW_YKvRDJMi51xPJS-/pub?gid=1516378637&single=true&output=csv";
const PKGITEMS_CSV   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSQagyOTerM4A-yQzU_rZ_jEEHnHv7ilzAeu9XpbaeqVOz3Ur-sINk07I_JYJrW_YKvRDJMi51xPJS-/pub?gid=1279769302&single=true&output=csv";

const state = {
  categories: [],
  items: [],
  packages: [],
  pkgItems: [],
  quote: JSON.parse(localStorage.getItem("quote_v2")||"[]"), // [{type:'item'|'pkg', id, name, unit, price, qty}]
  selectedCat: "",
  q: "",
  sort: "sortAsc",
  dlgPayload: null,
};

const $ = (s)=>document.querySelector(s);
const fmt = (n)=>"NT$ " + (Math.round(Number(n)||0)).toLocaleString("zh-Hant-TW");

function toast(msg){
  const t=$("#toast");
  t.textContent=msg||"完成";
  t.classList.add("show");
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.classList.remove("show"),1100);
}

function parseCSV(text){
  // 簡單 CSV 解析（支援引號）
  const rows=[];
  let row=[], cur="", inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(inQ){
      if(c=='"' && n=='"'){cur+='"'; i++;}
      else if(c=='"') inQ=false;
      else cur+=c;
    }else{
      if(c=='"') inQ=true;
      else if(c==","){row.push(cur); cur="";}
      else if(c=="\n"){row.push(cur); rows.push(row); row=[]; cur="";}
      else if(c=="\r"){/* ignore */}
      else cur+=c;
    }
  }
  if(cur.length||row.length){row.push(cur); rows.push(row);}
  return rows.filter(r=>r.some(x=>String(x||"").trim()!==""));
}

async function loadAll(){
  try{
    $("#loadErr").style.display="none";
    const [cTxt,iTxt,pTxt,piTxt] = await Promise.all([
      fetch(CATEGORIES_CSV).then(r=>r.text()),
      fetch(ITEMS_CSV).then(r=>r.text()),
      fetch(PACKAGES_CSV).then(r=>r.text()),
      fetch(PKGITEMS_CSV).then(r=>r.text()),
    ]);
    state.categories = toObjects(parseCSV(cTxt));
    state.items      = toObjects(parseCSV(iTxt));
    state.packages   = toObjects(parseCSV(pTxt));
    state.pkgItems   = toObjects(parseCSV(piTxt));
    normalize();
    renderAll();
  }catch(err){
    console.error(err);
    $("#loadErr").style.display="block";
    $("#loadErr").textContent="載入失敗：請確認 Google Sheet「發布到網路」仍有效，且 4 條 CSV 連結在瀏覽器可直接開到資料。";
  }
}

function toObjects(rows){
  if(!rows.length) return [];
  const head = rows[0].map(h=>String(h||"").trim());
  return rows.slice(1).map(r=>{
    const o={};
    head.forEach((h,idx)=>o[h]= (r[idx]??"").trim?.() ? r[idx].trim() : (r[idx]??""));
    return o;
  }).filter(o=>Object.values(o).some(v=>String(v||"").trim()!==""));
}

function normalize(){
  state.categories = state.categories.map(x=>({
    catId: String(x.catId||x.id||"").trim(),
    catName: String(x.catName||x.name||"").trim(),
    sort: Number(x.sort||0),
  })).filter(x=>x.catId && x.catName)
    .sort((a,b)=>(a.sort-b.sort)||a.catName.localeCompare(b.catName));

  state.items = state.items.map(x=>({
    id: String(x.id||"").trim(),
    catId: String(x.catId||"").trim(),
    name: String(x.name||"").trim(),
    unit: String(x.unit||"").trim() || "項",
    price: Number(String(x.price||"0").replace(/[^0-9.]/g,""))||0,
    img: String(x.img||"").trim(),
    desc: String(x.desc||x.shortDesc||"").trim(),
    detail: String(x.detail||"").trim(),
    sort: Number(x.sort||0),
  })).filter(x=>x.id && x.name)
    .sort((a,b)=>(a.sort-b.sort)||a.name.localeCompare(b.name));

  state.packages = state.packages.map(x=>({
    pkgId: String(x.pkgId||x.id||"").trim(),
    pkgName: String(x.pkgName||x.name||"").trim(),
    unit: "套",
    price: Number(String(x.price||"0").replace(/[^0-9.]/g,""))||0,
    shortDesc: String(x.shortDesc||x.desc||"").trim(),
    detail: String(x.detail||"").trim(),
    sort: Number(x.sort||0),
  })).filter(x=>x.pkgId && x.pkgName)
    .sort((a,b)=>(a.sort-b.sort)||a.pkgName.localeCompare(b.pkgName));

  state.pkgItems = state.pkgItems.map(x=>({
    pkgId: String(x.pkgId||"").trim(),
    itemText: String(x.itemText||x.text||x.item||"").trim(),
    sort: Number(x.sort||0),
  })).filter(x=>x.pkgId && x.itemText)
    .sort((a,b)=>(a.sort-b.sort));
}

function renderAll(){
  renderCats();
  renderPackages();
  renderItems();
  renderQuote();
}

function renderCats(){
  const sel=$("#catSel");
  const cur=sel.value;
  sel.innerHTML = '<option value="">全部分類</option>' + state.categories.map(c=>`<option value="${esc(c.catId)}">${esc(c.catName)}</option>`).join("");
  sel.value = cur || state.selectedCat || "";
}

function renderPackages(){
  const box=$("#packages");
  if(!state.packages.length){box.innerHTML='<div class="small">（packages 沒有資料）</div>'; return;}
  box.innerHTML = state.packages.map(p=>{
    return `
      <div class="it">
        <div class="thumb">方案</div>
        <div class="itb">
          <div class="name">${esc(p.pkgName)}</div>
          <div class="meta">
            <span class="badge">方案</span>
            <span>單位：${esc(p.unit)}</span>
            <span class="price">${fmt(p.price)}</span>
          </div>
          <div class="small">${esc(p.shortDesc||"")}</div>
          <div class="actions">
            <button class="btn ghost" data-pkg-detail="${esc(p.pkgId)}">詳情</button>
            <button class="btn primary" data-pkg-add="${esc(p.pkgId)}">加入</button>
          </div>
        </div>
      </div>`;
  }).join("");
}

function passesFilter(it){
  const q = state.q.trim().toLowerCase();
  if(state.selectedCat && it.catId!==state.selectedCat) return false;
  if(!q) return true;
  return [it.name,it.desc,it.detail].some(s=>String(s||"").toLowerCase().includes(q));
}

function sortItems(arr){
  const mode = state.sort;
  const a=[...arr];
  if(mode==="priceAsc") a.sort((x,y)=>x.price-y.price);
  else if(mode==="priceDesc") a.sort((x,y)=>y.price-x.price);
  else a.sort((x,y)=>(x.sort-y.sort)||x.name.localeCompare(y.name));
  return a;
}

function renderItems(){
  const box=$("#items");
  const filtered = sortItems(state.items.filter(passesFilter));
  if(!filtered.length){box.innerHTML='<div class="small">（沒有符合的品項）</div>'; return;}
  box.innerHTML = filtered.map(it=>{
    const thumb = it.img ? `<img src="${esc(it.img)}" alt="">` : '無圖片';
    return `
    <div class="it">
      <div class="thumb">${thumb}</div>
      <div class="itb">
        <div class="name">${esc(it.name)}</div>
        <div class="meta">
          <span>${catName(it.catId)}</span>
          <span>單位：${esc(it.unit)}</span>
          <span class="price">${fmt(it.price)}</span>
        </div>
        <div class="small">${esc(it.desc||"")}</div>
        <div class="actions">
          <div class="qty">
            <button class="qbtn" data-dec="${esc(it.id)}">−</button>
            <div class="qnum" id="q-${esc(it.id)}">${getQty("item",it.id)}</div>
            <button class="qbtn" data-inc="${esc(it.id)}">＋</button>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn ghost" data-detail="${esc(it.id)}">詳情</button>
            <button class="btn primary" data-add="${esc(it.id)}">加入</button>
          </div>
        </div>
      </div>
    </div>`;
  }).join("");
}

function catName(catId){
  const c = state.categories.find(x=>x.catId===catId);
  return c ? `分類：${esc(c.catName)}` : "分類：—";
}

function getQty(type,id){
  const row = state.quote.find(x=>x.type===type && x.id===id);
  return row ? row.qty : 0;
}

function upsertQuote(row){
  const i = state.quote.findIndex(x=>x.type===row.type && x.id===row.id);
  if(i>=0){ state.quote[i].qty = row.qty; }
  else state.quote.push(row);
  state.quote = state.quote.filter(x=>x.qty>0);
  localStorage.setItem("quote_v2", JSON.stringify(state.quote));
}

function addOne(type,id){
  if(type==="item"){
    const it = state.items.find(x=>x.id===id); if(!it) return;
    const qty = getQty("item",id)+1;
    upsertQuote({type:"item", id:it.id, name:it.name, unit:it.unit, price:it.price, qty});
    toast("已加入品項");
  }else{
    const p = state.packages.find(x=>x.pkgId===id); if(!p) return;
    const qty = getQty("pkg",id)+1;
    upsertQuote({type:"pkg", id:p.pkgId, name:`【方案】${p.pkgName}`, unit:p.unit, price:p.price, qty});
    toast("已加入方案");
  }
  renderQuote();
  if(type==="item"){ const el=document.getElementById("q-"+id); if(el) el.textContent=String(getQty("item",id)); }
}

function decOne(id){
  const qty = Math.max(0, getQty("item",id)-1);
  const it = state.items.find(x=>x.id===id); if(!it) return;
  upsertQuote({type:"item", id:it.id, name:it.name, unit:it.unit, price:it.price, qty});
  renderQuote();
  const el=document.getElementById("q-"+id); if(el) el.textContent=String(qty);
}

function renderQuote(){
  const box=$("#quote");
  if(!state.quote.length){box.innerHTML='<div class="small">尚未加入任何品項。到左側選擇並按「加入」。</div>'; $("#total").textContent=fmt(0); return;}
  box.innerHTML = state.quote.map((r,idx)=>{
    const sub = `${fmt(r.price)} × ${r.qty} ${r.unit}`;
    const line = r.price * r.qty;
    return `
      <div class="qrow">
        <div>
          <div class="qname">${esc(r.name)}</div>
          <div class="qsub">${esc(sub)}</div>
        </div>
        <div class="qright">
          <div style="font-weight:900">${fmt(line)}</div>
          <button class="btn ghost" style="padding:6px 10px;margin-top:6px" data-rm="${idx}">移除</button>
        </div>
      </div>`;
  }).join("");
  const total = state.quote.reduce((s,r)=>s+(r.price*r.qty),0);
  $("#total").textContent = fmt(total);
}

function openItemDetail(id){
  const it = state.items.find(x=>x.id===id); if(!it) return;
  state.dlgPayload = {kind:"item", id};
  $("#dlgTitle").textContent = it.name;
  $("#dlgBadge").style.display="inline-flex";
  $("#dlgBadge").textContent = "品項";
  $("#dlgBody").innerHTML = `
    <div class="small" style="margin-bottom:8px">${catName(it.catId)} ｜ 單位：${esc(it.unit)} ｜ ${fmt(it.price)}</div>
    <div>${esc(it.detail||it.desc||"")}</div>
  `;
  $("#dlg").showModal();
}

function openPkgDetail(id){
  const p = state.packages.find(x=>x.pkgId===id); if(!p) return;
  const lines = state.pkgItems.filter(x=>x.pkgId===id).sort((a,b)=>a.sort-b.sort);
  state.dlgPayload = {kind:"pkg", id};
  $("#dlgTitle").textContent = p.pkgName;
  $("#dlgBadge").style.display="inline-flex";
  $("#dlgBadge").textContent = "方案";
  $("#dlgBody").innerHTML = `
    <div class="small" style="margin-bottom:8px">單位：${esc(p.unit)} ｜ ${fmt(p.price)}</div>
    <div style="margin-bottom:10px">${esc(p.detail||p.shortDesc||"")}</div>
    <b>內容包含：</b>
    <ul class="ul">
      ${
        (lines.length? lines.map(x=>`<li>${esc(x.itemText)}</li>`).join("") : "<li>（package_items 尚未填寫）</li>")
      }
    </ul>
  `;
  $("#dlg").showModal();
}

function esc(s){
  return String(s??"").replace(/[&<>"']/g, m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

document.addEventListener("click",(e)=>{
  const t=e.target;
  if(t.matches("[data-add]")) addOne("item", t.getAttribute("data-add"));
  if(t.matches("[data-inc]")) addOne("item", t.getAttribute("data-inc"));
  if(t.matches("[data-dec]")) decOne(t.getAttribute("data-dec"));
  if(t.matches("[data-detail]")) openItemDetail(t.getAttribute("data-detail"));

  if(t.matches("[data-pkg-add]")) addOne("pkg", t.getAttribute("data-pkg-add"));
  if(t.matches("[data-pkg-detail]")) openPkgDetail(t.getAttribute("data-pkg-detail"));

  if(t.matches("[data-rm]")){
    const idx=Number(t.getAttribute("data-rm"));
    state.quote.splice(idx,1);
    localStorage.setItem("quote_v2", JSON.stringify(state.quote));
    renderQuote();
    renderItems();
  }
});

$("#catSel").addEventListener("change",(e)=>{state.selectedCat=e.target.value; renderItems();});
$("#q").addEventListener("input",(e)=>{state.q=e.target.value; renderItems();});
$("#sortSel").addEventListener("change",(e)=>{state.sort=e.target.value; renderItems();});
$("#btnClear").addEventListener("click",()=>{state.quote=[]; localStorage.setItem("quote_v2","[]"); renderQuote(); renderItems(); toast("已清空");});
$("#btnReload").addEventListener("click",()=>{toast("重新載入"); loadAll();});
$("#dlgClose").addEventListener("click",()=>$("#dlg").close());
$("#dlgAdd").addEventListener("click",()=>{
  const p=state.dlgPayload;
  if(!p) return;
  if(p.kind==="item") addOne("item", p.id);
  else addOne("pkg", p.id);
  $("#dlg").close();
});

loadAll();
</script>
</body>
</html>
