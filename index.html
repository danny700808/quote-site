<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>活動企劃｜燈光音響配置區｜設備選配與即時報價</title>

  <style>
    #btnMail{display:none !important;}
    :root{
      --bg:#f7fbf9;               /* 淡薄荷白（整體底色） */
      --card:#ffffff;             /* 卡片白 */
      --text:#1f2937;             /* 深灰字 */
      --muted:#6b7280;            /* 次要字 */
      --line:#e6efe9;             /* 薄荷邊線 */
      --brand:#63bfae;            /* 主綠（粉嫩薄荷） */
      --brand2:#2f8f7b;           /* 深綠（hover/重點） */
      --blush:#f4b7c4;            /* 粉嫩點綴 */
      --mintSoft:#eaf7f3;         /* 淡薄荷底 */
      --blushSoft:#fff1f4;        /* 淡粉底 */
      --danger:#e25a6a;           /* 警示紅（偏粉嫩） */
      --shadow:0 10px 28px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:10;background:rgba(247,251,249,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .head{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center;padding:14px 18px}
    .title{grid-column:2;display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center}
    .title h1{margin:0;font-size:18px}
    .title small{display:none!important}
    .actions{grid-column:3;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    /* ===== 四步驟導覽 ===== */
    .stepsWrap{width:100%}
    .stepsHint{font-size:13px;color:var(--muted);margin-top:2px}
    .steps{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap}
    .stepBox{
      display:flex;align-items:center;gap:12px;
      padding:12px 16px;
      background:var(--mintSoft);
      border:1px solid var(--line);
      border-radius:999px;
      box-shadow:0 10px 26px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .stepBox:nth-child(4n+1){border-color:color-mix(in srgb, var(--brand) 35%, var(--line));}
    .stepBox:nth-child(4n+2){border-color:color-mix(in srgb, var(--blush) 35%, var(--line)); background:color-mix(in srgb, var(--blushSoft) 85%, var(--card));}
    .stepBox:nth-child(4n+3){border-color:color-mix(in srgb, var(--brand) 22%, var(--line));}
    .stepBox:nth-child(4n+4){border-color:color-mix(in srgb, var(--blush) 22%, var(--line)); background:color-mix(in srgb, var(--blushSoft) 85%, var(--card));}
    .stepNum{
      width:34px;height:34px;border-radius:999px;
      display:grid;place-items:center;
      background:color-mix(in srgb, var(--brand) 22%, transparent);
      color:var(--brand2);
      font-weight:900;
      flex:0 0 auto;
    }
    .stepText{font-size:14px;font-weight:750;color:var(--text)}
    .stepArrow{color:var(--muted);display:inline-flex;align-items:center}
    .stepIcon{width:22px;height:22px;opacity:.9}

    .btn{border:1px solid var(--line);background:var(--card);padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px}
    .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
    .btn.primary:hover{background:var(--brand2)}
    .btn.danger{background:var(--danger);border-color:transparent;color:#fff}
    
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:14px;align-items:start}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card .hd h2{margin:0;font-size:16px}

    /* ===== 四步驟區塊標題 ===== */
    .stepHd{position:relative;border-bottom:1px solid var(--line)}
    .stepHd::before{
      content:"";
      position:absolute;left:0;top:0;bottom:0;width:10px;
      border-radius:0 10px 10px 0;
      background:color-mix(in srgb, var(--line) 35%, transparent);
    }
    .stepHd h2{display:flex;align-items:center;gap:10px}
    .stepHd h2::before{
      content:"";
      width:10px;height:10px;border-radius:999px;flex:0 0 auto;
      background:color-mix(in srgb, var(--line) 35%, transparent);
    }

    .step1{background:linear-gradient(90deg, color-mix(in srgb, var(--brand) 18%, #fff), #fff)}
    .step1::before{background:color-mix(in srgb, var(--brand2) 55%, var(--brand))}
    .step1 h2::before{background:var(--brand2)}

    .step2{background:linear-gradient(90deg, color-mix(in srgb, var(--blush) 18%, #fff), #fff)}
    .step2::before{background:color-mix(in srgb, var(--blush) 70%, #fff)}
    .step2 h2::before{background:var(--danger)}

    .step3{background:linear-gradient(90deg, #eff6ff, #fff)}
    .step3::before{background:#60a5fa}
    .step3 h2::before{background:#2563eb}

    .step4{background:linear-gradient(90deg, #fffbeb, #fff)}
    .step4::before{background:#f59e0b}
    .step4 h2::before{background:#f59e0b}

    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff;white-space:nowrap}
    .pillStatus{display:none!important}
    #tierPills{display:none!important;}
    #pickedCount{display:none!important;}
    #cartBadge{display:none!important;}
    #jsStatus{display:none!important;}
    #btnCopy{display:none!important;}
    #catName{display:none!important;}

    /* 表單 */
    .form{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted);font-weight:900}
    .field input,.field select,.field textarea{border:1px solid var(--line);border-radius:12px;padding:11px 12px;background:#fff;outline:none;font-size:14px}
    .field textarea{min-height:84px;resize:vertical}
    .span2{grid-column:1/-1}

    .timeRow{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
    .timeRow .sep{color:var(--muted);font-weight:900;text-align:center}
    .dateRow{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:end}
    .dateRow .sep{color:var(--muted);font-weight:900;text-align:center}
    .dateCol{display:grid;gap:6px;min-width:0}
    .dateCap{font-size:11px;color:var(--muted);font-weight:900}
    .dateRow input{width:100%;min-width:0}

    /* 單品選項與清單 */
    .tabs{padding:12px 14px 14px;display:flex;gap:10px;flex-wrap:wrap;border-top:1px solid var(--line)}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000;font-size:14px}
    .tab.active{background:rgba(30,142,111,.12);border-color:rgba(30,142,111,.35);color:var(--brand2)}

    .items{padding:14px;display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;grid-template-columns:74px 1fr auto;gap:12px;align-items:center}
    .thumb{width:74px;height:74px;border-radius:14px;object-fit:cover;border:1px solid var(--line);background:#f3f4f6}
    .meta{min-width:0}
    .meta .name{font-weight:1000}
    .meta .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .meta .row2{margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .price{font-weight:1000;text-align:right}

    .qty{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 8px;background:#fff}
    .qbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000}
    .qval{min-width:44px;text-align:center;font-weight:1000}
    .linkbtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:1000;font-size:12px}

    /* 購物車區塊 */
    .summary{padding:14px;display:grid;gap:12px}
    .totals{border:1px dashed var(--line);border-radius:14px;padding:12px;display:grid;gap:8px;background:linear-gradient(180deg, rgba(30,142,111,.06), transparent)}
    .trow{display:flex;justify-content:space-between;align-items:center;gap:10px}

    .cart{display:grid;gap:12px}
    .group{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .group .gh{padding:10px 12px;background:#fafafa;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;font-weight:1000}
    .group .gb{padding:12px;display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
    .citem{position:relative;border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;display:block}
    .citem img{width:58px;height:58px;border-radius:12px;object-fit:cover;border:1px solid var(--line)}
    .cmeta .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .cmeta .nm{font-weight:1000;line-height:1.2}
    .cmeta .unit{color:var(--muted);font-size:12px;margin-top:2px}
    .cline{margin-top:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}

    .qtyRow{display:flex;align-items:center;gap:10px}
    .xbtn{width:36px;height:36px;border-radius:12px;border:1px solid rgba(226,74,74,.35);background:rgba(226,74,74,.10);color:var(--danger);font-weight:1000;cursor:pointer}
    .subttl{color:var(--muted);font-size:12px}
    .subttl b{color:var(--text)}
    .note{color:var(--muted);font-size:12px;line-height:1.5}
    .note-inline{color:var(--muted);font-size:12px;font-weight:800;margin-left:6px}

    /* 三層等級 */
    .tierWrap{padding:14px;display:grid;gap:12px}
    .tierGrid{display:grid;grid-template-columns:1fr;gap:12px}
    .tierCard{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .tierHead{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .tierHead b{font-size:14px}
    .tierBody{padding:12px;display:grid;gap:10px}
    .levelRow{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px}

    .levelBtn{
      padding:12px; border-radius:14px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:1000; text-align:left;
      display:flex; flex-direction:column; gap:10px; user-select:none; align-items:stretch; justify-content:flex-start;
    }
    .levelText{min-width:0;display:flex;flex-direction:column;gap:6px}
    .levelTopRow{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .levelName{font-size:13px;line-height:1.25;word-break:break-word}
    .levelPrice{font-size:12px;font-weight:1000;white-space:nowrap}
    .levelActions{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .miniBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:7px 10px;cursor:pointer;font-weight:1000;font-size:12px}
    .miniBtn:hover{border-color:rgba(30,142,111,.35)}
    .miniBtn.primaryMini{background:var(--brand);border-color:transparent;color:#fff}
    .miniBtn.primaryMini:hover{background:var(--brand2)}
    
    .levelMedia{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#f3f4f6}
    .levelMedia img{width:100%;height:120px;object-fit:cover;display:block}

    .tierActions{display:none}
    .hint{font-size:12px;color:var(--muted);line-height:1.55}
    .hint b{color:var(--text)}
    .tierStatus{display:flex;gap:8px;flex-wrap:wrap}

    /* Modal 彈出視窗 */
    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
    .modal{width:min(560px,100%);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 18px 48px rgba(0,0,0,.22);overflow:hidden}
    .modal .mh{padding:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;border-bottom:1px solid var(--line)}
    .modal .mb{padding:14px}
    .modal .mb p{margin:0;color:#374151;line-height:1.65}
    .modal .mf{padding:12px 14px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:10px;background:#fafafa}

    .photoGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .packMeta{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 6px}
    .packMeta .tag{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff}
    .packList{margin:8px 0 0;padding-left:18px;line-height:1.65}
    .packList li{margin:4px 0}
    .modalDesc{margin-top:8px;color:var(--muted);line-height:1.7}
    .photoBox{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;background:#fff}
    .photoBox img{width:100%;height:140px;object-fit:cover;display:block}
    .photoCap{padding:8px 10px;font-size:12px;color:#6b7280}

    /* 即時報價精簡顯示 */
    #quoteCard .quoteHdrRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    #quoteCard .quoteActions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    #quoteCard .quoteActions .btn{padding:8px 10px;font-size:13px;border-radius:999px}
    
    #cart .citem img{display:none!important}
    #cart .unit{display:none!important}
    #cart .cline{margin-top:6px}
    #cart .qty{display:none!important}
    #cart .cline .subttl{display:none!important}
    #cart .citem{padding-right:52px}
    #cart .xbtn{position:absolute;top:50%;transform:translateY(-50%);right:10px}
    #cart .price{padding-right:8px}

    #quoteCard .sendBar{margin-top:12px;display:flex;justify-content:flex-end}
    #quoteCard .btn.send{background:#0ea5e9;border-color:#0284c7;color:#fff;font-weight:800}
    #quoteCard .btn.send:hover{filter:brightness(.97)}
    .btn.warn{background:#facc15;border-color:#f59e0b;color:#111827;font-weight:800;}
    .btn.warn:hover{filter:brightness(.97)}

    .mini{font-size:12px;color:var(--muted)}
    .optbox{margin-top:10px;padding:10px 12px;border:1px dashed var(--line);border-radius:12px;background:#fbfdfc}
    .optrow{display:flex;gap:10px;align-items:center;margin:6px 0}
    .optlabel{min-width:92px;font-size:13px;color:var(--muted)}
    .optselect{flex:1;padding:9px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px}

    @media (max-width:920px){
/* === 手機版專屬優化：步驟直覺化、左右對稱、符號對齊 === */
    @media (max-width: 620px) {
      /* 1. 四步驟導覽：更像進度條 */
      .steps {
        display: grid !important;
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 6px !important;
        padding: 5px 0 !important;
      }
      .stepBox {
        flex-direction: column !important;
        padding: 8px 2px !important;
        gap: 4px !important;
        border-radius: 8px !important;
        background: #fff !important;
        border: 1px solid var(--line) !important;
        box-shadow: 0 4px 10px rgba(0,0,0,.04) !important;
      }
      .stepNum {
        width: 22px !important;
        height: 22px !important;
        font-size: 11px !important;
      }
      .stepText {
        font-size: 10px !important;
        white-space: normal !important;
        text-align: center;
        line-height: 1.2;
        transform: scale(0.9);
      }
      .stepArrow { display: none !important; }

      /* 2. 設備等級左右對稱（解決圖 2 太長的問題） */
      .levelRow {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 10px !important;
      }
      .levelBtn {
        flex-direction: column !important;
        align-items: stretch !important;
        padding: 8px !important;
        border-radius: 12px !important;
      }
      .levelMedia {
        width: 100% !important;
        height: 80px !important;
        margin: 0 0 8px 0 !important;
        border-radius: 8px !important;
      }
      .levelTopRow {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 2px !important;
      }
      .levelName {
        font-size: 13px !important;
        min-height: 32px;
      }
      .levelPrice {
        font-size: 12px !important;
        color: var(--danger) !important;
      }
      /* 恢復詳情按鈕佈局 */
      .levelActions {
        display: flex !important;
        gap: 4px !important;
        margin-top: 6px !important;
      }
      .miniBtn {
        flex: 1 !important;
        padding: 6px 2px !important;
        font-size: 11px !important;
        text-align: center !important;
      }

      /* 3. 日期範圍符號垂直對齊（修正圖 3） */
      .dateRow {
        display: flex !important;
        align-items: flex-end !important;
      }
      .dateRow .sep {
        padding: 0 4px 10px 4px !important; /* 讓波浪號對齊輸入框中心 */
        margin: 0 !important;
        font-size: 16px !important;
      }
      .dateCol { flex: 1 !important; }
    }
  </style>
</head>

<body>
<header>
  <div class="head">
    <div class="title">
      <h1>活動企劃｜設備選配與即時報價</h1>
      <div class="stepsWrap" aria-label="報價流程四步驟">
        <div class="steps">
          <div class="stepBox"><span class="stepNum">1</span><span class="stepText">填寫基本資料</span></div>
          <span class="stepArrow" aria-hidden="true"><svg class="stepIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M9 18l6-6-6-6" fill="none" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
          <div class="stepBox"><span class="stepNum">2</span><span class="stepText">選取燈光音響配置</span></div>
          <span class="stepArrow" aria-hidden="true"><svg class="stepIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M9 18l6-6-6-6" fill="none" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
          <div class="stepBox"><span class="stepNum">3</span><span class="stepText">選取設備服務加購</span></div>
          <span class="stepArrow" aria-hidden="true"><svg class="stepIcon" viewBox="0 0 24 24" aria-hidden="true"><path d="M9 18l6-6-6-6" fill="none" stroke="currentColor" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
          <div class="stepBox"><span class="stepNum">4</span><span class="stepText">查看即時報價</span></div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <noscript><div style="margin:12px 0;padding:12px;border:1px solid #f59e0b;background:#fffbeb;border-radius:12px;font-weight:900;color:#92400e">⚠️ 你的瀏覽器目前停用了 JavaScript，因此「安全/氣氛/升級等級」與「設備分類」不會顯示。請改用可執行 JS 的瀏覽器。</div></noscript>

  <div class="grid">
    <section class="card">
      <div class="hd stepHd step1">
        <h2>1) 基本資料</h2>
        <span class="pill" id="pickedCount">0 項已選</span>
      </div>

      <div class="form">
        <div class="field">
          <label>姓名 / 單位</label>
          <input id="fName" placeholder="例：柚子樂器 / 王小明">
        </div>
        <div class="field">
          <label>行動電話</label>
          <input id="fPhone" type="tel" inputmode="tel" placeholder="例：09xx-xxx-xxx">
        </div>
        <div class="field">
          <label>Email</label>
          <input id="fEmail" type="email" placeholder="例：you@example.com">
        </div>
        <div class="field span2">
          <label>活動地點（縣市/區）</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <select id="fCity"></select>
            <select id="fArea"></select>
          </div>
        </div>
        <div class="field span2">
          <label>詳細地址（路名/號）</label>
          <input id="fAddr" placeholder="例：中山路 100 號">
        </div>
        <div class="field span2">
          <label>大樓/棟別/樓層/入口（讓地址更清楚）</label>
          <input id="fBldg" placeholder="例：XX大樓 A棟 3F（從側門進）">
        </div>
        <div class="field">
          <label>活動類型</label>
          <select id="fEventType">
            <option value="">請選擇活動類型</option>
            <option>開幕典禮／剪綵儀式</option>
            <option>記者會／產品發表會</option>
            <option>品牌活動／快閃活動（商場/戶外）</option>
            <option>展覽開幕／展場活動（含舞台時段）</option>
            <option>校慶活動（運動會/園遊會/舞台）</option>
            <option>畢業典禮</option>
            <option>成果發表會（學校/才藝/社團）</option>
            <option>社團成發／迎新送舊晚會</option>
            <option>演講／講座／論壇</option>
            <option>研討會／學術會議（含分場）</option>
            <option>公司內訓／教育訓練／大會</option>
            <option>尾牙／春酒</option>
            <option>公司家庭日／園遊會</option>
            <option>餐會／晚宴（含抽獎、致詞、表演）</option>
            <option>商務交流會／同業公會活動</option>
            <option>演唱會／Live Band 表演</option>
            <option>DJ 派對／電音活動</option>
            <option>舞蹈表演／舞蹈比賽</option>
            <option>戲劇／舞台劇／音樂劇</option>
            <option>親子活動／兒童舞台秀</option>
            <option>慶生會／派對（含包場）</option>
            <option>婚禮（證婚/宴客/After party）</option>
            <option>告別式／追思會（殯儀館/會館/戶外追思）</option>
            <option>宗教活動（廟會/法會/禮拜/慶典）</option>
            <option>社區活動／里民大會／宣導活動（戶外廣播）</option>
          </select>
        </div>
        <div class="field">
          <label>預估人數</label>
          <select id="fCrowd">
            <option value="">請選擇</option>
            <option value="100">100人以內</option>
            <option value="400">100到400人</option>
            <option value="1000">400至1000人</option>
            <option value="2000">1000人至2000人</option>
            <option value="9999">2000人至以上</option>
          </select>
        </div>
        <div class="field">
          <label>室內 / 戶外</label>
          <select id="fIndoor">
            <option value="">請選擇</option>
            <option>室內</option>
            <option>戶外</option>
            <option>半戶外</option>
          </select>
        </div>
        <div class="field span2">
          <label>活動日期（開始 ～ 結束）</label>
          <div class="dateRow">
            <div class="dateCol"><div class="dateCap">開始</div><input id="fDateStart" type="date"></div>
            <div class="sep">～</div>
            <div class="dateCol"><div class="dateCap">結束</div><input id="fDateEnd" type="date"></div>
          </div>
        </div>
        <div class="field span2">
          <label>活動時間（只提供 00/10/20/30/40/50 分）</label>
          <div class="timeRow">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <select id="tStartH"></select>
              <select id="tStartM"></select>
            </div>
            <div class="sep">～</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <select id="tEndH"></select>
              <select id="tEndM"></select>
            </div>
          </div>
          <input id="fTimeStart" type="hidden">
          <input id="fTimeEnd" type="hidden">
        </div>
        <div class="field span2">
          <label>同日第二場（選填）</label>
          <div style="display:grid;gap:10px">
            <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted)">
              <input type="checkbox" id="fHasSession2" style="width:18px;height:18px">
              同一天有第二場（勾選後可設定第二場時間；第二場加價：原始總價 x 30%）
            </label>
            <div id="session2Wrap" style="display:none;border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff">
              <div style="font-weight:1000;margin-bottom:8px">第二場時間</div>
              <div class="timeRow">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                  <select id="t2StartH"></select><select id="t2StartM"></select>
                </div>
                <div class="sep">～</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                  <select id="t2EndH"></select><select id="t2EndM"></select>
                </div>
              </div>
              <input id="fTime2Start" type="hidden">
              <input id="fTime2End" type="hidden">
              <div class="hint" style="margin-top:8px">提示：第二場只算同一天內的加價，不影響跨天判定。</div>
              <div id="session2DaysWrap" style="margin-top:10px;display:none">
                <div style="font-weight:1000;margin-bottom:8px">（跨天時）第2天起的第二場日別</div>
                <div id="session2Days" style="display:grid;gap:8px"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="field span2">
          <label>備註 / 需求</label>
          <textarea id="fNote" placeholder="例：室內婚禮120人，需四支無線麥，場地有220V插座，需含進退場..."></textarea>
        </div>
      </div>

      <div class="hd stepHd step2" style="border-top:1px solid var(--line);border-bottom:none">
        <h2>2) 燈光音響配置區</h2>
        <span class="pill" id="tierPills">安全—｜氣氛—｜升級—</span>
      </div>

      <div class="tierWrap">
        <div class="tierGrid">
          <div class="tierCard">
            <div class="tierHead"><b>安全等級</b><span class="pill pillStatus" id="pillSafety">未選</span></div>
            <div class="tierBody">
              <div class="levelRow" id="levelsSafety"></div>
              <div class="tierActions"><button class="btn primary" id="applySafety">一鍵套用（安全）</button></div>
              <div class="hint">建議：一般活動多數選 <b>第3級</b>；戶外建議至少 <b>第3級</b>。</div>
            </div>
          </div>
          <div class="tierCard">
            <div class="tierHead"><b>氣氛等級</b><span class="pill pillStatus" id="pillAmbience">未選</span></div>
            <div class="tierBody">
              <div class="levelRow" id="levelsAmbience"></div>
              <div class="tierActions"><button class="btn primary" id="applyAmbience">一鍵套用（氣氛）</button></div>
              <div class="hint">想要「看起來不寒酸」：至少選到 <b>第2級</b>；有表演感：選到 <b>第4級</b>。</div>
            </div>
          </div>
          <div class="tierCard">
            <div class="tierHead"><b>升級等級</b><span class="pill pillStatus" id="pillUpgrade">未選</span></div>
            <div class="tierBody">
              <div class="levelRow" id="levelsUpgrade"></div>
              <div class="tierActions"><button class="btn primary" id="applyUpgrade">一鍵套用（升級）</button></div>
              <div class="hint">升級是高滿意度來源：先看內容與價格再選等級，之後再微調。</div>
            </div>
          </div>
        </div>
        <div class="tierStatus">
          <span class="pill">提示：每個 1–6 級都可以按「詳情」先看包含什麼。</span>
          <button class="btn" id="btnSuggest">依人數/室內外建議等級</button>
        </div>
      </div>

      <div class="hd stepHd step3" style="border-top:1px solid var(--line);border-bottom:none">
        <h2>3) 設備/服務分類（自由加減）</h2>
        <span class="pill" id="catName">—</span>
      </div>

      <div class="tabs" id="tabs"></div>
      <div class="items" id="items"></div>
    </section>

    <aside class="card" id="quoteCard">
      <div class="hd stepHd step4">
        <h2>4) 即時報價</h2>
        <div class="quoteHdrRight">
          <span class="pill" id="cartBadge">0 項已選</span>
          <div class="quoteActions">
            <span class="pill" id="jsStatus">JS: loading</span>
            <button class="btn" id="btnCopy">複製報價內容</button>
            <button class="btn primary" id="btnMail" style="display:none">送出報價單</button>
            <button class="btn warn" id="btnPrint" style="display:none">列印成 PDF</button>
            <button class="btn danger" id="btnClear">清空全部項目</button>
          </div>
        </div>
      </div>
      <div class="summary">
        <div class="totals">
          <div class="trow" id="grandTotalRow"><span class="subttl">目前合計</span><b id="grandTotal">NT$0</b></div>
          <div class="trow" id="daySurchargeRow" style="display:none"><span class="subttl">跨天加價</span><b id="daySurcharge">NT$0</b></div>
          <div class="trow" id="session2SurchargeRow" style="display:none"><span class="subttl">同日第二場加價</span><b id="session2Surcharge">NT$0</b></div>
          <div class="trow"><span class="subttl">總計</span><b id="finalTotal">NT$0</b></div>
        </div>
        <div class="cart" id="cart"></div>
        <div class="sendBar">
          <button class="btn send" id="btnSendQuote">送出報價單</button>
        </div>
      </div>
    </aside>

  </div>
</div>

<div class="modalMask" id="modalMask">
  <div class="modal">
    <div class="mh"><b id="mTitle">詳情</b><button class="xbtn" id="mClose" title="關閉">✕</button></div>
    <div class="mb"><p id="mBody">—</p></div>
    <div class="mf"><button class="btn primary" id="mBack">返回估價單</button></div>
  </div>
</div>
<script>
  // ============================
  // 基本設定與資料
  // ============================
  const BRAND_NAME = "柚子樂器";
  const PRINT_TITLE = "活動企劃｜設備與器材報價單";

  window.addEventListener('error', function(e){
    try{
      const el = document.querySelector('#jsStatus');
      if(el) el.textContent = 'JS: error';
    }catch(_){ }
  });

  function svgThumb(label){
    const safe = (label||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200">
  <defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop offset="0" stop-color="#e8f5f0"/><stop offset="1" stop-color="#f6f7fb"/></linearGradient></defs>
  <rect width="200" height="200" rx="22" fill="url(#g)"/>
  <circle cx="160" cy="40" r="26" fill="#1e8e6f" opacity="0.18"/>
  <circle cx="40" cy="160" r="36" fill="#156e56" opacity="0.12"/>
  <text x="18" y="102" font-size="16" font-family="system-ui, sans-serif" fill="#156e56" font-weight="700">${safe}</text>
</svg>`;
    return "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(svg);
  }

  const CATEGORIES = [
    { id:"stage", name:"舞台結構與桁架系統", items:[
      { id:"stage-deck", name:"舞台板（2x1m）", unit:"片", price:1200, priceTiers:[{min:1,price:1200},{min:20,price:1100},{min:50,price:1000}], options:{ carpet:{label:"是否要鋪地毯", values:["請選擇","要","不要"], omitValues:["不要"]}, carpet_color:{label:"地毯顏色", values:["請選擇","黑","灰","紅","藍","綠","米白"], when:{opt:"carpet", is:"要"}}, color:{label:"舞台板顏色", values:["請選擇","黑","灰","紅","藍"]}, height:{label:"舞台高度", values:["請選擇","20cm","40cm","60cm","80cm","100cm"]} }, img:svgThumb("舞台板"), desc:"舞台板（2x1m）。" },
      { id:"stage-step", name:"舞台階梯（含扶手）", unit:"座", price:900, img:svgThumb("階梯"), desc:"舞台上下台階梯。" },
      { id:"stage-truss", name:"TRUSS 桁架（3m）", unit:"支", price:1800, img:svgThumb("TRUSS"), desc:"基本桁架結構。" },
      { id:"stage-backdrop", name:"主視覺背板（基本）", unit:"組", price:6500, img:svgThumb("背板"), desc:"基本背板（含架設）。" },
      { id:"stage-drape", name:"舞台布幕/遮擋（基本）", unit:"組", price:4800, img:svgThumb("布幕"), desc:"舞台側布/後布/遮擋。" }
    ]},
    { id:"light", name:"燈光與氣氛效果", items:[
      { id:"light-par", name:"LED PAR（染色燈）", unit:"盞", price:900, img:svgThumb("染色燈"), desc:"典禮/氛圍底色必備。" },
      { id:"light-moving", name:"Moving Head（光束燈）", unit:"盞", price:2500, img:svgThumb("光束燈"), desc:"動態光束效果。" },
      { id:"light-follow", name:"追光燈（含操作）", unit:"組", price:6000, img:svgThumb("追光"), desc:"追光燈含操作人員。" },
      { id:"light-console", name:"燈控台（基本）", unit:"套", price:3500, img:svgThumb("燈控"), desc:"燈光場景切換/節奏控制。" },
      { id:"fx-haze", name:"薄霧機（Hazer）", unit:"台", price:2200, img:svgThumb("薄霧"), desc:"讓光束更立體。" }
    ]},
    { id:"audio", name:"音響與舞台收音", items:[
      { id:"audio-main", name:"主喇叭（全頻）", unit:"組", price:6000, img:svgThumb("主喇叭"), desc:"主擴聲系統。" },
      { id:"audio-sub", name:"低音喇叭（Sub）", unit:"顆", price:4500, img:svgThumb("Sub"), desc:"增加低頻能量。" },
      { id:"audio-mixer", name:"混音器（基本）", unit:"台", price:3000, img:svgThumb("混音"), desc:"基本混音控制。" },
      { id:"audio-wireless2", name:"無線麥克風（2支組）", unit:"組", price:2200, img:svgThumb("無線麥"), desc:"常見典禮/講座用。" },
      { id:"audio-monitor", name:"舞台監聽喇叭", unit:"顆", price:1800, img:svgThumb("監聽"), desc:"給主持/表演者聽到。" },
      { id:"audio-di", name:"DI Box（主動式）", unit:"顆", price:400, img:svgThumb("DI"), desc:"訊號轉換。" },
      { id:"audio-drumkit", name:"鼓組收音套裝（基本）", unit:"組", price:6500, img:svgThumb("鼓組"), desc:"適合 Live Band。" }
    ]},
    { id:"video", name:"影像、投影與直播導播", items:[
      { id:"video-projector", name:"投影機（基本）", unit:"台", price:6500, img:svgThumb("投影"), desc:"會議/典禮簡報。" },
      { id:"video-screen", name:"投影布幕（120吋）", unit:"面", price:1800, img:svgThumb("布幕"), desc:"投影布幕（示意）。" },
      { id:"video-tv", name:"電視（75吋）", unit:"台", price:4800, img:svgThumb("75吋TV"), desc:"展場/小型場地。" },
      { id:"video-camera", name:"活動攝影機（基本）", unit:"台", price:5000, img:svgThumb("攝影"), desc:"活動錄影/直播機位。" },
      { id:"video-switcher", name:"直播導播/切換台", unit:"套", price:9000, img:svgThumb("導播"), desc:"多機位切換。" }
    ]},
    { id:"site", name:"帳篷桌子椅子", items:[
      { id:"site-tent", name:"快帳（3x3m）", unit:"頂", price:1800, img:svgThumb("快帳"), desc:"戶外遮陽遮雨。" },
      { id:"site-chair", name:"折疊椅", unit:"張", price:30, img:svgThumb("椅子"), desc:"觀眾座位。" },
      { id:"site-table", name:"折疊桌", unit:"張", price:150, img:svgThumb("桌子"), desc:"報到/設備區用。" },
      { id:"site-queue", name:"紅龍/排隊動線（2m）", unit:"支", price:120, img:svgThumb("紅龍"), desc:"控場動線。" },
      { id:"site-cableramp", name:"護線板（1m）", unit:"條", price:120, img:svgThumb("護線"), desc:"走線安全必備。" }
    ]},
    { id:"power", name:"電力、控場人員與安全營運", items:[
      { id:"power-gen", name:"發電機（基本）", unit:"台", price:12000, img:svgThumb("發電"), desc:"戶外/電力不足必備。" },
      { id:"power-dist", name:"配電箱/延長線組", unit:"套", price:1800, img:svgThumb("配電"), desc:"含基本配電、延長線。" },
      { id:"staff-audio", name:"音控工程師", unit:"人/場", price:6500, img:svgThumb("音控"), desc:"含設定、全程控場。" },
      { id:"staff-light", name:"燈控工程師", unit:"人/場", price:6500, img:svgThumb("燈控"), desc:"燈光場景控制。" },
      { id:"staff-stage", name:"舞台監督/控場", unit:"人/場", price:7000, img:svgThumb("舞監"), desc:"流程控場、串接。" },
      { id:"staff-host", name:"主持人（基本）", unit:"人/場", price:9000, img:svgThumb("主持"), desc:"主持/串場/互動。" }
    ]}
  ];

  const LEVELS = {
    safety: ["① 基礎穩定","② 標準配置","③ 活動專業","④ 演出進階","⑤ 旗艦舞台","⑥ 全盛典藏"],
    ambience:["① 純淨燈色","② 典禮質感","③ 氛圍層次","④ 視覺焦點","⑤ 沉浸舞台","⑥ 全感體驗"],
    upgrade:["① 亮點入門","② 氣氛效果","③ 儀式震撼","④ 演出支援","⑤ 全方位","⑥ 尊榮規格"]
  };
  const LEVEL_PRICES = {
    safety:  [ 10000, 15000, 20000, 25000, 35000, 50000 ],
    ambience:[ 20000, 25000, 35000, 45000, 60000, 80000 ],
    upgrade: [ 30000, 40000, 50000, 80000, 100000, 150000 ]
  };
  const PACKS_SAFETY = {
    1: [{id:"audio-main",qty:1},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:1}],
    2: [{id:"audio-main",qty:1},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:2},{id:"audio-monitor",qty:1},{id:"power-dist",qty:1}],
    3: [{id:"audio-main",qty:2},{id:"audio-sub",qty:1},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:2},{id:"audio-monitor",qty:2},{id:"power-dist",qty:1},{id:"staff-audio",qty:1}],
    4: [{id:"audio-main",qty:2},{id:"audio-sub",qty:2},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:3},{id:"audio-monitor",qty:3},{id:"power-dist",qty:1},{id:"staff-audio",qty:1}],
    5: [{id:"audio-main",qty:3},{id:"audio-sub",qty:3},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:4},{id:"audio-monitor",qty:4},{id:"power-gen",qty:1},{id:"power-dist",qty:2},{id:"staff-audio",qty:1}],
    6: [{id:"audio-main",qty:4},{id:"audio-sub",qty:4},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:5},{id:"audio-monitor",qty:5},{id:"power-gen",qty:1},{id:"power-dist",qty:3},{id:"staff-audio",qty:1}]
  };
  const PACKS_AMBIENCE = {
    1: [{id:"light-par",qty:4}],
    2: [{id:"stage-backdrop",qty:1},{id:"light-par",qty:6},{id:"light-console",qty:1}],
    3: [{id:"stage-deck",qty:4},{id:"stage-backdrop",qty:1},{id:"light-par",qty:8},{id:"light-console",qty:1},{id:"staff-light",qty:1}],
    4: [{id:"stage-deck",qty:6},{id:"stage-truss",qty:2},{id:"stage-backdrop",qty:1},{id:"light-par",qty:10},{id:"light-moving",qty:4},{id:"light-console",qty:1},{id:"fx-haze",qty:1},{id:"staff-light",qty:1}],
    5: [{id:"stage-deck",qty:8},{id:"stage-truss",qty:4},{id:"stage-drape",qty:1},{id:"stage-backdrop",qty:1},{id:"light-par",qty:12},{id:"light-moving",qty:6},{id:"light-console",qty:1},{id:"fx-haze",qty:1},{id:"staff-light",qty:1}],
    6: [{id:"stage-deck",qty:10},{id:"stage-truss",qty:6},{id:"stage-drape",qty:1},{id:"stage-backdrop",qty:1},{id:"light-par",qty:16},{id:"light-moving",qty:8},{id:"light-console",qty:1},{id:"fx-haze",qty:2},{id:"staff-light",qty:1}]
  };
  const PACKS_UPGRADE = {
    1: [{id:"light-follow",qty:1}],
    2: [{id:"fx-haze",qty:1}],
    3: [{id:"video-projector",qty:1},{id:"video-screen",qty:1}],
    4: [{id:"audio-drumkit",qty:1},{id:"audio-di",qty:4},{id:"audio-monitor",qty:2}],
    5: [{id:"staff-host",qty:1},{id:"staff-stage",qty:1},{id:"staff-audio",qty:1}],
    6: [{id:"staff-host",qty:1},{id:"staff-stage",qty:1},{id:"staff-audio",qty:1},{id:"staff-light",qty:1}]
  };
  const TIER_PHOTOS = {
    safety: Array.from({length:6},(_,i)=>[ `https://picsum.photos/seed/safety-${i+1}-a/800/600`, `https://picsum.photos/seed/safety-${i+1}-b/800/600` ]),
    ambience: Array.from({length:6},(_,i)=>[ `https://picsum.photos/seed/ambience-${i+1}-a/800/600`, `https://picsum.photos/seed/ambience-${i+1}-b/800/600` ]),
    upgrade: Array.from({length:6},(_,i)=>[ `https://picsum.photos/seed/upgrade-${i+1}-a/800/600`, `https://picsum.photos/seed/upgrade-${i+1}-b/800/600` ])
  };

  const ENABLE_SHEET = false;
  const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxrphr7gIrOVrrhp1lplR7IYrZdc_8E8cajBEitSoUiujGRE7v8FDy0BYL8VLHaexvq/exec";
  function loadSheetData(){
    if(!ENABLE_SHEET || !SHEET_API_URL) return;
    const cbName = "__applySheetPayload__" + Date.now();
    window[cbName] = (payload)=>{
      try{
        if(payload && payload.ok) { applySheetData(payload.data); renderAll(); }
      }catch(err){}
    };
    const s = document.createElement("script");
    s.src = SHEET_API_URL + "?callback=" + cbName + "&_=" + Date.now();
    document.head.appendChild(s);
  }
  function applySheetData(data){ /* 本段落保留不影響運作 */ }

  const TW = {
    "台北市":["中正區","大同區","中山區","松山區","大安區","萬華區","信義區","士林區","北投區","內湖區","南港區","文山區"],
    "新北市":["板橋區","新莊區","中和區","永和區","三重區","土城區","新店區","汐止區","淡水區","林口區"],
    "桃園市":["桃園區","中壢區","平鎮區","八德區","龜山區","蘆竹區"],
    "台中市":["西屯區","北屯區","南屯區","中區","東區","西區","南區","北區","豐原區"],
    "台南市":["中西區","東區","南區","北區","永康區","安平區"],
    "高雄市":["三民區","左營區","鼓山區","苓雅區","前鎮區","鳳山區"]
  };

  // ============================
  // DOM 與邏輯輔助
  // ============================
  const $ = (s)=>document.querySelector(s);
  const escapeHtml = (v)=>String(v??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const fmt = (n)=>"NT$"+Number(n||0).toLocaleString("zh-Hant-TW");
  
  const state = { 
    catId: CATEGORIES[0].id, 
    cart: { packs: {} }, 
    tiers: { safety: 0, ambience: 0, upgrade: 0 },
    itemOpts: {},
    shipping: { fee: 0, km: null },
    surcharges: { day: 0, session2: 0, dayCount: 1, extraDays: 0 }
  };

  function getUnitPrice(item, qty){
    const q = Math.max(1, Number(qty||1));
    if(Array.isArray(item?.priceTiers) && item.priceTiers.length){
      let price = Number(item.price||0);
      for(const t of item.priceTiers){ if(q >= Number(t.min||1)) price = Number(t.price||0); }
      return price;
    }
    return Number(item?.price||0);
  }
  function formatTiers(item){
    if(!Array.isArray(item?.priceTiers) || !item.priceTiers.length) return "";
    const sorted = [...item.priceTiers].sort((a,b)=>Number(a.min||1)-Number(b.min||1));
    return sorted.map((cur,i,arr) => {
      const next = arr[i+1];
      const min = Number(cur.min||1);
      const max = next ? (Number(next.min||1)-1) : null;
      return (max && max>=min) ? `${min}–${max}${item.unit} ${fmt(cur.price)} / ${item.unit}` : `${min}${item.unit}以上 ${fmt(cur.price)} / ${item.unit}`;
    }).join("；");
  }
  function getItemSubPriceText(item, qty){
    const hasTiers = Array.isArray(item?.priceTiers) && item.priceTiers.length;
    if(!hasTiers) return `${fmt(item.price)} / ${item.unit}`;
    const q = Number(qty||0);
    if(q>0){
      const up = getUnitPrice(item, q);
      return `${fmt(up)}${up < Number(item.price||0) ? "（優惠）" : ""} / ${item.unit} <span class="mini">｜${formatTiers(item)}</span>`;
    }
    return `${fmt(item.price)} 起 / ${item.unit} <span class="mini">｜${formatTiers(item)}</span>`;
  }
  function getItemOpts(itemId){ return (state.itemOpts && state.itemOpts[itemId]) ? state.itemOpts[itemId] : {}; }
  function isOptVisible(def, opts){
    if(def && def.when && def.when.opt) return String(opts?.[def.when.opt] ?? "") === String(def.when.is ?? "");
    return true;
  }
  function normalizeOptValue(def, value){ return value==="請選擇" ? "" : String(value||""); }
  function setItemOpt(itemId, key, value){
    const f=findItem(itemId);
    const v = normalizeOptValue(f?.item?.options?.[key], value);
    if(!state.itemOpts) state.itemOpts = {};
    if(!state.itemOpts[itemId]) state.itemOpts[itemId] = {};
    if(v===""){
      delete state.itemOpts[itemId][key];
      if(Object.keys(state.itemOpts[itemId]).length===0) delete state.itemOpts[itemId];
    }else{ state.itemOpts[itemId][key] = v; }
    // cleanup
    const opts = getItemOpts(itemId) || {};
    for(const [k,def] of Object.entries(f?.item?.options || {})){
      if(opts[k]!=null && !isOptVisible(def, opts)){ delete opts[k]; }
    }
  }
  function clearItemOpts(itemId){ if(state.itemOpts && state.itemOpts[itemId]) delete state.itemOpts[itemId]; }
  function formatOptText(itemId){
    const f=findItem(itemId); if(!f || !f.item?.options) return "";
    const opts=getItemOpts(itemId) || {};
    const parts=[];
    for(const [k,def] of Object.entries(f.item.options)){
      if(!isOptVisible(def, opts) || !opts[k]) continue;
      if(def.omitValues && def.omitValues.includes(String(opts[k]))) continue;
      parts.push(`${def.label||k}：${opts[k]}`);
    }
    return parts.length ? `（${parts.join("，")}）` : "";
  }
  function buildOptionsHTML(item){
    if(!item?.options) return "";
    const optsState = getItemOpts(item.id) || {};
    const rows = Object.entries(item.options).map(([k,def])=>{
      if(!isOptVisible(def, optsState)) return "";
      const cur = normalizeOptValue(def, optsState[k]);
      const optionsHTML = (def.values||[]).map(v=>{
        const vv = String(v);
        const valAttr = vv==="請選擇" ? "" : vv;
        return `<option value="${escapeHtml(valAttr)}" ${(valAttr===cur || (cur==="" && valAttr===""))?"selected":""}>${escapeHtml(vv)}</option>`;
      }).join("");
      return `<div class="optrow"><div class="optlabel">${escapeHtml(def.label||k)}</div><select class="optselect" data-act="opt" data-id="${item.id}" data-opt="${k}">${optionsHTML}</select></div>`;
    }).join("");
    return rows.trim() ? `<div class="optbox">${rows}</div>` : "";
  }

  function initCity(){
    const city=$("#fCity"), area=$("#fArea");
    if(!city || !area) return;
    city.innerHTML=Object.keys(TW).map(c=>`<option value="${c}">${c}</option>`).join("");
    function fillArea(){ area.innerHTML=(TW[city.value]||[]).map(a=>`<option value="${a}">${a}</option>`).join(""); }
    city.addEventListener("change", ()=>{ fillArea(); renderCart(); });
    area.addEventListener("change", ()=>{ renderCart(); });
    fillArea();
    if(Object.keys(TW).includes("台中市")){
      city.value="台中市"; fillArea();
      if((TW["台中市"]||[]).includes("豐原區")) area.value="豐原區";
    }
  }
  function pad2(n){ return String(n).padStart(2,"0"); }
  function parseDateTime(dateStr, timeStr){
    if(!dateStr) return null;
    const [hh,mm] = String(timeStr||"00:00").split(":").map(x=>Number(x||0));
    const d = new Date(dateStr+"T00:00:00");
    if(Number.isNaN(d.getTime())) return null;
    d.setHours(hh, mm, 0, 0);
    return d;
  }
  function initTimePickers(){
    const hours = Array.from({length:24}, (_,i)=>pad2(i));
    const mins = ["00","10","20","30","40","50"];
    function fill(sel, arr, suffix){ sel.innerHTML = arr.map(v=>`<option value="${v}">${v}${suffix||""}</option>`).join(""); }
    fill($("#tStartH"), hours, ""); fill($("#tEndH"), hours, "");
    fill($("#tStartM"), mins, ""); fill($("#tEndM"), mins, "");
    if($("#t2StartH")){
      fill($("#t2StartH"), hours, ""); fill($("#t2EndH"), hours, "");
      fill($("#t2StartM"), mins, ""); fill($("#t2EndM"), mins, "");
    }
    $("#tStartH").value="09"; $("#tStartM").value="00"; $("#tEndH").value="12"; $("#tEndM").value="00";
    if($("#t2StartH")){ $("#t2StartH").value="18"; $("#t2StartM").value="00"; $("#t2EndH").value="21"; $("#t2EndM").value="00"; }
    function sync(){ $("#fTimeStart").value = `${$("#tStartH").value}:${$("#tStartM").value}`; $("#fTimeEnd").value = `${$("#tEndH").value}:${$("#tEndM").value}`; }
    function sync2(){ if($("#t2StartH")){ $("#fTime2Start").value = `${$("#t2StartH").value}:${$("#t2StartM").value}`; $("#fTime2End").value = `${$("#t2EndH").value}:${$("#t2EndM").value}`; } }
    ["tStartH","tStartM","tEndH","tEndM"].forEach(id=>{ const el=$("#"+id); if(el) el.addEventListener("change", ()=>{ sync(); renderCart(); }); });
    sync();
    if($("#t2StartH")){ ["t2StartH","t2StartM","t2EndH","t2EndM"].forEach(id=>{ const el=$("#"+id); if(el) el.addEventListener("change", ()=>{ sync2(); renderCart(); }); }); sync2(); }
  }

  function renderSession2Days(){
    const wrap = $("#session2DaysWrap"), box = $("#session2Days");
    if(!wrap || !box) return;
    const ds = $("#fDateStart")?.value || "", de = $("#fDateEnd")?.value || ds;
    if(!ds){ wrap.style.display="none"; box.innerHTML=""; return; }
    let dayCount = 1;
    if(ds && de){
      const s = new Date(ds+"T00:00:00"), e = new Date(de+"T00:00:00");
      if(!isNaN(s) && !isNaN(e)){ dayCount = Math.max(1, Math.round((e.getTime()-s.getTime())/(24*60*60*1000)) + 1); }
    }
    if(dayCount <= 1){ wrap.style.display="none"; box.innerHTML=""; return; }
    wrap.style.display="block";
    const prev = new Set(Array.from(box.querySelectorAll('input[data-s2day="1"]')).filter(x=>x.checked).map(x=>x.value));
    const rows=[];
    for(let d=2; d<=dayCount; d++){
      const key = `day${d}`;
      rows.push(`<label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted)"><input type="checkbox" data-s2day="1" value="${key}" ${prev.has(key)?"checked":""} style="width:18px;height:18px">第${d}天有第二場（加價：基準 E × 30%）</label>`);
    }
    box.innerHTML = rows.join("");
    box.querySelectorAll('input[data-s2day="1"]').forEach(cb=>{ cb.addEventListener("change", ()=>{ renderCart(); }); });
  }

  function renderTabs(){
    const el=$("#tabs");
    el.innerHTML=CATEGORIES.map(c=>`<button class="tab ${c.id===state.catId?"active":""}" data-cat="${c.id}">${c.name}</button>`).join("");
    el.querySelectorAll(".tab").forEach(b=>b.addEventListener("click", ()=>{ state.catId=b.dataset.cat; renderAll(); }));
  }

  function findItem(itemId){
    for(const c of CATEGORIES){ const it=c.items.find(x=>x.id===itemId); if(it) return {cat:c,item:it}; }
    return null;
  }
  function setQty(itemId, qty){
    if(qty<=0){ delete state.cart[itemId]; clearItemOpts(itemId); } else state.cart[itemId]=qty;
    renderAll();
  }

  function renderItems(){
    const cat=CATEGORIES.find(c=>c.id===state.catId);
    $("#catName").textContent=cat?.name||"—";
    const el=$("#items");
    el.innerHTML=(cat?.items||[]).map(it=>{
      const qty=state.cart[it.id]||0;
      return `
        <div class="item">
          <img class="thumb" src="${getItemPhotos(state.catId, it.id)[0]}" alt="${it.name}" loading="lazy" onerror="this.onerror=null;this.src=svgThumb(it.name);">
          <div class="meta">
            <div class="name">${it.name}</div>
            <div class="sub">${getItemSubPriceText(it, qty)}</div>
            <div class="row2">
              <div class="qty"><button class="qbtn" data-act="dec" data-id="${it.id}">-</button><div class="qval">${qty}</div><button class="qbtn" data-act="inc" data-id="${it.id}">+</button></div>
              <button class="linkbtn" data-act="detail" data-id="${it.id}">詳情</button>
            </div>
            ${qty>0 ? buildOptionsHTML(it) : ""}
          </div>
          <div class="price">${fmt(getUnitPrice(it, qty) * qty)}</div>
        </div>
      `;
    }).join("");

    el.querySelectorAll("button").forEach(b=>{
      const act=b.dataset.act, id=b.dataset.id;
      if(!act||!id) return;
      if(act==="inc") b.addEventListener("click", ()=>setQty(id,(state.cart[id]||0)+1));
      if(act==="dec") b.addEventListener("click", ()=>setQty(id,Math.max(0,(state.cart[id]||0)-1)));
      if(act==="detail") openModal(`商品詳情｜${findItem(id).item.name}`, buildPhotoHTML(getItemPhotos(findItem(id).cat.id, id)) + `<div class="modalDesc">${(findItem(id).item.desc||"").replace(/\n/g,"<br>")}</div>`);
    });

    el.querySelectorAll('select[data-act="opt"]').forEach(s=>{
      s.addEventListener("change", ()=>{ setItemOpt(s.dataset.id, s.dataset.opt, s.value); renderItems(); renderCart(); });
    });

    $("#pickedCount").textContent = `${Object.keys(state.cart).filter(k=>k!=="packs" && state.cart[k]>0).length + Object.keys(state.cart.packs||{}).filter(k=>state.cart.packs[k]).length} 項已選`;
  }

  function groupCart(){
    const groups=new Map();
    for(const [id,qty] of Object.entries(state.cart)){
      if(id==="packs") continue;
      const f=findItem(id); if(!f) continue;
      if(!groups.has(f.cat.name)) groups.set(f.cat.name, []);
      groups.get(f.cat.name).push({item:f.item, qty});
    }
    return groups;
  }

  function updateSurcharges(baseSum){
    const ds = $("#fDateStart")?.value || "", de = $("#fDateEnd")?.value || ds;
    const ts = $("#fTimeStart")?.value || "00:00", te = $("#fTimeEnd")?.value || "00:00";
    let start = parseDateTime(ds, ts), end = parseDateTime(de, te), dayCount = 1;
    if(start && end){
      if(de===ds && end.getTime() <= start.getTime()) end = new Date(end.getTime() + 24*60*60*1000);
      dayCount = Math.max(1, Math.round((new Date(end.getFullYear(), end.getMonth(), end.getDate()).getTime() - new Date(start.getFullYear(), start.getMonth(), start.getDate()).getTime())/(24*60*60*1000)) + 1);
    }
    const has2 = !!$("#fHasSession2") && $("#fHasSession2").checked;
    let day1SecondFee = 0;
    if(has2 && $("#fTime2Start")?.value && $("#fTime2End")?.value) day1SecondFee = Math.round(baseSum * 0.30);
    const E = baseSum + day1SecondFee;
    const extraDays = Math.max(0, dayCount - 1);
    let dayFee = 0;
    if(extraDays >= 1) dayFee += Math.round(E * 0.50);
    if(extraDays >= 2) dayFee += Math.round(E * 0.30 * (extraDays - 1));
    let s2DaysFee = 0;
    if(dayCount >= 2){ document.querySelectorAll('input[data-s2day="1"]').forEach(cb=>{ if(cb.checked) s2DaysFee += Math.round(E * 0.30); }); }
    state.surcharges = { day: dayFee, session2: day1SecondFee + s2DaysFee, day1SecondFee, s2DaysFee, dayCount, extraDays, E, baseSum };
    return state.surcharges;
  }

  function calc(){
    let sum=0;
    if(state.cart.packs){ for(const pack of Object.values(state.cart.packs)){ if(pack) sum += Number(pack.price||0); } }
    for(const [id,qty] of Object.entries(state.cart)){
      if(id==="packs") continue;
      const f=findItem(id); if(f) sum += getUnitPrice(f.item, qty) * qty;
    }
    const sur = updateSurcharges(sum);
    return {sum, adj:0, ship:0, dayFee: Number(sur.day||0), session2Fee: Number(sur.session2||0), total: sum + Number(sur.day||0) + Number(sur.session2||0)};
  }

  function openModal(title, htmlBody){ $("#mTitle").textContent = title || "詳情"; $("#mBody").innerHTML = htmlBody || "—"; $("#modalMask").style.display="flex"; }
  function closeModal(){ $("#modalMask").style.display="none"; }
  (function(){
    const mask = document.getElementById("modalMask");
    if(document.getElementById("mClose")) document.getElementById("mClose").addEventListener("click", closeModal);
    if(mask) mask.addEventListener("click", (e)=>{ if(e.target===mask) closeModal(); });
    if(document.getElementById("mBack")) document.getElementById("mBack").addEventListener("click", closeModal);
  })();

  function getItemPhotos(catId, itemId){ return [`https://picsum.photos/seed/${catId}-${itemId}-a/800/600`, `https://picsum.photos/seed/${catId}-${itemId}-b/800/600`]; }
  function buildPhotoHTML(urls){
    return `<div class="photoGrid"><div class="photoBox"><img src="${urls[0]||""}" alt="示意照片 1" loading="lazy"></div><div class="photoBox"><img src="${urls[1]||""}" alt="示意照片 2" loading="lazy"></div></div>`;
  }

  function applyPackLevel(tierKey, level){
    const packs = tierKey==="safety" ? PACKS_SAFETY : (tierKey==="ambience" ? PACKS_AMBIENCE : PACKS_UPGRADE);
    const list = (packs && packs[level]) ? packs[level] : [];
    if(!level || !list.length){ alert("此等級尚未設定套裝內容。"); return; }
    state.tiers[tierKey] = level;
    state.cart = state.cart || {}; state.cart.packs = state.cart.packs || {};
    state.cart.packs[tierKey] = { tierKey, label: tierKey==="safety" ? "安全等級" : (tierKey==="ambience" ? "氣氛等級" : "升級等級"), level, name: (LEVELS[tierKey]?.[level-1]) || `第${level}級`, price: (LEVEL_PRICES[tierKey]?.[level-1]) || 0, items: list };
    renderAll();
  }
  function removePack(tierKey){ if(state.cart.packs) delete state.cart.packs[tierKey]; state.tiers[tierKey]=0; renderAll(); }

  function renderTierButtons(){
    const mk = (tierKey, containerSel) => {
      const el = $(containerSel);
      el.innerHTML = LEVELS[tierKey].map((name, idx)=>{
        const n = idx+1, price = LEVEL_PRICES[tierKey]?.[idx];
        return `<div class="levelBtn ${state.tiers[tierKey]===n ? "active" : ""}" data-tier="${tierKey}" data-level="${n}">
            <div class="levelText">
              <div class="levelTopRow"><span class="levelName">${name}</span><span class="levelPrice">${price?fmt(price):"—"}</span></div>
              <div class="levelActions"><button type="button" class="miniBtn primaryMini" data-act="apply" data-tier="${tierKey}" data-level="${n}">加入報價</button></div>
            </div>
            <div class="levelMedia"><img src="${(TIER_PHOTOS[tierKey]?.[idx]?.[0]) || ''}" loading="lazy"></div>
          </div>`;
      }).join("");
      el.querySelectorAll(".levelBtn").forEach(box=>{
        box.addEventListener("click", (e)=>{
          if(e.target && e.target.closest(".miniBtn")) return;
          state.tiers[box.dataset.tier]=Number(box.dataset.level);
          renderTierPills(); renderTierButtons();
        });
      });
      el.querySelectorAll(".miniBtn").forEach(b=>{ b.addEventListener("click", (e)=>{ e.stopPropagation(); applyPackLevel(b.dataset.tier, Number(b.dataset.level)); }); });
    };
    mk("safety","#levelsSafety"); mk("ambience","#levelsAmbience"); mk("upgrade","#levelsUpgrade");
    $("#pillSafety").textContent = state.tiers.safety ? `第${state.tiers.safety}級` : "未選";
    $("#pillAmbience").textContent = state.tiers.ambience ? `第${state.tiers.ambience}級` : "未選";
    $("#pillUpgrade").textContent = state.tiers.upgrade ? `第${state.tiers.upgrade}級` : "未選";
  }
  function renderTierPills(){ $("#tierPills").textContent = `${state.tiers.safety?`安全第${state.tiers.safety}級`:"安全—"}｜${state.tiers.ambience?`氣氛第${state.tiers.ambience}級`:"氣氛—"}｜${state.tiers.upgrade?`升級第${state.tiers.upgrade}級`:"升級—"}`; }

  function renderCart(){
    const el=$("#cart"), groups=groupCart();
    const {sum,dayFee,session2Fee,total}=calc();
    
    if($("#daySurchargeRow")) $("#daySurchargeRow").querySelector(".subttl").innerHTML = `跨天加價 <span class="note-inline">（第2天：E×50%；第3天起：每一天 E×30%）</span>`;
    if($("#session2SurchargeRow")) $("#session2SurchargeRow").querySelector(".subttl").innerHTML = `第二場加價 <span class="note-inline">（第一天/跨天每勾一天：E×30%）</span>`;
    $("#cartBadge").textContent = `${(state.cart.packs ? Object.keys(state.cart.packs).filter(k=>state.cart.packs[k]).length : 0) + Object.keys(state.cart).filter(k=>k!=="packs").length} 項已選`;

    const parts=[];
    if(state.cart.packs){
      for(const [tierKey, title] of [["safety","安全等級"],["ambience","氣氛等級"],["upgrade","升級等級"]]){
        const pack = state.cart.packs[tierKey];
        if(!pack) continue;
        parts.push(`
          <div class="group">
            <div class="gh"><span>${title}（套裝）</span><span class="subttl">已選 <b>1</b> 項</span></div>
            <div class="gb">
              <div class="citem">
                <img src="${(TIER_PHOTOS[tierKey]?.[Number(pack.level)-1]?.[0]) || ''}">
                <div class="cmeta">
                  <div class="top"><div><div class="nm">${title}｜${pack.name}</div><div class="unit">套裝</div></div><div style="font-weight:1000">${fmt(pack.price)}</div></div>
                  <div class="cline"><div class="qtyRow"><div class="qty" style="padding:6px 10px"><b>套裝</b></div><button class="xbtn" data-act="delpack" data-tier="${tierKey}">✕</button></div></div>
                </div>
              </div>
            </div>
          </div>
        `);
      }
    }
    for(const [gname, rows] of groups.entries()){
      parts.push(`
        <div class="group">
          <div class="gh"><span>${gname}</span><span class="subttl">已選 <b>${rows.length}</b> 項</span></div>
          <div class="gb">
            ${rows.map(({item,qty})=>{
              const up=getUnitPrice(item, qty);
              return `
                <div class="citem">
                  <div class="cmeta">
                    <div class="top"><div><div class="nm">${item.name}${formatOptText(item.id)}</div><div class="unit">${fmt(up)} / ${item.unit}</div></div><div style="font-weight:1000">${fmt(up*qty)}</div></div>
                    <div class="cline"><div class="qtyRow"><div class="qty"><button class="qbtn" data-act="dec" data-id="${item.id}">-</button><div class="qval">${qty}</div><button class="qbtn" data-act="inc" data-id="${item.id}">+</button></div><button class="xbtn" data-act="del" data-id="${item.id}">✕</button></div></div>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        </div>
      `);
    }

    el.innerHTML = parts.join("") || `<div class="note" style="display:none"></div>`;
    el.querySelectorAll("button").forEach(b=>{
      const act=b.dataset.act, id=b.dataset.id;
      if(act==="inc") b.addEventListener("click", ()=>setQty(id,(state.cart[id]||0)+1));
      if(act==="dec") b.addEventListener("click", ()=>setQty(id,Math.max(0,(state.cart[id]||0)-1)));
      if(act==="del") b.addEventListener("click", ()=>setQty(id,0));
      if(act==="delpack") b.addEventListener("click", ()=>removePack(b.dataset.tier));
    });
    
    $("#grandTotal").textContent=fmt(sum);
    if($("#grandTotalRow")) $("#grandTotalRow").style.display = (dayFee>0 || session2Fee>0) ? "flex" : "none";
    if($("#daySurchargeRow")) { $("#daySurchargeRow").style.display = dayFee>0 ? "flex" : "none"; $("#daySurcharge").textContent = fmt(dayFee); }
    if($("#session2SurchargeRow")) { $("#session2SurchargeRow").style.display = session2Fee>0 ? "flex" : "none"; $("#session2Surcharge").textContent = fmt(session2Fee); }
    $("#finalTotal").textContent=fmt(total);
  }

  function renderAll(){ renderTierPills(); renderTierButtons(); renderTabs(); renderItems(); renderCart(); }

  // ============================
  // ✅ 核心打包邏輯：送出所有填寫欄位
  // ============================
  const ORDER_API_URL = "https://script.google.com/macros/s/AKfycbxrphr7gIrOVrrhp1lplR7IYrZdc_8E8cajBEitSoUiujGRE7v8FDy0BYL8VLHaexvq/exec";

  function buildQuoteItemsForSend(){
    const items = [];
    if(state.cart?.packs){
      for(const [k,label] of [["safety","安全等級"],["ambience","氣氛等級"],["upgrade","升級等級"]]){
        const p = state.cart.packs[k];
        if(!p) continue;
        items.push({ categoryName: "套裝", name: `套裝｜${label}｜${p.name||""}`, id: `pack_${k}`, unit: "套", price: Number(p.price||0), qty: 1, lineTotal: Number(p.price||0), options: {} });
      }
    }
    for(const [catName, rows] of groupCart().entries()){
      for(const {item, qty} of rows){
        const up = getUnitPrice(item, qty);
        items.push({ categoryName: catName, name: item.name, id: item.id, unit: item.unit || "", price: Number(up||0), qty: Number(qty||0), lineTotal: Number(up||0) * Number(qty||0), options: state.itemOpts?.[item.id] || {} });
      }
    }
    return items;
  }

  function submitQuoteToAppsScript(){
    const btn = document.getElementById("btnSendQuote");
    if(btn) { btn.disabled = true; btn.textContent = "傳送中..."; }
    
    try{
      const payload = {
        action: "submitQuote",
        form: {
          name: $("#fName")?.value?.trim() || "",
          phone: $("#fPhone")?.value?.trim() || "",
          email: $("#fEmail")?.value?.trim() || "",
          dateStart: $("#fDateStart")?.value || "",
          dateEnd: $("#fDateEnd")?.value || "",
          timeStart: $("#fTimeStart")?.value || "",
          timeEnd: $("#fTimeEnd")?.value || "",
          city: $("#fCity")?.value || "",
          area: $("#fArea")?.value || "",
          addr: $("#fAddr")?.value?.trim() || "",
          bldg: $("#fBldg")?.value?.trim() || "",
          eventType: $("#fEventType")?.value || "",
          crowd: $("#fCrowd")?.value || "",
          indoor: $("#fIndoor")?.value || "",
          hasSession2: $("#fHasSession2")?.checked ? "是" : "否",
          session2Start: $("#fTime2Start")?.value || "",
          session2End: $("#fTime2End")?.value || "",
          note: $("#fNote")?.value?.trim() || ""
        },
        levels: { safety: state.cart?.packs?.safety?.name || "", ambience: state.cart?.packs?.ambience?.name || "", upgrade: state.cart?.packs?.upgrade?.name || "" },
        items: buildQuoteItemsForSend(),
        summary: calc()
      };

      fetch(ORDER_API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) })
        .then(() => { alert("已送出！系統會產生 PDF 報價單並寄給您，請至信箱查收。"); })
        .catch(e => { alert("送出失敗：" + e.message); })
        .finally(() => { if(btn) { btn.disabled = false; btn.textContent = "送出報價單"; } });
    }catch(e){
      alert("送出過程發生錯誤：" + e.message);
      if(btn) { btn.disabled = false; btn.textContent = "送出報價單"; }
    }
  }

  if($("#btnSendQuote")) $("#btnSendQuote").addEventListener("click", submitQuoteToAppsScript);
  if($("#btnMail")) $("#btnMail").addEventListener("click", submitQuoteToAppsScript);

  try{
    initCity(); initTimePickers(); renderSession2Days();
    if($("#fHasSession2")){
      $("#fHasSession2").addEventListener("change", ()=>{ if($("#session2Wrap")) $("#session2Wrap").style.display = $("#fHasSession2").checked ? "block" : "none"; renderCart(); });
      if($("#session2Wrap")) $("#session2Wrap").style.display = $("#fHasSession2").checked ? "block" : "none";
    }
    ["t2StartH","t2StartM","t2EndH","t2EndM", "fDateStart","fDateEnd"].forEach(id=>{ if($("#"+id)) $("#"+id).addEventListener("change", ()=>{ renderSession2Days(); renderCart(); }); });
  }catch(err){} finally { renderAll(); }

</script>
</body>
</html>
