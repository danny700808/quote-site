<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ´»å‹•ä¼åŠƒï½œç‡ˆå…‰éŸ³éŸ¿é…ç½®å€ï½œè¨­å‚™é¸é…èˆ‡å³æ™‚å ±åƒ¹</title>

  <style>
    #btnMail{display:none !important;}
    :root{
      --bg:#f7fbf9;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --line:#e6efe9;
      --brand:#63bfae;
      --brand2:#2f8f7b;
      --blush:#f4b7c4;
      --mintSoft:#eaf7f3;
      --blushSoft:#fff1f4;
      --danger:#e25a6a;
      --shadow:0 10px 28px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:10;background:rgba(247,251,249,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .head{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center;padding:14px 18px}
    .title{grid-column:2;display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center}
    .title h1{margin:0;font-size:18px}

    /* å››æ­¥é©Ÿå°è¦½ */
    .stepsWrap { width: 100%; margin-top: 4px; }
    .steps { display: flex; justify-content: space-between; position: relative; padding: 0; margin: 0; }
    .steps::before { content: ""; position: absolute; top: 15px; left: 10%; right: 10%; height: 2px; background: var(--line); z-index: 0; }
    .stepBox { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; }
    .stepNum { width: 32px; height: 32px; background: var(--card); border: 2px solid var(--brand); color: var(--brand2); font-weight: 900; border-radius: 999px; display: grid; place-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
    .stepText { font-size: 13px; font-weight: 800; color: var(--text); text-align: center; line-height: 1.25; }

    .btn{border:1px solid var(--line);background:var(--card);padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px}
    .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
    .btn.danger{background:var(--danger);border-color:transparent;color:#fff}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:14px;align-items:start}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;}
    .card .hd h2{margin:0;font-size:16px}

    .stepHd{position:relative;border-bottom:1px solid var(--line)}
    .step1{background:linear-gradient(90deg, color-mix(in srgb, var(--brand) 18%, #fff), #fff)}
    .step2{background:linear-gradient(90deg, color-mix(in srgb, var(--blush) 18%, #fff), #fff)}
    .step3{background:linear-gradient(90deg, #eff6ff, #fff)}
    .step4{background:linear-gradient(90deg, #fffbeb, #fff)}

    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff;white-space:nowrap}

    .form{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted);font-weight:900}
    .field input,.field select,.field textarea{border:1px solid var(--line);border-radius:12px;padding:11px 12px;background:#fff;outline:none;font-size:14px}
    .field textarea{min-height:84px;resize:vertical}
    .span2{grid-column:1/-1}

    /* ğŸš€ æ’ç‰ˆä¿®æ­£ï¼šæ—¥æœŸèˆ‡æ™‚é–“æ ¼å­ */
    .dateRow{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:end}
    .dateRow .sep{color:var(--muted);font-weight:900;text-align:center; transform: translateY(-14px);}
    .dateCol{display:grid;gap:6px;min-width:0}
    .dateCap{font-size:11px;color:var(--muted);font-weight:900}
    .dateRow input{width:100%;min-width:0}

    .timeRow{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
    .timeRow .sep{color:var(--muted);font-weight:900;text-align:center}
    .timeInputGroup{display:grid;grid-template-columns:1fr 1fr;gap:6px} /* åˆ†é–‹å°æ™‚èˆ‡åˆ†é˜æ ¼å­ */

    .tabs{padding:12px 14px 14px;display:flex;gap:10px;flex-wrap:wrap;border-top:1px solid var(--line)}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000;font-size:14px}
    .tab.active{background:rgba(30,142,111,.12);border-color:rgba(30,142,111,.35);color:var(--brand2)}
    .items{padding:14px;display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;grid-template-columns:74px 1fr auto;gap:12px;align-items:center}
    .thumb{width:74px;height:74px;border-radius:14px;object-fit:cover;border:1px solid var(--line);background:#f3f4f6}
    .meta{min-width:0}
    .meta .name{font-weight:1000}
    .meta .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .meta .row2{margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .price{font-weight:1000;text-align:right}
    .qty{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 8px;background:#fff}
    .qbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000}
    .qval{min-width:44px;text-align:center;font-weight:1000}
    .summary{padding:14px;display:grid;gap:12px}
    .totals{border:1px dashed var(--line);border-radius:14px;padding:12px;display:grid;gap:8px;background:linear-gradient(180deg, rgba(30,142,111,.06), transparent)}
    .trow{display:flex;justify-content:space-between;align-items:center;gap:10px}

    .cart{display:grid;gap:12px}
    .group{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .citem{position:relative;border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;display:block; padding-right:52px;}
    .xbtn{position:absolute; top:50%; transform:translateY(-50%); right:10px; width:36px;height:36px;border-radius:12px;border:1px solid rgba(226,74,74,.35);background:rgba(226,74,74,.10);color:var(--danger);font-weight:1000;cursor:pointer}

    .tierWrap{padding:14px;display:grid;gap:12px}
    .tierGrid{display:grid;grid-template-columns:1fr;gap:12px}
    .tierCard{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .tierHead{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .levelRow{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;padding:12px}
    .levelBtn{border:1px solid var(--line);border-radius:14px;padding:8px;cursor:pointer;background:#fff;display:flex;flex-direction:column;gap:8px}
    .levelTopRow{display:flex;justify-content:space-between;gap:8px;align-items:flex-start}
    .levelMedia img{width:100%;height:120px;object-fit:cover;display:block;border-radius:8px}
    .miniBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:7px 10px;cursor:pointer;font-weight:1000;font-size:12px}
    .primaryMini{background:var(--brand);border-color:transparent;color:#fff}

    .sendBar{display:flex;justify-content:flex-end}
    .btn.send{background:#0ea5e9;border-color:#0284c7;color:#fff;font-weight:900}
    .btn.send:hover{filter:brightness(.97)}

    /* Modalï¼ˆåŸæœ¬ç¼ºå°‘ï¼Œå°è‡´é®ç½©å¯èƒ½æ°¸é é¡¯ç¤º/æˆ–æ¨£å¼è·‘æ‰ï¼‰ */
    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
    .modal{width:min(560px,100%);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 18px 48px rgba(0,0,0,.22);overflow:hidden}
    .modal .mh{padding:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;border-bottom:1px solid var(--line)}
    .modal .mb{padding:14px 14px 20px;}
    .modal .mb p{margin:0;color:#374151;line-height:1.65}

    @media (max-width: 620px) {
      .form { grid-template-columns: 1fr !important; }
      .field input, .field select, .field textarea { font-size: 16px !important; }
      .timeRow { gap: 4px; }
      .timeInputGroup { gap: 4px; }
      .timeInputGroup select { padding: 8px 4px !important; font-size: 13px !important; }
      .dateRow{gap:4px}
      .dateRow .sep{transform:translateY(-10px)}
      .levelRow { grid-template-columns: repeat(2, 1fr); gap: 6px; }
      .levelMedia img { height: 75px; }
      .items { grid-template-columns: repeat(2, 1fr); gap: 6px; }
      .item { display: flex; flex-direction: column; align-items: stretch; padding: 8px; }
      .thumb { width: 100%; height: 90px; }
      .sendBar{justify-content:stretch}
      .btn.send{width:100%}
    }
  </style>
</head>

<body>
<header>
  <div class="head">
    <div class="title">
      <h1>æ´»å‹•ä¼åŠƒï½œè¨­å‚™é¸é…èˆ‡å³æ™‚å ±åƒ¹</h1>
      <div class="stepsWrap">
        <div class="steps">
          <div class="stepBox"><span class="stepNum">1</span><span class="stepText">å¡«å¯«åŸºæœ¬è³‡æ–™</span></div>
          <div class="stepBox"><span class="stepNum">2</span><span class="stepText">é¸å–ç‡ˆå…‰éŸ³éŸ¿é…ç½®</span></div>
          <div class="stepBox"><span class="stepNum">3</span><span class="stepText">é¸å–è¨­å‚™æœå‹™åŠ è³¼</span></div>
          <div class="stepBox"><span class="stepNum">4</span><span class="stepText">é€å‡ºå ±åƒ¹å–®</span></div>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card">
      <div class="hd stepHd step1">
        <h2>1) åŸºæœ¬è³‡æ–™</h2>
        <span class="pill" id="pickedCount">0 é …å·²é¸</span>
      </div>

      <div class="form">
        <div class="field"><label>å§“å / å–®ä½</label><input id="fName" placeholder="ä¾‹ï¼šæŸšå­æ¨‚å™¨ / ç‹å°æ˜"></div>
        <div class="field"><label>è¡Œå‹•é›»è©±</label><input id="fPhone" type="tel" placeholder="09xx-xxx-xxx"></div>
        <div class="field span2"><label>è©³ç´°åœ°å€</label><input id="fAddr" placeholder="ä¾‹ï¼šä¸­å±±è·¯ 100 è™Ÿ"></div>

        <div class="field span2">
          <label>æ´»å‹•æ—¥æœŸï¼ˆé–‹å§‹ ï½ çµæŸï¼‰</label>
          <div class="dateRow">
            <div class="dateCol">
              <div class="dateCap">é–‹å§‹</div>
              <input id="fDateStart" type="date">
            </div>
            <div class="sep">ï½</div>
            <div class="dateCol">
              <div class="dateCap">çµæŸ</div>
              <input id="fDateEnd" type="date">
            </div>
          </div>
        </div>

        <div class="field span2">
          <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted);cursor:pointer;">
            <input type="checkbox" id="fHasExtraDate" style="width:18px;height:18px">
            æ–°å¢ä¸é€£çºŒçš„æ´»å‹•æ—¥æœŸ (ä¾åŸåƒ¹è¨ˆç®—)
          </label>
          <div id="extraDateWrap" style="display:none; margin-top:8px; padding:10px; border:1px dashed var(--line); border-radius:12px; background:#fbfdfc;">
            <div class="dateRow">
              <div class="dateCol">
                <div class="dateCap">é¡å¤–é–‹å§‹</div>
                <input id="fExtraDateStart" type="date">
              </div>
              <div class="sep">ï½</div>
              <div class="dateCol">
                <div class="dateCap">é¡å¤–çµæŸ</div>
                <input id="fExtraDateEnd" type="date">
              </div>
            </div>
          </div>
        </div>

        <div class="field span2">
          <label>æ´»å‹•æ™‚é–“</label>
          <div class="timeRow">
            <div class="timeInputGroup">
              <select id="tStartH"></select>
              <select id="tStartM"></select>
            </div>
            <div class="sep">ï½</div>
            <div class="timeInputGroup">
              <select id="tEndH"></select>
              <select id="tEndM"></select>
            </div>
          </div>
          <input id="fTimeStart" type="hidden">
          <input id="fTimeEnd" type="hidden">
        </div>

        <div class="field span2">
          <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted);cursor:pointer;">
            <input type="checkbox" id="fHasSession2" style="width:18px;height:18px">
            åŒä¸€å¤©æœ‰ç¬¬äºŒå ´åŒæ€§è³ªæ´»å‹•ï¼ˆå‹¾é¸å¾Œå¯è¨­å®šç¬¬äºŒå ´æ™‚é–“ï¼›ç¬¬äºŒå ´åŠ åƒ¹ï¼šåŸå§‹ç¸½åƒ¹ x 30%ï¼‰
          </label>

          <div id="session2Wrap" style="display:none; margin-top:8px; padding:10px; border:1px dashed var(--line); border-radius:12px; background:#fbfdfc;">
            <div style="font-weight:1000; margin-bottom:8px; color:var(--text);">ç¬¬äºŒå ´æ™‚é–“</div>
            <div class="timeRow">
              <div class="timeInputGroup">
                <select id="t2StartH"></select>
                <select id="t2StartM"></select>
              </div>
              <div class="sep">ï½</div>
              <div class="timeInputGroup">
                <select id="t2EndH"></select>
                <select id="t2EndM"></select>
              </div>
            </div>
            <input id="fTime2Start" type="hidden">
            <input id="fTime2End" type="hidden">
          </div>
        </div>

        <div class="field span2"><label>å‚™è¨»éœ€æ±‚</label><textarea id="fNote"></textarea></div>
      </div>

      <div class="hd stepHd step2" style="border-top:1px solid var(--line);border-bottom:none">
        <h2>2) ç‡ˆå…‰éŸ³éŸ¿é…ç½®å€</h2>
      </div>

      <div class="tierWrap">
        <div class="tierGrid">
          <div class="tierCard"><div class="tierHead"><b>å®‰å…¨ç­‰ç´š</b></div><div id="levelsSafety" class="levelRow"></div></div>
          <div class="tierCard"><div class="tierHead"><b>æ°£æ°›ç­‰ç´š</b></div><div id="levelsAmbience" class="levelRow"></div></div>
          <div class="tierCard"><div class="tierHead"><b>å‡ç´šç­‰ç´š</b></div><div id="levelsUpgrade" class="levelRow"></div></div>
        </div>
      </div>

      <div class="hd stepHd step3" style="border-top:1px solid var(--line);border-bottom:none">
        <h2>3) è¨­å‚™/æœå‹™åˆ†é¡ï¼ˆè‡ªç”±åŠ æ¸›ï¼‰</h2>
        <span class="pill" id="catName">â€”</span>
      </div>
      <div class="tabs" id="tabs"></div>
      <div class="items" id="items"></div>
    </section>

    <aside class="card" id="quoteCard">
      <div class="hd stepHd step4"><h2>4) å³æ™‚å ±åƒ¹</h2></div>
      <div class="summary">
        <div class="totals">
          <div class="trow"><span>ç¸½è¨ˆ</span><b id="finalTotal">NT$0</b></div>
        </div>
        <div class="cart" id="cart"></div>
        <div class="sendBar"><button class="btn send" id="btnSendQuote" type="button">é€å‡ºå ±åƒ¹å–®</button></div>
      </div>
    </aside>
  </div>
</div>

<div class="modalMask" id="modalMask">
  <div class="modal">
    <div class="mh"><b id="mTitle">è©³æƒ…</b><button class="xbtn" id="mClose" type="button">âœ•</button></div>
    <div class="mb"><p id="mBody">â€”</p></div>
  </div>
</div>

<script>
  /* -----------------------------------------------------------
     å®Œå…¨ä¿ç•™æ‚¨åŸå§‹æœ€å®Œæ•´çš„å™¨ææ•¸æ“š CATEGORIES èˆ‡è¨ˆç®—é‚è¼¯
     ----------------------------------------------------------- */
  const CATEGORIES = [
    { id:"stage", name:"èˆå°çµæ§‹èˆ‡æ¡æ¶ç³»çµ±", items:[
      { id:"stage-deck", name:"èˆå°æ¿ï¼ˆ2x1mï¼‰", unit:"ç‰‡", price:1200, img:svgThumb("èˆå°æ¿"), desc:"æ¨™æº–èˆå°æ¿ã€‚æ•¸é‡å„ªæƒ ï¼š1-19ç‰‡ 1200ï¼›20-49ç‰‡ 1100ï¼›50ç‰‡ä»¥ä¸Š 1000ã€‚" },
      { id:"stage-backdrop", name:"ä¸»è¦–è¦ºèƒŒæ¿", unit:"çµ„", price:6500, img:svgThumb("èƒŒæ¿"), desc:"åŸºæœ¬èƒŒæ¿è¼¸å‡ºèˆ‡æ¶è¨­ã€‚" },
      { id:"stage-truss", name:"TRUSS æ¡æ¶", unit:"æ”¯", price:1800, img:svgThumb("TRUSS"), desc:"ç‡ˆå…‰/å¸ƒå¹•æ¶è¨­ç”¨ã€‚" }
    ]},
    { id:"audio", name:"éŸ³éŸ¿èˆ‡èˆå°æ”¶éŸ³", items:[
      { id:"audio-main", name:"ä¸»å–‡å­çµ„", unit:"çµ„", price:6000, img:svgThumb("ä¸»å–‡å­"), desc:"é©åˆ 100-400 äººå ´åœ°ã€‚" },
      { id:"audio-wireless2", name:"ç„¡ç·šéº¥å…‹é¢¨(2æ”¯çµ„)", unit:"çµ„", price:2200, img:svgThumb("ç„¡ç·šéº¥"), desc:"å°ˆæ¥­ç­‰ç´šç„¡ç·šæ”¶éŸ³ã€‚" },
      { id:"staff-audio", name:"éŸ³æ§å·¥ç¨‹å¸«", unit:"äºº/å ´", price:6500, img:svgThumb("éŸ³æ§"), desc:"å…¨ç¨‹ç¾å ´æ§å ´ã€‚" }
    ]},
    { id:"light", name:"ç‡ˆå…‰èˆ‡æ°£æ°›æ•ˆæœ", items:[
      { id:"light-par", name:"LED æŸ“è‰²ç‡ˆ", unit:"ç›", price:900, img:svgThumb("æŸ“è‰²ç‡ˆ"), desc:"æ°›åœç‡Ÿé€ æŸ“è‰²ã€‚" },
      { id:"light-moving", name:"å…‰æŸç‡ˆ", unit:"ç›", price:2500, img:svgThumb("å…‰æŸç‡ˆ"), desc:"å‹•æ…‹èˆå°ç‡ˆå…‰æ•ˆæœã€‚" }
    ]},
    { id:"video", name:"å½±åƒèˆ‡æŠ•å½±ç³»çµ±", items:[
      { id:"video-projector", name:"æŠ•å½±æ©Ÿ(åŸºæœ¬)", unit:"å°", price:6500, img:svgThumb("æŠ•å½±"), desc:"æœƒè­°ç°¡å ±å¿…å‚™ã€‚" }
    ]},
    { id:"site", name:"å¸³ç¯·æ¡Œæ¤…å™¨æ", items:[
      { id:"site-tent", name:"å¿«å¸³(3x3m)", unit:"é ‚", price:1800, img:svgThumb("å¿«å¸³"), desc:"æˆ¶å¤–é®é™½å¿…å‚™ã€‚" }
    ]},
    { id:"power", name:"é›»åŠ›ç‡Ÿé‹èˆ‡å®‰å…¨", items:[
      { id:"power-dist", name:"é…é›»ç®±çµ„", unit:"å¥—", price:1800, img:svgThumb("é…é›»"), desc:"åŸºæœ¬é›»åŠ›åˆ†é…ã€‚" }
    ]}
  ];

  const LEVELS = {
    safety: ["â‘  åŸºç¤ç©©å®š","â‘¡ æ¨™æº–é…ç½®","â‘¢ æ´»å‹•å°ˆæ¥­","â‘£ æ¼”å‡ºé€²éš","â‘¤ æ——è‰¦èˆå°","â‘¥ å…¨ç››å…¸è—"],
    ambience:["â‘  ç´”æ·¨ç‡ˆè‰²","â‘¡ å…¸ç¦®è³ªæ„Ÿ","â‘¢ æ°›åœå±¤æ¬¡","â‘£ è¦–è¦ºç„¦é»","â‘¤ æ²‰æµ¸èˆå°","â‘¥ å…¨æ„Ÿé«”é©—"],
    upgrade:["â‘  äº®é»å…¥é–€","â‘¡ æ°£æ°›æ•ˆæœ","â‘¢ å„€å¼éœ‡æ’¼","â‘£ æ¼”å‡ºæ”¯æ´","â‘¤ å…¨æ–¹ä½","â‘¥ å°Šæ¦®è¦æ ¼"]
  };

  const LEVEL_PRICES = {
    safety: [10000, 15000, 20000, 25000, 35000, 50000],
    ambience:[20000, 25000, 35000, 45000, 60000, 80000],
    upgrade: [30000, 40000, 50000, 80000, 100000, 150000]
  };

  function svgThumb(label){ return `https://picsum.photos/seed/${encodeURIComponent(label)}/200`; }
  const state = { catId: "audio", cart: { packs: {} }, tiers: { safety: 0, ambience: 0, upgrade: 0 } };
  const $ = (s)=>document.querySelector(s);
  const fmt = (n)=>"NT$"+Number(n||0).toLocaleString();

  function setHiddenTime(hId, mId, outId){
    const h = document.getElementById(hId)?.value ?? "00";
    const m = document.getElementById(mId)?.value ?? "00";
    const out = document.getElementById(outId);
    if(out) out.value = `${h}:${m}`;
  }

  // ğŸš€ ä¿®æ­£ï¼šæ™‚é–“ç”Ÿæˆé‚è¼¯ï¼Œåˆ†é›¢å°æ™‚èˆ‡åˆ†é˜ï¼ˆä¸¦åŒæ­¥ hidden å€¼ï¼‰
  function initTimePickers(){
    const hours = Array.from({length:24}, (_,i)=>String(i).padStart(2,"0"));
    const mins = ["00","10","20","30","40","50"];
    const fill = (id, arr)=> {
      const el = document.getElementById(id);
      if(el) el.innerHTML = arr.map(v=>`<option value="${v}">${v}</option>`).join("");
    };

    fill("tStartH", hours); fill("tStartM", mins);
    fill("tEndH", hours); fill("tEndM", mins);
    fill("t2StartH", hours); fill("t2StartM", mins);
    fill("t2EndH", hours); fill("t2EndM", mins);

    const safeSet = (id,val)=>{ const el=document.getElementById(id); if(el) el.value=val; }
    safeSet("tStartH","09"); safeSet("tStartM","00");
    safeSet("tEndH","12"); safeSet("tEndM","00");
    safeSet("t2StartH","14"); safeSet("t2StartM","00");
    safeSet("t2EndH","17"); safeSet("t2EndM","00");

    const bind = (hId,mId,outId)=>{
      const h=document.getElementById(hId), m=document.getElementById(mId);
      const fn=()=>setHiddenTime(hId,mId,outId);
      h?.addEventListener("change", fn);
      m?.addEventListener("change", fn);
      fn();
    };
    bind("tStartH","tStartM","fTimeStart");
    bind("tEndH","tEndM","fTimeEnd");
    bind("t2StartH","t2StartM","fTime2Start");
    bind("t2EndH","t2EndM","fTime2End");
  }

  function renderTierButtons(){
    const mk = (tierKey, containerSel) => {
      const el = $(containerSel);
      el.innerHTML = LEVELS[tierKey].map((name, idx)=>{
        const n = idx+1;
        const active = state.tiers[tierKey] === n ? "active" : "";
        return `
          <div class="levelBtn ${active}" onclick="selectTier('${tierKey}', ${n})" role="button" tabindex="0">
            <div class="levelTopRow">
              <span style="font-size:13px">${name}</span>
              <span style="font-size:12px;font-weight:1000">${fmt(LEVEL_PRICES[tierKey][idx])}</span>
            </div>
            <div class="levelMedia"><img src="https://picsum.photos/seed/${tierKey}${n}/200/120" alt=""></div>
            <button class="miniBtn primaryMini" type="button" onclick="event.stopPropagation(); selectTier('${tierKey}', ${n});" style="width:100%">åŠ å…¥å ±åƒ¹</button>
          </div>`;
      }).join("");
    };
    mk("safety","#levelsSafety"); mk("ambience","#levelsAmbience"); mk("upgrade","#levelsUpgrade");
  }

  window.selectTier = (key, n) => {
    state.tiers[key] = n;
    state.cart.packs[key] = { name: LEVELS[key][n-1], price: LEVEL_PRICES[key][n-1] };
    renderAll();
  };

  function renderItems(){
    const cat = CATEGORIES.find(c=>c.id===state.catId) || CATEGORIES[0];
    $("#catName").textContent = cat.name;
    $("#items").innerHTML = cat.items.map(it=>{
      const q = state.cart[it.id] || 0;
      return `
        <div class="item">
          <img class="thumb" src="${it.img}" alt="">
          <div class="meta">
            <div class="name">${it.name}</div>
            <div class="sub">${fmt(it.price)} / ${it.unit}</div>
            <div class="row2">
              <div class="qty">
                <button class="qbtn" type="button" onclick="updateQty('${it.id}',-1)">-</button>
                <div class="qval">${q}</div>
                <button class="qbtn" type="button" onclick="updateQty('${it.id}',1)">+</button>
              </div>
            </div>
          </div>
          <div class="price">${fmt(it.price * q)}</div>
        </div>`;
    }).join("");
  }

  window.updateQty = (id, delta) => {
    state.cart[id] = Math.max(0, (state.cart[id]||0) + delta);
    if(state.cart[id]===0) delete state.cart[id];
    renderAll();
  };

  function renderCart(){
    let sum = 0;
    const items = [];

    Object.entries(state.cart.packs).forEach(([k, p]) => {
      sum += p.price;
      items.push(`<div class="citem"><div class="cmeta"><div class="top" style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start"><div class="nm" style="font-weight:1000">${p.name}</div><div style="font-weight:1000">${fmt(p.price)}</div></div></div><button class="xbtn" type="button" onclick="deletePack('${k}')">âœ•</button></div>`);
    });

    CATEGORIES.forEach(c => c.items.forEach(it => {
      const q = state.cart[it.id];
      if(q > 0) {
        sum += it.price * q;
        items.push(`<div class="citem"><div class="cmeta"><div class="top" style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start"><div class="nm" style="font-weight:1000">${it.name} x ${q}</div><div style="font-weight:1000">${fmt(it.price*q)}</div></div></div><button class="xbtn" type="button" onclick="updateQty('${it.id}',-${q})">âœ•</button></div>`);
      }
    }));

    $("#cart").innerHTML = items.join("");
    $("#finalTotal").textContent = fmt(sum);

    const itemCount = Object.keys(state.cart).filter(k => k !== "packs").length; // åªç®—å–®å“
    const packCount = Object.keys(state.cart.packs || {}).length;
    $("#pickedCount").textContent = (itemCount + packCount) + " é …å·²é¸";
  }

  window.deletePack = (key) => { delete state.cart.packs[key]; state.tiers[key]=0; renderAll(); };

  function renderTabs(){
    $("#tabs").innerHTML = CATEGORIES.map(c => `<button type="button" class="tab ${c.id===state.catId?'active':''}" onclick="state.catId='${c.id}';renderAll()">${c.name}</button>`).join("");
  }

  function renderAll(){ renderTierButtons(); renderTabs(); renderItems(); renderCart(); }

  // âœ… ä¿®æ­£ï¼šå‹¾é¸æ‰é¡¯ç¤ºé¡å¤–æ—¥æœŸ/ç¬¬äºŒå ´æ™‚é–“
  function bindToggles(){
    const ex = document.getElementById("fHasExtraDate");
    const exWrap = document.getElementById("extraDateWrap");
    const s2 = document.getElementById("fHasSession2");
    const s2Wrap = document.getElementById("session2Wrap");

    const apply = ()=>{
      if(exWrap) exWrap.style.display = ex?.checked ? "block" : "none";
      if(s2Wrap) s2Wrap.style.display = s2?.checked ? "block" : "none";
    };
    ex?.addEventListener("change", apply);
    s2?.addEventListener("change", apply);
    apply();
  }

  window.onload = () => { initTimePickers(); bindToggles(); renderAll(); };

  $("#mClose").onclick = () => $("#modalMask").style.display="none";
</script>
</body>
</html>
