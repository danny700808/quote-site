<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ´»å‹•ä¼åŠƒï½œç‡ˆå…‰éŸ³éŸ¿é…ç½®å€ï½œè¨­å‚™é¸é…èˆ‡å³æ™‚å ±åƒ¹</title>

<style>

#btnMail{display:none !important;}
:root{
--bg:#f7fbf9;               /* æ·¡è–„è·ç™½ï¼ˆæ•´é«”åº•è‰²ï¼‰ */
--card:#ffffff;             /* å¡ç‰‡ç™½ */
--text:#1f2937;             /* æ·±ç°å­— */
--muted:#6b7280;            /* æ¬¡è¦å­— */
--line:#e6efe9;             /* è–„è·é‚Šç·š */
--brand:#63bfae;            /* ä¸»ç¶ ï¼ˆç²‰å«©è–„è·ï¼‰ */
--brand2:#2f8f7b;           /* æ·±ç¶ ï¼ˆhover/é‡é»ï¼‰ */
--blush:#f4b7c4;            /* ç²‰å«©é»ç¶´ */
--mintSoft:#eaf7f3;         /* æ·¡è–„è·åº• */
--blushSoft:#fff1f4;        /* æ·¡ç²‰åº• */
--danger:#e25a6a;           /* è­¦ç¤ºç´…ï¼ˆåç²‰å«©ï¼‰ */
--shadow:0 10px 28px rgba(0,0,0,.08);
--radius:16px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
.wrap{max-width:1100px;margin:0 auto;padding:18px}
header{position:sticky;top:0;z-index:10;background:rgba(247,251,249,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
.head{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center;padding:14px 18px}
.title{grid-column:2;display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center}
.title h1{margin:0;font-size:18px}
.title small{color:var(--muted);display:none!important;}
.actions{grid-column:3;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

/* ===== å››æ­¥é©Ÿå°è¦½ï¼ˆé€£è²«é€²åº¦æ¢æ¨£å¼ï¼‰ ===== */
.stepsWrap { width: 100%; margin-top: 4px; }
.steps { display: flex; justify-content: space-between; position: relative; padding: 0; margin: 0; }
.steps::before { content: ""; position: absolute; top: 15px; left: 10%; right: 10%; height: 2px; background: var(--line); z-index: 0; }
.stepBox { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; background: transparent !important; border: none !important; box-shadow: none !important; padding: 0; flex: 1; white-space: normal; }
.stepNum { width: 32px; height: 32px; background: var(--card); border: 2px solid var(--brand); color: var(--brand2); font-weight: 900; border-radius: 999px; display: grid; place-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.06); flex: 0 0 auto; }
.stepText { font-size: 13px; font-weight: 800; color: var(--text); text-align: center; line-height: 1.25; word-break: keep-all; }
.stepArrow { display: none !important; }

.btn{border:1px solid var(--line);background:var(--card);padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px}
.btn.primary{background:var(--brand);border-color:transparent;color:#fff}
.btn.primary:hover{background:var(--brand2)}
.btn.danger{background:var(--danger);border-color:transparent;color:#fff}
.grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:14px;align-items:start}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
.card .hd h2{margin:0;font-size:16px}

/* å››æ­¥é©Ÿå€å¡Šæ¨™é¡Œ */
.stepHd{position:relative;border-bottom:1px solid var(--line)}
.stepHd::before{content:"";position:absolute;left:0;top:0;bottom:0;width:10px;border-radius:0 10px 10px 0;background:color-mix(in srgb, var(--line) 35%, transparent);}
.stepHd h2{display:flex;align-items:center;gap:10px}
.stepHd h2::before{content:"";width:10px;height:10px;border-radius:999px;flex:0 0 auto;background:color-mix(in srgb, var(--line) 35%, transparent);}

.step1{background:linear-gradient(90deg, color-mix(in srgb, var(--brand) 18%, #fff), #fff)}
.step1::before{background:color-mix(in srgb, var(--brand2) 55%, var(--brand))}
.step1 h2::before{background:var(--brand2)}

.step2{background:linear-gradient(90deg, color-mix(in srgb, var(--blush) 18%, #fff), #fff)}
.step2::before{background:color-mix(in srgb, var(--blush) 70%, #fff)}
.step2 h2::before{background:var(--danger)}

.step3{background:linear-gradient(90deg, #eff6ff, #fff)}
.step3::before{background:#60a5fa}
.step3 h2::before{background:#2563eb}

.step4{background:linear-gradient(90deg, #fffbeb, #fff)}
.step4::before{background:#f59e0b}
.step4 h2::before{background:#f59e0b}

.pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff;white-space:nowrap}
.pillStatus{display:none!important}

.form{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{display:flex;flex-direction:column;gap:6px}
.field label{font-size:12px;color:var(--muted);font-weight:900}
.field input,.field select,.field textarea{border:1px solid var(--line);border-radius:12px;padding:11px 12px;background:#fff;outline:none;font-size:14px}
.field textarea{min-height:84px;resize:vertical}
.span2{grid-column:1/-1}

.timeRow{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
.timeRow .sep{color:var(--muted);font-weight:900;text-align:center}

.dateRow{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:end}
.dateRow .sep{color:var(--muted);font-weight:900;text-align:center; transform: translateY(-14px); margin: 0 4px;}
.dateCol{display:grid;gap:6px;min-width:0}
.dateCap{font-size:11px;color:var(--muted);font-weight:900}
.dateRow input{width:100%;min-width:0}

.tabs{padding:12px 14px 14px;display:flex;gap:10px;flex-wrap:wrap;border-top:1px solid var(--line)}
.tab{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000;font-size:14px}
.tab.active{background:rgba(30,142,111,.12);border-color:rgba(30,142,111,.35);color:var(--brand2)}

.items{padding:14px;display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
.item{border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;grid-template-columns:74px 1fr auto;gap:12px;align-items:center}
.thumb{width:74px;height:74px;border-radius:14px;object-fit:cover;border:1px solid var(--line);background:#f3f4f6}
.meta{min-width:0}
.meta .name{font-weight:1000}
.meta .sub{color:var(--muted);font-size:12px;margin-top:2px}
.meta .row2{margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.price{font-weight:1000;text-align:right}

.qty{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 8px;background:#fff}
.qbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000}
.qval{min-width:44px;text-align:center;font-weight:1000}
.linkbtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:1000;font-size:12px}

.summary{padding:14px;display:grid;gap:12px}
.totals{border:1px dashed var(--line);border-radius:14px;padding:12px;display:grid;gap:8px;background:linear-gradient(180deg, rgba(30,142,111,.06), transparent)}
.trow{display:flex;justify-content:space-between;align-items:center;gap:10px}

.cart{display:grid;gap:12px}
.group{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
.group .gh{padding:10px 12px;background:#fafafa;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;font-weight:1000}
.group .gb{padding:12px;display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
.citem{position:relative;border:1px solid var(--line);border-radius:14px;padding:10px;background:#fff;display:block; padding-right:52px;}
.citem img{display:none!important}
.cmeta .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
.cmeta .nm{font-weight:1000;line-height:1.2}
.cmeta .unit{display:none!important}
.cline{margin-top:6px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}

.qtyRow{display:flex;align-items:center;gap:10px}
.xbtn{position:absolute; top:50%; transform:translateY(-50%); right:10px; width:36px;height:36px;border-radius:12px;border:1px solid rgba(226,74,74,.35);background:rgba(226,74,74,.10);color:var(--danger);font-weight:1000;cursor:pointer}
.subttl{color:var(--muted);font-size:12px}
.subttl b{color:var(--text)}
.note{color:var(--muted);font-size:12px;line-height:1.5}
.note-inline{color:var(--muted);font-size:12px;font-weight:800;margin-left:6px}

/* Three-layer selector */
.tierWrap{padding:14px;display:grid;gap:12px}
.tierGrid{display:grid;grid-template-columns:1fr;gap:12px}
.tierCard{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
.tierHead{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
.tierHead b{font-size:14px}
.tierBody{padding:12px;display:grid;gap:10px}
.levelRow{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px}

.levelBtn{
padding:12px;
border-radius:14px;
border:1px solid var(--line);
background:#fff;
cursor:pointer;
font-weight:1000;
text-align:left;
display:flex;
flex-direction:column; 
gap:10px;
user-select:none;
align-items:stretch;
justify-content:flex-start;
}

.levelText{min-width:0;display:flex;flex-direction:column;gap:6px}
.levelTopRow{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
.levelName{font-size:13px;line-height:1.25;word-break:break-word}
.levelPrice{font-size:12px;font-weight:1000;white-space:nowrap}
.levelActions{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.miniBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:7px 10px;cursor:pointer;font-weight:1000;font-size:12px}
.miniBtn:hover{border-color:rgba(30,142,111,.35)}
.miniBtn.primaryMini{background:var(--brand);border-color:transparent;color:#fff}
.miniBtn.primaryMini:hover{background:var(--brand2)}

.levelMedia{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#f3f4f6}
.levelMedia img{width:100%;height:120px;object-fit:cover;display:block}

.tierActions{display:none}
.hint{font-size:12px;color:var(--muted);line-height:1.55}
.hint b{color:var(--text)}
.tierStatus{display:flex;gap:8px;flex-wrap:wrap}

.modalMask{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
.modal{width:min(560px,100%);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 18px 48px rgba(0,0,0,.22);overflow:hidden}
.modal .mh{padding:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;border-bottom:1px solid var(--line)}
.modal .mb{padding:14px 14px 20px;}
.modal .mb p{margin:0;color:#374151;line-height:1.65}

.photoGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.packMeta{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 6px}
.packMeta .tag{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff}
.packList{margin:8px 0 0;padding-left:18px;line-height:1.65}
.packList li{margin:4px 0}
.modalDesc{margin-top:8px;color:var(--muted);line-height:1.7}
.photoBox{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;background:#fff}
.photoBox img{width:100%;height:140px;object-fit:cover;display:block}
.photoCap{padding:8px 10px;font-size:12px;color:#6b7280}

#quoteCard .quoteHdrRight{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
#quoteCard .quoteActions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
#quoteCard .quoteActions .btn{padding:8px 10px;font-size:13px;border-radius:999px}
#jsStatus{display:inline-flex}

#cart .qty{display:none!important}
#cart .cline .subttl{display:none!important}
#cart .price{padding-right:8px}

#quoteCard .sendBar{margin-top:12px;display:flex;justify-content:flex-end}
#quoteCard .btn.send{background:#0ea5e9;border-color:#0284c7;color:#fff;font-weight:800}
#quoteCard .btn.send:hover{filter:brightness(.97)}
@media (max-width:700px){#quoteCard .sendBar{justify-content:stretch} #quoteCard .btn.send{width:100%}}

.btn.warn{background:#facc15;border-color:#f59e0b;color:#111827;font-weight:800;}
.btn.warn:hover{filter:brightness(.97)}
#printRoot{display:none}
body.printing #printRoot{display:block}
@media print{
body.printing *{visibility:hidden !important}
body.printing #printRoot, body.printing #printRoot *{visibility:visible !important}
body.printing #printRoot{position:absolute; inset:0; padding:16mm 12mm; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif; color:#111827;}
.printHdr{margin-bottom:10mm}
.printBrand{font-size:18px;font-weight:900;margin:0}
.printTitle{font-size:15px;font-weight:800;margin:6px 0 0 0}
.printMeta{font-size:11px;color:#6b7280;margin-top:6px}
.printH3{font-size:13px;font-weight:900;margin:10mm 0 4mm 0}
.printTbl{width:100%;border-collapse:collapse;font-size:11px}
.printTbl th,.printTbl td{border:1px solid #e5e7eb;padding:6px 7px;vertical-align:top}
.printTbl th{background:#f9fafb;text-align:left}
.printTbl tr.cat td{background:#f3f4f6;font-weight:900;color:#111827}
.right{text-align:right}
.muted{color:#6b7280}
.totalsBox{margin-top:8mm;display:flex;justify-content:flex-end}
.totals{min-width:260px;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px}
.trow{display:flex;justify-content:space-between;gap:12px;margin:6px 0}
.trow b{white-space:nowrap}
.trow.total{border-top:1px solid #e5e7eb;padding-top:8px;margin-top:8px;font-size:12px;font-weight:900}
@page{size:auto;margin:10mm}
}

#tierPills{display:none!important;}
#pickedCount{display:none!important;}
#cartBadge{display:none!important;}
#jsStatus{display:none!important;}
#btnCopy{display:none!important;}
#catName{display:none!important;}

.mini{font-size:12px;color:var(--muted)}
.optbox{margin-top:10px;padding:10px 12px;border:1px dashed var(--line);border-radius:12px;background:#fbfdfc}
.optrow{display:flex;gap:10px;align-items:center;margin:6px 0}
.optlabel{min-width:92px;font-size:13px;color:var(--muted)}
.optselect{flex:1;padding:9px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:14px}

/* å¹³æ¿éŸ¿æ‡‰å¼ */
@media (max-width:920px){
.levelRow{grid-template-columns:repeat(2, 1fr)}
.grid{grid-template-columns:1fr}
.tierGrid{grid-template-columns:1fr}
}

/* ===== æ‰‹æ©Ÿç‰ˆç·Šæ¹Šèˆ‡ä¸¦æ’å„ªåŒ– (Max-width: 620px) ===== */
@media (max-width: 620px) {
/* å››æ­¥é©Ÿé€²åº¦æ¢å¾®èª¿ */
.steps::before { top: 13px; left: 8%; right: 8%; }
.stepNum { width: 28px; height: 28px; font-size: 12px; border-width: 1.5px; }
.stepText { font-size: 11px; transform: scale(0.95); }
.stepBox { gap: 4px; }

/* æ•´é«”èˆ‡å¡ç‰‡å…§è· */
.wrap { padding: 8px; }
.grid { gap: 10px; margin-top: 10px; }
.card .hd { padding: 10px 10px 8px; }
.form, .items, .tierWrap, .summary, .tierBody { padding: 10px; gap: 8px; }

/* è¡¨å–®è¼¸å…¥æ¡†èˆ‡æ—¥æœŸä¿®å¾© */
.field input, .field select, .field textarea { padding: 8px 10px; font-size: 13px; }
.field textarea { min-height: 60px; }
.field { gap: 4px; }
.dateRow { gap: 4px; } 
.dateRow input[type="date"] { padding: 8px 4px; font-size: 13px; letter-spacing: -0.5px; }
.dateRow .sep { transform: translateY(-10px); }
.timeRow { grid-template-columns: 1fr auto 1fr; }
.optrow{flex-direction:column;align-items:stretch;gap:6px}
.optlabel{min-width:0}

/* ğŸŒŸ 1. ç­‰ç´šé¸é…å¡ç‰‡ï¼šä¸¦æ’é¡¯ç¤º (2æ¬„) ğŸŒŸ */
.levelRow { grid-template-columns: repeat(2, 1fr); gap: 6px; }
.levelBtn { padding: 6px; gap: 6px; }
.levelTopRow { flex-direction: column; align-items: flex-start; gap: 2px; }
.levelPrice { font-size: 12px; }
.levelMedia img { height: 65px; } /* åœ–ç‰‡å¤§å¹…ç¸®å° */
.levelActions { gap: 4px; width: 100%; }
.miniBtn { padding: 6px 8px; font-size: 11px; width: 100%; text-align: center; margin: 0; } /* æŒ‰éˆ•å‚ç›´æ»¿ç‰ˆç–Šæ”¾ */

/* ğŸŒŸ 2. è¨­å‚™èˆ‡æœå‹™æ¸…å–®ï¼šä¸¦æ’é¡¯ç¤º (2æ¬„ç›´å¼å¡ç‰‡) ğŸŒŸ */
.items { grid-template-columns: repeat(2, 1fr); gap: 6px; padding: 6px; }
.item { 
display: flex; flex-direction: column; align-items: stretch;
padding: 8px; gap: 8px; 
}
.thumb { width: 100%; height: 90px; border-radius: 8px; }
.meta { display: flex; flex-direction: column; flex: 1; gap: 4px; }
.meta .name { font-size: 13px; line-height: 1.3; }
.meta .sub { font-size: 11px; }
.meta .row2 { margin-top: auto; flex-direction: column; align-items: stretch; gap: 6px; }
.qty { justify-content: space-between; padding: 4px 6px; }
.qbtn { width: 26px; height: 26px; }
.linkbtn { width: 100%; text-align: center; padding: 6px; }
.price { text-align: left; font-size: 14px; margin-top: 4px; border-top: 1px dashed var(--line); padding-top: 6px; }

/* å³å´è³¼ç‰©è»Šèˆ‡é ç±¤ */
.group .gh { padding: 8px 10px; font-size: 13px; }
.group .gb { padding: 8px; gap: 6px; grid-template-columns: 1fr; }
.citem { padding: 8px; padding-right: 40px; } 
.citem .nm { font-size: 13px; }
#cart .xbtn { width: 28px; height: 28px; right: 6px; font-size: 12px; }
.tabs { padding: 8px 10px 10px; gap: 6px; }
.tab { padding: 6px 10px; font-size: 13px; }
.photoGrid { grid-template-columns: 1fr; }
.photoBox img { height: 170px; }
}
/* ===== ä¿®æ­£åŸºæœ¬è³‡æ–™å€å¡Šï¼šé˜²æ“ å£“èˆ‡å­—é«”ç¸®æ”¾å„ªåŒ– ===== */
@media (max-width: 620px) {
/* 1. è¡¨å–®å¼·åˆ¶æ”¹ç‚ºå–®æ¬„ä¸Šä¸‹æ’åˆ—ï¼Œä¸è¦å·¦å³ä¸¦æ’æ“ å£“ */
.form { grid-template-columns: 1fr !important; }

/* 2. é¿å… iOS è‡ªå‹•ç¸®æ”¾å°è‡´å­—é«”å¿½å¤§å¿½å°ï¼Œè¼¸å…¥æ¡†å¼·åˆ¶è¨­å›å®‰å…¨å¤§å° 16px */
.field input, .field select, .field textarea { 
font-size: 16px !important; 
padding: 10px 12px !important; 
}

/* 3. è®“ä¸‹æ‹‰é¸å–®çš„æ–‡å­—ä¹Ÿä¿æŒä¸€è‡´ */
.field label { font-size: 13px !important; }
}
</style>
</head>

<body>
<header>
<div class="head">
<div class="title">
<h1>æ´»å‹•ä¼åŠƒï½œè¨­å‚™é¸é…èˆ‡å³æ™‚å ±åƒ¹</h1>

<div class="stepsWrap" aria-label="å ±åƒ¹æµç¨‹å››æ­¥é©Ÿ">
<div class="steps">
<div class="stepBox"><span class="stepNum">1</span><span class="stepText">å¡«å¯«åŸºæœ¬è³‡æ–™</span></div>
<span class="stepArrow" aria-hidden="true"></span>
<div class="stepBox"><span class="stepNum">2</span><span class="stepText">é¸å–ç‡ˆå…‰éŸ³éŸ¿é…ç½®</span></div>
<span class="stepArrow" aria-hidden="true"></span>
<div class="stepBox"><span class="stepNum">3</span><span class="stepText">é¸å–è¨­å‚™æœå‹™åŠ è³¼</span></div>
<span class="stepArrow" aria-hidden="true"></span>
<div class="stepBox"><span class="stepNum">4</span><span class="stepText">é€å‡ºå ±åƒ¹å–®</span></div>
</div>
</div>

</div>
</div>
</header>

<div class="wrap">
<noscript><div style="margin:12px 0;padding:12px;border:1px solid #f59e0b;background:#fffbeb;border-radius:12px;font-weight:900;color:#92400e">âš ï¸ ä½ çš„ç€è¦½å™¨ç›®å‰åœç”¨äº† JavaScriptï¼Œå› æ­¤ã€Œå®‰å…¨/æ°£æ°›/å‡ç´šç­‰ç´šã€èˆ‡ã€Œè¨­å‚™åˆ†é¡ã€ä¸æœƒé¡¯ç¤ºã€‚è«‹æ”¹ç”¨å¯åŸ·è¡Œ JS çš„ç€è¦½å™¨ã€‚</div></noscript>

<div class="grid">

<section class="card">
<div class="hd stepHd step1">
<h2>1) åŸºæœ¬è³‡æ–™</h2>
<span class="pill" id="pickedCount">0 é …å·²é¸</span>
</div>

<div class="form">
<div class="field">
<label>å§“å / å–®ä½</label>
<input id="fName" placeholder="ä¾‹ï¼šæŸšå­æ¨‚å™¨ / ç‹å°æ˜">
</div>

<div class="field">
<label>è¡Œå‹•é›»è©±</label>
<input id="fPhone" type="tel" inputmode="tel" placeholder="ä¾‹ï¼š09xx-xxx-xxx">
</div>

<div class="field">
<label>Email</label>
<input id="fEmail" type="email" placeholder="ä¾‹ï¼šyou@example.com">
</div>

<div class="field span2">
<label>æ´»å‹•åœ°é»ï¼ˆç¸£å¸‚/å€ï¼‰</label>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
<select id="fCity"></select>
<select id="fArea"></select>
</div>
</div>

<div class="field span2">
<label>è©³ç´°åœ°å€ï¼ˆè·¯å/è™Ÿï¼‰</label>
<input id="fAddr" placeholder="ä¾‹ï¼šä¸­å±±è·¯ 100 è™Ÿ">
</div>

<div class="field span2">
<label>å¤§æ¨“/æ£Ÿåˆ¥/æ¨“å±¤/å…¥å£ï¼ˆè®“åœ°å€æ›´æ¸…æ¥šï¼‰</label>
<input id="fBldg" placeholder="ä¾‹ï¼šXXå¤§æ¨“ Aæ£Ÿ 3Fï¼ˆå¾å´é–€é€²ï¼‰">
</div>

<div class="field">
<label>æ´»å‹•é¡å‹</label>
<select id="fEventType">
<option value="">è«‹é¸æ“‡æ´»å‹•é¡å‹</option>
<option>é–‹å¹•å…¸ç¦®ï¼å‰ªç¶µå„€å¼</option>
<option>è¨˜è€…æœƒï¼ç”¢å“ç™¼è¡¨æœƒ</option>
<option>å“ç‰Œæ´»å‹•ï¼å¿«é–ƒæ´»å‹•ï¼ˆå•†å ´/æˆ¶å¤–ï¼‰</option>
<option>å±•è¦½é–‹å¹•ï¼å±•å ´æ´»å‹•ï¼ˆå«èˆå°æ™‚æ®µï¼‰</option>
<option>æ ¡æ…¶æ´»å‹•ï¼ˆé‹å‹•æœƒ/åœ’éŠæœƒ/èˆå°ï¼‰</option>
<option>ç•¢æ¥­å…¸ç¦®</option>
<option>æˆæœç™¼è¡¨æœƒï¼ˆå­¸æ ¡/æ‰è—/ç¤¾åœ˜ï¼‰</option>
<option>ç¤¾åœ˜æˆç™¼ï¼è¿æ–°é€èˆŠæ™šæœƒ</option>
<option>æ¼”è¬›ï¼è¬›åº§ï¼è«–å£‡</option>
<option>ç ”è¨æœƒï¼å­¸è¡“æœƒè­°ï¼ˆå«åˆ†å ´ï¼‰</option>
<option>å…¬å¸å…§è¨“ï¼æ•™è‚²è¨“ç·´ï¼å¤§æœƒ</option>
<option>å°¾ç‰™ï¼æ˜¥é…’</option>
<option>å…¬å¸å®¶åº­æ—¥ï¼åœ’éŠæœƒ</option>
<option>é¤æœƒï¼æ™šå®´ï¼ˆå«æŠ½çã€è‡´è©ã€è¡¨æ¼”ï¼‰</option>
<option>å•†å‹™äº¤æµæœƒï¼åŒæ¥­å…¬æœƒæ´»å‹•</option>
<option>æ¼”å”±æœƒï¼Live Band è¡¨æ¼”</option>
<option>DJ æ´¾å°ï¼é›»éŸ³æ´»å‹•</option>
<option>èˆè¹ˆè¡¨æ¼”ï¼èˆè¹ˆæ¯”è³½</option>
<option>æˆ²åŠ‡ï¼èˆå°åŠ‡ï¼éŸ³æ¨‚åŠ‡</option>
<option>è¦ªå­æ´»å‹•ï¼å…’ç«¥èˆå°ç§€</option>
<option>æ…¶ç”Ÿæœƒï¼æ´¾å°ï¼ˆå«åŒ…å ´ï¼‰</option>
<option>å©šç¦®ï¼ˆè­‰å©š/å®´å®¢/After partyï¼‰</option>
<option>å‘Šåˆ¥å¼ï¼è¿½æ€æœƒï¼ˆæ®¯å„€é¤¨/æœƒé¤¨/æˆ¶å¤–è¿½æ€ï¼‰</option>
<option>å®—æ•™æ´»å‹•ï¼ˆå»Ÿæœƒ/æ³•æœƒ/ç¦®æ‹œ/æ…¶å…¸ï¼‰</option>
<option>ç¤¾å€æ´»å‹•ï¼é‡Œæ°‘å¤§æœƒï¼å®£å°æ´»å‹•ï¼ˆæˆ¶å¤–å»£æ’­ï¼‰</option>
</select>
</div>

<div class="field">
<label>é ä¼°äººæ•¸</label>
<select id="fCrowd">
<option value="">è«‹é¸æ“‡</option>
<option value="100">100äººä»¥å…§</option>
<option value="400">100åˆ°400äºº</option>
<option value="1000">400è‡³1000äºº</option>
<option value="2000">1000äººè‡³2000äºº</option>
<option value="9999">2000äººè‡³ä»¥ä¸Š</option>
</select>
</div>

<div class="field">
<label>å®¤å…§ / æˆ¶å¤–</label>
<select id="fIndoor">
<option value="">è«‹é¸æ“‡</option>
<option>å®¤å…§</option>
<option>æˆ¶å¤–</option>
<option>åŠæˆ¶å¤–</option>
</select>
</div>
        <div class="field span2">
          <label>æ´»å‹•æ—¥æœŸï¼ˆé–‹å§‹ ï½ çµæŸï¼‰</label>
          <div class="dateRow">
<div class="field span2">
          <label>æ´»å‹•æ—¥æœŸï¼ˆé–‹å§‹ã€çµæŸï¼‰</label>
          <div class="dateRow" style="grid-template-columns: 1fr 1fr;">
<div class="dateCol">
<div class="dateCap">é–‹å§‹</div>
<input id="fDateStart" type="date">
</div>
            <div class="sep">ï½</div>
<div class="dateCol">
<div class="dateCap">çµæŸ</div>
<input id="fDateEnd" type="date">
</div>
</div>
</div>

        <div class="field span2" style="margin-top: 4px;">
          <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted);cursor:pointer;">
            <input type="checkbox" id="fHasExtraDate" style="width:18px;height:18px">
            éœ€è¦æ–°å¢ä¸é€£çºŒçš„æ´»å‹•æ—¥æœŸ
          </label>
          <div id="extraDateWrap" style="display:none; padding:10px; border:1px dashed var(--line); border-radius:12px; background:#fbfdfc; margin-top:6px;">
            <div class="dateRow" style="grid-template-columns: 1fr 1fr;">
              <div class="dateCol">
                <div class="dateCap">é¡å¤–æ—¥æœŸï¼ˆé–‹å§‹ï¼‰</div>
                <input id="fExtraDateStart" type="date">
              </div>
              <div class="dateCol">
                <div class="dateCap">é¡å¤–æ—¥æœŸï¼ˆçµæŸï¼‰</div>
                <input id="fExtraDateEnd" type="date">
              </div>
            </div>
          </div>
        </div>
<div class="field span2">
<label>æ´»å‹•æ™‚é–“ï¼ˆåªæä¾› 00/10/20/30/40/50 åˆ†ï¼‰</label>
<div class="timeRow">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
<select id="tStartH"></select>
<select id="tStartM"></select>
</div>
<div class="sep">ï½</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
<select id="tEndH"></select>
<select id="tEndM"></select>
</div>
</div>
<input id="fTimeStart" type="hidden">
<input id="fTimeEnd" type="hidden">
</div>

<div class="field span2">
<label>åŒæ—¥ç¬¬äºŒå ´ï¼ˆé¸å¡«ï¼‰</label>
<div style="display:grid;gap:10px">
<label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted)">
<input type="checkbox" id="fHasSession2" style="width:18px;height:18px">
åŒä¸€å¤©æœ‰ç¬¬äºŒå ´ï¼ˆå‹¾é¸å¾Œå¯è¨­å®šç¬¬äºŒå ´æ™‚é–“ï¼›ç¬¬äºŒå ´åŠ åƒ¹ï¼šåŸå§‹ç¸½åƒ¹ x 30%ï¼‰
</label>

<div id="session2Wrap" style="display:none;border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff">
<div style="font-weight:1000;margin-bottom:8px">ç¬¬äºŒå ´æ™‚é–“</div>
<div class="timeRow">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
<select id="t2StartH"></select>
<select id="t2StartM"></select>
</div>
<div class="sep">ï½</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
<select id="t2EndH"></select>
<select id="t2EndM"></select>
</div>
</div>
<input id="fTime2Start" type="hidden">
<input id="fTime2End" type="hidden">
<div class="hint" style="margin-top:8px">æç¤ºï¼šç¬¬äºŒå ´åªç®—åŒä¸€å¤©å…§çš„åŠ åƒ¹ï¼Œä¸å½±éŸ¿è·¨å¤©åˆ¤å®šã€‚</div>
<div id="session2DaysWrap" style="margin-top:10px;display:none">
<div style="font-weight:1000;margin-bottom:8px">ï¼ˆè·¨å¤©æ™‚ï¼‰ç¬¬2å¤©èµ·çš„ç¬¬äºŒå ´æ—¥åˆ¥</div>
<div id="session2Days" style="display:grid;gap:8px"></div>
</div>
</div>
</div>
</div>

<div class="field span2">
<label>å‚™è¨» / éœ€æ±‚</label>
<textarea id="fNote" placeholder="ä¾‹ï¼šå®¤å…§å©šç¦®120äººï¼Œéœ€å››æ”¯ç„¡ç·šéº¥ï¼Œå ´åœ°æœ‰220Væ’åº§ï¼Œéœ€å«é€²é€€å ´..."></textarea>
</div>

</div>

<div class="hd stepHd step2" style="border-top:1px solid var(--line);border-bottom:none">
<h2>2) ç‡ˆå…‰éŸ³éŸ¿é…ç½®å€</h2>
<span class="pill" id="tierPills">å®‰å…¨â€”ï½œæ°£æ°›â€”ï½œå‡ç´šâ€”</span>
</div>

<div class="tierWrap">
<div class="tierGrid">

<div class="tierCard">
<div class="tierHead">
              <b>å®‰å…¨ç­‰ç´š</b>
              <b>å®‰å…¨ç­‰ç´š <span style="font-size:12px;color:var(--muted);font-weight:normal;">ï¼ˆä¸åŒ…å«ç‡ˆå…‰ï¼‰</span></b>
<span class="pill pillStatus" id="pillSafety">æœªé¸</span>
</div>
<div class="tierBody">
<div class="levelRow" id="levelsSafety"></div>
<div class="tierActions">
<button class="btn primary" id="applySafety">ä¸€éµå¥—ç”¨ï¼ˆå®‰å…¨ï¼‰</button>
</div>
<div class="hint">å»ºè­°ï¼šä¸€èˆ¬æ´»å‹•å¤šæ•¸é¸ <b>ç¬¬3ç´š</b>ï¼›æˆ¶å¤–å»ºè­°è‡³å°‘ <b>ç¬¬3ç´š</b>ã€‚</div>
</div>
</div>

<div class="tierCard">
<div class="tierHead">
              <b>æ°£æ°›ç­‰ç´š</b>
              <b>æ°£æ°›ç­‰ç´š <span style="font-size:12px;color:var(--muted);font-weight:normal;">ï¼ˆå«ç‡ˆå…‰+ç°¡æ˜“ç‰¹æ•ˆï¼‰</span></b>
<span class="pill pillStatus" id="pillAmbience">æœªé¸</span>
</div>
<div class="tierBody">
<div class="levelRow" id="levelsAmbience"></div>
<div class="tierActions">
<button class="btn primary" id="applyAmbience">ä¸€éµå¥—ç”¨ï¼ˆæ°£æ°›ï¼‰</button>
</div>
<div class="hint">æƒ³è¦ã€Œçœ‹èµ·ä¾†ä¸å¯’é…¸ã€ï¼šè‡³å°‘é¸åˆ° <b>ç¬¬2ç´š</b>ï¼›æœ‰è¡¨æ¼”æ„Ÿï¼šé¸åˆ° <b>ç¬¬4ç´š</b>ã€‚</div>
</div>
</div>

<div class="tierCard">
<div class="tierHead">
              <b>å‡ç´šç­‰ç´š</b>
              <b>å‡ç´šç­‰ç´š <span style="font-size:12px;color:var(--muted);font-weight:normal;">ï¼ˆå«é€²éšç‡ˆå…‰+é«˜ç´šç‰¹æ•ˆï¼‰</span></b>
<span class="pill pillStatus" id="pillUpgrade">æœªé¸</span>
</div>
<div class="tierBody">
<div class="levelRow" id="levelsUpgrade"></div>
<div class="tierActions">
<button class="btn primary" id="applyUpgrade">ä¸€éµå¥—ç”¨ï¼ˆå‡ç´šï¼‰</button>
</div>
<div class="hint">å‡ç´šæ˜¯é«˜æ»¿æ„åº¦ä¾†æºï¼šå…ˆçœ‹å…§å®¹èˆ‡åƒ¹æ ¼å†é¸ç­‰ç´šï¼Œä¹‹å¾Œå†å¾®èª¿ã€‚</div>
</div>
</div>

</div>

<div class="tierStatus">
<span class="pill">æç¤ºï¼šæ¯å€‹ 1â€“6 ç´šéƒ½å¯ä»¥æŒ‰ã€Œè©³æƒ…ã€å…ˆçœ‹åŒ…å«ä»€éº¼ã€‚</span>
<button class="btn" id="btnSuggest">ä¾äººæ•¸/å®¤å…§å¤–å»ºè­°ç­‰ç´š</button>
</div>
</div>

<div class="hd stepHd step3" style="border-top:1px solid var(--line);border-bottom:none">
<h2>3) è¨­å‚™/æœå‹™åˆ†é¡ï¼ˆè‡ªç”±åŠ æ¸›ï¼‰</h2>
<span class="pill" id="catName">â€”</span>
</div>

<div class="tabs" id="tabs"></div>
<div class="items" id="items"></div>
</section>

<aside class="card" id="quoteCard">
<div class="hd stepHd step4">
<h2>4) å³æ™‚å ±åƒ¹</h2>
<div class="quoteHdrRight">
<span class="pill" id="cartBadge">0 é …å·²é¸</span>
<div class="quoteActions">
<span class="pill" id="jsStatus">JS: loading</span>
<button class="btn" id="btnCopy">è¤‡è£½å ±åƒ¹å…§å®¹</button>
<button class="btn primary" id="btnMail" style="display:none">é€å‡ºå ±åƒ¹å–®</button>
<button class="btn warn" id="btnPrint" style="display:none">åˆ—å°æˆ PDF</button>
<button class="btn danger" id="btnClear">æ¸…ç©ºå…¨éƒ¨é …ç›®</button>
</div>
</div>
</div>

<div class="summary">
<div class="totals">
<div class="trow" id="grandTotalRow"><span class="subttl">ç›®å‰åˆè¨ˆ</span><b id="grandTotal">NT$0</b></div>
<div class="trow" id="daySurchargeRow" style="display:none"><span class="subttl">è·¨å¤©åŠ åƒ¹</span><b id="daySurcharge">NT$0</b></div>
<div class="trow" id="session2SurchargeRow" style="display:none"><span class="subttl">åŒæ—¥ç¬¬äºŒå ´åŠ åƒ¹</span><b id="session2Surcharge">NT$0</b></div>
<div class="trow"><span class="subttl">ç¸½è¨ˆ</span><b id="finalTotal">NT$0</b></div>
</div>

<div class="cart" id="cart"></div>

<div class="sendBar">
<button class="btn send" id="btnSendQuote">é€å‡ºå ±åƒ¹å–®</button>
</div>
</div>
</aside>

</div>
</div>

<div class="modalMask" id="modalMask">
<div class="modal">
<div class="mh">
<b id="mTitle">è©³æƒ…</b>
<button class="xbtn" id="mClose" title="é—œé–‰">âœ•</button>
</div>
<div class="mb"><p id="mBody">â€”</p></div>
</div>
</div>

<script>
const BRAND_NAME = "æŸšå­æ¨‚å™¨";
const PRINT_TITLE = "æ´»å‹•ä¼åŠƒï½œè¨­å‚™èˆ‡å™¨æå ±åƒ¹å–®";

window.addEventListener('error', function(e){
try{
const el = document.querySelector('#jsStatus');
if(el) el.textContent = 'JS: error';
}catch(_){ }
});

function svgThumb(label){
const safe = (label||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200">
 <defs>
   <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
     <stop offset="0" stop-color="#e8f5f0"/>
     <stop offset="1" stop-color="#f6f7fb"/>
   </linearGradient>
 </defs>
 <rect width="200" height="200" rx="22" fill="url(#g)"/>
 <circle cx="160" cy="40" r="26" fill="#1e8e6f" opacity="0.18"/>
 <circle cx="40" cy="160" r="36" fill="#156e56" opacity="0.12"/>
 <text x="18" y="102" font-size="16" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial" fill="#156e56" font-weight="700">${safe}</text>
</svg>`;
return "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(svg);
}

const CATEGORIES = [
{ id:"stage", name:"èˆå°çµæ§‹èˆ‡æ¡æ¶ç³»çµ±", items:[
{ id:"stage-deck", name:"èˆå°æ¿ï¼ˆ2x1mï¼‰", unit:"ç‰‡", price:1200,
priceTiers:[{min:1,price:1200},{min:20,price:1100},{min:50,price:1000}],
options:{
carpet:{label:"æ˜¯å¦è¦é‹ªåœ°æ¯¯", values:["è«‹é¸æ“‡","è¦","ä¸è¦"], omitValues:["ä¸è¦"]},
carpet_color:{label:"åœ°æ¯¯é¡è‰²", values:["è«‹é¸æ“‡","é»‘","ç°","ç´…","è—","ç¶ ","ç±³ç™½"], when:{opt:"carpet", is:"è¦"}},
color:{label:"èˆå°æ¿é¡è‰²", values:["è«‹é¸æ“‡","é»‘","ç°","ç´…","è—"]},
height:{label:"èˆå°é«˜åº¦", values:["è«‹é¸æ“‡","20cm","40cm","60cm","80cm","100cm"]}
},
img:svgThumb("èˆå°æ¿"),
desc:"èˆå°æ¿ï¼ˆ2x1mï¼‰ã€‚å¯ä¾å°ºå¯¸ã€éšæ¢¯ã€åœè£™ç­‰èª¿æ•´ã€‚\n\næ•¸é‡å„ªæƒ ï¼ˆå¯ä¿®æ”¹ï¼‰ï¼š1â€“19ç‰‡ 1200/ç‰‡ï¼›20â€“49ç‰‡ 1100/ç‰‡ï¼›50ç‰‡ä»¥ä¸Š 1000/ç‰‡ã€‚\nå¯é¸ç´°é …ï¼šé¡è‰²/é«˜åº¦ï¼ˆæœƒåœ¨å³å´å ±åƒ¹å–®é¡¯ç¤ºï¼‰ã€‚"
},
{ id:"stage-step", name:"èˆå°éšæ¢¯ï¼ˆå«æ‰¶æ‰‹ï¼‰", unit:"åº§", price:900, img:svgThumb("éšæ¢¯"), desc:"èˆå°ä¸Šä¸‹å°éšæ¢¯ï¼Œé©åˆå…¸ç¦®/è¡¨æ¼”ã€‚" },
{ id:"stage-truss", name:"TRUSS æ¡æ¶ï¼ˆ3mï¼‰", unit:"æ”¯", price:1800, img:svgThumb("TRUSS"), desc:"åŸºæœ¬æ¡æ¶çµæ§‹ï¼Œç”¨æ–¼ç‡ˆå…·/èƒŒæ¿/å¸ƒå¹•ã€‚" },
{ id:"stage-backdrop", name:"ä¸»è¦–è¦ºèƒŒæ¿ï¼ˆåŸºæœ¬ï¼‰", unit:"çµ„", price:6500, img:svgThumb("èƒŒæ¿"), desc:"åŸºæœ¬èƒŒæ¿ï¼ˆå«æ¶è¨­ï¼‰ã€‚ä¸»è¦–è¦ºè¼¸å‡ºå¦è¨ˆæˆ–å¯åŒ…å¥—ã€‚" },
{ id:"stage-drape", name:"èˆå°å¸ƒå¹•/é®æ“‹ï¼ˆåŸºæœ¬ï¼‰", unit:"çµ„", price:4800, img:svgThumb("å¸ƒå¹•"), desc:"èˆå°å´å¸ƒ/å¾Œå¸ƒ/é®æ“‹ï¼Œæå‡æ•´é«”è³ªæ„Ÿã€‚" },
]},
{ id:"light", name:"ç‡ˆå…‰èˆ‡æ°£æ°›æ•ˆæœ", items:[
{ id:"light-par", name:"LED PARï¼ˆæŸ“è‰²ç‡ˆï¼‰", unit:"ç›", price:900, img:svgThumb("æŸ“è‰²ç‡ˆ"), desc:"å…¸ç¦®/æ°›åœåº•è‰²å¿…å‚™ã€‚å¯æ­é…ç‡ˆæ§/å ´æ™¯è®Šæ›ã€‚" },
{ id:"light-moving", name:"Moving Headï¼ˆå…‰æŸç‡ˆï¼‰", unit:"ç›", price:2500, img:svgThumb("å…‰æŸç‡ˆ"), desc:"å‹•æ…‹å…‰æŸæ•ˆæœï¼Œé©åˆè¡¨æ¼”/é«˜æ½®æ®µè½ã€‚" },
{ id:"light-follow", name:"è¿½å…‰ç‡ˆï¼ˆå«æ“ä½œï¼‰", unit:"çµ„", price:6000, img:svgThumb("è¿½å…‰"), desc:"è¿½å…‰ç‡ˆå«æ“ä½œäººå“¡ï¼Œé©åˆèµ°ä½/å¾—ç/è¡¨æ¼”ä¸»è§’ã€‚" },
{ id:"light-console", name:"ç‡ˆæ§å°ï¼ˆåŸºæœ¬ï¼‰", unit:"å¥—", price:3500, img:svgThumb("ç‡ˆæ§"), desc:"ç‡ˆå…‰å ´æ™¯åˆ‡æ›/ç¯€å¥æ§åˆ¶ã€‚æ¼”å‡ºæ„Ÿæå‡ã€‚" },
{ id:"fx-haze", name:"è–„éœ§æ©Ÿï¼ˆHazerï¼‰", unit:"å°", price:2200, img:svgThumb("è–„éœ§"), desc:"è®“å…‰æŸæ›´ç«‹é«”ã€‚å°å¿ƒå ´åœ°æ–¹è¦å®š/æ¶ˆé˜²ã€‚" },
]},
{ id:"audio", name:"éŸ³éŸ¿èˆ‡èˆå°æ”¶éŸ³", items:[
{ id:"audio-main", name:"ä¸»å–‡å­ï¼ˆå…¨é »ï¼‰", unit:"çµ„", price:6000, img:svgThumb("ä¸»å–‡å­"), desc:"ä¸»æ“´è²ç³»çµ±ï¼ˆç¤ºæ„ï¼‰ã€‚å¯ä¾å“ç‰Œ/åŠŸç‡/å ´åŸŸèª¿æ•´ã€‚" },
{ id:"audio-sub", name:"ä½éŸ³å–‡å­ï¼ˆSubï¼‰", unit:"é¡†", price:4500, img:svgThumb("Sub"), desc:"å¢åŠ ä½é »èƒ½é‡ï¼Œé©åˆæˆ¶å¤–/éŸ³æ¨‚æ´»å‹•ã€‚" },
{ id:"audio-mixer", name:"æ··éŸ³å™¨ï¼ˆåŸºæœ¬ï¼‰", unit:"å°", price:3000, img:svgThumb("æ··éŸ³"), desc:"åŸºæœ¬æ··éŸ³æ§åˆ¶ã€‚å¤šè·¯æ•¸éœ€æ±‚å¯å‡ç´šã€‚" },
{ id:"audio-wireless2", name:"ç„¡ç·šéº¥å…‹é¢¨ï¼ˆ2æ”¯çµ„ï¼‰", unit:"çµ„", price:2200, img:svgThumb("ç„¡ç·šéº¥"), desc:"å¸¸è¦‹å…¸ç¦®/è¬›åº§ç”¨ã€‚å¯åŠ åˆ° 4/6/8 æ”¯ã€‚" },
{ id:"audio-monitor", name:"èˆå°ç›£è½å–‡å­", unit:"é¡†", price:1800, img:svgThumb("ç›£è½"), desc:"çµ¦ä¸»æŒ/è¡¨æ¼”è€…è½åˆ°è‡ªå·±çš„è²éŸ³ã€‚" },
{ id:"audio-di", name:"DI Boxï¼ˆä¸»å‹•å¼ï¼‰", unit:"é¡†", price:400, img:svgThumb("DI"), desc:"éµç›¤/æœ¨å‰ä»–/é›»è²æ–¯ç­‰è¨Šè™Ÿè½‰æ›ã€‚" },
{ id:"audio-drumkit", name:"é¼“çµ„æ”¶éŸ³å¥—è£ï¼ˆåŸºæœ¬ï¼‰", unit:"çµ„", price:6500, img:svgThumb("é¼“çµ„"), desc:"é©åˆ Live Band / è¡¨æ¼”ã€‚ç´°é …å¯æ‹†åˆ†ã€‚" },
]},
{ id:"video", name:"å½±åƒã€æŠ•å½±èˆ‡ç›´æ’­å°æ’­", items:[
{ id:"video-projector", name:"æŠ•å½±æ©Ÿï¼ˆåŸºæœ¬ï¼‰", unit:"å°", price:6500, img:svgThumb("æŠ•å½±"), desc:"æœƒè­°/å…¸ç¦®ç°¡å ±ã€‚äº®åº¦/é¡é ­ä¾å ´åœ°èª¿æ•´ã€‚" },
{ id:"video-screen", name:"æŠ•å½±å¸ƒå¹•ï¼ˆ120å‹ï¼‰", unit:"é¢", price:1800, img:svgThumb("å¸ƒå¹•"), desc:"æŠ•å½±å¸ƒå¹•ï¼ˆç¤ºæ„ï¼‰ã€‚ä¹Ÿå¯ç”¨é›»å‹•å¸ƒå¹•ã€‚" },
{ id:"video-tv", name:"é›»è¦–ï¼ˆ75å‹ï¼‰", unit:"å°", price:4800, img:svgThumb("75å‹TV"), desc:"å±•å ´/å°å‹å ´åœ°æ›´æ–¹ä¾¿ã€‚" },
{ id:"video-camera", name:"æ´»å‹•æ”å½±æ©Ÿï¼ˆåŸºæœ¬ï¼‰", unit:"å°", price:5000, img:svgThumb("æ”å½±"), desc:"æ´»å‹•éŒ„å½±/ç›´æ’­æ©Ÿä½ï¼ˆç¤ºæ„ï¼‰ã€‚" },
{ id:"video-switcher", name:"ç›´æ’­å°æ’­/åˆ‡æ›å°ï¼ˆåŸºæœ¬ï¼‰", unit:"å¥—", price:9000, img:svgThumb("å°æ’­"), desc:"å¤šæ©Ÿä½åˆ‡æ›/å­—å¹•/ç•«é¢è¼¸å‡ºï¼ˆç¤ºæ„ï¼‰ã€‚" },
]},
{ id:"site", name:"å¸³ç¯·æ¡Œå­æ¤…å­", items:[
{ id:"site-tent", name:"å¿«å¸³ï¼ˆ3x3mï¼‰", unit:"é ‚", price:1800, img:svgThumb("å¿«å¸³"), desc:"æˆ¶å¤–é®é™½é®é›¨ã€‚å¯åŠ é…é‡/å´å¸ƒã€‚" },
{ id:"site-chair", name:"æŠ˜ç–Šæ¤…", unit:"å¼µ", price:30, img:svgThumb("æ¤…å­"), desc:"è§€çœ¾åº§ä½ï¼ˆç¤ºæ„ï¼‰ã€‚" },
{ id:"site-table", name:"æŠ˜ç–Šæ¡Œ", unit:"å¼µ", price:150, img:svgThumb("æ¡Œå­"), desc:"å ±åˆ°/è¨­å‚™å€ç”¨ã€‚" },
{ id:"site-queue", name:"ç´…é¾/æ’éšŠå‹•ç·šï¼ˆ2mï¼‰", unit:"æ”¯", price:120, img:svgThumb("ç´…é¾"), desc:"æ§å ´å‹•ç·šã€å…¥å£å€æ’éšŠã€‚" },
{ id:"site-cableramp", name:"è­·ç·šæ¿ï¼ˆ1mï¼‰", unit:"æ¢", price:120, img:svgThumb("è­·ç·š"), desc:"èµ°ç·šå®‰å…¨å¿…å‚™ï¼Œé¿å…çµ†å€’ã€‚" },
]},
{ id:"power", name:"é›»åŠ›ã€æ§å ´äººå“¡èˆ‡å®‰å…¨ç‡Ÿé‹", items:[
{ id:"power-gen", name:"ç™¼é›»æ©Ÿï¼ˆåŸºæœ¬ï¼‰", unit:"å°", price:12000, img:svgThumb("ç™¼é›»"), desc:"æˆ¶å¤–/é›»åŠ›ä¸è¶³æ™‚å¿…å‚™ã€‚åŠŸç‡å¯å‡ç´šã€‚" },
{ id:"power-dist", name:"é…é›»ç®±/å»¶é•·ç·šçµ„ï¼ˆåŸºæœ¬ï¼‰", unit:"å¥—", price:1800, img:svgThumb("é…é›»"), desc:"å«åŸºæœ¬é…é›»ã€å»¶é•·ç·šã€æ•´ç†ã€‚" },
{ id:"staff-audio", name:"éŸ³æ§å·¥ç¨‹å¸«ï¼ˆå«å½©æ’ï¼‰", unit:"äºº/å ´", price:6500, img:svgThumb("éŸ³æ§"), desc:"å«è¨­å®šã€å½©æ’ã€å…¨ç¨‹æ§å ´ï¼ˆç¤ºæ„ï¼‰ã€‚" },
{ id:"staff-light", name:"ç‡ˆæ§å·¥ç¨‹å¸«ï¼ˆå«å½©æ’ï¼‰", unit:"äºº/å ´", price:6500, img:svgThumb("ç‡ˆæ§"), desc:"ç‡ˆå…‰å ´æ™¯ã€ç¯€å¥æ§åˆ¶ï¼ˆç¤ºæ„ï¼‰ã€‚" },
{ id:"staff-stage", name:"èˆå°ç›£ç£/æ§å ´ï¼ˆèˆç›£ï¼‰", unit:"äºº/å ´", price:7000, img:svgThumb("èˆç›£"), desc:"æµç¨‹æ§å ´ã€æ¼”å‡ºä¸²æ¥ã€å¾Œå°å”èª¿ï¼ˆç¤ºæ„ï¼‰ã€‚" },
{ id:"staff-host", name:"ä¸»æŒäººï¼ˆåŸºæœ¬ï¼‰", unit:"äºº/å ´", price:9000, img:svgThumb("ä¸»æŒ"), desc:"ä¸»æŒ/ä¸²å ´/äº’å‹•ï¼ˆç¤ºæ„ï¼‰ã€‚" },
]}
];

const LEVELS = {
safety: ["â‘  åŸºç¤ç©©å®š","â‘¡ æ¨™æº–é…ç½®","â‘¢ æ´»å‹•å°ˆæ¥­","â‘£ æ¼”å‡ºé€²éš","â‘¤ æ——è‰¦èˆå°","â‘¥ å…¨ç››å…¸è—"],
ambience:["â‘  ç´”æ·¨ç‡ˆè‰²","â‘¡ å…¸ç¦®è³ªæ„Ÿ","â‘¢ æ°›åœå±¤æ¬¡","â‘£ è¦–è¦ºç„¦é»","â‘¤ æ²‰æµ¸èˆå°","â‘¥ å…¨æ„Ÿé«”é©—"],
upgrade:["â‘  äº®é»å…¥é–€","â‘¡ æ°£æ°›æ•ˆæœ","â‘¢ å„€å¼éœ‡æ’¼","â‘£ æ¼”å‡ºæ”¯æ´","â‘¤ å…¨æ–¹ä½","â‘¥ å°Šæ¦®è¦æ ¼"]
};

const LEVEL_PRICES = {
safety:  [ 10000, 15000, 20000, 25000, 35000, 50000 ],
ambience:[ 20000, 25000, 35000, 45000, 60000, 80000 ],
upgrade: [ 30000, 40000, 50000, 80000, 100000, 150000 ],
};

const PACKS_SAFETY = {
1: [{id:"audio-main",qty:1},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:1}],
2: [{id:"audio-main",qty:1},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:2},{id:"audio-monitor",qty:1},{id:"power-dist",qty:1}],
3: [{id:"audio-main",qty:2},{id:"audio-sub",qty:1},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:2},{id:"audio-monitor",qty:2},{id:"power-dist",qty:1},{id:"staff-audio",qty:1}],
4: [{id:"audio-main",qty:2},{id:"audio-sub",qty:2},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:3},{id:"audio-monitor",qty:3},{id:"power-dist",qty:1},{id:"staff-audio",qty:1}],
5: [{id:"audio-main",qty:3},{id:"audio-sub",qty:3},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:4},{id:"audio-monitor",qty:4},{id:"power-gen",qty:1},{id:"power-dist",qty:2},{id:"staff-audio",qty:1}],
6: [{id:"audio-main",qty:4},{id:"audio-sub",qty:4},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:5},{id:"audio-monitor",qty:5},{id:"power-gen",qty:1},{id:"power-dist",qty:3},{id:"staff-audio",qty:1}],
};
const PACKS_AMBIENCE = {
1: [{id:"light-par",qty:4}],
2: [{id:"stage-backdrop",qty:1},{id:"light-par",qty:6},{id:"light-console",qty:1}],
3: [{id:"stage-deck",qty:4},{id:"stage-backdrop",qty:1},{id:"light-par",qty:8},{id:"light-console",qty:1},{id:"staff-light",qty:1}],
4: [{id:"stage-deck",qty:6},{id:"stage-truss",qty:2},{id:"stage-backdrop",qty:1},{id:"light-par",qty:10},{id:"light-moving",qty:4},{id:"light-console",qty:1},{id:"fx-haze",qty:1},{id:"staff-light",qty:1}],
5: [{id:"stage-deck",qty:8},{id:"stage-truss",qty:4},{id:"stage-drape",qty:1},{id:"stage-backdrop",qty:1},{id:"light-par",qty:12},{id:"light-moving",qty:6},{id:"light-console",qty:1},{id:"fx-haze",qty:1},{id:"staff-light",qty:1}],
6: [{id:"stage-deck",qty:10},{id:"stage-truss",qty:6},{id:"stage-drape",qty:1},{id:"stage-backdrop",qty:1},{id:"light-par",qty:16},{id:"light-moving",qty:8},{id:"light-console",qty:1},{id:"fx-haze",qty:2},{id:"staff-light",qty:1}],
};
const PACKS_UPGRADE = {
1: [{id:"light-follow",qty:1}],
2: [{id:"fx-haze",qty:1}],
3: [{id:"video-projector",qty:1},{id:"video-screen",qty:1}],
4: [{id:"audio-drumkit",qty:1},{id:"audio-di",qty:4},{id:"audio-monitor",qty:2}],
5: [{id:"staff-host",qty:1},{id:"staff-stage",qty:1},{id:"staff-audio",qty:1}],
6: [{id:"staff-host",qty:1},{id:"staff-stage",qty:1},{id:"staff-audio",qty:1},{id:"staff-light",qty:1}],
};

const TIER_PHOTOS = {
safety: Array.from({length:6},(_,i)=>[
`https://picsum.photos/seed/safety-${i+1}-a/800/600`,
`https://picsum.photos/seed/safety-${i+1}-b/800/600`
]),
ambience: Array.from({length:6},(_,i)=>[
`https://picsum.photos/seed/ambience-${i+1}-a/800/600`,
`https://picsum.photos/seed/ambience-${i+1}-b/800/600`
]),
upgrade: Array.from({length:6},(_,i)=>[
`https://picsum.photos/seed/upgrade-${i+1}-a/800/600`,
`https://picsum.photos/seed/upgrade-${i+1}-b/800/600`
])
};

const ENABLE_SHEET = false;
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbxrphr7gIrOVrrhp1lplR7IYrZdc_8E8cajBEitSoUiujGRE7v8FDy0BYL8VLHaexvq/exec";

function loadSheetData(){
if(!ENABLE_SHEET) return;
if(!SHEET_API_URL) return;
const cbName = "__applySheetPayload__" + Date.now();
window[cbName] = (payload)=>{
try{
if(!payload || !payload.ok) throw new Error("API å›å‚³ä¸æ­£ç¢º");
applySheetData(payload.data);
try{ if(!CATEGORIES.find(c=>c.id===state.catId) && CATEGORIES[0]) state.catId = CATEGORIES[0].id; }catch(_){}
renderAll();
}catch(err){
}finally{
try{ delete window[cbName]; }catch(_){}
}
};
const s = document.createElement("script");
s.src = SHEET_API_URL + (SHEET_API_URL.includes("?") ? "&" : "?") + "callback=" + cbName + "&_=" + Date.now();
document.head.appendChild(s);
}

function applySheetData(data){ }

const TW = {
"å°åŒ—å¸‚":["ä¸­æ­£å€","å¤§åŒå€","ä¸­å±±å€","æ¾å±±å€","å¤§å®‰å€","è¬è¯å€","ä¿¡ç¾©å€","å£«æ—å€","åŒ—æŠ•å€","å…§æ¹–å€","å—æ¸¯å€","æ–‡å±±å€"],
"æ–°åŒ—å¸‚":["æ¿æ©‹å€","æ–°èŠå€","ä¸­å’Œå€","æ°¸å’Œå€","ä¸‰é‡å€","åœŸåŸå€","æ–°åº—å€","æ±æ­¢å€","æ·¡æ°´å€","æ—å£å€"],
"æ¡ƒåœ’å¸‚":["æ¡ƒåœ’å€","ä¸­å£¢å€","å¹³é®å€","å…«å¾·å€","é¾œå±±å€","è˜†ç«¹å€"],
"å°ä¸­å¸‚":["è¥¿å±¯å€","åŒ—å±¯å€","å—å±¯å€","ä¸­å€","æ±å€","è¥¿å€","å—å€","åŒ—å€","è±åŸå€"],
"å°å—å¸‚":["ä¸­è¥¿å€","æ±å€","å—å€","åŒ—å€","æ°¸åº·å€","å®‰å¹³å€"],
"é«˜é›„å¸‚":["ä¸‰æ°‘å€","å·¦ç‡Ÿå€","é¼“å±±å€","è‹“é›…å€","å‰é®å€","é³³å±±å€"]
};

const $ = (s)=>document.querySelector(s);
const escapeHtml = (v)=>String(v??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
const fmt = (n)=>"NT$"+Number(n||0).toLocaleString("zh-Hant-TW");
const state = { 
catId: CATEGORIES[0].id, 
cart: { packs: {} }, 
tiers: { safety: 0, ambience: 0, upgrade: 0 },
itemOpts: {},
shipping: { fee: 0, km: null },
surcharges: { day: 0, session2: 0, dayCount: 1, extraDays: 0 }
};

function getUnitPrice(item, qty){
const q = Math.max(1, Number(qty||1));
const tiers = item?.priceTiers;
if(Array.isArray(tiers) && tiers.length){
let price = Number(item.price||0);
for(const t of tiers){
const min = Number(t.min||1);
const p = Number(t.price||0);
if(q >= min) price = p;
}
return price;
}
return Number(item?.price||0);
}

function formatTiers(item){
const tiers = item?.priceTiers;
if(!Array.isArray(tiers) || !tiers.length) return "";
const sorted = [...tiers].sort((a,b)=>Number(a.min||1)-Number(b.min||1));
const parts=[];
for(let i=0;i<sorted.length;i++){
const cur=sorted[i];
const next=sorted[i+1];
const min=Number(cur.min||1);
const max = next ? (Number(next.min||1)-1) : null;
if(max && max>=min) parts.push(`${min}â€“${max}${item.unit} ${fmt(cur.price)} / ${item.unit}`);
else parts.push(`${min}${item.unit}ä»¥ä¸Š ${fmt(cur.price)} / ${item.unit}`);
}
return parts.join("ï¼›");
}

function getItemOpts(itemId){ return (state.itemOpts && state.itemOpts[itemId]) ? state.itemOpts[itemId] : {}; }
function isOptVisible(def, opts){
if(!def) return true;
const w = def.when;
if(w && w.opt) return String(opts?.[w.opt] ?? "") === String(w.is ?? "");
return true;
}
function normalizeOptValue(def, value){
const v = (value==null) ? "" : String(value);
if(v==="è«‹é¸æ“‡") return "";
return v;
}
function cleanupHiddenOpts(itemId){
const f=findItem(itemId); if(!f) return;
const item=f.item;
if(!item?.options) return;
const opts = getItemOpts(itemId) || {};
let changed=false;
for(const [k,def] of Object.entries(item.options)){
if(opts[k]==null) continue;
if(!isOptVisible(def, opts)){
delete opts[k];
changed=true;
}
}
if(changed){
if(!state.itemOpts) state.itemOpts={};
state.itemOpts[itemId]=opts;
if(Object.keys(opts).length===0) delete state.itemOpts[itemId];
}
}
function setItemOpt(itemId, key, value){
const f=findItem(itemId);
const def = f?.item?.options?.[key];
const v = normalizeOptValue(def, value);
if(!state.itemOpts) state.itemOpts = {};
if(!state.itemOpts[itemId]) state.itemOpts[itemId] = {};
if(v===""){
delete state.itemOpts[itemId][key];
if(Object.keys(state.itemOpts[itemId]).length===0) delete state.itemOpts[itemId];
}else{
state.itemOpts[itemId][key] = v;
}
cleanupHiddenOpts(itemId);
}
function clearItemOpts(itemId){ if(state.itemOpts && state.itemOpts[itemId]) delete state.itemOpts[itemId]; }
function formatOptText(itemId){
const f=findItem(itemId); if(!f) return "";
const item=f.item;
const opts=getItemOpts(itemId) || {};
if(!item?.options) return "";
const parts=[];
for(const [k,def] of Object.entries(item.options)){
if(!isOptVisible(def, opts)) continue;
const v = opts[k];
if(v==null || v==="") continue;
if(def && Array.isArray(def.omitValues) && def.omitValues.includes(String(v))) continue;
parts.push(`${def.label||k}ï¼š${v}`);
}
return parts.length ? `ï¼ˆ${parts.join("ï¼Œ")}ï¼‰` : "";
}

function buildOptionsHTML(item){
if(!item?.options) return "";
const optsState = getItemOpts(item.id) || {};
const rows = Object.entries(item.options).map(([k,def])=>{
if(!isOptVisible(def, optsState)) return "";
const values = Array.isArray(def.values) ? def.values : [];
const curRaw = (optsState[k] != null) ? String(optsState[k]) : "";
const cur = normalizeOptValue(def, curRaw);
const optionsHTML = values.map(v=>{
const vv = String(v);
const valueAttr = (vv==="è«‹é¸æ“‡") ? "" : vv;
const selected = (valueAttr === cur) || (cur==="" && valueAttr==="");
return `<option value="${escapeHtml(valueAttr)}" ${selected?"selected":""}>${escapeHtml(vv)}</option>`;
}).join("");
return `
       <div class="optrow">
         <div class="optlabel">${escapeHtml(def.label||k)}</div>
         <select class="optselect" data-act="opt" data-id="${item.id}" data-opt="${k}">
           ${optionsHTML}
         </select>
       </div>
     `;
}).join("");
return rows.trim() ? `<div class="optbox">${rows}</div>` : "";
}

function getLineSubtotal(item, qty){ return getUnitPrice(item, qty) * Number(qty||0); }
function getItemSubPriceText(item, qty){
const hasTiers = Array.isArray(item?.priceTiers) && item.priceTiers.length;
if(!hasTiers) return `${fmt(item.price)} / ${item.unit}`;
const q = Number(qty||0);
if(q>0){
const up = getUnitPrice(item, q);
const base = Number(item.price||0);
const tag = up < base ? "ï¼ˆå„ªæƒ ï¼‰" : "";
return `${fmt(up)}${tag} / ${item.unit} <span class="mini">ï½œ${formatTiers(item)}</span>`;
}
return `${fmt(item.price)} èµ· / ${item.unit} <span class="mini">ï½œ${formatTiers(item)}</span>`;
}
function updateShipping(){
try{
state.shipping = state.shipping || { fee: 0, km: null };
state.shipping.fee = 0;
state.shipping.km  = null;
}catch(e){}
}

function initCity(){
const city=$("#fCity"), area=$("#fArea");
if(!city || !area) return;
city.innerHTML=Object.keys(TW).map(c=>`<option value="${c}">${c}</option>`).join("");
function fillArea(){ area.innerHTML=(TW[city.value]||[]).map(a=>`<option value="${a}">${a}</option>`).join(""); }
city.addEventListener("change", ()=>{ fillArea(); updateShipping(); renderCart(); });
area.addEventListener("change", ()=>{ updateShipping(); renderCart(); });
fillArea();
if(Object.keys(TW).includes("å°ä¸­å¸‚")){
city.value="å°ä¸­å¸‚";
fillArea();
if((TW["å°ä¸­å¸‚"]||[]).includes("è±åŸå€")) area.value="è±åŸå€";
}
}

function pad2(n){ return String(n).padStart(2,"0"); }
function parseDateTime(dateStr, timeStr){
if(!dateStr) return null;
const [hh,mm] = String(timeStr||"00:00").split(":").map(x=>Number(x||0));
const d = new Date(dateStr+"T00:00:00");
if(Number.isNaN(d.getTime())) return null;
d.setHours(hh, mm, 0, 0);
return d;
}
function initTimePickers(){
const hours = Array.from({length:24}, (_,i)=>pad2(i));
const mins = ["00","10","20","30","40","50"];
function fill(sel, arr, suffix){ sel.innerHTML = arr.map(v=>`<option value="${v}">${v}${suffix||""}</option>`).join(""); }
fill($("#tStartH"), hours, ""); fill($("#tEndH"), hours, "");
fill($("#tStartM"), mins, ""); fill($("#tEndM"), mins, "");
if($("#t2StartH")){
fill($("#t2StartH"), hours, ""); fill($("#t2EndH"), hours, "");
fill($("#t2StartM"), mins, ""); fill($("#t2EndM"), mins, "");
}
$("#tStartH").value="09"; $("#tStartM").value="00";
$("#tEndH").value="12"; $("#tEndM").value="00";
if($("#t2StartH")){
$("#t2StartH").value="18"; $("#t2StartM").value="00";
$("#t2EndH").value="21"; $("#t2EndM").value="00";
}
function sync(){
$("#fTimeStart").value = `${$("#tStartH").value}:${$("#tStartM").value}`;
$("#fTimeEnd").value   = `${$("#tEndH").value}:${$("#tEndM").value}`;
}
function sync2(){
if(!$("#t2StartH")) return;
$("#fTime2Start").value = `${$("#t2StartH").value}:${$("#t2StartM").value}`;
$("#fTime2End").value   = `${$("#t2EndH").value}:${$("#t2EndM").value}`;
}
["tStartH","tStartM","tEndH","tEndM"].forEach(id=>{ const el=$("#"+id); if(el) el.addEventListener("change", ()=>{ sync(); renderCart(); }); });
sync();
if($("#t2StartH")){
["t2StartH","t2StartM","t2EndH","t2EndM"].forEach(id=>{ const el=$("#"+id); if(el) el.addEventListener("change", ()=>{ sync2(); renderCart(); }); });
sync2();
}
}

function renderSession2Days(){
const wrap = $("#session2DaysWrap");
const box  = $("#session2Days");
if(!wrap || !box) return;
const ds = $("#fDateStart")?.value || "";
const de = $("#fDateEnd")?.value || ds;
if(!ds){ wrap.style.display="none"; box.innerHTML=""; return; }
let dayCount = 1;
if(ds && de){
const s = new Date(ds+"T00:00:00");
const e = new Date(de+"T00:00:00");
if(!isNaN(s) && !isNaN(e)){
const diff = Math.round((e.getTime()-s.getTime())/(24*60*60*1000));
dayCount = Math.max(1, diff + 1);
}
}
if(dayCount <= 1){ wrap.style.display="none"; box.innerHTML=""; return; }
wrap.style.display="block";
const prev = new Set(Array.from(box.querySelectorAll('input[data-s2day="1"]')).filter(x=>x.checked).map(x=>x.value));
const rows=[];
for(let d=2; d<=dayCount; d++){
const key = `day${d}`;
const checked = prev.has(key) ? "checked" : "";
rows.push(`
       <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted)">
         <input type="checkbox" data-s2day="1" value="${key}" ${checked} style="width:18px;height:18px">
         ç¬¬${d}å¤©æœ‰ç¬¬äºŒå ´ï¼ˆåŠ åƒ¹ï¼šåŸºæº– E Ã— 30%ï¼‰
       </label>
     `);
}
box.innerHTML = rows.join("");
box.querySelectorAll('input[data-s2day="1"]').forEach(cb=>{ cb.addEventListener("change", ()=>{ renderCart(); }); });
}

function renderTabs(){
const el=$("#tabs");
el.innerHTML=CATEGORIES.map(c=>`<button class="tab ${c.id===state.catId?"active":""}" data-cat="${c.id}">${c.name}</button>`).join("");
el.querySelectorAll(".tab").forEach(b=>b.addEventListener("click", ()=>{ state.catId=b.dataset.cat; renderAll(); }));
}

function findItem(itemId){
for(const c of CATEGORIES){
const it=c.items.find(x=>x.id===itemId);
if(it) return {cat:c,item:it};
}
return null;
}

function setQty(itemId, qty){
if(qty<=0){ delete state.cart[itemId]; clearItemOpts(itemId); }
else state.cart[itemId]=qty;
renderAll();
}

function renderItems(){
const cat=CATEGORIES.find(c=>c.id===state.catId);
$("#catName").textContent=cat?.name||"â€”";
const el=$("#items");
el.innerHTML=(cat?.items||[]).map(it=>{
const qty=state.cart[it.id]||0;
return `
       <div class="item">
         <img class="thumb" src="${getItemPhotos(state.catId, it.id)[0]}" alt="${it.name}" loading="lazy" onerror="this.onerror=null;this.src=svgThumb(it.name);">
         <div class="meta">
           <div class="name">${it.name}</div>
           <div class="sub">${getItemSubPriceText(it, qty)}</div>
           <div class="row2">
             <div class="qty">
               <button class="qbtn" data-act="dec" data-id="${it.id}">-</button>
               <div class="qval">${qty}</div>
               <button class="qbtn" data-act="inc" data-id="${it.id}">+</button>
             </div>
             <button class="linkbtn" data-act="detail" data-id="${it.id}">è©³æƒ…</button>
           </div>
           ${qty>0 ? buildOptionsHTML(it) : ""}
         </div>
         <div class="price">${fmt(getLineSubtotal(it, qty))}</div>
       </div>
     `;
}).join("");

el.querySelectorAll("button").forEach(b=>{
const act=b.dataset.act, id=b.dataset.id;
if(!act||!id) return;
if(act==="inc") b.addEventListener("click", ()=>setQty(id,(state.cart[id]||0)+1));
if(act==="dec") b.addEventListener("click", ()=>setQty(id,Math.max(0,(state.cart[id]||0)-1)));
if(act==="detail") b.addEventListener("click", ()=>openItemDetail(id));
});

el.querySelectorAll('select[data-act="opt"]').forEach(s=>{
s.addEventListener("change", ()=>{
const id=s.dataset.id;
const key=s.dataset.opt;
setItemOpt(id, key, s.value);
renderItems();
renderCart();
});
});

const pickedItemCount = Object.keys(state.cart).filter(k=>k!=="packs" && state.cart[k]>0).length;
const pickedPackCount = Object.keys(state.cart.packs||{}).filter(k=>state.cart.packs[k]).length;
$("#pickedCount").textContent = `${pickedItemCount + pickedPackCount} é …å·²é¸`;
}

function groupCart(){
const groups=new Map();
for(const [id,qty] of Object.entries(state.cart)){
if(id==="packs") continue;
const f=findItem(id); if(!f) continue;
const key=f.cat.name;
if(!groups.has(key)) groups.set(key, []);
groups.get(key).push({item:f.item, qty});
}
return groups;
}

function updateSurcharges(baseSum){
const ds = $("#fDateStart")?.value || "";
const de = $("#fDateEnd")?.value || ds;
const ts = $("#fTimeStart")?.value || "00:00";
const te = $("#fTimeEnd")?.value || "00:00";

let start = parseDateTime(ds, ts);
let end   = parseDateTime(de, te);
let dayCount = 1;
if(start && end){
if(de===ds && end.getTime() <= start.getTime()){
end = new Date(end.getTime() + 24*60*60*1000);
}
const startDay = new Date(start.getFullYear(), start.getMonth(), start.getDate()).getTime();
const endDay   = new Date(end.getFullYear(), end.getMonth(), end.getDate()).getTime();
dayCount = Math.max(1, Math.round((endDay - startDay)/(24*60*60*1000)) + 1);
}

const has2 = !!$("#fHasSession2") && $("#fHasSession2").checked;
let day1SecondFee = 0;
if(has2){
const t2s = $("#fTime2Start")?.value || "";
const t2e = $("#fTime2End")?.value || "";
if(t2s && t2e){ day1SecondFee = Math.round(baseSum * 0.30); }
}

const E = baseSum + day1SecondFee;
const extraDays = Math.max(0, dayCount - 1);
let dayFee = 0;
if(extraDays >= 1) dayFee += Math.round(E * 0.50);
if(extraDays >= 2) dayFee += Math.round(E * 0.30 * (extraDays - 1));

let s2DaysFee = 0;
if(dayCount >= 2){
document.querySelectorAll('input[data-s2day="1"]').forEach(cb=>{
if(cb.checked) s2DaysFee += Math.round(E * 0.30);
});
}

const session2Fee = day1SecondFee + s2DaysFee;
state.surcharges = { day: dayFee, session2: session2Fee, day1SecondFee, s2DaysFee, dayCount, extraDays, E, baseSum };
return state.surcharges;
}

function calc(){
let sum=0;
if(state.cart.packs){
for(const [tierKey, pack] of Object.entries(state.cart.packs)){
if(!pack) continue;
sum += Number(pack.price||0);
}
}
for(const [id,qty] of Object.entries(state.cart)){
if(id==="packs") continue;
const f=findItem(id); if(!f) continue;
sum += getUnitPrice(f.item, qty) * qty;
}
const sur = updateSurcharges(sum);
const dayFee = Number(sur.day||0);
const session2Fee = Number(sur.session2||0);
const adj=0;
const ship = 0;
return {sum, adj, ship, dayFee, session2Fee, total: sum + ship + dayFee + session2Fee};
}

function openModal(title, htmlBody){
$("#mTitle").textContent = title || "è©³æƒ…";
$("#mBody").innerHTML = htmlBody || "â€”";
$("#modalMask").style.display="flex";
}
function closeModal(){ $("#modalMask").style.display="none"; }

(function(){
const mask = document.getElementById("modalMask");
const btnClose = document.getElementById("mClose");
function closeModalSafe(){ try{ closeModal(); }catch(e){ if(mask) mask.style.display="none"; } }
if(btnClose) btnClose.addEventListener("click", closeModalSafe);
if(mask) mask.addEventListener("click", (e)=>{ if(e.target===mask) closeModalSafe(); });
document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && mask && mask.style.display==="flex") closeModalSafe(); });
})();

function getItemPhotos(catId, itemId){
const seedBase = `${catId||"cat"}-${itemId||"item"}`;
return [
`https://picsum.photos/seed/${seedBase}-a/800/600`,
`https://picsum.photos/seed/${seedBase}-b/800/600`
];
}

function openItemDetail(itemId){
const f=findItem(itemId); if(!f) return;
const photos = getItemPhotos(f.cat.id, f.item.id);
const desc = ((f.item.desc||"â€”")+"").replace(/\n/g,"<br>");
openModal(`å•†å“è©³æƒ…ï½œ${f.item.name}`, `
     ${buildPhotoHTML(photos)}
     <div class="modalDesc">${desc}</div>
   `);
}

function buildPhotoHTML(urls){
const a = (urls && urls[0]) ? urls[0] : "https://picsum.photos/seed/event-fallback/800/600";
const b = (urls && urls[1]) ? urls[1] : "https://picsum.photos/seed/stage-fallback/800/600";
return `
     <div class="photoGrid">
       <div class="photoBox">
         <img src="${a}" alt="ç¤ºæ„ç…§ç‰‡ 1" loading="lazy">
         <div class="photoCap">ç¤ºæ„ç…§ç‰‡ 1ï¼ˆå¯æ›æˆä½ çš„ç…§ç‰‡é€£çµï¼‰</div>
       </div>
       <div class="photoBox">
         <img src="${b}" alt="ç¤ºæ„ç…§ç‰‡ 2" loading="lazy">
         <div class="photoCap">ç¤ºæ„ç…§ç‰‡ 2ï¼ˆå¯æ›æˆä½ çš„ç…§ç‰‡é€£çµï¼‰</div>
       </div>
     </div>
   `;
}

function openTierDetail(tierKey, level){
const tierLabel = ({safety:"å®‰å…¨", ambience:"æ°£æ°›", upgrade:"å‡ç´š"}[tierKey]) || "å¥—è£";
const levelName = (LEVELS[tierKey] && LEVELS[tierKey][level-1]) ? LEVELS[tierKey][level-1] : `ç¬¬${level}ç´š`;
const price = LEVEL_PRICES[tierKey]?.[level-1];
const packs = tierKey==="safety" ? PACKS_SAFETY : (tierKey==="ambience" ? PACKS_AMBIENCE : PACKS_UPGRADE);
const list = packs[level] || [];
const photos = TIER_PHOTOS[tierKey]?.[level-1];

const itemsHTML = list.map(p=>{
const f = findItem(p.id);
const name = f ? f.item.name : p.id;
const unit = f ? f.item.unit : "";
return `<li><b>${name}</b> Ã— ${p.qty}${unit?` ${unit}`:""}</li>`;
}).join("");

const usage = (()=>{
if(tierKey==="safety"){
if(level<=2) return "é©åˆï¼šå®¤å…§/å°å‹æ´»å‹•ã€ä¸»æŒ/è‡´è©ã€èƒŒæ™¯éŸ³æ¨‚ï¼›ä»¥ç©©å®šæ¸…æ™°ç‚ºä¸»ã€‚";
if(level<=4) return "é©åˆï¼šä¸­å‹æ´»å‹•/è¡¨æ¼”ï¼Œæœ‰åŸºæœ¬ç›£è½èˆ‡å·¥ç¨‹é…ç½®ï¼›å¯æ‡‰ä»˜è¼ƒè¤‡é›œæµç¨‹ã€‚";
return "é©åˆï¼šå¤§å‹æˆ¶å¤–/èˆå°æ¼”å‡ºï¼Œå¤šç›£è½èˆ‡é›»åŠ›é…å¥—ï¼›æ›´é©åˆäººå¤šèˆ‡éœ€æ±‚è¼ƒé«˜çš„æ´»å‹•ã€‚";
}
if(tierKey==="ambience"){
if(level<=2) return "é©åˆï¼šå…¸ç¦®/æ´»å‹•åŸºç¤æ°›åœï¼Œä¸»è‰²æŸ“è‰²èˆ‡åŸºæœ¬æ§åˆ¶ã€‚";
if(level<=4) return "é©åˆï¼šè¡¨æ¼”/é€²é€€å ´éœ€è¦è¦–è¦ºç„¦é»ï¼Œå«ç§»å‹•ç‡ˆ/è–„éœ§ç­‰æ•ˆæœæå‡ã€‚";
return "é©åˆï¼šèˆå°æ„Ÿæ›´å¼·çš„æ´»å‹•ï¼Œè¦–è¦ºå±¤æ¬¡èˆ‡æ•´é«”è³ªæ„ŸåŠ å¼·ã€‚";
}
if(level<=2) return "åŠ å€¼ï¼šè¿½å…‰æˆ–è–„éœ§ç­‰å–®é»å‡ç´šï¼Œå¿«é€Ÿæå‡èˆå°æ„Ÿã€‚";
if(level<=4) return "åŠ å€¼ï¼šæŠ•å½±/è¢å¹•æˆ–æ¼”å‡ºæ”¯æ´ï¼ˆé¼“çµ„/DI/ç›£è½ï¼‰ï¼Œé©åˆæœ‰è¡¨æ¼”éœ€æ±‚ã€‚";
return "åŠ å€¼ï¼šäººåŠ›/æ§å ´/å…¨æ–¹ä½æ”¯æ´ï¼Œé©åˆå¤§å‹æˆ–æµç¨‹è¤‡é›œçš„æ´»å‹•ã€‚";
})();

openModal(`å¥—è£è©³æƒ…ï½œ${tierLabel} ${levelName}`, `
     ${buildPhotoHTML(photos)}
     <div class="packMeta">
       <span class="tag">${tierLabel}</span>
       <span class="tag">ç­‰ç´šï¼š${levelName}</span>
       <span class="tag">åƒè€ƒåƒ¹ï¼š${price?fmt(price):"â€”"}</span>
     </div>
     <div class="subttl">åŒ…å«å…§å®¹</div>
     <ul class="packList">${itemsHTML || "<li>â€”</li>"}</ul>
     <div class="subttl" style="margin-top:10px">èªªæ˜</div>
     <div class="modalDesc">${usage}</div>
   `);
}

function applyPackLevel(tierKey, level){
const packs = tierKey==="safety" ? PACKS_SAFETY : (tierKey==="ambience" ? PACKS_AMBIENCE : PACKS_UPGRADE);
const list = (packs && packs[level]) ? packs[level] : [];
if(!level || !list.length){ alert("æ­¤ç­‰ç´šå°šæœªè¨­å®šå¥—è£å…§å®¹ã€‚"); return; }
state.tiers[tierKey] = level;
const packLabel = tierKey==="safety" ? "å®‰å…¨ç­‰ç´š" : (tierKey==="ambience" ? "æ°£æ°›ç­‰ç´š" : "å‡ç´šç­‰ç´š");
const name = (LEVELS[tierKey]?.[level-1]) || `ç¬¬${level}ç´š`;
const price = (LEVEL_PRICES[tierKey]?.[level-1]) || 0;
state.cart = state.cart || {};
state.cart.packs = state.cart.packs || {};
state.cart.packs[tierKey] = { tierKey, label: packLabel, level, name, price, items: list };
if(tierKey==="safety") state.catId="audio";
if(tierKey==="ambience") state.catId="light";
if(tierKey==="upgrade") state.catId="video";
renderAll();
}

function removePack(tierKey){
if(state.cart.packs) delete state.cart.packs[tierKey];
state.tiers[tierKey]=0;
renderAll();
}

function renderTierButtons(){
const mk = (tierKey, containerSel) => {
const el = $(containerSel);
el.innerHTML = LEVELS[tierKey].map((name, idx)=>{
const n = idx+1;
const on = state.tiers[tierKey]===n ? "active" : "";
const price = LEVEL_PRICES[tierKey]?.[idx];
return `
         <div class="levelBtn ${on}" data-tier="${tierKey}" data-level="${n}">
           <div class="levelText">
             <div class="levelTopRow">
               <span class="levelName">${name}</span>
               <span class="levelPrice">${price?fmt(price):"â€”"}</span>
             </div>
             <div class="levelActions">
               <button type="button" class="miniBtn primaryMini" data-act="apply" data-tier="${tierKey}" data-level="${n}">åŠ å…¥å ±åƒ¹</button>
               <button type="button" class="miniBtn" data-tier="${tierKey}" data-level="${n}">è©³æƒ…</button>
             </div>
           </div>
           <div class="levelMedia">
             <img src="${(TIER_PHOTOS[tierKey]?.[idx]?.[0]) || 'https://picsum.photos/seed/stage-fallback/800/600'}" alt="ç¤ºæ„ç…§ç‰‡" loading="lazy">
           </div>
         </div>
       `;
}).join("");

el.querySelectorAll(".levelBtn").forEach(box=>{
box.addEventListener("click", (e)=>{
if(e.target && e.target.closest(".miniBtn")) return;
const tier = box.dataset.tier;
const level = Number(box.dataset.level);
state.tiers[tier]=level;
renderTierPills();
renderTierButtons();
});
});

el.querySelectorAll(".miniBtn").forEach(b=>{
b.addEventListener("click", (e)=>{
e.stopPropagation();
const act = b.dataset.act || "";
if(act==="apply"){ applyPackLevel(b.dataset.tier, Number(b.dataset.level)); return; }
openTierDetail(b.dataset.tier, Number(b.dataset.level));
});
});
};

mk("safety","#levelsSafety");
mk("ambience","#levelsAmbience");
mk("upgrade","#levelsUpgrade");

$("#pillSafety").textContent = state.tiers.safety ? `ç¬¬${state.tiers.safety}ç´š` : "æœªé¸";
$("#pillAmbience").textContent = state.tiers.ambience ? `ç¬¬${state.tiers.ambience}ç´š` : "æœªé¸";
$("#pillUpgrade").textContent = state.tiers.upgrade ? `ç¬¬${state.tiers.upgrade}ç´š` : "æœªé¸";
}

function renderTierPills(){
const s = state.tiers.safety ? `å®‰å…¨ç¬¬${state.tiers.safety}ç´š` : "å®‰å…¨â€”";
const a = state.tiers.ambience ? `æ°£æ°›ç¬¬${state.tiers.ambience}ç´š` : "æ°£æ°›â€”";
const u = state.tiers.upgrade ? `å‡ç´šç¬¬${state.tiers.upgrade}ç´š` : "å‡ç´šâ€”";
$("#tierPills").textContent = `${s}ï½œ${a}ï½œ${u}`;
}

function getEventDateText(){
const ds = $("#fDateStart")?.value || "";
const de = $("#fDateEnd")?.value || ds;
const ts = $("#fTimeStart")?.value || "";
const te = $("#fTimeEnd")?.value || "";
if(!ds) return "";
const dpart = (de && de!==ds) ? `${ds} ï½ ${de}` : ds;
const tpart = (ts && te) ? ` ${ts}ï½${te}` : "";
return dpart + tpart;
}

function getSession2Text(){
const has = $("#fHasSession2")?.checked;
if(!has) return "";
const s = $("#fTime2Start")?.value || "";
const e = $("#fTime2End")?.value || "";
if(s && e) return `ç¬¬äºŒå ´æ™‚é–“ï¼š${s}ï½${e}`;
if(s) return `ç¬¬äºŒå ´æ™‚é–“ï¼š${s}`;
return "ç¬¬äºŒå ´æ™‚é–“ï¼šå·²å‹¾é¸";
}

function renderCart(){
const el=$("#cart");
const dayLabel = $("#daySurchargeRow")?.querySelector(".subttl");
if(dayLabel){ dayLabel.innerHTML = `è·¨å¤©åŠ åƒ¹ <span class="note-inline">ï¼ˆç¬¬2å¤©ï¼šEÃ—50%ï¼›ç¬¬3å¤©èµ·ï¼šæ¯ä¸€å¤© EÃ—30%ï¼‰</span>`; }
const s2Label = $("#session2SurchargeRow")?.querySelector(".subttl");
if(s2Label){ s2Label.innerHTML = `ç¬¬äºŒå ´åŠ åƒ¹ <span class="note-inline">ï¼ˆç¬¬ä¸€å¤©/è·¨å¤©æ¯å‹¾ä¸€å¤©ï¼šEÃ—30%ï¼‰</span>`; }

const groups=groupCart();
const packCount = state.cart.packs ? Object.keys(state.cart.packs).filter(k=>state.cart.packs[k]).length : 0;
const itemCount = Object.keys(state.cart).filter(k=>k!=="packs").length;
$("#cartBadge").textContent = `${packCount + itemCount} é …å·²é¸`;

const parts=[];
if(state.cart.packs){
const order = [["safety","å®‰å…¨ç­‰ç´š"],["ambience","æ°£æ°›ç­‰ç´š"],["upgrade","å‡ç´šç­‰ç´š"]];
for(const [tierKey, title] of order){
const pack = state.cart.packs[tierKey];
if(!pack) continue;
const lv = Number(pack.level||0);
const packName = `${title}ï½œ${pack.name || ((LEVELS[tierKey]?.[lv-1]) || `ç¬¬${lv}ç´š`)}`;
const price = Number(pack.price||0);
parts.push(`
         <div class="group">
           <div class="gh"><span>${title}ï¼ˆå¥—è£ï¼‰</span><span class="subttl">å·²é¸ <b>1</b> é …</span></div>
           <div class="gb">
             <div class="citem">
               <img src="${(TIER_PHOTOS[tierKey]?.[lv-1]?.[0]) || svgThumb("å¥—è£")}" alt="${packName}">
               <div class="cmeta">
                 <div class="top">
                   <div><div class="nm">${packName}</div><div class="unit">å¥—è£åƒ¹æ ¼ï¼ˆç¤ºç¯„ï¼‰</div></div>
                   <div style="font-weight:1000">${fmt(price)}</div>
                 </div>
                 <div class="cline">
                   <div class="qtyRow">
                     <div class="qty" style="padding:6px 10px"><b>å¥—è£</b></div>
                     <button class="xbtn" data-act="delpack" data-tier="${tierKey}" title="åˆªé™¤å¥—è£">âœ•</button>
                   </div>
                   <div class="subttl">å°è¨ˆï¼š<b>${fmt(price)}</b></div>
                 </div>
               </div>
             </div>
           </div>
         </div>
       `);
}
}

for(const [gname, rows] of groups.entries()){
parts.push(`
       <div class="group">
         <div class="gh"><span>${gname}</span><span class="subttl">å·²é¸ <b>${rows.length}</b> é …</span></div>
         <div class="gb">
           ${rows.map(({item,qty})=>{
             const up=getUnitPrice(item, qty);
             const line=up*qty;
             const optText = formatOptText(item.id);
             const tiersHint = formatTiers(item);
             return `
               <div class="citem">
                 <img src="${item.img}" alt="${item.name}">
                 <div class="cmeta">
                   <div class="top">
                     <div>
                       <div class="nm">${item.name}${optText}</div>
                       <div class="unit">${fmt(up)} / ${item.unit}${tiersHint?` <span class="mini">ï½œ${tiersHint}</span>`:""}</div>
                     </div>
                     <div style="font-weight:1000">${fmt(line)}</div>
                   </div>
                   <div class="cline">
                     <div class="qtyRow">
                       <div class="qty">
                         <button class="qbtn" data-act="dec" data-id="${item.id}">-</button>
                         <div class="qval">${qty}</div>
                         <button class="qbtn" data-act="inc" data-id="${item.id}">+</button>
                       </div>
                       <button class="xbtn" data-act="del" data-id="${item.id}" title="åˆªé™¤">âœ•</button>
                     </div>
                     <div class="subttl">å°è¨ˆï¼š<b>${fmt(line)}</b></div>
                   </div>
                 </div>
               </div>
             `;
           }).join("")}
         </div>
       </div>
     `);
}

el.innerHTML = parts.join("") || `<div class="note" style="display:none"></div>`;
el.querySelectorAll("button").forEach(b=>{
const act=b.dataset.act, id=b.dataset.id;
if(act==="inc") b.addEventListener("click", ()=>setQty(id,(state.cart[id]||0)+1));
if(act==="dec") b.addEventListener("click", ()=>setQty(id,Math.max(0,(state.cart[id]||0)-1)));
if(act==="del") b.addEventListener("click", ()=>setQty(id,0));
if(act==="delpack") b.addEventListener("click", ()=>removePack(b.dataset.tier));
});

const {sum,dayFee,session2Fee,total}=calc();
$("#grandTotal").textContent=fmt(sum);
const subRow=$("#grandTotalRow");
if(subRow){
const hasFee = Number(dayFee||0)>0 || Number(session2Fee||0)>0;
subRow.style.display = hasFee ? "flex" : "none";
}
const dayRow=$("#daySurchargeRow");
const dayEl=$("#daySurcharge");
if(dayRow && dayEl){
const v = Number(dayFee||0);
dayRow.style.display = v>0 ? "flex" : "none";
dayEl.textContent = fmt(v);
}
const s2Row=$("#session2SurchargeRow");
const s2El=$("#session2Surcharge");
if(s2Row && s2El){
const v2 = Number(session2Fee||0);
s2Row.style.display = v2>0 ? "flex" : "none";
s2El.textContent = fmt(v2);
}
$("#finalTotal").textContent=fmt(total);
}

function renderAll(){
renderTierPills();
renderTierButtons();
renderTabs();
renderItems();
renderCart();
}

const ORDER_API_URL = "https://script.google.com/macros/s/AKfycbxrphr7gIrOVrrhp1lplR7IYrZdc_8E8cajBEitSoUiujGRE7v8FDy0BYL8VLHaexvq/exec";

function buildQuoteItemsForSend(){
const items = [];
if(state.cart?.packs){
const order=[["safety","å®‰å…¨ç­‰ç´š"],["ambience","æ°£æ°›ç­‰ç´š"],["upgrade","å‡ç´šç­‰ç´š"]];
for(const [k,label] of order){
const p = state.cart.packs[k];
if(!p) continue;
items.push({
categoryName: "å¥—è£",
name: `å¥—è£ï½œ${label}ï½œ${p.name||""}`,
id: `pack_${k}`,
unit: "å¥—",
price: Number(p.price||0),
qty: 1,
lineTotal: Number(p.price||0),
options: {}
});
}
}
const groups = groupCart();
for(const [catName, rows] of groups.entries()){
for(const {item, qty} of rows){
const up = getUnitPrice(item, qty);
items.push({
categoryName: catName,
name: item.name,
id: item.id,
unit: item.unit || "",
price: Number(up||0),
qty: Number(qty||0),
lineTotal: Number(up||0) * Number(qty||0),
options: state.itemOpts?.[item.id] || {}
});
}
}
return items;
}

function calcQuoteSummaryForSend(){
const r = calc();
return {
subtotal: Number(r.sum||0),
discount: 0,
tax: 0,
dayFee: Number(r.dayFee||0),
session2Fee: Number(r.session2Fee||0),
total: Number(r.total||0)
};
}

function getLevelsForSend(){
return {
safety: state.cart?.packs?.safety?.name || "",
ambience: state.cart?.packs?.ambience?.name || "",
upgrade: state.cart?.packs?.upgrade?.name || ""
};
}

function submitQuoteToAppsScript(){
try{
const payload = {
action: "submitQuote",
ownerEmail: "", 
form: {
name: $("#fName")?.value?.trim() || "",
phone: $("#fPhone")?.value?.trim() || "",
email: $("#fEmail")?.value?.trim() || "",
dateStart: $("#fDateStart")?.value || "",
dateEnd: $("#fDateEnd")?.value || "",
timeStart: $("#fTimeStart")?.value || "",
timeEnd: $("#fTimeEnd")?.value || "",
city: $("#fCity")?.value || "",
area: $("#fArea")?.value || "",
addr: $("#fAddr")?.value?.trim() || "",
bldg: $("#fBldg")?.value?.trim() || "",
eventType: $("#fEventType")?.value || "",
crowd: $("#fCrowd")?.value || "",
indoor: $("#fIndoor")?.value || "",
hasSession2: $("#fHasSession2")?.checked ? "æ˜¯" : "å¦",
session2Start: $("#fTime2Start")?.value || "",
session2End: $("#fTime2End")?.value || "",
          hasExtraDate: $("#fHasExtraDate")?.checked ? "æ˜¯" : "å¦",
          extraDateStart: $("#fExtraDateStart")?.value || "",
          extraDateEnd: $("#fExtraDateEnd")?.value || "",
note: $("#fNote")?.value?.trim() || ""
},
levels: getLevelsForSend(),
items: buildQuoteItemsForSend(),
summary: calcQuoteSummaryForSend()
};

const ok = navigator.sendBeacon(ORDER_API_URL, JSON.stringify(payload));
if(ok) {
alert("å·²é€å‡ºï¼ç³»çµ±æœƒç”¢ç”Ÿ PDF å ±åƒ¹å–®ä¸¦å¯„çµ¦æ‚¨ï¼Œè«‹è‡³ä¿¡ç®±æŸ¥æ”¶ã€‚");
} else {
alert("é€å‡ºå¤±æ•—ï¼ˆç€è¦½å™¨æœªé€å‡ºï¼‰ã€‚è«‹é‡æ–°æ•´ç†å¾Œå†è©¦ä¸€æ¬¡ã€‚");
}
}catch(e){
console.error(e);
alert("é€å‡ºå¤±æ•—ï¼š" + (e?.message||e));
}
}

const __btnMail = $("#btnMail");
if(__btnMail) __btnMail.addEventListener("click", ()=>{ submitQuoteToAppsScript(); });
const __btnSendQuote = $("#btnSendQuote");
if(__btnSendQuote) __btnSendQuote.addEventListener("click", ()=>{ submitQuoteToAppsScript(); });

try{
initCity();
initTimePickers();
renderSession2Days();

const cExtra = $("#fHasExtraDate");
    const wExtra = $("#extraDateWrap");
    if(cExtra){
      cExtra.addEventListener("change", ()=>{
        if(wExtra) wExtra.style.display = cExtra.checked ? "block" : "none";
      });
    }
const c2 = $("#fHasSession2");
const w2 = $("#session2Wrap");
if(c2){
c2.addEventListener("change", ()=>{
if(w2) w2.style.display = c2.checked ? "block" : "none";
renderCart();
});
if(w2) w2.style.display = c2.checked ? "block" : "none";
}

["t2StartH","t2StartM","t2EndH","t2EndM"].forEach(id=>{
const el=$("#"+id);
if(el) el.addEventListener("change", ()=>renderCart());
});

["fAddr","fBldg"].forEach(id=>{
const el=$("#"+id);
if(el) el.addEventListener("input", ()=>{ updateShipping(); renderCart(); });
});

["fDateStart","fDateEnd"].forEach(id=>{
const el=$("#"+id);
if(el) el.addEventListener("change", ()=>{ renderSession2Days(); renderCart(); });
});

}catch(err){
}finally{
try{
renderAll();
loadSheetData();
}catch(err){}
}
</script>
</body>
</html>
