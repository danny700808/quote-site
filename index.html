<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>活動企劃｜燈光音響配置區｜設備選配與即時報價</title>

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#1a1f2b; --muted:#6b7280; --line:#e5e7eb;
      --brand:#1e8e6f; --brand2:#156e56; --danger:#e24a4a;
      --shadow:0 10px 28px rgba(0,0,0,.08); --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{position:sticky;top:0;z-index:10;background:rgba(246,247,251,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .head{max-width:1100px;margin:0 auto;display:flex;gap:14px;align-items:center;justify-content:space-between;padding:14px 18px}
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{margin:0;font-size:18px}
    .title small{color:var(--muted)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:var(--card);padding:10px 12px;border-radius:999px;cursor:pointer;font-weight:900;font-size:13px}
    .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
    .btn.primary:hover{background:var(--brand2)}
    .btn.danger{background:var(--danger);border-color:transparent;color:#fff}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:14px;align-items:start}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .card .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card .hd h2{margin:0;font-size:16px}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff;white-space:nowrap}

    .form{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;color:var(--muted);font-weight:900}
    .field input,.field select,.field textarea{border:1px solid var(--line);border-radius:12px;padding:11px 12px;background:#fff;outline:none;font-size:14px}
    .field textarea{min-height:84px;resize:vertical}
    .span2{grid-column:1/-1}

    .timeRow{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
    .timeRow .sep{color:var(--muted);font-weight:900;text-align:center}

    .tabs{padding:12px 14px 14px;display:flex;gap:10px;flex-wrap:wrap;border-top:1px solid var(--line)}
    .tab{padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000;font-size:14px}
    .tab.active{background:rgba(30,142,111,.12);border-color:rgba(30,142,111,.35);color:var(--brand2)}

    .items{padding:14px;display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;grid-template-columns:74px 1fr auto;gap:12px;align-items:center}
    .thumb{width:74px;height:74px;border-radius:14px;object-fit:cover;border:1px solid var(--line);background:#f3f4f6}
    .meta{min-width:0}
    .meta .name{font-weight:1000}
    .meta .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .meta .row2{margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .price{font-weight:1000;text-align:right}

    .qty{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 8px;background:#fff}
    .qbtn{width:36px;height:36px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:1000}
    .qval{min-width:44px;text-align:center;font-weight:1000}
    .linkbtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 10px;cursor:pointer;font-weight:1000;font-size:12px}

    .summary{padding:14px;display:grid;gap:12px}
    .totals{border:1px dashed var(--line);border-radius:14px;padding:12px;display:grid;gap:8px;background:linear-gradient(180deg, rgba(30,142,111,.06), transparent)}
    .trow{display:flex;justify-content:space-between;align-items:center;gap:10px}

    .cart{display:grid;gap:12px}
    .group{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .group .gh{padding:10px 12px;background:#fafafa;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;font-weight:1000}
    .group .gb{padding:12px;display:grid;gap:12px}
    .citem{border:1px solid var(--line);border-radius:14px;padding:12px;display:grid;grid-template-columns:58px 1fr;gap:12px;background:#fff}
    .citem img{width:58px;height:58px;border-radius:12px;object-fit:cover;border:1px solid var(--line)}
    .cmeta .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .cmeta .nm{font-weight:1000;line-height:1.2}
    .cmeta .unit{color:var(--muted);font-size:12px;margin-top:2px}
    .cline{margin-top:10px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}

    .qtyRow{display:flex;align-items:center;gap:10px}
    .xbtn{width:36px;height:36px;border-radius:12px;border:1px solid rgba(226,74,74,.35);background:rgba(226,74,74,.10);color:var(--danger);font-weight:1000;cursor:pointer}
    .subttl{color:var(--muted);font-size:12px}
    .subttl b{color:var(--text)}
    .note{color:var(--muted);font-size:12px;line-height:1.5}
    .note-inline{color:var(--muted);font-size:12px;font-weight:800;margin-left:6px}

    /* Three-layer selector */
    .tierWrap{padding:14px;display:grid;gap:12px}
    .tierGrid{display:grid;grid-template-columns:1fr;gap:12px}
    .tierCard{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    .tierHead{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .tierHead b{font-size:14px}
    .tierBody{padding:12px;display:grid;gap:10px}
    .levelRow{display:grid;grid-template-columns:repeat(3, 1fr);gap:12px}

    /* ✅ iPhone Safari 修正：不再用 button 包 button（會導致整塊不顯示） */
    .levelBtn{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:1000;
      text-align:left;
      display:flex;
      flex-direction:column;   /* ✅ 垂直卡片：避免擠在一起 */
      gap:10px;
      user-select:none;
      align-items:stretch;
      justify-content:flex-start;
    }

    .levelText{min-width:0;display:flex;flex-direction:column;gap:6px}
    .levelTopRow{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .levelName{font-size:13px;line-height:1.25;word-break:break-word}
    .levelPrice{font-size:12px;font-weight:1000;white-space:nowrap}
    .levelActions{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .miniBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:7px 10px;cursor:pointer;font-weight:1000;font-size:12px}
    .miniBtn:hover{border-color:rgba(30,142,111,.35)}
    .miniBtn.primaryMini{background:var(--brand);border-color:transparent;color:#fff}
    .miniBtn.primaryMini:hover{background:var(--brand2)}
    .tierActions{display:flex;gap:10px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted);line-height:1.55}
    .hint b{color:var(--text)}
    .tierStatus{display:flex;gap:8px;flex-wrap:wrap}
    /* ✅ 隱藏一鍵套用按鈕（改成每格直接加入） */
    .tierActions{display:none}

    .modalMask{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:18px;z-index:50}
    .modal{width:min(560px,100%);background:#fff;border-radius:18px;border:1px solid var(--line);box-shadow:0 18px 48px rgba(0,0,0,.22);overflow:hidden}
    .modal .mh{padding:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;border-bottom:1px solid var(--line)}
    .modal .mb{padding:14px}
    .modal .mb p{margin:0;color:#374151;line-height:1.65}
    .modal .mf{padding:12px 14px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:10px;background:#fafafa}

    /* ✅ 詳情：兩張照片版面 */
    .photoGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .packMeta{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 6px}
        .packMeta .tag{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff}
        .packList{margin:8px 0 0;padding-left:18px;line-height:1.65}
        .packList li{margin:4px 0}
        .modalDesc{margin-top:8px;color:var(--muted);line-height:1.7}
    .photoBox{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;background:#fff}
    .photoBox img{width:100%;height:140px;object-fit:cover;display:block}
    .photoCap{padding:8px 10px;font-size:12px;color:#6b7280}

    @media (max-width:920px){
      .levelRow{grid-template-columns:repeat(2, 1fr)}
      .grid{grid-template-columns:1fr}
      .tierGrid{grid-template-columns:1fr}
    }
    @media (max-width:620px){
      .levelRow{grid-template-columns:1fr}
      .items{grid-template-columns:1fr}
      .form{grid-template-columns:1fr}
      .item{grid-template-columns:74px 1fr}
      .price{grid-column:2;text-align:left}
      .actions{display:none}
      .levelRow{grid-template-columns:1fr}
      .timeRow{grid-template-columns:1fr auto 1fr}
      .photoGrid{grid-template-columns:1fr}
      .photoBox img{height:170px}
      .levelBtn{flex-direction:column}
    }
  </style>
</head>

<body>
<header>
  <div class="head">
    <div class="title">
      <h1>活動企劃｜設備選配與即時報價</h1>
      <small>先看「安全→氣氛→升級」內容與價格，再按一鍵套用｜右邊即時報價</small>
    </div>
    <div class="actions">
      <button class="btn" id="btnCopy">複製報價內容</button>
      <button class="btn primary" id="btnMail">寄 Email（mailto）</button>
      <button class="btn" id="btnPrint">列印成 PDF</button>
      <button class="btn danger" id="btnClear">清空全部</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <section class="card">
      <div class="hd">
        <h2>1) 基本資料</h2>
        <span class="pill" id="pickedCount">0 項已選</span>
      </div>

      <div class="form">
                <div class="field">
          <label>姓名 / 單位</label>
          <input id="fName" placeholder="例：柚子樂器 / 王小明">
        </div>

        <div class="field">
          <label>行動電話</label>
          <input id="fPhone" type="tel" inputmode="tel" placeholder="例：09xx-xxx-xxx">
        </div>

        <div class="field">
          <label>Email</label>
          <input id="fEmail" type="email" placeholder="例：you@example.com">
        </div>

        <div class="field span2">
          <label>活動地點（縣市/區）</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <select id="fCity"></select>
            <select id="fArea"></select>
          </div>
        </div>

        <div class="field span2">
          <label>詳細地址（路名/號）</label>
          <input id="fAddr" placeholder="例：中山路 100 號">
        </div>

        <div class="field span2">
          <label>大樓/棟別/樓層/入口（讓地址更清楚）</label>
          <input id="fBldg" placeholder="例：XX大樓 A棟 3F（從側門進）">
        </div>

        <div class="field">
          <label>活動類型</label>
          <select id="fEventType">
            <option value="">請選擇活動類型</option>
            <option>開幕典禮／剪綵儀式</option>
            <option>記者會／產品發表會</option>
            <option>品牌活動／快閃活動（商場/戶外）</option>
            <option>展覽開幕／展場活動（含舞台時段）</option>
            <option>校慶活動（運動會/園遊會/舞台）</option>
            <option>畢業典禮</option>
            <option>成果發表會（學校/才藝/社團）</option>
            <option>社團成發／迎新送舊晚會</option>
            <option>演講／講座／論壇</option>
            <option>研討會／學術會議（含分場）</option>
            <option>公司內訓／教育訓練／大會</option>
            <option>尾牙／春酒</option>
            <option>公司家庭日／園遊會</option>
            <option>餐會／晚宴（含抽獎、致詞、表演）</option>
            <option>商務交流會／同業公會活動</option>
            <option>演唱會／Live Band 表演</option>
            <option>DJ 派對／電音活動</option>
            <option>舞蹈表演／舞蹈比賽</option>
            <option>戲劇／舞台劇／音樂劇</option>
            <option>親子活動／兒童舞台秀</option>
            <option>慶生會／派對（含包場）</option>
            <option>婚禮（證婚/宴客/After party）</option>
            <option>告別式／追思會（殯儀館/會館/戶外追思）</option>
            <option>宗教活動（廟會/法會/禮拜/慶典）</option>
            <option>社區活動／里民大會／宣導活動（戶外廣播）</option>
          </select>
        </div>

        <div class="field">
          <label>預估人數</label>
          <select id="fCrowd">
            <option value="">請選擇</option>
            <option value="30">30人內</option>
            <option value="100">30–100人</option>
            <option value="200">100–200人</option>
            <option value="400">200–400人</option>
            <option value="999">400人以上</option>
          </select>
        </div>

        <div class="field">
          <label>室內 / 戶外</label>
          <select id="fIndoor">
            <option value="">請選擇</option>
            <option>室內</option>
            <option>戶外</option>
            <option>半戶外</option>
          </select>
        </div>

        <div class="field">
          <label>活動日期（開始）</label>
          <input id="fDateStart" type="date">
        </div>

        <div class="field">
          <label>活動日期（結束）</label>
          <input id="fDateEnd" type="date">
        </div>

        <div class="field span2">
          <label>活動時間（只提供 00/10/20/30/40/50 分）</label>
          <div class="timeRow">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <select id="tStartH"></select>
              <select id="tStartM"></select>
            </div>
            <div class="sep">～</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
              <select id="tEndH"></select>
              <select id="tEndM"></select>
            </div>
          </div>
          <input id="fTimeStart" type="hidden">
          <input id="fTimeEnd" type="hidden">
        </div>

        <div class="field span2">
          <label>同日第二場（選填）</label>
          <div style="display:grid;gap:10px">
            <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted)">
              <input type="checkbox" id="fHasSession2" style="width:18px;height:18px">
              同一天有第二場（勾選後可設定第二場時間；第二場加價：原始總價 x 30%）
            </label>

            <div id="session2Wrap" style="display:none;border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff">
              <div style="font-weight:1000;margin-bottom:8px">第二場時間</div>
              <div class="timeRow">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                  <select id="t2StartH"></select>
                  <select id="t2StartM"></select>
                </div>
                <div class="sep">～</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                  <select id="t2EndH"></select>
                  <select id="t2EndM"></select>
                </div>
              </div>
              <input id="fTime2Start" type="hidden">
              <input id="fTime2End" type="hidden">
              <div class="hint" style="margin-top:8px">提示：第二場只算同一天內的加價，不影響跨天判定。</div>
            </div>
          </div>
        </div>

        <div class="field span2">
          <label>備註 / 需求</label>
          <textarea id="fNote" placeholder="例：室內婚禮120人，需四支無線麥，場地有220V插座，需含進退場..."></textarea>
        </div>

      </div>

      <div class="hd" style="border-top:1px solid var(--line);border-bottom:none">
        <h2>2) 燈光音響配置區</h2>
        <span class="pill" id="tierPills">安全—｜氣氛—｜升級—</span>
      </div>

      <div class="tierWrap">
        <div class="tierGrid">

          <div class="tierCard">
            <div class="tierHead">
              <b>安全等級</b>
              <span class="pill" id="pillSafety">未選</span>
            </div>
            <div class="tierBody">
              <div class="levelRow" id="levelsSafety"></div>
              <div class="tierActions">
                <button class="btn primary" id="applySafety">一鍵套用（安全）</button>
              </div>
              <div class="hint">建議：一般活動多數選 <b>第3級</b>；戶外建議至少 <b>第3級</b>。</div>
            </div>
          </div>

          <div class="tierCard">
            <div class="tierHead">
              <b>氣氛等級</b>
              <span class="pill" id="pillAmbience">未選</span>
            </div>
            <div class="tierBody">
              <div class="levelRow" id="levelsAmbience"></div>
              <div class="tierActions">
                <button class="btn primary" id="applyAmbience">一鍵套用（氣氛）</button>
              </div>
              <div class="hint">想要「看起來不寒酸」：至少選到 <b>第2級</b>；有表演感：選到 <b>第4級</b>。</div>
            </div>
          </div>

          <div class="tierCard">
            <div class="tierHead">
              <b>升級等級</b>
              <span class="pill" id="pillUpgrade">未選</span>
            </div>
            <div class="tierBody">
              <div class="levelRow" id="levelsUpgrade"></div>
              <div class="tierActions">
                <button class="btn primary" id="applyUpgrade">一鍵套用（升級）</button>
              </div>
              <div class="hint">升級是高滿意度來源：先看內容與價格再選等級，之後再微調。</div>
            </div>
          </div>

        </div>

        <div class="tierStatus">
          <span class="pill">提示：每個 1–6 級都可以按「詳情」先看包含什麼。</span>
          <button class="btn" id="btnSuggest">依人數/室內外建議等級</button>
        </div>
      </div>

      <div class="hd" style="border-top:1px solid var(--line);border-bottom:none">
        <h2>3) 設備/服務分類（自由加減）</h2>
        <span class="pill" id="catName">—</span>
      </div>

      <div class="tabs" id="tabs"></div>
      <div class="items" id="items"></div>
    </section>

    <aside class="card" id="quoteCard">
      <div class="hd">
        <h2>4) 即時報價</h2>
        <span class="pill" id="cartBadge">0 項已選</span>
      </div>

      <div class="summary">
        <div class="totals">
          <div class="trow"><span class="subttl">目前合計</span><b id="grandTotal">NT$0</b></div>
          <div class="trow"><span class="subttl">折扣/加價</span>
            <input id="adj" type="number" value="0" style="width:130px;border:1px solid var(--line);border-radius:12px;padding:10px 12px">
          </div>
          <div class="trow" id="daySurchargeRow" style="display:none"><span class="subttl">跨天加價</span><b id="daySurcharge">NT$0</b></div>
          <div class="trow" id="session2SurchargeRow" style="display:none"><span class="subttl">同日第二場加價</span><b id="session2Surcharge">NT$0</b></div>
<div class="trow"><span class="subttl">總計</span><b id="finalTotal">NT$0</b></div>
        </div>

        <div class="cart" id="cart"></div>

        <div class="note">
          ✦「寄 Email（mailto）」會開啟你的信箱 App，內容會自動填好。<br>
          ✦此頁示範內容，你可再替換成你的正式品項/套裝/價格。
        </div>
      </div>
    </aside>

  </div>
</div>

<div class="modalMask" id="modalMask">
  <div class="modal">
    <div class="mh">
      <b id="mTitle">詳情</b>
      <button class="xbtn" id="mClose" title="關閉">✕</button>
    </div>
    <div class="mb"><p id="mBody">—</p></div>
    <div class="mf">
      <button class="btn primary" id="mBack">返回估價單</button>
    </div>
  </div>
</div>

<script>
  function svgThumb(label){
    const safe = (label||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200">
  <defs>
    <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0" stop-color="#e8f5f0"/>
      <stop offset="1" stop-color="#f6f7fb"/>
    </linearGradient>
  </defs>
  <rect width="200" height="200" rx="22" fill="url(#g)"/>
  <circle cx="160" cy="40" r="26" fill="#1e8e6f" opacity="0.18"/>
  <circle cx="40" cy="160" r="36" fill="#156e56" opacity="0.12"/>
  <text x="18" y="102" font-size="16" font-family="system-ui, -apple-system, Segoe UI, Roboto, Arial" fill="#156e56" font-weight="700">${safe}</text>
</svg>`;
    return "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(svg);
  }

  const CATEGORIES = [
    { id:"stage", name:"舞台結構與桁架系統", items:[
      { id:"stage-deck", name:"舞台板（2x1m）", unit:"片", price:1200, img:svgThumb("舞台板"), desc:"舞台板（2x1m）。可依尺寸、階梯、圍裙等調整。" },
      { id:"stage-step", name:"舞台階梯（含扶手）", unit:"座", price:900, img:svgThumb("階梯"), desc:"舞台上下台階梯，適合典禮/表演。" },
      { id:"stage-truss", name:"TRUSS 桁架（3m）", unit:"支", price:1800, img:svgThumb("TRUSS"), desc:"基本桁架結構，用於燈具/背板/布幕。" },
      { id:"stage-backdrop", name:"主視覺背板（基本）", unit:"組", price:6500, img:svgThumb("背板"), desc:"基本背板（含架設）。主視覺輸出另計或可包套。" },
      { id:"stage-drape", name:"舞台布幕/遮擋（基本）", unit:"組", price:4800, img:svgThumb("布幕"), desc:"舞台側布/後布/遮擋，提升整體質感。" },
    ]},
    { id:"light", name:"燈光與氣氛效果", items:[
      { id:"light-par", name:"LED PAR（染色燈）", unit:"盞", price:900, img:svgThumb("染色燈"), desc:"典禮/氛圍底色必備。可搭配燈控/場景變換。" },
      { id:"light-moving", name:"Moving Head（光束燈）", unit:"盞", price:2500, img:svgThumb("光束燈"), desc:"動態光束效果，適合表演/高潮段落。" },
      { id:"light-follow", name:"追光燈（含操作）", unit:"組", price:6000, img:svgThumb("追光"), desc:"追光燈含操作人員，適合走位/得獎/表演主角。" },
      { id:"light-console", name:"燈控台（基本）", unit:"套", price:3500, img:svgThumb("燈控"), desc:"燈光場景切換/節奏控制。演出感提升。" },
      { id:"fx-haze", name:"薄霧機（Hazer）", unit:"台", price:2200, img:svgThumb("薄霧"), desc:"讓光束更立體。小心場地方規定/消防。" },
    ]},
    { id:"audio", name:"音響與舞台收音", items:[
      { id:"audio-main", name:"主喇叭（全頻）", unit:"組", price:6000, img:svgThumb("主喇叭"), desc:"主擴聲系統（示意）。可依品牌/功率/場域調整。" },
      { id:"audio-sub", name:"低音喇叭（Sub）", unit:"顆", price:4500, img:svgThumb("Sub"), desc:"增加低頻能量，適合戶外/音樂活動。" },
      { id:"audio-mixer", name:"混音器（基本）", unit:"台", price:3000, img:svgThumb("混音"), desc:"基本混音控制。多路數需求可升級。" },
      { id:"audio-wireless2", name:"無線麥克風（2支組）", unit:"組", price:2200, img:svgThumb("無線麥"), desc:"常見典禮/講座用。可加到 4/6/8 支。" },
      { id:"audio-monitor", name:"舞台監聽喇叭", unit:"顆", price:1800, img:svgThumb("監聽"), desc:"給主持/表演者聽到自己的聲音。" },
      { id:"audio-di", name:"DI Box（主動式）", unit:"顆", price:400, img:svgThumb("DI"), desc:"鍵盤/木吉他/電貝斯等訊號轉換。" },
      { id:"audio-drumkit", name:"鼓組收音套裝（基本）", unit:"組", price:6500, img:svgThumb("鼓組"), desc:"適合 Live Band / 表演。細項可拆分。" },
    ]},
    { id:"video", name:"影像、投影與直播導播", items:[
      { id:"video-projector", name:"投影機（基本）", unit:"台", price:6500, img:svgThumb("投影"), desc:"會議/典禮簡報。亮度/鏡頭依場地調整。" },
      { id:"video-screen", name:"投影布幕（120吋）", unit:"面", price:1800, img:svgThumb("布幕"), desc:"投影布幕（示意）。也可用電動布幕。" },
      { id:"video-tv", name:"電視（75吋）", unit:"台", price:4800, img:svgThumb("75吋TV"), desc:"展場/小型場地更方便。" },
      { id:"video-camera", name:"活動攝影機（基本）", unit:"台", price:5000, img:svgThumb("攝影"), desc:"活動錄影/直播機位（示意）。" },
      { id:"video-switcher", name:"直播導播/切換台（基本）", unit:"套", price:9000, img:svgThumb("導播"), desc:"多機位切換/字幕/畫面輸出（示意）。" },
    ]},
    { id:"site", name:"帳篷桌子椅子", items:[
      { id:"site-tent", name:"快帳（3x3m）", unit:"頂", price:1800, img:svgThumb("快帳"), desc:"戶外遮陽遮雨。可加配重/側布。" },
      { id:"site-chair", name:"折疊椅", unit:"張", price:30, img:svgThumb("椅子"), desc:"觀眾座位（示意）。" },
      { id:"site-table", name:"折疊桌", unit:"張", price:150, img:svgThumb("桌子"), desc:"報到/設備區用。" },
      { id:"site-queue", name:"紅龍/排隊動線（2m）", unit:"支", price:120, img:svgThumb("紅龍"), desc:"控場動線、入口區排隊。" },
      { id:"site-cableramp", name:"護線板（1m）", unit:"條", price:120, img:svgThumb("護線"), desc:"走線安全必備，避免絆倒。" },
    ]},
    { id:"power", name:"電力、控場人員與安全營運", items:[
      { id:"power-gen", name:"發電機（基本）", unit:"台", price:12000, img:svgThumb("發電"), desc:"戶外/電力不足時必備。功率可升級。" },
      { id:"power-dist", name:"配電箱/延長線組（基本）", unit:"套", price:1800, img:svgThumb("配電"), desc:"含基本配電、延長線、整理。" },
      { id:"staff-audio", name:"音控工程師（含彩排）", unit:"人/場", price:6500, img:svgThumb("音控"), desc:"含設定、彩排、全程控場（示意）。" },
      { id:"staff-light", name:"燈控工程師（含彩排）", unit:"人/場", price:6500, img:svgThumb("燈控"), desc:"燈光場景、節奏控制（示意）。" },
      { id:"staff-stage", name:"舞台監督/控場（舞監）", unit:"人/場", price:7000, img:svgThumb("舞監"), desc:"流程控場、演出串接、後台協調（示意）。" },
      { id:"staff-host", name:"主持人（基本）", unit:"人/場", price:9000, img:svgThumb("主持"), desc:"主持/串場/互動（示意）。" },
    ]}
  ];

  const LEVELS = {
    safety: ["① 基礎穩定","② 標準配置","③ 活動專業","④ 演出進階","⑤ 旗艦舞台","⑥ 全盛典藏"],
    ambience:["① 純淨燈色","② 典禮質感","③ 氛圍層次","④ 視覺焦點","⑤ 沉浸舞台","⑥ 全感體驗"],
    upgrade:["① 亮點入門","② 氣氛效果","③ 儀式震撼","④ 演出支援","⑤ 全方位","⑥ 尊榮規格"]
  };

  const LEVEL_PRICES = {
    safety:  [ 9800, 16800, 29800, 42800, 68800, 88800 ],
    ambience:[ 4800, 13800, 26800, 42800, 68800, 88800 ],
    upgrade: [ 3800, 6800, 14800, 24800, 39800, 59800 ],
  };

  const PACKS_SAFETY = {
    1: [{id:"audio-main",qty:1},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:1}],
    2: [{id:"audio-main",qty:1},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:2},{id:"audio-monitor",qty:1},{id:"power-dist",qty:1}],
    3: [{id:"audio-main",qty:2},{id:"audio-sub",qty:1},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:2},{id:"audio-monitor",qty:2},{id:"power-dist",qty:1},{id:"staff-audio",qty:1}],
    4: [{id:"audio-main",qty:2},{id:"audio-sub",qty:2},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:3},{id:"audio-monitor",qty:3},{id:"power-dist",qty:1},{id:"staff-audio",qty:1}],
    5: [{id:"audio-main",qty:3},{id:"audio-sub",qty:3},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:4},{id:"audio-monitor",qty:4},{id:"power-gen",qty:1},{id:"power-dist",qty:2},{id:"staff-audio",qty:1}],
    6: [{id:"audio-main",qty:4},{id:"audio-sub",qty:4},{id:"audio-mixer",qty:1},{id:"audio-wireless2",qty:5},{id:"audio-monitor",qty:5},{id:"power-gen",qty:1},{id:"power-dist",qty:3},{id:"staff-audio",qty:1}],
  };
  const PACKS_AMBIENCE = {
    1: [{id:"light-par",qty:4}],
    2: [{id:"stage-backdrop",qty:1},{id:"light-par",qty:6},{id:"light-console",qty:1}],
    3: [{id:"stage-deck",qty:4},{id:"stage-backdrop",qty:1},{id:"light-par",qty:8},{id:"light-console",qty:1},{id:"staff-light",qty:1}],
    4: [{id:"stage-deck",qty:6},{id:"stage-truss",qty:2},{id:"stage-backdrop",qty:1},{id:"light-par",qty:10},{id:"light-moving",qty:4},{id:"light-console",qty:1},{id:"fx-haze",qty:1},{id:"staff-light",qty:1}],
    5: [{id:"stage-deck",qty:8},{id:"stage-truss",qty:4},{id:"stage-drape",qty:1},{id:"stage-backdrop",qty:1},{id:"light-par",qty:12},{id:"light-moving",qty:6},{id:"light-console",qty:1},{id:"fx-haze",qty:1},{id:"staff-light",qty:1}],
    6: [{id:"stage-deck",qty:10},{id:"stage-truss",qty:6},{id:"stage-drape",qty:1},{id:"stage-backdrop",qty:1},{id:"light-par",qty:16},{id:"light-moving",qty:8},{id:"light-console",qty:1},{id:"fx-haze",qty:2},{id:"staff-light",qty:1}],
  };
  const PACKS_UPGRADE = {
    1: [{id:"light-follow",qty:1}],
    2: [{id:"fx-haze",qty:1}],
    3: [{id:"video-projector",qty:1},{id:"video-screen",qty:1}],
    4: [{id:"audio-drumkit",qty:1},{id:"audio-di",qty:4},{id:"audio-monitor",qty:2}],
    5: [{id:"staff-host",qty:1},{id:"staff-stage",qty:1},{id:"staff-audio",qty:1}],
    6: [{id:"staff-host",qty:1},{id:"staff-stage",qty:1},{id:"staff-audio",qty:1},{id:"staff-light",qty:1}],
  };

  const TIER_PHOTOS = {
    safety: Array.from({length:6},(_,i)=>[
      `https://picsum.photos/seed/safety-${i+1}-a/800/600`,
      `https://picsum.photos/seed/safety-${i+1}-b/800/600`
    ]),
    ambience: Array.from({length:6},(_,i)=>[
      `https://picsum.photos/seed/ambience-${i+1}-a/800/600`,
      `https://picsum.photos/seed/ambience-${i+1}-b/800/600`
    ]),
    upgrade: Array.from({length:6},(_,i)=>[
      `https://picsum.photos/seed/upgrade-${i+1}-a/800/600`,
      `https://picsum.photos/seed/upgrade-${i+1}-b/800/600`
    ])
  };

  const TW = {
    "台北市":["中正區","大同區","中山區","松山區","大安區","萬華區","信義區","士林區","北投區","內湖區","南港區","文山區"],
    "新北市":["板橋區","新莊區","中和區","永和區","三重區","土城區","新店區","汐止區","淡水區","林口區"],
    "桃園市":["桃園區","中壢區","平鎮區","八德區","龜山區","蘆竹區"],
    "台中市":["西屯區","北屯區","南屯區","中區","東區","西區","南區","北區","豐原區"],
    "台南市":["中西區","東區","南區","北區","永康區","安平區"],
    "高雄市":["三民區","左營區","鼓山區","苓雅區","前鎮區","鳳山區"]
  };




  const $ = (s)=>document.querySelector(s);
  const fmt = (n)=>"NT$"+Number(n||0).toLocaleString("zh-Hant-TW");
  const state = { 
    catId: CATEGORIES[0].id, 
    cart: { packs: {} }, 
    tiers: { safety: 0, ambience: 0, upgrade: 0 },
    shipping: { fee: 0, km: null } 
  ,
    surcharges: { day: 0, session2: 0, dayCount: 1, extraDays: 0 }
  };

  function initCity(){
    const city=$("#fCity"), area=$("#fArea");
    city.innerHTML=Object.keys(TW).map(c=>`<option value="${c}">${c}</option>`).join("");
    function fillArea(){
      area.innerHTML=(TW[city.value]||[]).map(a=>`<option value="${a}">${a}</option>`).join("");
    }

    city.addEventListener("change", ()=>{ fillArea(); updateShipping(); renderCart(); });
    area.addEventListener("change", ()=>{ updateShipping(); renderCart(); });

    fillArea();

    // ✅ 預設定位：台中市豐原區（方便測試，也符合你的基準點）
    if(Object.keys(TW).includes("台中市")){
      city.value="台中市";
      fillArea();
      if((TW["台中市"]||[]).includes("豐原區")) area.value="豐原區";
    }
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  

  function parseDateTime(dateStr, timeStr){
    if(!dateStr) return null;
    const [hh,mm] = String(timeStr||"00:00").split(":").map(x=>Number(x||0));
    const d = new Date(dateStr+"T00:00:00");
    if(Number.isNaN(d.getTime())) return null;
    d.setHours(hh, mm, 0, 0);
    return d;
  }
function initTimePickers(){
    const hours = Array.from({length:24}, (_,i)=>pad2(i));
    const mins = ["00","10","20","30","40","50"];

    function fill(sel, arr, suffix){
      sel.innerHTML = arr.map(v=>`<option value="${v}">${v}${suffix||""}</option>`).join("");
    }

    // 第一場
    fill($("#tStartH"), hours, "");
    fill($("#tEndH"), hours, "");
    fill($("#tStartM"), mins, "");
    fill($("#tEndM"), mins, "");

    // 第二場（同日）
    if($("#t2StartH")){
      fill($("#t2StartH"), hours, "");
      fill($("#t2EndH"), hours, "");
      fill($("#t2StartM"), mins, "");
      fill($("#t2EndM"), mins, "");
    }

    // 預設值（可自行改）
    $("#tStartH").value="09"; $("#tStartM").value="00";
    $("#tEndH").value="12"; $("#tEndM").value="00";

    if($("#t2StartH")){
      $("#t2StartH").value="18"; $("#t2StartM").value="00";
      $("#t2EndH").value="21"; $("#t2EndM").value="00";
    }

    function sync(){
      $("#fTimeStart").value = `${$("#tStartH").value}:${$("#tStartM").value}`;
      $("#fTimeEnd").value   = `${$("#tEndH").value}:${$("#tEndM").value}`;
    }

    function sync2(){
      if(!$("#t2StartH")) return;
      $("#fTime2Start").value = `${$("#t2StartH").value}:${$("#t2StartM").value}`;
      $("#fTime2End").value   = `${$("#t2EndH").value}:${$("#t2EndM").value}`;
    }

    ["tStartH","tStartM","tEndH","tEndM"].forEach(id=>$("#"+id).addEventListener("change", ()=>{ sync(); renderCart(); }));
    sync();

    if($("#t2StartH")){
      ["t2StartH","t2StartM","t2EndH","t2EndM"].forEach(id=>$("#"+id).addEventListener("change", ()=>{ sync2(); renderCart(); }));
      sync2();
    }
  }

  function renderSession2Days(){
    const wrap = $("#session2DaysWrap");
    const box  = $("#session2Days");
    if(!wrap || !box) return;

    const ds = $("#fDateStart")?.value || "";
    const de = $("#fDateEnd")?.value || ds;
    // 沒選日期就先不顯示
    if(!ds){ wrap.style.display="none"; box.innerHTML=""; return; }

    // 先用日期粗算跨天天數（不看時間）
    let dayCount = 1;
    if(ds && de){
      const s = new Date(ds+"T00:00:00");
      const e = new Date(de+"T00:00:00");
      if(!isNaN(s) && !isNaN(e)){
        const diff = Math.round((e.getTime()-s.getTime())/(24*60*60*1000));
        dayCount = Math.max(1, diff + 1);
      }
    }

    // 只在跨天時提供「第2天起」的第二場勾選
    if(dayCount <= 1){
      wrap.style.display="none";
      box.innerHTML="";
      return;
    }

    wrap.style.display="block";

    // 保留原先勾選狀態：先讀現有 input
    const prev = new Set(Array.from(box.querySelectorAll('input[data-s2day="1"]')).filter(x=>x.checked).map(x=>x.value));

    const rows=[];
    for(let d=2; d<=dayCount; d++){
      const key = `day${d}`;
      const checked = prev.has(key) ? "checked" : "";
      rows.push(`
        <label style="display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted)">
          <input type="checkbox" data-s2day="1" value="${key}" ${checked} style="width:18px;height:18px">
          第${d}天有第二場（加價：基準 E × 30%）
        </label>
      `);
    }
    box.innerHTML = rows.join("");

    // 勾選就即時重算
    box.querySelectorAll('input[data-s2day="1"]').forEach(cb=>{
      cb.addEventListener("change", ()=>{ renderCart(); });
    });
  }


  function renderTabs(){
    const el=$("#tabs");
    el.innerHTML=CATEGORIES.map(c=>`<button class="tab ${c.id===state.catId?"active":""}" data-cat="${c.id}">${c.name}</button>`).join("");
    el.querySelectorAll(".tab").forEach(b=>b.addEventListener("click", ()=>{ state.catId=b.dataset.cat; renderAll(); }));
  }

  function findItem(itemId){
    for(const c of CATEGORIES){
      const it=c.items.find(x=>x.id===itemId);
      if(it) return {cat:c,item:it};
    }
    return null;
  }

  function setQty(itemId, qty){
    if(qty<=0) delete state.cart[itemId];
    else state.cart[itemId]=qty;
    renderAll();
  }

  function renderItems(){
    const cat=CATEGORIES.find(c=>c.id===state.catId);
    $("#catName").textContent=cat?.name||"—";
    const el=$("#items");
    el.innerHTML=(cat?.items||[]).map(it=>{
      const qty=state.cart[it.id]||0;
      return `
        <div class="item">
          <img class="thumb" src="${getItemPhotos(state.catId, it.id)[0]}" alt="${it.name}" loading="lazy" onerror="this.onerror=null;this.src=svgThumb(it.name);">
          <div class="meta">
            <div class="name">${it.name}</div>
            <div class="sub">${fmt(it.price)} / ${it.unit}</div>
            <div class="row2">
              <div class="qty">
                <button class="qbtn" data-act="dec" data-id="${it.id}">-</button>
                <div class="qval">${qty}</div>
                <button class="qbtn" data-act="inc" data-id="${it.id}">+</button>
              </div>
              <button class="linkbtn" data-act="detail" data-id="${it.id}">詳情</button>
            </div>
          </div>
          <div class="price">${fmt(it.price*qty)}</div>
        </div>
      `;
    }).join("");

    el.querySelectorAll("button").forEach(b=>{
      const act=b.dataset.act, id=b.dataset.id;
      if(!act||!id) return;
      if(act==="inc") b.addEventListener("click", ()=>setQty(id,(state.cart[id]||0)+1));
      if(act==="dec") b.addEventListener("click", ()=>setQty(id,Math.max(0,(state.cart[id]||0)-1)));
      if(act==="detail") b.addEventListener("click", ()=>openItemDetail(id));
    });

    const pickedItemCount = Object.keys(state.cart).filter(k=>k!=="packs" && state.cart[k]>0).length;
    const pickedPackCount = Object.keys(state.cart.packs||{}).filter(k=>state.cart.packs[k]).length;
    $("#pickedCount").textContent = `${pickedItemCount + pickedPackCount} 項已選`;
  }

  function groupCart(){
    const groups=new Map();
    for(const [id,qty] of Object.entries(state.cart)){
      if(id==="packs") continue;
      const f=findItem(id); if(!f) continue;
      const key=f.cat.name;
      if(!groups.has(key)) groups.set(key, []);
      groups.get(key).push({item:f.item, qty});
    }
    return groups;
  }

  function updateSurcharges(baseSum){
    // baseSum：原始總價（套裝/單品加總，不含任何加價與折扣）
    // 基準 E：原始總價 +（第一天第二場加價，若有）→ 之後跨天/續日與「跨天的第二場」都以 E 為基準
    const ds = $("#fDateStart")?.value || "";
    const de = $("#fDateEnd")?.value || ds;
    const ts = $("#fTimeStart")?.value || "00:00";
    const te = $("#fTimeEnd")?.value || "00:00";

    // 計算跨天天數（以日期為準；同日但結束早於開始 → 容錯視為跨到隔日）
    let start = parseDateTime(ds, ts);
    let end   = parseDateTime(de, te);

    let dayCount = 1;
    if(start && end){
      if(de===ds && end.getTime() <= start.getTime()){
        end = new Date(end.getTime() + 24*60*60*1000);
      }
      const startDay = new Date(start.getFullYear(), start.getMonth(), start.getDate()).getTime();
      const endDay   = new Date(end.getFullYear(), end.getMonth(), end.getDate()).getTime();
      dayCount = Math.max(1, Math.round((endDay - startDay)/(24*60*60*1000)) + 1);
    }

    // 第一天天內第二場（原本的勾選）
    const has2 = !!$("#fHasSession2") && $("#fHasSession2").checked;
    let day1SecondFee = 0;
    if(has2){
      const t2s = $("#fTime2Start")?.value || "";
      const t2e = $("#fTime2End")?.value || "";
      if(t2s && t2e){
        day1SecondFee = Math.round(baseSum * 0.30);
      }
    }

    const E = baseSum + day1SecondFee;

    // 跨天加價：第2天 +50%，第3天起每一天 +30%（以 E 為基準）
    const extraDays = Math.max(0, dayCount - 1);
    let dayFee = 0;
    if(extraDays >= 1) dayFee += Math.round(E * 0.50);                    // 第2天
    if(extraDays >= 2) dayFee += Math.round(E * 0.30 * (extraDays - 1));   // 第3天起

    // 跨天的第二場：只在 dayCount>=2 時出現，且每一天可各自勾選（每勾一天 +E×30%）
    let s2DaysFee = 0;
    if(dayCount >= 2){
      document.querySelectorAll('input[data-s2day="1"]').forEach(cb=>{
        if(cb.checked) s2DaysFee += Math.round(E * 0.30);
      });
    }

    // session2Fee：第一天第二場 + 跨天的第二場（若有）
    const session2Fee = day1SecondFee + s2DaysFee;

    state.surcharges = { day: dayFee, session2: session2Fee, day1SecondFee, s2DaysFee, dayCount, extraDays, E, baseSum };
    return state.surcharges;
  }


  
  function calc(){
    let sum=0;

    // 套裝（右側只顯示名稱）
    if(state.cart.packs){
      for(const [tierKey, pack] of Object.entries(state.cart.packs)){
        if(!pack) continue;
        sum += Number(pack.price||0);
      }
    }

    // 自由加減的單品
    for(const [id,qty] of Object.entries(state.cart)){
      if(id==="packs") continue;
      const f=findItem(id); if(!f) continue;
      sum += f.item.price*qty;
    }

    // 更新跨天/第二場加價（以原始總價 sum 為基準）
    const sur = updateSurcharges(sum);
    const dayFee = Number(sur.day||0);
    const session2Fee = Number(sur.session2||0);

    // 折扣/加價（手動輸入）
    const adj=Number($("#adj").value||0);

    const ship = 0;
    return {sum, adj, ship, dayFee, session2Fee, total: sum + ship + dayFee + session2Fee + adj};
  }

  function openModal(title, htmlBody){
    $("#mTitle").textContent = title || "詳情";
    $("#mBody").innerHTML = htmlBody || "—";
    $("#modalMask").style.display="flex";
  }
  function closeModal(){ $("#modalMask").style.display="none"; }

// === Modal interactions (close / back / ESC / click mask) ===
(function(){
  const mask = document.getElementById("modalMask");
  const btnClose = document.getElementById("mClose");
  const btnBack = document.getElementById("mBack");

  function closeModalSafe(){
    try{ closeModal(); }catch(e){ if(mask) mask.style.display="none"; }
  }

  if(btnClose) btnClose.addEventListener("click", closeModalSafe);
  if(mask) mask.addEventListener("click", (e)=>{ if(e.target===mask) closeModalSafe(); });
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && mask && mask.style.display==="flex") closeModalSafe(); });

  if(btnBack) btnBack.addEventListener("click", ()=>{
    closeModalSafe();
    const qc = document.getElementById("quoteCard");
    if(qc) qc.scrollIntoView({behavior:"smooth", block:"start"});
  });
})();


  
function getItemPhotos(catId, itemId){
  const seedBase = `${catId||"cat"}-${itemId||"item"}`;
  return [
    `https://picsum.photos/seed/${seedBase}-a/800/600`,
    `https://picsum.photos/seed/${seedBase}-b/800/600`
  ];
}

  
function openItemDetail(itemId){
  const f=findItem(itemId); if(!f) return;
  const photos = getItemPhotos(f.cat.id, f.item.id);
  const desc = ((f.item.desc||"—")+"").replace(/
/g,"<br>");
  openModal(`商品詳情｜${f.item.name}`, `
    ${buildPhotoHTML(photos)}
    <div class="modalDesc">${desc}</div>
  `);
}

function buildPhotoHTML(
urls){
    const a = (urls && urls[0]) ? urls[0] : "https://picsum.photos/seed/event-fallback/800/600";
    const b = (urls && urls[1]) ? urls[1] : "https://picsum.photos/seed/stage-fallback/800/600";
    return `
      <div class="photoGrid">
        <div class="photoBox">
          <img src="${a}" alt="示意照片 1" loading="lazy">
          <div class="photoCap">示意照片 1（可換成你的照片連結）</div>
        </div>
        <div class="photoBox">
          <img src="${b}" alt="示意照片 2" loading="lazy">
          <div class="photoCap">示意照片 2（可換成你的照片連結）</div>
        </div>
      </div>
    `;
  }


  function openTierDetail(tierKey, level){
    const tierLabel = ({safety:"安全", ambience:"氣氛", upgrade:"升級"}[tierKey]) || "套裝";
    const levelName = (LEVELS[tierKey] && LEVELS[tierKey][level-1]) ? LEVELS[tierKey][level-1] : `第${level}級`;
    const price = LEVEL_PRICES[tierKey]?.[level-1];

    const packs = tierKey==="safety" ? PACKS_SAFETY : (tierKey==="ambience" ? PACKS_AMBIENCE : PACKS_UPGRADE);
    const list = packs[level] || [];
    const photos = TIER_PHOTOS[tierKey]?.[level-1];

    const itemsHTML = list.map(p=>{
      const f = findItem(p.id);
      const name = f ? f.item.name : p.id;
      const unit = f ? f.item.unit : "";
      return `<li><b>${name}</b> × ${p.qty}${unit?` ${unit}`:""}</li>`;
    }).join("");

    const usage = (()=>{
      if(tierKey==="safety"){
        if(level<=2) return "適合：室內/小型活動、主持/致詞、背景音樂；以穩定清晰為主。";
        if(level<=4) return "適合：中型活動/表演，有基本監聽與工程配置；可應付較複雜流程。";
        return "適合：大型戶外/舞台演出，多監聽與電力配套；更適合人多與需求較高的活動。";
      }
      if(tierKey==="ambience"){
        if(level<=2) return "適合：典禮/活動基礎氛圍，主色染色與基本控制。";
        if(level<=4) return "適合：表演/進退場需要視覺焦點，含移動燈/薄霧等效果提升。";
        return "適合：舞台感更強的活動，視覺層次與整體質感加強。";
      }
      // upgrade
      if(level<=2) return "加值：追光或薄霧等單點升級，快速提升舞台感。";
      if(level<=4) return "加值：投影/螢幕或演出支援（鼓組/DI/監聽），適合有表演需求。";
      return "加值：人力/控場/全方位支援，適合大型或流程複雜的活動。";
    })();

    openModal(`套裝詳情｜${tierLabel} ${levelName}`, `
      ${buildPhotoHTML(photos)}
      <div class="packMeta">
        <span class="tag">${tierLabel}</span>
        <span class="tag">等級：${levelName}</span>
        <span class="tag">參考價：${price?fmt(price):"—"}</span>
      </div>

      <div class="subttl">包含內容</div>
      <ul class="packList">${itemsHTML || "<li>—</li>"}</ul>

      <div class="subttl" style="margin-top:10px">說明</div>
      <div class="modalDesc">${usage}</div>
    `);
  }

  // ✅ 直接加入：不用先選等級再按「一鍵套用」
  function applyPackLevel(tierKey, level){
    const packs = tierKey==="safety" ? PACKS_SAFETY : (tierKey==="ambience" ? PACKS_AMBIENCE : PACKS_UPGRADE);
    const list = (packs && packs[level]) ? packs[level] : [];
    if(!level || !list.length){ alert("此等級尚未設定套裝內容。"); return; }

    state.tiers[tierKey] = level;

    const packLabel = tierKey==="safety" ? "安全等級" : (tierKey==="ambience" ? "氣氛等級" : "升級等級");
    const name = (LEVELS[tierKey]?.[level-1]) || `第${level}級`;
    const price = (LEVEL_PRICES[tierKey]?.[level-1]) || 0;

    // ✅ 防呆：確保 packs 容器存在
    state.cart = state.cart || {};
    state.cart.packs = state.cart.packs || {};

    state.cart.packs[tierKey] = { tierKey, label: packLabel, level, name, price, items: list };

    if(tierKey==="safety") state.catId="audio";
    if(tierKey==="ambience") state.catId="light";
    if(tierKey==="upgrade") state.catId="video";

    renderAll();
  }

  function removePack(tierKey){
    if(state.cart.packs) delete state.cart.packs[tierKey];
    state.tiers[tierKey]=0;
    renderAll();
  }

  function renderTierButtons(){
    const mk = (tierKey, containerSel) => {
      const el = $(containerSel);

      el.innerHTML = LEVELS[tierKey].map((name, idx)=>{
        const n = idx+1;
        const on = state.tiers[tierKey]===n ? "active" : "";
        const price = LEVEL_PRICES[tierKey]?.[idx];

        return `
          <div class="levelBtn ${on}" data-tier="${tierKey}" data-level="${n}">
            <div class="levelText">
              <div class="levelTopRow">
                <span class="levelName">${name}</span>
                <span class="levelPrice">${price?fmt(price):"—"}</span>
              </div>
              <div class="levelActions">
                <button type="button" class="miniBtn primaryMini" data-act="apply" data-tier="${tierKey}" data-level="${n}">加入</button>
                <button type="button" class="miniBtn" data-tier="${tierKey}" data-level="${n}">詳情</button>
              </div>
            </div>
            <div class="levelMedia">
              <img src="${(TIER_PHOTOS[tierKey]?.[idx]?.[0]) || 'https://picsum.photos/seed/stage-fallback/800/600'}" alt="示意照片" loading="lazy">
            </div>
          </div>
        `;
      }).join("");

      el.querySelectorAll(".levelBtn").forEach(box=>{
        box.addEventListener("click", (e)=>{
          if(e.target && e.target.closest(".miniBtn")) return;
          const tier = box.dataset.tier;
          const level = Number(box.dataset.level);
          state.tiers[tier]=level;
          renderTierPills();
          renderTierButtons();
        });
      });

      el.querySelectorAll(".miniBtn").forEach(b=>{
        b.addEventListener("click", (e)=>{
          e.stopPropagation();
          const act = b.dataset.act || "";
          if(act==="apply"){
            applyPackLevel(b.dataset.tier, Number(b.dataset.level));
            return;
          }
          openTierDetail(b.dataset.tier, Number(b.dataset.level));
        });
      });
    };

    mk("safety","#levelsSafety");
    mk("ambience","#levelsAmbience");
    mk("upgrade","#levelsUpgrade");

    $("#pillSafety").textContent = state.tiers.safety ? `第${state.tiers.safety}級` : "未選";
    $("#pillAmbience").textContent = state.tiers.ambience ? `第${state.tiers.ambience}級` : "未選";
    $("#pillUpgrade").textContent = state.tiers.upgrade ? `第${state.tiers.upgrade}級` : "未選";
  }

  function renderTierPills(){
    const s = state.tiers.safety ? `安全第${state.tiers.safety}級` : "安全—";
    const a = state.tiers.ambience ? `氣氛第${state.tiers.ambience}級` : "氣氛—";
    const u = state.tiers.upgrade ? `升級第${state.tiers.upgrade}級` : "升級—";
    $("#tierPills").textContent = `${s}｜${a}｜${u}`;
  }

  function groupCart(){
    const groups=new Map();
    for(const [id,qty] of Object.entries(state.cart)){
      if(id==="packs") continue;
      const f=findItem(id); if(!f) continue;
      const key=f.cat.name;
      if(!groups.has(key)) groups.set(key, []);
      groups.get(key).push({item:f.item, qty});
    }
    return groups;
  }

  function buildQuoteText(){
    const lines=[];
    lines.push("【活動企劃｜設備選配報價】");
    const name=$("#fName").value.trim();
    if(name) lines.push(`姓名/單位：${name}`);
    lines.push(`三層等級：${$("#tierPills").textContent}`);

    if(state.cart.packs){
      const order=[["safety","安全等級"],["ambience","氣氛等級"],["upgrade","升級等級"]];
      for(const [k,title] of order){
        const p=state.cart.packs[k];
        if(!p) continue;
        lines.push(`套裝：${title}｜${p.name}（${fmt(p.price)}）`);
      }
      lines.push("");
    }

    const groups=groupCart();
    for(const [gname, rows] of groups.entries()){
      lines.push(`■ ${gname}`);
      for(const {item,qty} of rows){
        lines.push(`- ${item.name} x${qty}（${fmt(item.price)} / ${item.unit}）小計：${fmt(item.price*qty)}`);
      }
      lines.push("");
    }
    const {sum,adj,total}=calc();
    lines.push(`小計：${fmt(sum)}`);
    lines.push(`折扣/加價：${fmt(adj)}`);
    lines.push(`總計：${fmt(total)}`);
    return lines.join("\n");
  }

  function renderCart(){
    const el=$("#cart");

    // 更新加價說明（顯示在「即時報價」的加價列上）
    const dayLabel = $("#daySurchargeRow")?.querySelector(".subttl");
    if(dayLabel){
      dayLabel.innerHTML = `跨天加價 <span class="note-inline">（第2天：E×50%；第3天起：每一天 E×30%）</span>`;
    }
    const s2Label = $("#session2SurchargeRow")?.querySelector(".subttl");
    if(s2Label){
      s2Label.innerHTML = `第二場加價 <span class="note-inline">（第一天/跨天每勾一天：E×30%）</span>`;
    }
    const groups=groupCart();

    const packCount = state.cart.packs ? Object.keys(state.cart.packs).filter(k=>state.cart.packs[k]).length : 0;
    const itemCount = Object.keys(state.cart).filter(k=>k!=="packs").length;
    $("#cartBadge").textContent = `${packCount + itemCount} 項已選`;

    const parts=[];

    if(state.cart.packs){
      const order = [["safety","安全等級"],["ambience","氣氛等級"],["upgrade","升級等級"]];
      for(const [tierKey, title] of order){
        const pack = state.cart.packs[tierKey];
        if(!pack) continue;

        const lv = Number(pack.level||0);
        const packName = `${title}｜${pack.name || ((LEVELS[tierKey]?.[lv-1]) || `第${lv}級`)}`;
        const price = Number(pack.price||0);

        parts.push(`
          <div class="group">
            <div class="gh">
              <span>${title}（套裝）</span>
              <span class="subttl">已選 <b>1</b> 項</span>
            </div>
            <div class="gb">
              <div class="citem">
                <img src="${(TIER_PHOTOS[tierKey]?.[lv-1]?.[0]) || svgThumb("套裝")}" alt="${packName}">
                <div class="cmeta">
                  <div class="top">
                    <div>
                      <div class="nm">${packName}</div>
                      <div class="unit">套裝價格（示範）</div>
                    </div>
                    <div style="font-weight:1000">${fmt(price)}</div>
                  </div>
                  <div class="cline">
                    <div class="qtyRow">
                      <div class="qty" style="padding:6px 10px"><b>套裝</b></div>
                      <button class="xbtn" data-act="delpack" data-tier="${tierKey}" title="刪除套裝">✕</button>
                    </div>
                    <div class="subttl">小計：<b>${fmt(price)}</b></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `);
      }
    }

    for(const [gname, rows] of groups.entries()){
      parts.push(`
        <div class="group">
          <div class="gh">
            <span>${gname}</span>
            <span class="subttl">已選 <b>${rows.length}</b> 項</span>
          </div>
          <div class="gb">
            ${rows.map(({item,qty})=>{
              const line=item.price*qty;
              return `
                <div class="citem">
                  <img src="${item.img}" alt="${item.name}">
                  <div class="cmeta">
                    <div class="top">
                      <div>
                        <div class="nm">${item.name}</div>
                        <div class="unit">${fmt(item.price)} / ${item.unit}</div>
                      </div>
                      <div style="font-weight:1000">${fmt(line)}</div>
                    </div>

                    <div class="cline">
                      <div class="qtyRow">
                        <div class="qty">
                          <button class="qbtn" data-act="dec" data-id="${item.id}">-</button>
                          <div class="qval">${qty}</div>
                          <button class="qbtn" data-act="inc" data-id="${item.id}">+</button>
                        </div>
                        <button class="xbtn" data-act="del" data-id="${item.id}" title="刪除">✕</button>
                      </div>
                      <div class="subttl">小計：<b>${fmt(line)}</b></div>
                    </div>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        </div>
      `);
    }

    el.innerHTML = parts.join("") || `<div class="note">先按「加入」把等級套裝放到右邊，或在下方分類加減設備。</div>`;

    el.querySelectorAll("button").forEach(b=>{
      const act=b.dataset.act, id=b.dataset.id;
      if(act==="inc") b.addEventListener("click", ()=>setQty(id,(state.cart[id]||0)+1));
      if(act==="dec") b.addEventListener("click", ()=>setQty(id,Math.max(0,(state.cart[id]||0)-1)));
      if(act==="del") b.addEventListener("click", ()=>setQty(id,0));
      if(act==="delpack") b.addEventListener("click", ()=>removePack(b.dataset.tier));
    });

    const {sum,adj,dayFee,session2Fee,total}=calc();
    $("#grandTotal").textContent=fmt(sum);
    // 只有需要加價時才顯示
    const dayRow=$("#daySurchargeRow");
    const dayEl=$("#daySurcharge");
    if(dayRow && dayEl){
      const v = Number(dayFee||0);
      dayRow.style.display = v>0 ? "flex" : "none";
      dayEl.textContent = fmt(v);
    }
    const s2Row=$("#session2SurchargeRow");
    const s2El=$("#session2Surcharge");
    if(s2Row && s2El){
      const v2 = Number(session2Fee||0);
      s2Row.style.display = v2>0 ? "flex" : "none";
      s2El.textContent = fmt(v2);
    }
    $("#finalTotal").textContent=fmt(total);
  }

  function renderAll(){
    renderTierPills();
    renderTierButtons();
    renderTabs();
    renderItems();
renderCart();
  }

  $("#btnPrint").addEventListener("click", ()=>window.print());
  $("#btnClear").addEventListener("click", ()=>{
    if(confirm("確定要清空全部已選項目嗎？")){
      state.cart={packs:{}}; $("#adj").value=0;
      state.tiers={ safety: 0, ambience: 0, upgrade: 0 };
      renderAll();
    }
  });
  $("#btnCopy").addEventListener("click", async ()=>{
    const txt=buildQuoteText();
    try{ await navigator.clipboard.writeText(txt); alert("已複製報價內容！"); }
    catch(e){ prompt("複製失敗，請手動全選複製：", txt); }
  });
  $("#btnMail").addEventListener("click", ()=>{
    const to = $("#fEmail").value.trim() ? $("#fEmail").value.trim() : "";
    const subject = encodeURIComponent("活動企劃｜設備選配報價");
    const body = encodeURIComponent(buildQuoteText());
    location.href = `mailto:${to}?subject=${subject}&body=${body}`;
  });

  // 初始化
  initCity();
  initTimePickers();
  renderSession2Days();
  const c2 = $("#fHasSession2");
  const w2 = $("#session2Wrap");
  if(c2){
    c2.addEventListener("change", ()=>{
      if(w2) w2.style.display = c2.checked ? "block" : "none";
      renderCart();
    });
    if(w2) w2.style.display = c2.checked ? "block" : "none";
  }
  ["t2StartH","t2StartM","t2EndH","t2EndM"].forEach(id=>{ const el=$("#"+id); if(el) el.addEventListener("change", ()=>renderCart()); });
  // 地址輸入時也更新（粗估仍以縣市/區為主，但讓使用者『輸入就更新』）
  ["fAddr","fBldg"].forEach(id=>{ const el=$("#"+id); if(el) el.addEventListener("input", ()=>{ updateShipping(); renderCart(); }); });
  ["fDateStart","fDateEnd"].forEach(id=>{ const el=$("#"+id); if(el) el.addEventListener("change", ()=>{ renderSession2Days(); renderCart(); }); });
  $("#adj").addEventListener("input", renderCart);
renderAll();
</script>
</body>
</html>
